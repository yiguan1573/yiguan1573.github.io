<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">

    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="referrer" content="never">
	
    
    <meta property="og:site_name" content="亿观的博客">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://yiguan1573.gitee.io//img/01.jpg">
    <meta property="twitter:image" content="https://yiguan1573.gitee.io//img/01.jpg" />
    

    
    <meta name="title" content="2、MongoDB基础（MongoDB）" />
    <meta property="og:title" content="2、MongoDB基础（MongoDB）" />
    <meta property="twitter:title" content="2、MongoDB基础（MongoDB）" />
    

    
    <meta name="description" content="">
    <meta property="og:description" content="" />
    <meta property="twitter:description" content="" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>2、MongoDB基础（MongoDB）-yiguan1573</title>

    <link rel="canonical" href="/post/987mongodb%E5%9F%BA%E7%A1%80/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>
	
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/syntax.css">
    
    
    <link rel="stylesheet" href="/css/zanshang.css">
    
    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    
    

    
    
    <script src="/js/jquery.min.js"></script>
    
    
    <script src="/js/bootstrap.min.js"></script>
    
    
    <script src="/js/hux-blog.min.js"></script>

    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/docco.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    

</head>



<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">亿观的博客</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">主页</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/%E5%AD%A6%E4%B9%A0">学习</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/#">图书</a></li>
                    
                        <li><a href="/#">关于</a></li>
                    

                    
		    <li>
                        <a href="/search">搜索 <img src="/img/search.png" height="15" style="cursor: pointer;" alt="Search"></a>
		    </li>
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('http://ww1.sinaimg.cn/large/006QQPIfly1gblyz9ca5mj30rs14yb29.jpg')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/mongodb" title="MongoDB">
                            MongoDB
                        </a>
                        
                    </div>
                    <h1>2、MongoDB基础（MongoDB）</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by 
                        
                                 &#34;亿观&#34;
                         
                        on 
                        Thursday, April 28, 2022
                        
                        
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <header>
                    <h2></h2>
                </header>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#1-mongodb相关概念">1 MongoDB相关概念</a>
      <ul>
        <li><a href="#11-业务应用场景">1.1 业务应用场景</a></li>
        <li><a href="#12-mongodb简介">1.2 MongoDB简介</a></li>
        <li><a href="#13-体系结构">1.3 体系结构</a></li>
        <li><a href="#14-数据模型">1.4 数据模型</a></li>
        <li><a href="#15-mongodb的特点">1.5 MongoDB的特点</a></li>
      </ul>
    </li>
    <li><a href="#2-单机部署">2 单机部署</a>
      <ul>
        <li><a href="#21-windows系统中的安装启动">2.1 Windows系统中的安装启动</a></li>
        <li><a href="#22-shell连接mongo命令">2.2 Shell连接(mongo命令)</a></li>
        <li><a href="#23-compass-图形化界面客户端">2.3 Compass-图形化界面客户端</a></li>
        <li><a href="#24-linux系统中的安装启动和连接">2.4 Linux系统中的安装启动和连接</a></li>
      </ul>
    </li>
    <li><a href="#3-基本常用命令">3 基本常用命令</a>
      <ul>
        <li><a href="#31-案例需求">3.1 案例需求</a></li>
        <li><a href="#32-数据库操作">3.2 数据库操作</a></li>
        <li><a href="#33-集合操作">3.3 集合操作</a></li>
        <li><a href="#34-文档基本crud">3.4 文档基本CRUD</a></li>
        <li><a href="#35-文档的分页查询">3.5 文档的分页查询</a></li>
        <li><a href="#36-文档的更多查询">3.6 文档的更多查询</a></li>
        <li><a href="#37-常用命令小结">3.7 常用命令小结</a></li>
      </ul>
    </li>
    <li><a href="#4-索引-index">4 索引-Index</a>
      <ul>
        <li><a href="#41-概述">4.1 概述</a></li>
        <li><a href="#42-索引的类型">4.2 索引的类型</a></li>
        <li><a href="#43-索引的管理操作">4.3 索引的管理操作</a></li>
        <li><a href="#44-索引的使用">4.4 索引的使用</a></li>
      </ul>
    </li>
    <li><a href="#5-文章评论">5 文章评论</a>
      <ul>
        <li><a href="#51-需求分析">5.1 需求分析</a></li>
        <li><a href="#52-表结构分析">5.2 表结构分析</a></li>
        <li><a href="#53-技术选型">5.3 技术选型</a></li>
        <li><a href="#54-文章微服务模块搭建">5.4 文章微服务模块搭建</a></li>
        <li><a href="#55-文章评论实体类的编写">5.5 文章评论实体类的编写</a></li>
        <li><a href="#56-文章评论的基本增删改查">5.6 文章评论的基本增删改查</a></li>
        <li><a href="#57-根据上级id查询文章评论的分页列表">5.7 根据上级ID查询文章评论的分页列表</a></li>
        <li><a href="#58-mongotemplate实现评论点赞">5.8 MongoTemplate实现评论点赞</a></li>
      </ul>
    </li>
  </ul>
</nav>
                
                <h2 id="1-mongodb相关概念">1 MongoDB相关概念</h2>
<h3 id="11-业务应用场景">1.1 业务应用场景</h3>
<p>传统的关系型数据库（如MySQL），在数据操作的“三高”需求以及应对Web2.0的网站需求面前，显得力不从心。</p>
<ul>
<li>
<p><strong>解释：“三高”需求：</strong></p>
<ul>
<li>High performance - 对数据库高并发读写的需求。</li>
<li>Huge Storage - 对海量数据的高效率存储和访问的需求。</li>
<li>High Scalability &amp;&amp; High Availability- 对数据库的高可扩展性和高可用性的需求。</li>
</ul>
</li>
<li>
<p><strong>而MongoDB可应对“三高”需求。</strong></p>
</li>
<li>
<p>具体的应用场景如：</p>
</li>
</ul>
<p>1 ）社交场景，使用 MongoDB 存储存储用户信息，以及用户发表的朋友圈信息，通过地理位置索引实现附近的人、地点等功能。</p>
<p>2）游戏场景，使用 MongoDB 存储游戏用户信息，用户的装备、积分等直接以内嵌文档的形式存储，方便查询、高效率存储和访问。</p>
<p>3）物流场景，使用 MongoDB 存储订单信息，订单状态在运送过程中会不断更新，以 MongoDB 内嵌数组的形式来存储，一次查询就能将订单所有的变更读取出来。</p>
<p>4 ）物联网场景，使用 MongoDB 存储所有接入的智能设备信息，以及设备汇报的日志信息，并对这些信息进行多维度的分析。</p>
<p>5 ）视频直播，使用 MongoDB 存储用户信息、点赞互动信息等。</p>
<p>这些应用场景中，数据操作方面的共同特点是：</p>
<p>（ 1 ）数据量大</p>
<p>（ 2 ）写入操作频繁（读写都很频繁）</p>
<p>（ 3 ）价值较低的数据，对事务性要求不高</p>
<p>对于这样的数据，我们更适合使用MongoDB来实现数据的存储。</p>
<p><strong>什么时候选择MongoDB</strong></p>
<p>在架构选型上，除了上述的三个特点外，如果你还犹豫是否要选择它？可以考虑以下的一些问题：</p>
<p>应用不需要事务及复杂 join 支持</p>
<p>新应用，需求会变，数据模型无法确定，想快速迭代开发</p>
<p>应用需要2000-3000以上的读写QPS（更高也可以）</p>
<p>应用需要TB甚至 PB 级别数据存储</p>
<p>应用发展迅速，需要能快速水平扩展</p>
<p>应用要求存储的数据不丢失</p>
<p>应用需要99.999%高可用</p>
<p>应用需要大量的地理位置查询、文本查询</p>
<p>如果上述有 1 个符合，可以考虑 MongoDB， 2 个及以上的符合，选择 MongoDB 绝不会后悔。</p>
<p>思考：如果用MySQL呢？</p>
<p>答：相对MySQL，可以以更低的成本解决问题（包括学习、开发、运维等成本）</p>
<h3 id="12-mongodb简介">1.2 MongoDB简介</h3>
<ul>
<li>MongoDB是一个开源、高性能、无模式的文档型数据库，当初的设计就是用于简化开发和方便扩展，是NoSQL数据库产品中的一种。是最像关系型数据库（MySQL）的非关系型数据库。</li>
<li>它支持的数据结构非常松散，是一种类似于 JSON 的 格式叫BSON，所以它既可以存储比较复杂的数据类型，又相当的灵活。</li>
<li>MongoDB中的记录是一个文档，它是一个由字段和值对（field:value）组成的数据结构。MongoDB文档类似于JSON对象，即一个文档认为就是一个对象。字段的数据类型是字符型，它的值除了使用基本的一些类型外，还可以包括其他文档、普通数组和文档数组。</li>
</ul>
<h3 id="13-体系结构">1.3 体系结构</h3>
<ul>
<li><strong>MySQL和MongoDB对比</strong>
<img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pm4j9bl3j30n70lt44e.jpg" alt="QQ截图20220428182931.png"></li>
</ul>
<h3 id="14-数据模型">1.4 数据模型</h3>
<ul>
<li>
<p>MongoDB的最小存储单位就是文档(document)对象。文档(document)对象对应于关系型数据库的行。数据在MongoDB中以</p>
</li>
<li>
<p>BSON（Binary-JSON）文档的格式存储在磁盘上。</p>
</li>
<li>
<p>BSON（Binary Serialized Document Format）是一种类json的一种二进制形式的存储格式，简称Binary JSON。BSON和JSON一样，支持内嵌的文档对象和数组对象，但是BSON有JSON没有的一些数据类型，如Date和BinData类型。</p>
</li>
<li>
<p>BSON采用了类似于 C 语言结构体的名称、对表示方法，支持内嵌的文档对象和数组对象，具有轻量性、可遍历性、高效性的三个特点，可以有效描述非结构化数据和结构化数据。这种格式的优点是灵活性高，但它的缺点是空间利用率不是很理想。</p>
</li>
<li>
<p>Bson中，除了基本的JSON类型：string,integer,boolean,double,null,array和object，mongo还使用了特殊的数据类型。这些类型包括date,object id,binary data,regular expression 和code。每一个驱动都以特定语言的方式实现了这些类型，查看你的驱动的文档来获取详细信息。</p>
</li>
<li>
<p>BSON数据类型参考列表：
<img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pm63s3czj30mz0j7dqv.jpg" alt="QQ截图20220428183102.png"></p>
</li>
</ul>
<h3 id="15-mongodb的特点">1.5 MongoDB的特点</h3>
<ul>
<li><strong>MongoDB主要有如下特点：</strong></li>
</ul>
<p>（ 1 ）高性能：</p>
<p>MongoDB提供高性能的数据持久性。特别是,</p>
<p>对嵌入式数据模型的支持减少了数据库系统上的I/O活动。</p>
<p>索引支持更快的查询，并且可以包含来自嵌入式文档和数组的键。（文本索引解决搜索的需求、TTL索引解决历史数据自动过期的需求、地理位置索引可用于构建各种 O2O 应用）</p>
<p>mmapv1、wiredtiger、mongorocks（rocksdb）、in-memory 等多引擎支持满足各种场景需求。</p>
<p>Gridfs解决文件存储的需求。</p>
<p>（ 2 ）高可用性：</p>
<p>MongoDB的复制工具称为副本集（replica set），它可提供自动故障转移和数据冗余。</p>
<p>（ 3 ）高扩展性：</p>
<p>MongoDB提供了水平可扩展性作为其核心功能的一部分。</p>
<p>分片将数据分布在一组集群的机器上。（海量数据存储，服务能力水平扩展）</p>
<p>从3.4开始，MongoDB支持基于片键创建数据区域。在一个平衡的集群中，MongoDB将一个区域所覆盖的读写只定向到该区域内的那些片。</p>
<p>（ 4 ）丰富的查询支持：</p>
<p>MongoDB支持丰富的查询语言，支持读和写操作(CRUD)，比如数据聚合、文本搜索和地理空间查询等。</p>
<p>（ 5 ）其他特点：如无模式（动态模式）、灵活的文档模型、</p>
<h2 id="2-单机部署">2 单机部署</h2>
<h3 id="21-windows系统中的安装启动">2.1 Windows系统中的安装启动</h3>
<ul>
<li>
<p>第一步：下载安装包</p>
<p>MongoDB 提供了可用于 32 位和 64 位系统的预编译二进制包，你可以从MongoDB官网下载安装，MongoDB 预编译二进制包下载地址： <a href="https://www.mongodb.com/download-center#community">https://www.mongodb.com/download-center#community</a>
<img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pm9m35x5j30la0e7784.jpg" alt="QQ截图20220428183422.png"></p>
<p>根据上图所示下载zip包。</p>
<p>提示：版本的选择：</p>
<p>MongoDB的版本命名规范如：x.y.z；</p>
<p>y为奇数时表示当前版本为开发版，如：1.5.2、4.1.13；</p>
<p>y为偶数时表示当前版本为稳定版，如：1.6.3、4.0.10；</p>
<p>z是修正版本号，数字越大越好。</p>
<p>详情：http://docs.mongodb.org/manual/release-notes/#release-version-numbers</p>
</li>
<li>
<p>第二步：解压安装启动</p>
<p>将压缩包解压到一个目录中。</p>
<p>在解压目录中，手动建立一个目录用于存放数据文件，如data/db</p>
<p><strong>方式 1 ：命令行参数方式启动服务</strong></p>
<p>在bin目录中打开命令行提示符，输入如下命令：</p>
<pre><code>mongod --dbpath=..\data\db
</code></pre><p>我们在启动信息中可以看到，mongoDB的默认端口是 27017 ，如果我们想改变默认的启动端口，可以通过&ndash;port来指定端口。</p>
<p>为了方便我们每次启动，可以将安装目录的bin目录设置到环境变量的path中，bin目录下是一些常用命令，比如mongod启动服务用的，mongo客户端连接服务用的。</p>
<p><strong>方式 2 ：配置文件方式启动服务</strong></p>
<p>在解压目录中新建config文件夹，该文件夹中新建配置文件mongod.conf，内如参考如下：</p>
<pre><code>storage: 
  #The directory where the mongod instance stores its data.Default Value is &quot;\data\db&quot; on Windows. 
  dbPath: D:\02_Server\DBServer\mongodb-win32-x86_64-2008plus-ssl-4.0.1\data
</code></pre><p>详细配置项内容可以参考官方文档：https://docs.mongodb.com/manual/reference/configuration-options/</p>
<p>【注意】</p>
<p>1 ）配置文件中如果使用双引号，比如路径地址，自动会将双引号的内容转义。如果不转义，则会报错：</p>
<p>解决：</p>
<p>a. 对\换成/或\</p>
<p>b. 如果路径中没有空格，则无需加引号。</p>
<p>2 ）配置文件中不能以Tab分割字段</p>
<p>解决：</p>
<p>将其转换成空格。</p>
<p>启动方式：</p>
<pre><code>mongod -f ../config/mongod.conf 或mongod --config ../config/mongod.conf
</code></pre><p>更多参数配置：</p>
<pre><code>systemLog: 
  destination: file 
  #The path of the log file to which mongod or mongos should send all diagnostic logging information 
  path: &quot;D:/02_Server/DBServer/mongodb-win32-x86_64-2008plus-ssl-4.0.1/log/mongod.log&quot; 
  logAppend: true 
storage: 
  journal: 
      enabled: true 
  #The directory where the mongod instance stores its data.Default Value is &quot;/data/db&quot;. 
  dbPath: &quot;D:/02_Server/DBServer/mongodb-win32-x86_64-2008plus-ssl-4.0.1/data&quot; 
net:
  #bindIp: 127.0.0.1 
  port: 27017 
setParameter: 
  enableLocalhostAuthBypass: false
</code></pre></li>
</ul>
<h3 id="22-shell连接mongo命令">2.2 Shell连接(mongo命令)</h3>
<p>在命令提示符输入以下shell命令即可完成登陆</p>
<pre><code>mongo 或mongo --host=127.0.0.1 --port=27017
</code></pre><p>查看已经有的数据库</p>
<pre><code>&gt;show databases
</code></pre><p>退出mongodb</p>
<pre><code>exit
</code></pre><p>更多参数可以通过帮助查看：</p>
<pre><code>mongo --help
</code></pre><p>提示：</p>
<p>MongoDB javascript shell是一个基于javascript的解释器，故是支持js程序的。</p>
<h3 id="23-compass-图形化界面客户端">2.3 Compass-图形化界面客户端</h3>
<p>到MongoDB官网下载MongoDB Compass，</p>
<p>地址：https://www.mongodb.com/download-center/v2/compass?initial=true</p>
<p>如果是下载安装版，则按照步骤安装；如果是下载加压缩版，直接解压，执行里面的MongoDBCompassCommunity.exe文件即可。</p>
<p>在打开的界面中，输入主机地址、端口等相关信息，点击连接：</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pmllmfqhj30mk0epq56.jpg" alt="QQ截图20220428184555.png"></p>
<h3 id="24-linux系统中的安装启动和连接">2.4 Linux系统中的安装启动和连接</h3>
<p>目标：在Linux中部署一个单机的MongoDB，作为生产环境下使用。</p>
<p>提示：和Windows下操作差不多。</p>
<p>步骤如下：</p>
<p>（ 1 ）先到官网下载压缩包mongod-linux-x 86 _ 64 - 4. 0. 10 .tgz。</p>
<p>（ 2 ）上传压缩包到Linux中，解压到当前目录：</p>
<pre><code>tar -xvf mongodb-linux-x86_64-4.0.10.tgz
</code></pre><p>（ 3 ）移动解压后的文件夹到指定的目录中：</p>
<pre><code>mv mongodb-linux-x86_64-4.0.10 /usr/local/mongodb
</code></pre><p>（ 4 ）新建几个目录，分别用来存储数据和日志：</p>
<pre><code>#数据存储目录 
mkdir -p /mongodb/single/data/db 
#日志存储目录 
mkdir -p /mongodb/single/log
</code></pre><p>（ 5 ）新建并修改配置文件</p>
<pre><code>vi /mongodb/single/mongod.conf
</code></pre><p>配置文件的内容如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#66d9ef">systemLog</span>: 
	<span style="color:#75715e">#MongoDB发送所有日志输出的目标指定为文件 </span>
	<span style="color:#75715e"># #The path of the log file to which mongod or mongos should send all diagnostic logging information </span>
	<span style="color:#66d9ef">destination</span>: file 
	<span style="color:#75715e">#mongod或mongos应向其发送所有诊断日志记录信息的日志文件的路径 </span>
	<span style="color:#66d9ef">path</span>: <span style="color:#e6db74">&#34;/mongodb/single/log/mongod.log&#34;</span> 
	<span style="color:#75715e">#当mongos或mongod实例重新启动时，mongos或mongod会将新条目附加到现有日志文件的末尾。 </span>
	<span style="color:#66d9ef">logAppend</span>: <span style="color:#66d9ef">true</span>
	<span style="color:#66d9ef">storage</span>: 
	<span style="color:#75715e">#mongod实例存储其数据的目录。storage.dbPath设置仅适用于mongod。 </span>
	<span style="color:#75715e">##The directory where the mongod instance stores its data.Default Value is &#34;/data/db&#34;. </span>
	<span style="color:#66d9ef">dbPath</span>: <span style="color:#e6db74">&#34;/mongodb/single/data/db&#34;</span> 
	<span style="color:#66d9ef">journal</span>: 
		<span style="color:#75715e">#启用或禁用持久性日志以确保数据文件保持有效和可恢复。 </span>
		<span style="color:#66d9ef">enabled</span>: <span style="color:#66d9ef">true</span>
<span style="color:#66d9ef">processManagement</span>: 
	<span style="color:#75715e">#启用在后台运行mongos或mongod进程的守护进程模式。 </span>
	<span style="color:#66d9ef">fork</span>: <span style="color:#66d9ef">true</span> 
net:
	<span style="color:#75715e">#服务实例绑定的IP，默认是localhost </span>
	<span style="color:#66d9ef">bindIp</span>: localhost,<span style="color:#ae81ff">192.168</span><span style="color:#ae81ff">.0</span><span style="color:#ae81ff">.2</span>
	<span style="color:#75715e">#bindIp </span>
	<span style="color:#75715e">#绑定的端口，默认是27017 </span>
	<span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">27017</span>
</code></pre></div><p>（6）启动MongoDB服务</p>
<pre><code>[root@bobohost single] /usr/local/mongodb/bin/mongod -f /mongodb/single/mongod.conf 
about to fork child process, waiting until server is ready for connections. 
forked process: 90384 
child process started successfully, parent exiting
</code></pre><p>注意：</p>
<p>如果启动后不是 successfully ，则是启动失败了。原因基本上就是配置文件有问题。</p>
<p>通过进程来查看服务是否启动了：</p>
<pre><code>[root@bobohost single] ps -ef |grep mongod 
root 90384 1 0 8月26 ? 00:02:13 /usr/local/mongdb/bin/mongod -f /mongodb/single/mongod.conf
</code></pre><p>（7）分别使用mongo命令和compass工具来连接测试。</p>
<p>提示：如果远程连接不上，需要配置防火墙放行，或直接关闭linux防火墙</p>
<pre><code>#查看防火墙状态 
systemctl status firewalld 
#临时关闭防火墙 
systemctl stop firewalld 
#开机禁止启动防火墙 
systemctl disable firewalld
</code></pre><p>（8）停止关闭服务</p>
<p>停止服务的方式有两种：快速关闭和标准关闭，下面依次说明：</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pnw2ciz4j30my0jatee.jpg" alt="QQ截图20220428193035.png"></p>
<h2 id="3-基本常用命令">3 基本常用命令</h2>
<h3 id="31-案例需求">3.1 案例需求</h3>
<p>存放文章评论的数据存放到MongoDB中，数据结构参考如下：</p>
<p>数据库：articledb</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pnxjbrylj30mi0bdq6v.jpg" alt="QQ截图20220428193200.png"></p>
<h3 id="32-数据库操作">3.2 数据库操作</h3>
<h4 id="321-选择和创建数据库">3.2.1 选择和创建数据库</h4>
<p>选择和创建数据库的语法格式：</p>
<pre><code>use 数据库名称
</code></pre><p>如果数据库不存在则自动创建，例如，以下语句创建spitdb数据库：</p>
<pre><code>use articledb
</code></pre><p>查看有权限查看的所有的数据库命令</p>
<pre><code>show dbs 
或
show databases
</code></pre><p><strong>注意: 在 MongoDB 中，集合只有在内容插入后才会创建! 就是说，创建集合(数据表)后要再插入一个文档(记录)，集合才会真正创建。</strong></p>
<p>查看当前正在使用的数据库命令</p>
<pre><code>db
</code></pre><p><strong>MongoDB 中默认的数据库为 test，如果你没有选择数据库，集合将存放在 test 数据库中。</strong></p>
<p>另外：</p>
<p>数据库名可以是满足以下条件的任意UTF-8字符串。</p>
<ul>
<li>
<p>不能是空字符串（&quot;&quot;)。</p>
</li>
<li>
<p>不得含有&rsquo; &lsquo;（空格)、.、$、/、\和\0 (空字符)。</p>
</li>
<li>
<p>应全部小写。</p>
</li>
<li>
<p>最多 64 字节。</p>
</li>
</ul>
<p>有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库。</p>
<ul>
<li>
<p>admin： 从权限的角度来看，这是&quot;root&quot;数据库。要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限。一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。</p>
</li>
<li>
<p>local: 这个数据永远不会被复制，可以用来存储限于本地单台服务器的任意集合</p>
</li>
<li>
<p>config: 当Mongo用于分片设置时，config数据库在内部使用，用于保存分片的相关信息。</p>
</li>
</ul>
<h4 id="322-数据库的删除">3.2.2 数据库的删除</h4>
<p>MongoDB 删除数据库的语法格式如下：</p>
<pre><code>db.dropDatabase()
</code></pre><p>提示：主要用来删除已经持久化的数据库</p>
<h3 id="33-集合操作">3.3 集合操作</h3>
<p>集合，类似关系型数据库中的表。</p>
<p>可以显示的创建，也可以隐式的创建。</p>
<h4 id="331-集合的显式创建了解">3.3.1 集合的显式创建（了解）</h4>
<h4 id="qq截图20220428193758pnghttptva1sinaimgcnlarge006qqpifly1h1po3rsx04j30my0f90xujpg"><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1po3rsx04j30my0f90xu.jpg" alt="QQ截图20220428193758.png"></h4>
<h4 id="332-集合的隐式创建">3.3.2 集合的隐式创建</h4>
<p>当向一个集合中插入一个文档的时候，如果集合不存在，则会自动创建集合。</p>
<p>详见文档的插入章节。</p>
<p>提示：通常我们使用隐式创建文档即可。</p>
<h4 id="333-集合的删除">3.3.3 集合的删除</h4>
<p>集合删除语法格式如下：</p>
<pre><code>db.collection.drop() 
或
db.集合.drop()
</code></pre><p><strong>返回值</strong></p>
<p>如果成功删除选定集合，则 drop() 方法返回 true，否则返回 false。</p>
<p>例如：要删除mycollection集合</p>
<pre><code>db.mycollection.drop()
</code></pre><h3 id="34-文档基本crud">3.4 文档基本CRUD</h3>
<p>文档（document）的数据结构和 JSON 基本一样。</p>
<p>所有存储在集合中的数据都是 BSON 格式。</p>
<h4 id="341-文档的插入">3.4.1 文档的插入</h4>
<p>（1）单个文档插入</p>
<p>使用insert() 或 save() 方法向集合中插入文档，语法如下：</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1po8gss2pj30hu0lh10p.jpg" alt="QQ截图20220428194230.png"></p>
<p>（2）批量插入</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1po9kfxt6j30gd04pgm3.jpg" alt="QQ截图20220428194324.png"></p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1po9pp7b6j30hf0m0dry.jpg" alt="QQ截图20220428194334.png"></p>
<h4 id="342文档的基本查询">3.4.2文档的基本查询</h4>
<p>查询数据的语法格式如下：</p>
<pre><code>db.collection.find(&lt;query&gt;, [projection])
</code></pre><p>参数：</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1podv08o7j30h503jta0.jpg" alt="QQ截图20220428194740.png"></p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1podzal0pj30jr0l6gt2.jpg" alt="QQ截图20220428194634.png"></p>
<h4 id="343-文档的更新">3.4.3 文档的更新</h4>
<p>更新文档的语法：</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pog2hp08j30if06adhe.jpg" alt="QQ截图20220428194948.png"></p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pogocfqlj30k40hltex.jpg" alt="QQ截图20220428195023.png"></p>
<h4 id="344-删除文档">3.4.4 删除文档</h4>
<p>删除文档的语法结构：</p>
<pre><code>db.集合名称.remove(条件)
</code></pre><p>以下语句可以将数据全部删除，请慎用</p>
<pre><code>db.comment.remove({})
</code></pre><p>如果删除_id=1的记录，输入以下语句</p>
<pre><code>db.comment.remove({_id:&quot;1&quot;})
</code></pre><h3 id="35-文档的分页查询">3.5 文档的分页查询</h3>
<h4 id="351-统计查询">3.5.1 统计查询</h4>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pojblldvj30ju0ew41q.jpg" alt="QQ截图20220428195241.png"></p>
<h4 id="352-分页列表查询">3.5.2 分页列表查询</h4>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pon2q3v5j30is0bt42f.jpg" alt="QQ截图20220428195633.png"></p>
<h4 id="353-排序查询">3.5.3 排序查询</h4>
<p>sort() 方法对数据进行排序，sort() 方法可以通过参数指定排序的字段，并使用 1 和 -1 来指定排序的方式，其中 1 为升序排列，而 -1 是用于降序排列。</p>
<p>语法如下所示：</p>
<pre><code>db.COLLECTION_NAME.find().sort({KEY:1}) 
或
db.集合名称.find().sort(排序方式)
</code></pre><p>例如：</p>
<p>对userid降序排列，并对访问量进行升序排列</p>
<pre><code>db.comment.find().sort({userid:-1,likenum:1})
</code></pre><p>提示：</p>
<p><strong>skip(), limilt(), sort()三个放在一起执行的时候，执行的顺序是先 sort(), 然后是 skip()，最后是显示的 limit()，和命令编写顺序无关。</strong></p>
<h3 id="36-文档的更多查询">3.6 文档的更多查询</h3>
<h4 id="361-正则的复杂条件查询">3.6.1 正则的复杂条件查询</h4>
<p>MongoDB的模糊查询是通过正则表达式的方式实现的。格式为：</p>
<pre><code>db.collection.find({field:/正则表达式/}) 
或
db.集合.find({字段:/正则表达式/})
</code></pre><p>提示：正则表达式是js的语法，直接量的写法。</p>
<p>例如，我要查询评论内容包含“开水”的所有文档，代码如下：</p>
<pre><code>db.comment.find({content:/开水/})
</code></pre><p>如果要查询评论的内容中以“专家”开头的，代码如下：</p>
<pre><code>db.comment.find({content:/^专家/})
</code></pre><h4 id="362-比较查询">3.6.2 比较查询</h4>
<p>&lt;, &lt;=, &gt;, &gt;= 这个操作符也是很常用的，格式如下:</p>
<pre><code>db.集合名称.find({ &quot;field&quot; : { $gt: value }}) // 大于: field &gt; value 
db.集合名称.find({ &quot;field&quot; : { $lt: value }}) // 小于: field &lt; value 
db.集合名称.find({ &quot;field&quot; : { $gte: value }}) // 大于等于: field &gt;= value 
db.集合名称.find({ &quot;field&quot; : { $lte: value }}) // 小于等于: field &lt;= value 
db.集合名称.find({ &quot;field&quot; : { $ne: value }}) // 不等于: field != value
</code></pre><p>示例：查询评论点赞数量大于 700 的记录</p>
<pre><code>db.comment.find({likenum:{$gt:NumberInt(700)}})
</code></pre><h4 id="363-包含查询">3.6.3 包含查询</h4>
<p>包含使用$in操作符。 示例：查询评论的集合中userid字段包含 1003 或 1004 的文档</p>
<pre><code>db.comment.find({userid:{$in:[&quot;1003&quot;,&quot;1004&quot;]}})
</code></pre><p>不包含使用$nin操作符。 示例：查询评论集合中userid字段不包含 1003 和 1004 的文档</p>
<pre><code>db.comment.find({userid:{$nin:[&quot;1003&quot;,&quot;1004&quot;]}})
</code></pre><h4 id="364-条件连接查询">3.6.4 条件连接查询</h4>
<p>我们如果需要查询同时满足两个以上条件，需要使用$and操作符将条件进行关联。（相 当于SQL的and） 格式为：</p>
<pre><code>$and:[ { },{ },{ } ]
</code></pre><p>示例：查询评论集合中likenum大于等于 700 并且小于 2000 的文档：</p>
<pre><code>db.comment.find({$and:[{likenum:{$gte:NumberInt( 700 )}},{likenum:{$lt:NumberInt( 2000 )}}]})
</code></pre><p>如果两个以上条件之间是或者的关系，我们使用 操作符进行关联，与前面 and的使用方式相同 格式为：</p>
<pre><code>$or:[ { },{ },{ } ]
</code></pre><p>示例：查询评论集合中userid为 1003 ，或者点赞数小于 1000 的文档记录</p>
<pre><code>db.comment.find({$or:[ {userid:&quot; 1003 &quot;} ,{likenum:{$lt: 1000 } }]})
</code></pre><h3 id="37-常用命令小结">3.7 常用命令小结</h3>
<pre><code>选择切换数据库：use articledb 
插入数据：db.comment.insert({bson数据}) 
查询所有数据：db.comment.find(); 
条件查询数据：db.comment.find({条件}) 
查询符合条件的第一条记录：db.comment.findOne({条件}) 
查询符合条件的前几条记录：db.comment.find({条件}).limit(条数) 
查询符合条件的跳过的记录：db.comment.find({条件}).skip(条数) 
修改数据：db.comment.update({条件},{修改后的数据}) 或db.comment.update({条件},{$set:{要修改部分的字段:数据}) 
修改数据并自增某字段值：db.comment.update({条件},{$inc:{自增的字段:步进值}}) 
删除数据：db.comment.remove({条件}) 
统计查询：db.comment.count({条件}) 
模糊查询：db.comment.find({字段名:/正则表达式/}) 
条件比较运算：db.comment.find({字段名:{$gt:值}}) 
包含查询：db.comment.find({字段名:{$in:[值1，值2]}})或db.comment.find({字段名:{$nin:[值1，值2]}}) 
条件连接查询：db.comment.find({$and:[{条件1},{条件2}]})或db.comment.find({$or:[{条件1},{条件2}]})
</code></pre><h2 id="4-索引-index">4 索引-Index</h2>
<h3 id="41-概述">4.1 概述</h3>
<p>索引支持在MongoDB中高效地执行查询。如果没有索引，MongoDB必须执行全集合扫描，即扫描集合中的每个文档，以选择与查询语句匹配的文档。这种扫描全集合的查询效率是非常低的，特别在处理大量的数据时，查询可以要花费几十秒甚至几分钟，这对网站的性能是非常致命的。</p>
<p>如果查询存在适当的索引，MongoDB可以使用该索引限制必须检查的文档数。</p>
<p>索引是特殊的数据结构，它以易于遍历的形式存储集合数据集的一小部分。索引存储特定字段或一组字段的值，按字段值排序。索引项的排序支持有效的相等匹配和基于范围的查询操作。此外，MongoDB还可以使用索引中的排序返回排序结果。</p>
<p>官网文档：https://docs.mongodb.com/manual/indexes/</p>
<p>了解：</p>
<p>MongoDB索引使用B树数据结构（确切的说是B-Tree，MySQL是B+Tree）</p>
<h3 id="42-索引的类型">4.2 索引的类型</h3>
<h4 id="421-单字段索引">4.2.1 单字段索引</h4>
<p>MongoDB支持在文档的单个字段上创建用户定义的升序/降序索引，称为单字段索引（Single Field Index）。</p>
<p>对于单个字段索引和排序操作，索引键的排序顺序（即升序或降序）并不重要，因为MongoDB可以在任何方向上遍历索引。</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1povuc226j30gf05a74t.jpg" alt="QQ截图20220428200457.png"></p>
<h4 id="422-复合索引">4.2.2 复合索引</h4>
<p>MongoDB还支持多个字段的用户定义索引，即复合索引（Compound Index）。</p>
<p>复合索引中列出的字段顺序具有重要意义。例如，如果复合索引由{ userid: 1 , score: - 1 }组成，则索引首先按userid正序排序，然后</p>
<p>在每个userid的值内，再在按score倒序排序。</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1powbhec9j30ht06jdgp.jpg" alt="QQ截图20220428200526.png"></p>
<h4 id="423-其他索引">4.2.3 其他索引</h4>
<p>地理空间索引（Geospatial Index）、文本索引（Text Indexes）、哈希索引（Hashed Indexes）。</p>
<p><strong>地理空间索引（Geospatial Index）</strong></p>
<p>为了支持对地理空间坐标数据的有效查询，MongoDB提供了两种特殊的索引：返回结果时使用平面几何的二维索引和返回结果时使用球面几何的二维球面索引。</p>
<p><strong>文本索引（Text Indexes）</strong></p>
<p>MongoDB提供了一种文本索引类型，支持在集合中搜索字符串内容。这些文本索引不存储特定于语言的停止词（例如“the”、“a”、“or”），而将集合中的词作为词干，只存储根词。</p>
<p><strong>哈希索引（Hashed Indexes）</strong></p>
<p>为了支持基于散列的分片，MongoDB提供了散列索引类型，它对字段值的散列进行索引。这些索引在其范围内的值分布更加随机，但只支持相等匹配，不支持基于范围的查询。</p>
<h3 id="43-索引的管理操作">4.3 索引的管理操作</h3>
<h4 id="431-索引的查看">4.3.1 索引的查看</h4>
<h4 id="heading"></h4>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1poy1q25uj30jj0dt41x.jpg" alt="QQ截图20220428200705.png"></p>
<h4 id="432-索引的创建">4.3.2 索引的创建</h4>
<p>说明：</p>
<p>在集合上创建索引。</p>
<p>语法：</p>
<pre><code>db.collection.createIndex(keys, options)
</code></pre><p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pozmw86yj30k20jvqdv.jpg" alt="QQ截图20220428200832.png"></p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pp0jxiryj30j80f7go4.jpg" alt="QQ截图20220428200853.png"></p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pp0qq8jdj30k40nkgq1.jpg" alt="QQ截图20220428200925.png"></p>
<h4 id="433-索引的移除">4.3.3 索引的移除</h4>
<p>说明：可以移除指定的索引，或移除所有索引</p>
<p><strong>一、指定索引的移除</strong></p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pp261a7zj30iv081tav.jpg" alt="QQ截图20220428201057.png"></p>
<p><strong>二、所有索引的移除</strong></p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pp2b0ar0j30j9076myi.jpg" alt="QQ截图20220428201103.png"></p>
<h3 id="44-索引的使用">4.4 索引的使用</h3>
<h4 id="441-执行计划">4.4.1 执行计划</h4>
<p>分析查询性能（Analyze Query Performance）通常使用执行计划（解释计划、Explain Plan）来查看查询的情况，如查询耗费的时间、是否基于索引查询等。</p>
<p>那么，通常，我们想知道，建立的索引是否有效，效果如何，都需要通过执行计划查看。</p>
<p>语法：</p>
<pre><code>db.collection.find(query,options).explain(options)
</code></pre><p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pp4qwqi9j30jg0f2n0m.jpg" alt="QQ截图20220428201300.png"></p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pp4ynbrpj30jn0ecdi9.jpg" alt="QQ截图20220428201312.png"></p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pp55mt8ij30kc0l8aes.jpg" alt="QQ截图20220428201321.png"></p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pp5b8lnvj30jo0fmmyp.jpg" alt="QQ截图20220428201328.png"></p>
<h4 id="442-涵盖的查询">4.4.2 涵盖的查询</h4>
<p>Covered Queries</p>
<p>当查询条件和查询的投影仅包含索引字段时，MongoDB直接从索引返回结果，而不扫描任何文档或将文档带入内存。 这些覆盖的查询可以非常有效。</p>
<p>更多：https://docs.mongodb.com/manual/core/query-optimization/#read-operations-covered-query</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pp6wlzmoj30k90gdaej.jpg" alt="QQ截图20220428201521.png"></p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pp75s51cj30ka0no0xz.jpg" alt="QQ截图20220428201532.png"></p>
<h2 id="5-文章评论">5 文章评论</h2>
<h3 id="51-需求分析">5.1 需求分析</h3>
<p>某头条的文章评论业务如下：</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pst038ffj30jl0f7gon.jpg" alt="QQ截图20220428222037.png"></p>
<p><strong>需要实现以下功能：</strong></p>
<p>1）基本增删改查API</p>
<p>2）根据文章id查询评论</p>
<p>3）评论点赞</p>
<h3 id="52-表结构分析">5.2 表结构分析</h3>
<p>数据库：articledb</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pstm2f88j30id08yacw.jpg" alt="QQ截图20220428222113.png"></p>
<h3 id="53-技术选型">5.3 技术选型</h3>
<h4 id="531-mongodb-driver了解">5.3.1 mongodb-driver（了解）</h4>
<p>mongodb-driver是mongo官方推出的java连接mongoDB的驱动包，相当于JDBC驱动。我们通过一个入门的案例来了解mongodb-driver的基本使用。</p>
<p>官方驱动说明和下载：http://mongodb.github.io/mongo-java-driver/</p>
<p>官方驱动示例文档：http://mongodb.github.io/mongo-java-driver/3.8/driver/getting-started/quick-start/</p>
<h4 id="532-springdatamongodb">5.3.2 SpringDataMongoDB</h4>
<p>SpringData家族成员之一，用于操作MongoDB的持久层框架，封装了底层的mongodb-driver。</p>
<p>官网主页： <a href="https://projects.spring.io/spring-data-mongodb/">https://projects.spring.io/spring-data-mongodb/</a></p>
<p>我们十次方项目的吐槽微服务就采用SpringDataMongoDB框架。</p>
<h3 id="54-文章微服务模块搭建">5.4 文章微服务模块搭建</h3>
<p>（1）搭建项目工程article，pom.xml引入依赖：</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pt2zcvavj30ii0f8dkv.jpg" alt="QQ截图20220428222953.png"></p>
<p>（2）创建application.yml</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pt36jlelj30hl05c0tn.jpg" alt="QQ截图20220428223013.png"></p>
<p>（3）创建启动类</p>
<p>cn.itcast.article.ArticleApplication</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pt3oat2yj30gu04wmyr.jpg" alt="QQ截图20220428223051.png"></p>
<p>（4）启动项目，看是否能正常启动，控制台没有错误。</p>
<h3 id="55-文章评论实体类的编写">5.5 文章评论实体类的编写</h3>
<p>创建实体类 创建包cn.itcast.article，包下建包po用于存放实体类，创建实体类</p>
<p>cn.itcast.article.po.Comment</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pt5hh8hbj30hc0jhn4o.jpg" alt="QQ截图20220428223237.png"></p>
<p>说明：</p>
<p><strong>索引可以大大提升查询效率，一般在查询字段上添加索引，索引的添加可以通过Mongo的命令来添加，也可以在Java的实体类中通过注解添加。</strong></p>
<p>1）单字段索引注解@Indexed</p>
<p>org.springframework.data.mongodb.core.index.Indexed.class</p>
<p>声明该字段需要索引，建索引可以大大的提高查询效率。</p>
<p>Mongo命令参考：</p>
<p>2）复合索引注解@CompoundIndex</p>
<p>org.springframework.data.mongodb.core.index.CompoundIndex.class</p>
<p>复合索引的声明，建复合索引可以有效地提高多字段的查询效率。</p>
<p>Mongo命令参考：</p>
<pre><code>db.comment.createIndex({&quot;userid&quot;:1,&quot;nickname&quot;:-1})
</code></pre><h3 id="56-文章评论的基本增删改查">5.6 文章评论的基本增删改查</h3>
<p>（1）创建数据访问接口 cn.itcast.article包下创建dao包，包下创建接口</p>
<p>cn.itcast.article.dao.CommentRepository</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pt7z3zugj30eh04fgn4.jpg" alt="QQ截图20220428223434.png"></p>
<p>（2）创建业务逻辑类 cn.itcast.article包下创建service包，包下创建类</p>
<p>cn.itcast.article.service.CommentService</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pt8y5sf1j30hj0hsgpp.jpg" alt="QQ截图20220428223445.png"></p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1pt96aowgj30gw0ctwgo.jpg" alt="QQ截图20220428223456.png"></p>
<p>（3）新建Junit测试类，测试保存和查询所有：</p>
<p>cn.itcast.article.service.CommentServiceTest</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1ptabd9laj30hm0kvtex.jpg" alt="QQ截图20220428223707.png"></p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1ptahdjubj30hj0ewgog.jpg" alt="QQ截图20220428223716.png"></p>
<h3 id="57-根据上级id查询文章评论的分页列表">5.7 根据上级ID查询文章评论的分页列表</h3>
<p>（1）CommentRepository新增方法定义</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">//根据父id，查询子评论的分页列表 
</span><span style="color:#75715e"></span>Page<span style="color:#f92672">&lt;</span>Comment<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">findByParentid</span><span style="color:#f92672">(</span>String parentid<span style="color:#f92672">,</span> Pageable pageable<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><p>（2）CommentService新增方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/*** 根据父id查询分页列表 
</span><span style="color:#75715e">    * @param parentid 
</span><span style="color:#75715e">    * @param page 
</span><span style="color:#75715e">    * @param size 
</span><span style="color:#75715e">    * @return */</span> 
	<span style="color:#66d9ef">public</span> Page<span style="color:#f92672">&lt;</span>Comment<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">findCommentListPageByParentid</span><span style="color:#f92672">(</span>String parentid<span style="color:#f92672">,</span><span style="color:#66d9ef">int</span> page <span style="color:#f92672">,</span><span style="color:#66d9ef">int</span> size<span style="color:#f92672">)</span><span style="color:#f92672">{</span> 	
        <span style="color:#66d9ef">return</span> commentRepository<span style="color:#f92672">.</span><span style="color:#a6e22e">findByParentid</span><span style="color:#f92672">(</span>parentid<span style="color:#f92672">,</span> PageRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span>page<span style="color:#f92672">-</span>1<span style="color:#f92672">,</span>size<span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span> 
	<span style="color:#f92672">}</span>
</code></pre></div><p>（3）junit测试用例：</p>
<p>cn.itcast.article.service.CommentServiceTest</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/** 
</span><span style="color:#75715e">    * 测试根据父id查询子评论的分页列表 
</span><span style="color:#75715e">    */</span> 
	<span style="color:#a6e22e">@Test</span> 
	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testFindCommentListPageByParentid</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">{</span> 
        Page<span style="color:#f92672">&lt;</span>Comment<span style="color:#f92672">&gt;</span> pageResponse <span style="color:#f92672">=</span> commentService<span style="color:#f92672">.</span><span style="color:#a6e22e">findCommentListPageByParentid</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;3&#34;</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">,</span> 2<span style="color:#f92672">)</span><span style="color:#f92672">;</span> 
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;----总记录数：&#34;</span><span style="color:#f92672">+</span>pageResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">getTotalElements</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span> 			           System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;----当前页数据：&#34;</span><span style="color:#f92672">+</span>pageResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">getContent</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span> 
    <span style="color:#f92672">}</span>
</code></pre></div><p>（4）测试</p>
<p>使用compass快速插入一条测试数据，数据的内容是对 3 号评论内容进行评论。</p>
<p>执行测试，结果：</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1ptdwax23j30hq0abadn.jpg" alt="QQ截图20220428224043.png"></p>
<h3 id="58-mongotemplate实现评论点赞">5.8 MongoTemplate实现评论点赞</h3>
<p>我们看一下以下点赞的临时示例代码： CommentService 新增updateThumbup方法</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1ptf4sothj30gv03zdgz.jpg" alt="QQ截图20220428224128.png"></p>
<p>以上方法虽然实现起来比较简单，但是执行效率并不高，因为我只需要将点赞数加 1 就可以了，没必要查询出所有字段修改后再更新所有字段。(蝴蝶效应)</p>
<p>我们可以使用MongoTemplate类来实现对某列的操作。</p>
<p>（1）修改CommentService</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1ptfduguyj30gd0dmgof.jpg" alt="QQ截图20220428224154.png"></p>
<p>（2）测试用例：</p>
<p>cn.itcast.article.service.CommentServiceTest</p>
<p><img src="http://tva1.sinaimg.cn/large/006QQPIfly1h1ptg0dk8uj30hf0b8abu.jpg" alt="QQ截图20220428224243.png"></p>


                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/985mongodb%E7%9A%84%E4%BD%BF%E7%94%A8%E7%AE%80%E5%8C%96%E7%89%88/" data-toggle="tooltip" data-placement="top" title="1、MongoDB的使用简化版（MongoDB）">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/1018activemq%E5%AE%89%E8%A3%85%E5%92%8C%E6%8E%A7%E5%88%B6%E5%8F%B0/" data-toggle="tooltip" data-placement="top" title="2、ActiveMQ安装和控制台（ActiveMQ）">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">标签</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/activemq" title="activemq">
                            activemq
                        </a>
                        
                        
                        
                        <a href="/tags/ajax" title="ajax">
                            ajax
                        </a>
                        
                        
                        
                        <a href="/tags/cookie" title="cookie">
                            cookie
                        </a>
                        
                        
                        
                        <a href="/tags/datax" title="datax">
                            datax
                        </a>
                        
                        
                        
                        <a href="/tags/docker" title="docker">
                            docker
                        </a>
                        
                        
                        
                        <a href="/tags/filter" title="filter">
                            filter
                        </a>
                        
                        
                        
                        <a href="/tags/hadoop" title="hadoop">
                            hadoop
                        </a>
                        
                        
                        
                        <a href="/tags/hbase" title="hbase">
                            hbase
                        </a>
                        
                        
                        
                        <a href="/tags/hive" title="hive">
                            hive
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/java" title="java">
                            java
                        </a>
                        
                        
                        
                        <a href="/tags/javascript" title="javascript">
                            javascript
                        </a>
                        
                        
                        
                        <a href="/tags/javaweb" title="javaweb">
                            javaweb
                        </a>
                        
                        
                        
                        <a href="/tags/jdbc" title="jdbc">
                            jdbc
                        </a>
                        
                        
                        
                        <a href="/tags/jquery" title="jquery">
                            jquery
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/jsp" title="jsp">
                            jsp
                        </a>
                        
                        
                        
                        <a href="/tags/juc" title="juc">
                            juc
                        </a>
                        
                        
                        
                        <a href="/tags/jwt" title="jwt">
                            jwt
                        </a>
                        
                        
                        
                        <a href="/tags/kafka" title="kafka">
                            kafka
                        </a>
                        
                        
                        
                        <a href="/tags/linux" title="linux">
                            linux
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/maven" title="maven">
                            maven
                        </a>
                        
                        
                        
                        <a href="/tags/minio" title="minio">
                            minio
                        </a>
                        
                        
                        
                        <a href="/tags/mongodb" title="mongodb">
                            mongodb
                        </a>
                        
                        
                        
                        <a href="/tags/mybatis" title="mybatis">
                            mybatis
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/mysql" title="mysql">
                            mysql
                        </a>
                        
                        
                        
                        <a href="/tags/nginx" title="nginx">
                            nginx
                        </a>
                        
                        
                        
                        <a href="/tags/react" title="react">
                            react
                        </a>
                        
                        
                        
                        <a href="/tags/redis" title="redis">
                            redis
                        </a>
                        
                        
                        
                        <a href="/tags/scala" title="scala">
                            scala
                        </a>
                        
                        
                        
                        <a href="/tags/servlet" title="servlet">
                            servlet
                        </a>
                        
                        
                        
                        <a href="/tags/session" title="session">
                            session
                        </a>
                        
                        
                        
                        <a href="/tags/shiro" title="shiro">
                            shiro
                        </a>
                        
                        
                        
                        <a href="/tags/spark" title="spark">
                            spark
                        </a>
                        
                        
                        
                        <a href="/tags/spring" title="spring">
                            spring
                        </a>
                        
                        
                        
                        <a href="/tags/springboot" title="springboot">
                            springboot
                        </a>
                        
                        
                        
                        <a href="/tags/springcloud" title="springcloud">
                            springcloud
                        </a>
                        
                        
                        
                        <a href="/tags/springmvc" title="springmvc">
                            springmvc
                        </a>
                        
                        
                        
                        <a href="/tags/springsecurity" title="springsecurity">
                            springsecurity
                        </a>
                        
                        
                        
                        <a href="/tags/tomcat" title="tomcat">
                            tomcat
                        </a>
                        
                        
                        
                        <a href="/tags/vue" title="vue">
                            vue
                        </a>
                        
                        
                        
                        <a href="/tags/xml" title="xml">
                            xml
                        </a>
                        
                        
                        
                        <a href="/tags/zookeeper" title="zookeeper">
                            zookeeper
                        </a>
                        
                        
                        
                        <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95" title="数据结构与算法">
                            数据结构与算法
                        </a>
                        
                        
                        
                        <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" title="设计模式">
                            设计模式
                        </a>
                        
                        
                        
                        <a href="/tags/%E9%A1%B9%E7%9B%AE" title="项目">
                            项目
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
                <section>
                    <hr>
                    <h5>朋友</h5>
                    <ul class="list-inline">
                        
                        <li><a target="_blank" href=""></a></li>
                        
                    </ul>
                </section>
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                 
                   
                    
                    <li>
                        <a href="mailto:1424197205@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    

                    

		    
                    
                    <li>
                        <a target="_blank" href="#">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-wechat fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    <li>
                        <a target="_blank" href="https://github.com/yiguan1573">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    
                    
                    
                    
                    
            
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; 亿观的博客 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






</body>
</html>
