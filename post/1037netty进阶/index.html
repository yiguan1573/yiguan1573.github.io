<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="referrer" content="never">

    
    <meta property="og:site_name" content="亿观的博客">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://yiguan1573.gitee.io//img/01.jpg">
    <meta property="twitter:image" content="https://yiguan1573.gitee.io//img/01.jpg" />
    

    
    <meta name="title" content="3、Netty进阶（Netty）" />
    <meta property="og:title" content="3、Netty进阶（Netty）" />
    <meta property="twitter:title" content="3、Netty进阶（Netty）" />
    

    
    <meta name="description" content="">
    <meta property="og:description" content="" />
    <meta property="twitter:description" content="" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>3、Netty进阶（Netty） | yiguan1573</title>

    <link rel="canonical" href="/post/1037netty%E8%BF%9B%E9%98%B6/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>




<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">亿观的博客</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">首页</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/%E5%AD%A6%E4%B9%A0">学习</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/archive/">档案</a></li>
                    
                        <li><a href="/top/about/">关于</a></li>
                    

                    
		    <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		    </li>
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/03.JPG')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/netty" title="Netty">
                            Netty
                        </a>
                        
                    </div>
                    <h1>3、Netty进阶（Netty）</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                亿观
                             
                            on 
                            Tuesday, May 17, 2022
                            
                                <span id="/post/1037netty%E8%BF%9B%E9%98%B6/" class="leancloud_visitors meta_data_item" data-flag-title="">
    <span class="post-meta-item-icon">
      <span class="octicon octicon-eye"></span> 
    </span>
    <i class="fa fa-eye"></i>
    <span class="old-visitors-count" style="display: none;"></span>
    <span class="leancloud-visitors-count"></span>
</span>



<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>

<script>
	AV.initialize("", "");
</script>

<script type="text/javascript">
function showTime(Counter) {
    var query = new AV.Query(Counter);
    var entries = [];
    var $visitors = $(".leancloud_visitors");

    $visitors.each(function() {
        entries.push($(this).attr("id").trim());
    });

    query.containedIn('url', entries);
    query.find()
        .done(function(results) {
            var COUNT_CONTAINER_REF = '.leancloud-visitors-count';
            var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';

            
            
            
            

            for (var i = 0; i < results.length; i++) {
                var item = results[i];
                var url = item.get('url');
                var time = item.get('time');
                var element = document.getElementById(url);

                $(element).find(COUNT_CONTAINER_REF).text(time);
            }
            for (var i = 0; i < entries.length; i++) {
                var url = entries[i];
                var element = document.getElementById(url);
                var countSpan = $(element).find(COUNT_CONTAINER_REF);
                if (countSpan.text() == '') {
                    var oldCountSpan = $(element).find(OLD_COUNT_CONTAINER_REF).text();
                    if(oldCountSpan!=''){
                        countSpan.text(0+parseInt(oldCountSpan));
                    }else{
                        countSpan.text(0);          
                    }
                }
            }
        })
        .fail(function(object, error) {
            console.log("Error: " + error.code + " " + error.message);
        });
}

function addCount(Counter) {
    var $visitors = $(".leancloud_visitors");
    var url = $visitors.attr('id').trim();
    var title = $visitors.attr('data-flag-title').trim();
    var query = new AV.Query(Counter);

    query.equalTo("url", url);
    query.find({
        success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment("time");
                counter.save(null, {
                    success: function(counter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(counter.get('time'));
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
                var newcounter = new Counter();
                 
                var acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                newcounter.setACL(acl);
                 
                newcounter.set("title", title);
                newcounter.set("url", url);
                var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';
                var $element = $(document.getElementById(url));
                var oldCountSpan = $element.find(OLD_COUNT_CONTAINER_REF).text();
                if(oldCountSpan!=''){
                    newcounter.set("time", parseInt(oldCountSpan)+1);
                }else{
 	                    newcounter.set("time",  1);
                }
                newcounter.save(null, {
                    success: function(newcounter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                    },
                    error: function(newcounter, error) {
                        console.log('Failed to create');
                    }
                });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + " " + error.message);
        }
    });
}
$(function() {
    var Counter = AV.Object.extend("Counter");
    
    
    if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
    } else {
        showTime(Counter);
    }
});
</script>

                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h2 id="1-粘包与半包">1. 粘包与半包</h2>
<h3 id="11-粘包现象">1.1 粘包现象</h3>
<p>服务端代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">HelloWorldServer</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> Logger log <span style="color:#ff79c6">=</span> LoggerFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getLogger</span><span style="color:#ff79c6">(</span>HelloWorldServer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">start</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        NioEventLoopGroup boss <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        NioEventLoopGroup worker <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            ServerBootstrap serverBootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ServerBootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioServerSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>boss<span style="color:#ff79c6">,</span> worker<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">childHandler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                        @Override
                        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelActive</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;connected {}&#34;</span><span style="color:#ff79c6">,</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">channelActive</span><span style="color:#ff79c6">(</span>ctx<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                        <span style="color:#ff79c6">}</span>

                        @Override
                        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelInactive</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;disconnect {}&#34;</span><span style="color:#ff79c6">,</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">channelInactive</span><span style="color:#ff79c6">(</span>ctx<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                        <span style="color:#ff79c6">}</span>
                    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ChannelFuture channelFuture <span style="color:#ff79c6">=</span> serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{} binding...&#34;</span><span style="color:#ff79c6">,</span> channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{} bound...&#34;</span><span style="color:#ff79c6">,</span> channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;server error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            boss<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            worker<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;stoped&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">new</span> HelloWorldServer<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">start</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>客户端代码希望发送 10 个消息，每个消息是 16 字节</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">HelloWorldClient</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> Logger log <span style="color:#ff79c6">=</span> LoggerFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getLogger</span><span style="color:#ff79c6">(</span>HelloWorldClient<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        NioEventLoopGroup worker <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            Bootstrap bootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>worker<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;connetted...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                        @Override
                        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelActive</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;sending...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            Random r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Random<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#8be9fd">char</span> c <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;a&#39;</span><span style="color:#ff79c6">;</span>
                            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> 10<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                                ByteBuf buffer <span style="color:#ff79c6">=</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alloc</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>0<span style="color:#ff79c6">,</span> 1<span style="color:#ff79c6">,</span> 2<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">,</span> 4<span style="color:#ff79c6">,</span> 5<span style="color:#ff79c6">,</span> 6<span style="color:#ff79c6">,</span> 7<span style="color:#ff79c6">,</span> 8<span style="color:#ff79c6">,</span> 9<span style="color:#ff79c6">,</span> 10<span style="color:#ff79c6">,</span> 11<span style="color:#ff79c6">,</span> 12<span style="color:#ff79c6">,</span> 13<span style="color:#ff79c6">,</span> 14<span style="color:#ff79c6">,</span> 15<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#ff79c6">}</span>
                        <span style="color:#ff79c6">}</span>
                    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ChannelFuture channelFuture <span style="color:#ff79c6">=</span> bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;client error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            worker<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>服务器端的某次输出，可以看到一次就接收了 160 个字节，而非分 10 次接收</p>
<pre><code>08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5] binding...
08:24:46 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x81e0fda5, L:/0:0:0:0:0:0:0:0:8080] bound...
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] REGISTERED
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] ACTIVE
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177]
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] READ: 160B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000010| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000020| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000030| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000040| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000050| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000060| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000070| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000080| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000090| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
+--------+-------------------------------------------------+----------------+
08:24:55 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x94132411, L:/127.0.0.1:8080 - R:/127.0.0.1:58177] READ COMPLETE
</code></pre><h3 id="12-半包现象">1.2 半包现象</h3>
<p>客户端代码希望发送 1 个消息，这个消息是 160 字节，代码改为</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ByteBuf buffer <span style="color:#ff79c6">=</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alloc</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> 10<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>0<span style="color:#ff79c6">,</span> 1<span style="color:#ff79c6">,</span> 2<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">,</span> 4<span style="color:#ff79c6">,</span> 5<span style="color:#ff79c6">,</span> 6<span style="color:#ff79c6">,</span> 7<span style="color:#ff79c6">,</span> 8<span style="color:#ff79c6">,</span> 9<span style="color:#ff79c6">,</span> 10<span style="color:#ff79c6">,</span> 11<span style="color:#ff79c6">,</span> 12<span style="color:#ff79c6">,</span> 13<span style="color:#ff79c6">,</span> 14<span style="color:#ff79c6">,</span> 15<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>为现象明显，服务端修改一下接收缓冲区，其它代码不变</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">option</span><span style="color:#ff79c6">(</span>ChannelOption<span style="color:#ff79c6">.</span><span style="color:#50fa7b">SO_RCVBUF</span><span style="color:#ff79c6">,</span> 10<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>服务器端的某次输出，可以看到接收的消息被分为两节，第一次 20 字节，第二次 140 字节</p>
<pre><code>08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84] binding...
08:43:49 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0x4d6c6a84, L:/0:0:0:0:0:0:0:0:8080] bound...
08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] REGISTERED
08:44:23 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] ACTIVE
08:44:23 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221]
08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ: 20B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f |................|
|00000010| 00 01 02 03                                     |....            |
+--------+-------------------------------------------------+----------------+
08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ COMPLETE
08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ: 140B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000010| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000020| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000030| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000040| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000050| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000060| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000070| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f 00 01 02 03 |................|
|00000080| 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f             |............    |
+--------+-------------------------------------------------+----------------+
08:44:24 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x1719abf7, L:/127.0.0.1:8080 - R:/127.0.0.1:59221] READ COMPLETE
</code></pre><blockquote>
<p><strong>注意</strong></p>
<p>serverBootstrap.option(ChannelOption.SO_RCVBUF, 10) 影响的底层接收缓冲区（即滑动窗口）大小，仅决定了 netty 读取的最小单位，netty 实际每次读取的一般是它的整数倍</p>
</blockquote>
<h3 id="13-现象分析">1.3 现象分析</h3>
<p>粘包</p>
<ul>
<li>现象，发送 abc def，接收 abcdef</li>
<li>原因
<ul>
<li>应用层：接收方 ByteBuf 设置太大（Netty 默认 1024）</li>
<li>滑动窗口：假设发送方 256 bytes 表示一个完整报文，但由于接收方处理不及时且窗口大小足够大，这 256 bytes 字节就会缓冲在接收方的滑动窗口中，当滑动窗口中缓冲了多个报文就会粘包</li>
<li>Nagle 算法：会造成粘包</li>
</ul>
</li>
</ul>
<p>半包</p>
<ul>
<li>现象，发送 abcdef，接收 abc def</li>
<li>原因
<ul>
<li>应用层：接收方 ByteBuf 小于实际发送数据量</li>
<li>滑动窗口：假设接收方的窗口只剩了 128 bytes，发送方的报文大小是 256 bytes，这时放不下了，只能先发送前 128 bytes，等待 ack 后才能发送剩余部分，这就造成了半包</li>
<li>MSS 限制：当发送的数据超过 MSS 限制后，会将数据切分发送，就会造成半包</li>
</ul>
</li>
</ul>
<p>本质是因为 TCP 是流式协议，消息无边界</p>
<blockquote>
<p>滑动窗口</p>
<ul>
<li>
<p>TCP 以一个段（segment）为单位，每发送一个段就需要进行一次确认应答（ack）处理，但如果这么做，缺点是包的往返时间越长性能就越差</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h385yzoijwj309b0cn407.jpg" alt="0049.png">

</p>
</li>
<li>
<p>为了解决此问题，引入了窗口概念，窗口大小即决定了无需等待应答而可以继续发送的数据最大值</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h385z9ai1xj30ag0dm0ul.jpg" alt="0051.png">

</p>
</li>
<li>
<p>窗口实际就起到一个缓冲区的作用，同时也能起到流量控制的作用</p>
<ul>
<li>图中深色的部分即要发送的数据，高亮的部分即窗口</li>
<li>窗口内的数据才允许被发送，当应答未到达前，窗口必须停止滑动</li>
<li>如果 1001~2000 这个段的数据 ack 回来了，窗口就可以向前滑动</li>
<li>接收方也会维护一个窗口，只有落在窗口内的数据才能允许接收</li>
</ul>
</li>
</ul>
</blockquote>
<blockquote>
<p>MSS 限制</p>
<ul>
<li>
<p>链路层对一次能够发送的最大数据有限制，这个限制称之为 MTU（maximum transmission unit），不同的链路设备的 MTU 值也有所不同，例如</p>
</li>
<li>
<p>以太网的 MTU 是 1500</p>
</li>
<li>
<p>FDDI（光纤分布式数据接口）的 MTU 是 4352</p>
</li>
<li>
<p>本地回环地址的 MTU 是 65535 - 本地测试不走网卡</p>
</li>
<li>
<p>MSS 是最大段长度（maximum segment size），它是 MTU 刨去 tcp 头和 ip 头后剩余能够作为数据传输的字节数</p>
</li>
<li>
<p>ipv4 tcp 头占用 20 bytes，ip 头占用 20 bytes，因此以太网 MSS 的值为 1500 - 40 = 1460</p>
</li>
<li>
<p>TCP 在传递大量数据时，会按照 MSS 大小将数据进行分割发送</p>
</li>
<li>
<p>MSS 的值在三次握手时通知对方自己 MSS 的值，然后在两者之间选择一个小值作为 MSS</p>
</li>
</ul>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h38601k25zj30ll0miq7r.jpg" alt="0031.jpg">

</p>
</blockquote>
<blockquote>
<p>Nagle 算法</p>
<ul>
<li>即使发送一个字节，也需要加入 tcp 头和 ip 头，也就是总字节数会使用 41 bytes，非常不经济。因此为了提高网络利用率，tcp 希望尽可能发送足够大的数据，这就是 Nagle 算法产生的缘由</li>
<li>该算法是指发送端即使还有应该发送的数据，但如果这部分数据很少的话，则进行延迟发送
<ul>
<li>如果 SO_SNDBUF 的数据达到 MSS，则需要发送</li>
<li>如果 SO_SNDBUF 中含有 FIN（表示需要连接关闭）这时将剩余数据发送，再关闭</li>
<li>如果 TCP_NODELAY = true，则需要发送</li>
<li>已发送的数据都收到 ack 时，则需要发送</li>
<li>上述条件不满足，但发生超时（一般为 200ms）则需要发送</li>
<li>除上述情况，延迟发送</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="14-解决方案">1.4 解决方案</h3>
<ol>
<li>短链接，发一个包建立一次连接，这样连接建立到连接断开之间就是消息的边界，缺点效率太低</li>
<li>每一条消息采用固定长度，缺点浪费空间</li>
<li>每一条消息采用分隔符，例如 \n，缺点需要转义</li>
<li>每一条消息分为 head 和 body，head 中包含 body 的长度</li>
</ol>
<h4 id="方法1短链接">方法1，短链接</h4>
<p>以解决粘包为例</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">HelloWorldClient</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> Logger log <span style="color:#ff79c6">=</span> LoggerFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getLogger</span><span style="color:#ff79c6">(</span>HelloWorldClient<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 分 10 次发送
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> 10<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            send<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">send</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        NioEventLoopGroup worker <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            Bootstrap bootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>worker<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;conneted...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                        @Override
                        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelActive</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;sending...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            ByteBuf buffer <span style="color:#ff79c6">=</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alloc</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>0<span style="color:#ff79c6">,</span> 1<span style="color:#ff79c6">,</span> 2<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">,</span> 4<span style="color:#ff79c6">,</span> 5<span style="color:#ff79c6">,</span> 6<span style="color:#ff79c6">,</span> 7<span style="color:#ff79c6">,</span> 8<span style="color:#ff79c6">,</span> 9<span style="color:#ff79c6">,</span> 10<span style="color:#ff79c6">,</span> 11<span style="color:#ff79c6">,</span> 12<span style="color:#ff79c6">,</span> 13<span style="color:#ff79c6">,</span> 14<span style="color:#ff79c6">,</span> 15<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#6272a4">// 发完即关
</span><span style="color:#6272a4"></span>                            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                        <span style="color:#ff79c6">}</span>
                    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ChannelFuture channelFuture <span style="color:#ff79c6">=</span> bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;localhost&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;client error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            worker<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>输出，略</p>
<blockquote>
<p>半包用这种办法还是不好解决，因为接收方的缓冲区大小是有限的</p>
</blockquote>
<h4 id="方法2固定长度">方法2，固定长度</h4>
<p>让所有数据包长度固定（假设长度为 8 字节），服务器端加入</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> FixedLengthFrameDecoder<span style="color:#ff79c6">(</span>8<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>客户端测试代码，注意, 采用这种方法后，客户端什么时候 flush 都可以</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">HelloWorldClient</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> Logger log <span style="color:#ff79c6">=</span> LoggerFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getLogger</span><span style="color:#ff79c6">(</span>HelloWorldClient<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        NioEventLoopGroup worker <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            Bootstrap bootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>worker<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;connetted...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                        @Override
                        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelActive</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;sending...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#6272a4">// 发送内容随机的数据包
</span><span style="color:#6272a4"></span>                            Random r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Random<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#8be9fd">char</span> c <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;a&#39;</span><span style="color:#ff79c6">;</span>
                            ByteBuf buffer <span style="color:#ff79c6">=</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alloc</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> 10<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                                <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> bytes <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>8<span style="color:#ff79c6">]</span><span style="color:#ff79c6">;</span>
                                <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> j <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> j <span style="color:#ff79c6">&lt;</span> r<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nextInt</span><span style="color:#ff79c6">(</span>8<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> j<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                                    bytes<span style="color:#ff79c6">[</span>j<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> c<span style="color:#ff79c6">;</span>
                                <span style="color:#ff79c6">}</span>
                                c<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">;</span>
                                buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#ff79c6">}</span>
                            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                        <span style="color:#ff79c6">}</span>
                    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ChannelFuture channelFuture <span style="color:#ff79c6">=</span> bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;192.168.0.103&#34;</span><span style="color:#ff79c6">,</span> 9090<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;client error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            worker<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>客户端输出</p>
<pre><code>12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] REGISTERED
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2] CONNECT: /192.168.0.103:9090
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] ACTIVE
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] WRITE: 80B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 61 61 61 00 00 00 00 62 00 00 00 00 00 00 00 |aaaa....b.......|
|00000010| 63 63 00 00 00 00 00 00 64 00 00 00 00 00 00 00 |cc......d.......|
|00000020| 00 00 00 00 00 00 00 00 66 66 66 66 00 00 00 00 |........ffff....|
|00000030| 67 67 67 00 00 00 00 00 68 00 00 00 00 00 00 00 |ggg.....h.......|
|00000040| 69 69 69 69 69 00 00 00 6a 6a 6a 6a 00 00 00 00 |iiiii...jjjj....|
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x3c2ef3c2, L:/192.168.0.103:53155 - R:/192.168.0.103:9090] FLUSH
</code></pre><p>服务端输出</p>
<pre><code>12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f] binding...
12:06:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xe3d9713f, L:/192.168.0.103:9090] bound...
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] REGISTERED
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] ACTIVE
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155]
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 61 61 61 00 00 00 00                         |aaaa....        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 62 00 00 00 00 00 00 00                         |b.......        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 63 00 00 00 00 00 00                         |cc......        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 64 00 00 00 00 00 00 00                         |d.......        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 00 00 00 00 00                         |........        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 66 66 66 00 00 00 00                         |ffff....        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 67 67 67 00 00 00 00 00                         |ggg.....        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 00 00 00 00 00 00 00                         |h.......        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 69 69 69 69 69 00 00 00                         |iiiii...        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6a 6a 6a 6a 00 00 00 00                         |jjjj....        |
+--------+-------------------------------------------------+----------------+
12:07:00 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0xd739f137, L:/192.168.0.103:9090 - R:/192.168.0.103:53155] READ COMPLETE
</code></pre><p>缺点是，数据包的大小不好把握</p>
<ul>
<li>长度定的太大，浪费</li>
<li>长度定的太小，对某些数据包又显得不够</li>
</ul>
<h4 id="方法3固定分隔符">方法3，固定分隔符</h4>
<p>服务端加入，默认以 \n 或 \r\n 作为分隔符，如果超出指定长度仍未出现分隔符，则抛出异常</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> LineBasedFrameDecoder<span style="color:#ff79c6">(</span>1024<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>客户端在每条消息之后，加入 \n 分隔符</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">HelloWorldClient</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> Logger log <span style="color:#ff79c6">=</span> LoggerFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getLogger</span><span style="color:#ff79c6">(</span>HelloWorldClient<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        NioEventLoopGroup worker <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            Bootstrap bootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>worker<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;connetted...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                        @Override
                        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelActive</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;sending...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            Random r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Random<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#8be9fd">char</span> c <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;a&#39;</span><span style="color:#ff79c6">;</span>
                            ByteBuf buffer <span style="color:#ff79c6">=</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alloc</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> 10<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                                <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> j <span style="color:#ff79c6">=</span> 1<span style="color:#ff79c6">;</span> j <span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">=</span> r<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nextInt</span><span style="color:#ff79c6">(</span>16<span style="color:#ff79c6">)</span><span style="color:#ff79c6">+</span>1<span style="color:#ff79c6">;</span> j<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                                    buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> c<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                <span style="color:#ff79c6">}</span>
                                buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>10<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                c<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">;</span>
                            <span style="color:#ff79c6">}</span>
                            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                        <span style="color:#ff79c6">}</span>
                    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ChannelFuture channelFuture <span style="color:#ff79c6">=</span> bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;192.168.0.103&#34;</span><span style="color:#ff79c6">,</span> 9090<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;client error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            worker<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>客户端输出</p>
<pre><code>14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] REGISTERED
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755] CONNECT: /192.168.0.103:9090
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] ACTIVE
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] WRITE: 60B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 0a 62 62 62 0a 63 63 63 0a 64 64 0a 65 65 65 |a.bbb.ccc.dd.eee|
|00000010| 65 65 65 65 65 65 65 0a 66 66 0a 67 67 67 67 67 |eeeeeee.ff.ggggg|
|00000020| 67 67 0a 68 68 68 68 0a 69 69 69 69 69 69 69 0a |gg.hhhh.iiiiiii.|
|00000030| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 0a             |jjjjjjjjjjj.    |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0x1282d755, L:/192.168.0.103:63641 - R:/192.168.0.103:9090] FLUSH
</code></pre><p>服务端输出</p>
<pre><code>14:08:18 [DEBUG] [nioEventLoopGroup-3-5] c.i.n.HelloWorldServer - connected [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641]
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 1B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61                                              |a               |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 3B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 62 62 62                                        |bbb             |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 3B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 63 63                                        |ccc             |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 2B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 64 64                                           |dd              |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 10B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 65 65 65 65 65 65 65 65 65 65                   |eeeeeeeeee      |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 2B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 66                                           |ff              |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 7B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 67 67 67 67 67 67 67                            |ggggggg         |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 4B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 68 68 68                                     |hhhh            |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 7B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 69 69 69 69 69 69 69                            |iiiiiii         |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ: 11B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a 6a                |jjjjjjjjjjj     |
+--------+-------------------------------------------------+----------------+
14:08:18 [DEBUG] [nioEventLoopGroup-3-5] i.n.h.l.LoggingHandler - [id: 0xa4b3be43, L:/192.168.0.103:9090 - R:/192.168.0.103:63641] READ COMPLETE
</code></pre><p>缺点，处理字符数据比较合适，但如果内容本身包含了分隔符（字节数据常常会有此情况），那么就会解析错误</p>
<h4 id="方法4预设长度">方法4，预设长度</h4>
<p>在发送消息前，先约定用定长字节表示接下来数据的长度</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">// 最大长度，长度偏移，长度占用字节，长度调整，剥离字节数
</span><span style="color:#6272a4"></span>ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> LengthFieldBasedFrameDecoder<span style="color:#ff79c6">(</span>1024<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> 1<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> 1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>客户端代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">HelloWorldClient</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> Logger log <span style="color:#ff79c6">=</span> LoggerFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getLogger</span><span style="color:#ff79c6">(</span>HelloWorldClient<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        NioEventLoopGroup worker <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            Bootstrap bootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>worker<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;connetted...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                        @Override
                        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelActive</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;sending...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            Random r <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Random<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#8be9fd">char</span> c <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;a&#39;</span><span style="color:#ff79c6">;</span>
                            ByteBuf buffer <span style="color:#ff79c6">=</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alloc</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> 10<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                                <span style="color:#8be9fd">byte</span> length <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">(</span>r<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nextInt</span><span style="color:#ff79c6">(</span>16<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> 1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                <span style="color:#6272a4">// 先写入长度
</span><span style="color:#6272a4"></span>                                buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>length<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                <span style="color:#6272a4">// 再
</span><span style="color:#6272a4"></span>                                <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> j <span style="color:#ff79c6">=</span> 1<span style="color:#ff79c6">;</span> j <span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">=</span> length<span style="color:#ff79c6">;</span> j<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                                    buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> c<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                <span style="color:#ff79c6">}</span>
                                c<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">;</span>
                            <span style="color:#ff79c6">}</span>
                            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                        <span style="color:#ff79c6">}</span>
                    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ChannelFuture channelFuture <span style="color:#ff79c6">=</span> bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;192.168.0.103&#34;</span><span style="color:#ff79c6">,</span> 9090<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;client error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            worker<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>客户端输出</p>
<pre><code>14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - connetted...
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] REGISTERED
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8] CONNECT: /192.168.0.103:9090
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] ACTIVE
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] c.i.n.HelloWorldClient - sending...
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] WRITE: 97B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 09 61 61 61 61 61 61 61 61 61 09 62 62 62 62 62 |.aaaaaaaaa.bbbbb|
|00000010| 62 62 62 62 06 63 63 63 63 63 63 08 64 64 64 64 |bbbb.cccccc.dddd|
|00000020| 64 64 64 64 0f 65 65 65 65 65 65 65 65 65 65 65 |dddd.eeeeeeeeeee|
|00000030| 65 65 65 65 0d 66 66 66 66 66 66 66 66 66 66 66 |eeee.fffffffffff|
|00000040| 66 66 02 67 67 02 68 68 0e 69 69 69 69 69 69 69 |ff.gg.hh.iiiiiii|
|00000050| 69 69 69 69 69 69 69 09 6a 6a 6a 6a 6a 6a 6a 6a |iiiiiii.jjjjjjjj|
|00000060| 6a                                              |j               |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-2-1] i.n.h.l.LoggingHandler - [id: 0xf0f347b8, L:/192.168.0.103:49979 - R:/192.168.0.103:9090] FLUSH
</code></pre><p>服务端输出</p>
<pre><code>14:36:50 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3] binding...
14:36:51 [DEBUG] [main] c.i.n.HelloWorldServer - [id: 0xdff439d3, L:/192.168.0.103:9090] bound...
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] REGISTERED
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] ACTIVE
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] c.i.n.HelloWorldServer - connected [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979]
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 61 61 61 61 61 61 61 61 61                      |aaaaaaaaa       |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 62 62 62 62 62 62 62 62 62                      |bbbbbbbbb       |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 6B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 63 63 63 63 63 63                               |cccccc          |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 64 64 64 64 64 64 64 64                         |dddddddd        |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 15B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 65 65 65 65 65 65 65 65 65 65 65 65 65 65 65    |eeeeeeeeeeeeeee |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 13B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 66 66 66 66 66 66 66 66 66 66 66 66 66          |fffffffffffff   |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 2B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 67 67                                           |gg              |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 2B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 68 68                                           |hh              |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 14B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 69 69 69 69 69 69 69 69 69 69 69 69 69 69       |iiiiiiiiiiiiii  |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ: 9B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6a 6a 6a 6a 6a 6a 6a 6a 6a                      |jjjjjjjjj       |
+--------+-------------------------------------------------+----------------+
14:37:10 [DEBUG] [nioEventLoopGroup-3-1] i.n.h.l.LoggingHandler - [id: 0x744f2b47, L:/192.168.0.103:9090 - R:/192.168.0.103:49979] READ COMPLETE

</code></pre><h2 id="2-协议设计与解析">2. 协议设计与解析</h2>
<h3 id="21-为什么需要协议">2.1 为什么需要协议？</h3>
<p>TCP/IP 中消息传输基于流的方式，没有边界。</p>
<p>协议的目的就是划定消息的边界，制定通信双方要共同遵守的通信规则</p>
<p>例如：在网络上传输</p>
<pre><code>下雨天留客天留我不留
</code></pre><p>是中文一句著名的无标点符号句子，在没有标点符号情况下，这句话有数种拆解方式，而意思却是完全不同，所以常被用作讲述标点符号的重要性</p>
<p>一种解读</p>
<pre><code>下雨天留客，天留，我不留
</code></pre><p>另一种解读</p>
<pre><code>下雨天，留客天，留我不？留
</code></pre><p>如何设计协议呢？其实就是给网络传输的信息加上“标点符号”。但通过分隔符来断句不是很好，因为分隔符本身如果用于传输，那么必须加以区分。因此，下面一种协议较为常用</p>
<pre><code>定长字节表示内容长度 + 实际内容
</code></pre><p>例如，假设一个中文字符长度为 3，按照上述协议的规则，发送信息方式如下，就不会被接收方弄错意思了</p>
<pre><code>0f下雨天留客06天留09我不留
</code></pre><blockquote>
<p>小故事</p>
<p>很久很久以前，一位私塾先生到一家任教。双方签订了一纸协议：“无鸡鸭亦可无鱼肉亦可白菜豆腐不可少不得束修金”。此后，私塾先生虽然认真教课，但主人家则总是给私塾先生以白菜豆腐为菜，丝毫未见鸡鸭鱼肉的款待。私塾先生先是很不解，可是后来也就想通了：主人把鸡鸭鱼肉的钱都会换为束修金的，也罢。至此双方相安无事。</p>
<p>年关将至，一个学年段亦告结束。私塾先生临行时，也不见主人家为他交付束修金，遂与主家理论。然主家亦振振有词：“有协议为证——无鸡鸭亦可，无鱼肉亦可，白菜豆腐不可少，不得束修金。这白纸黑字明摆着的，你有什么要说的呢？”</p>
<p>私塾先生据理力争：“协议是这样的——无鸡，鸭亦可；无鱼，肉亦可；白菜豆腐不可，少不得束修金。”</p>
<p>双方唇枪舌战，你来我往，真个是不亦乐乎！</p>
<p>这里的束修金，也作“束脩”，应当是泛指教师应当得到的报酬</p>
</blockquote>
<h3 id="22-redis-协议举例">2.2 redis 协议举例</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">NioEventLoopGroup worker <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> LINE <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>13<span style="color:#ff79c6">,</span> 10<span style="color:#ff79c6">}</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
    Bootstrap bootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>worker<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#6272a4">// 会在连接 channel 建立成功后，会触发 active 事件
</span><span style="color:#6272a4"></span>                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelActive</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    set<span style="color:#ff79c6">(</span>ctx<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    get<span style="color:#ff79c6">(</span>ctx<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
                <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    ByteBuf buf <span style="color:#ff79c6">=</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alloc</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;*2&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>LINE<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;$3&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>LINE<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;get&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>LINE<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;$3&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>LINE<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;aaa&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>LINE<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>buf<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
                <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    ByteBuf buf <span style="color:#ff79c6">=</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alloc</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;*3&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>LINE<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;$3&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>LINE<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;set&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>LINE<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;$3&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>LINE<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;aaa&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>LINE<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;$3&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>LINE<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bbb&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>LINE<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>buf<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>

                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    ByteBuf buf <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>ByteBuf<span style="color:#ff79c6">)</span> msg<span style="color:#ff79c6">;</span>
                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">(</span>Charset<span style="color:#ff79c6">.</span><span style="color:#50fa7b">defaultCharset</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    ChannelFuture channelFuture <span style="color:#ff79c6">=</span> bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;localhost&#34;</span><span style="color:#ff79c6">,</span> 6379<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;client error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
    worker<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="23-http-协议举例">2.3 http 协议举例</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">NioEventLoopGroup boss <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
NioEventLoopGroup worker <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
    ServerBootstrap serverBootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ServerBootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioServerSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>boss<span style="color:#ff79c6">,</span> worker<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">childHandler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> HttpServerCodec<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> SimpleChannelInboundHandler<span style="color:#ff79c6">&lt;</span>HttpRequest<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead0</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> HttpRequest msg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    <span style="color:#6272a4">// 获取请求
</span><span style="color:#6272a4"></span>                    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">uri</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

                    <span style="color:#6272a4">// 返回响应
</span><span style="color:#6272a4"></span>                    DefaultFullHttpResponse response <span style="color:#ff79c6">=</span>
                            <span style="color:#ff79c6">new</span> DefaultFullHttpResponse<span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">protocolVersion</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> HttpResponseStatus<span style="color:#ff79c6">.</span><span style="color:#50fa7b">OK</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

                    <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> bytes <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&lt;h1&gt;Hello, world!&lt;/h1&gt;&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

                    response<span style="color:#ff79c6">.</span><span style="color:#50fa7b">headers</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">setInt</span><span style="color:#ff79c6">(</span>CONTENT_LENGTH<span style="color:#ff79c6">,</span> bytes<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    response<span style="color:#ff79c6">.</span><span style="color:#50fa7b">content</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

                    <span style="color:#6272a4">// 写回响应
</span><span style="color:#6272a4"></span>                    ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>response<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#6272a4">/*ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {
</span><span style="color:#6272a4">                @Override
</span><span style="color:#6272a4">                public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
</span><span style="color:#6272a4">                    log.debug(&#34;{}&#34;, msg.getClass());
</span><span style="color:#6272a4">
</span><span style="color:#6272a4">                    if (msg instanceof HttpRequest) { // 请求行，请求头
</span><span style="color:#6272a4">
</span><span style="color:#6272a4">                    } else if (msg instanceof HttpContent) { //请求体
</span><span style="color:#6272a4">
</span><span style="color:#6272a4">                    }
</span><span style="color:#6272a4">                }
</span><span style="color:#6272a4">            });*/</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    ChannelFuture channelFuture <span style="color:#ff79c6">=</span> serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;server error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
    boss<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    worker<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="24-自定义协议要素">2.4 自定义协议要素</h3>
<ul>
<li>魔数，用来在第一时间判定是否是无效数据包</li>
<li>版本号，可以支持协议的升级</li>
<li>序列化算法，消息正文到底采用哪种序列化反序列化方式，可以由此扩展，例如：json、protobuf、hessian、jdk</li>
<li>指令类型，是登录、注册、单聊、群聊&hellip; 跟业务相关</li>
<li>请求序号，为了双工通信，提供异步能力</li>
<li>正文长度</li>
<li>消息正文</li>
</ul>
<h4 id="编解码器">编解码器</h4>
<p>根据上面的要素，设计一个登录请求消息和登录响应消息，并使用 Netty 完成收发</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Slf4j
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MessageCodec</span> <span style="color:#8be9fd;font-style:italic">extends</span> ByteToMessageCodec<span style="color:#ff79c6">&lt;</span>Message<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">encode</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Message msg<span style="color:#ff79c6">,</span> ByteBuf out<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 1. 4 字节的魔数
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>1<span style="color:#ff79c6">,</span> 2<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">,</span> 4<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 2. 1 字节的版本,
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 3. 1 字节的序列化方式 jdk 0 , json 1
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 4. 1 字节的指令类型
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMessageType</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 5. 4 个字节
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeInt</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSequenceId</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 无意义，对齐填充
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>0xff<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 6. 获取内容的字节数组
</span><span style="color:#6272a4"></span>        ByteArrayOutputStream bos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayOutputStream<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        ObjectOutputStream oos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectOutputStream<span style="color:#ff79c6">(</span>bos<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> bytes <span style="color:#ff79c6">=</span> bos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toByteArray</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 7. 长度
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeInt</span><span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 8. 写入内容
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">decode</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> ByteBuf in<span style="color:#ff79c6">,</span> List<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> out<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        <span style="color:#8be9fd">int</span> magicNum <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">byte</span> version <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">byte</span> serializerType <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">byte</span> messageType <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">int</span> sequenceId <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">int</span> length <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> bytes <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>length<span style="color:#ff79c6">]</span><span style="color:#ff79c6">;</span>
        in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readBytes</span><span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> length<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        ObjectInputStream ois <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectInputStream<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ByteArrayInputStream<span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        Message message <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Message<span style="color:#ff79c6">)</span> ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{}, {}, {}, {}, {}, {}&#34;</span><span style="color:#ff79c6">,</span> magicNum<span style="color:#ff79c6">,</span> version<span style="color:#ff79c6">,</span> serializerType<span style="color:#ff79c6">,</span> messageType<span style="color:#ff79c6">,</span> sequenceId<span style="color:#ff79c6">,</span> length<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{}&#34;</span><span style="color:#ff79c6">,</span> message<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>测试</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">EmbeddedChannel channel <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> EmbeddedChannel<span style="color:#ff79c6">(</span>
    <span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span>
    <span style="color:#ff79c6">new</span> LengthFieldBasedFrameDecoder<span style="color:#ff79c6">(</span>
        1024<span style="color:#ff79c6">,</span> 12<span style="color:#ff79c6">,</span> 4<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span>
    <span style="color:#ff79c6">new</span> MessageCodec<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#6272a4">// encode
</span><span style="color:#6272a4"></span>LoginRequestMessage message <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LoginRequestMessage<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;zhangsan&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;123&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;张三&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#6272a4">//        channel.writeOutbound(message);
</span><span style="color:#6272a4"></span><span style="color:#6272a4">// decode
</span><span style="color:#6272a4"></span>ByteBuf buf <span style="color:#ff79c6">=</span> ByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">new</span> MessageCodec<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">encode</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> message<span style="color:#ff79c6">,</span> buf<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

ByteBuf s1 <span style="color:#ff79c6">=</span> buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">slice</span><span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">,</span> 100<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
ByteBuf s2 <span style="color:#ff79c6">=</span> buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">slice</span><span style="color:#ff79c6">(</span>100<span style="color:#ff79c6">,</span> buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readableBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span> 100<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
s1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">retain</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 引用计数 2
</span><span style="color:#6272a4"></span>channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeInbound</span><span style="color:#ff79c6">(</span>s1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// release 1
</span><span style="color:#6272a4"></span>channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeInbound</span><span style="color:#ff79c6">(</span>s2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>解读</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h3860sbeiej30ia0crdqw.jpg" alt="0013.png">

</p>
<h4 id="-什么时候可以加-sharable">💡 什么时候可以加 @Sharable</h4>
<ul>
<li>当 handler 不保存状态时，就可以安全地在多线程下被共享</li>
<li>但要注意对于编解码器类，不能继承 ByteToMessageCodec 或 CombinedChannelDuplexHandler 父类，他们的构造方法对 @Sharable 有限制</li>
<li>如果能确保编解码器不会保存状态，可以继承 MessageToMessageCodec 父类</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Slf4j
@ChannelHandler.Sharable
<span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * 必须和 LengthFieldBasedFrameDecoder 一起使用，确保接到的 ByteBuf 消息是完整的
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MessageCodecSharable</span> <span style="color:#8be9fd;font-style:italic">extends</span> MessageToMessageCodec<span style="color:#ff79c6">&lt;</span>ByteBuf<span style="color:#ff79c6">,</span> Message<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">encode</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Message msg<span style="color:#ff79c6">,</span> List<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> outList<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        ByteBuf out <span style="color:#ff79c6">=</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alloc</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 1. 4 字节的魔数
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>1<span style="color:#ff79c6">,</span> 2<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">,</span> 4<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 2. 1 字节的版本,
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 3. 1 字节的序列化方式 jdk 0 , json 1
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 4. 1 字节的指令类型
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMessageType</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 5. 4 个字节
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeInt</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSequenceId</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 无意义，对齐填充
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>0xff<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 6. 获取内容的字节数组
</span><span style="color:#6272a4"></span>        ByteArrayOutputStream bos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayOutputStream<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        ObjectOutputStream oos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectOutputStream<span style="color:#ff79c6">(</span>bos<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> bytes <span style="color:#ff79c6">=</span> bos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toByteArray</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 7. 长度
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeInt</span><span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 8. 写入内容
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        outList<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>out<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">decode</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> ByteBuf in<span style="color:#ff79c6">,</span> List<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> out<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        <span style="color:#8be9fd">int</span> magicNum <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">byte</span> version <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">byte</span> serializerType <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">byte</span> messageType <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">int</span> sequenceId <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">int</span> length <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> bytes <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>length<span style="color:#ff79c6">]</span><span style="color:#ff79c6">;</span>
        in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readBytes</span><span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> length<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        ObjectInputStream ois <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectInputStream<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ByteArrayInputStream<span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        Message message <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Message<span style="color:#ff79c6">)</span> ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{}, {}, {}, {}, {}, {}&#34;</span><span style="color:#ff79c6">,</span> magicNum<span style="color:#ff79c6">,</span> version<span style="color:#ff79c6">,</span> serializerType<span style="color:#ff79c6">,</span> messageType<span style="color:#ff79c6">,</span> sequenceId<span style="color:#ff79c6">,</span> length<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{}&#34;</span><span style="color:#ff79c6">,</span> message<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h2 id="3-聊天室案例">3. 聊天室案例</h2>
<h3 id="31-聊天室业务介绍">3.1 聊天室业务介绍</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * 用户管理接口
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">interface</span> <span style="color:#50fa7b">UserService</span> <span style="color:#ff79c6">{</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 登录
</span><span style="color:#6272a4">     * @param username 用户名
</span><span style="color:#6272a4">     * @param password 密码
</span><span style="color:#6272a4">     * @return 登录成功返回 true, 否则返回 false
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">login</span><span style="color:#ff79c6">(</span>String username<span style="color:#ff79c6">,</span> String password<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * 会话管理接口
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">interface</span> <span style="color:#50fa7b">Session</span> <span style="color:#ff79c6">{</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 绑定会话
</span><span style="color:#6272a4">     * @param channel 哪个 channel 要绑定会话
</span><span style="color:#6272a4">     * @param username 会话绑定用户
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>Channel channel<span style="color:#ff79c6">,</span> String username<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 解绑会话
</span><span style="color:#6272a4">     * @param channel 哪个 channel 要解绑会话
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">unbind</span><span style="color:#ff79c6">(</span>Channel channel<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 获取属性
</span><span style="color:#6272a4">     * @param channel 哪个 channel
</span><span style="color:#6272a4">     * @param name 属性名
</span><span style="color:#6272a4">     * @return 属性值
</span><span style="color:#6272a4">     */</span>
    Object <span style="color:#50fa7b">getAttribute</span><span style="color:#ff79c6">(</span>Channel channel<span style="color:#ff79c6">,</span> String name<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 设置属性
</span><span style="color:#6272a4">     * @param channel 哪个 channel
</span><span style="color:#6272a4">     * @param name 属性名
</span><span style="color:#6272a4">     * @param value 属性值
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setAttribute</span><span style="color:#ff79c6">(</span>Channel channel<span style="color:#ff79c6">,</span> String name<span style="color:#ff79c6">,</span> Object value<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 根据用户名获取 channel
</span><span style="color:#6272a4">     * @param username 用户名
</span><span style="color:#6272a4">     * @return channel
</span><span style="color:#6272a4">     */</span>
    Channel <span style="color:#50fa7b">getChannel</span><span style="color:#ff79c6">(</span>String username<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * 聊天组会话管理接口
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">interface</span> <span style="color:#50fa7b">GroupSession</span> <span style="color:#ff79c6">{</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 创建一个聊天组, 如果不存在才能创建成功, 否则返回 null
</span><span style="color:#6272a4">     * @param name 组名
</span><span style="color:#6272a4">     * @param members 成员
</span><span style="color:#6272a4">     * @return 成功时返回组对象, 失败返回 null
</span><span style="color:#6272a4">     */</span>
    Group <span style="color:#50fa7b">createGroup</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">,</span> Set<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> members<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 加入聊天组
</span><span style="color:#6272a4">     * @param name 组名
</span><span style="color:#6272a4">     * @param member 成员名
</span><span style="color:#6272a4">     * @return 如果组不存在返回 null, 否则返回组对象
</span><span style="color:#6272a4">     */</span>
    Group <span style="color:#50fa7b">joinMember</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">,</span> String member<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 移除组成员
</span><span style="color:#6272a4">     * @param name 组名
</span><span style="color:#6272a4">     * @param member 成员名
</span><span style="color:#6272a4">     * @return 如果组不存在返回 null, 否则返回组对象
</span><span style="color:#6272a4">     */</span>
    Group <span style="color:#50fa7b">removeMember</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">,</span> String member<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 移除聊天组
</span><span style="color:#6272a4">     * @param name 组名
</span><span style="color:#6272a4">     * @return 如果组不存在返回 null, 否则返回组对象
</span><span style="color:#6272a4">     */</span>
    Group <span style="color:#50fa7b">removeGroup</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 获取组成员
</span><span style="color:#6272a4">     * @param name 组名
</span><span style="color:#6272a4">     * @return 成员集合, 没有成员会返回 empty set
</span><span style="color:#6272a4">     */</span>
    Set<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">getMembers</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 获取组成员的 channel 集合, 只有在线的 channel 才会返回
</span><span style="color:#6272a4">     * @param name 组名
</span><span style="color:#6272a4">     * @return 成员 channel 集合
</span><span style="color:#6272a4">     */</span>
    List<span style="color:#ff79c6">&lt;</span>Channel<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">getMembersChannel</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="32-聊天室业务-登录">3.2 聊天室业务-登录</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Slf4j
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">ChatServer</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        NioEventLoopGroup boss <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        NioEventLoopGroup worker <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        LoggingHandler LOGGING_HANDLER <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        MessageCodecSharable MESSAGE_CODEC <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> MessageCodecSharable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            ServerBootstrap serverBootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ServerBootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioServerSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>boss<span style="color:#ff79c6">,</span> worker<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">childHandler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ProcotolFrameDecoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>LOGGING_HANDLER<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>MESSAGE_CODEC<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> SimpleChannelInboundHandler<span style="color:#ff79c6">&lt;</span>LoginRequestMessage<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                        @Override
                        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead0</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> LoginRequestMessage msg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                            String username <span style="color:#ff79c6">=</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUsername</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            String password <span style="color:#ff79c6">=</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getPassword</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#8be9fd">boolean</span> login <span style="color:#ff79c6">=</span> UserServiceFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUserService</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">login</span><span style="color:#ff79c6">(</span>username<span style="color:#ff79c6">,</span> password<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            LoginResponseMessage message<span style="color:#ff79c6">;</span>
                            <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>login<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                                message <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LoginResponseMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;登录成功&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
                                message <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LoginResponseMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;用户名或密码不正确&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#ff79c6">}</span>
                            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                        <span style="color:#ff79c6">}</span>
                    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            Channel channel <span style="color:#ff79c6">=</span> serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;server error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            boss<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            worker<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Slf4j
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">ChatClient</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        NioEventLoopGroup group <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        LoggingHandler LOGGING_HANDLER <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        MessageCodecSharable MESSAGE_CODEC <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> MessageCodecSharable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        CountDownLatch WAIT_FOR_LOGIN <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> CountDownLatch<span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        AtomicBoolean LOGIN <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> AtomicBoolean<span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            Bootstrap bootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>group<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ProcotolFrameDecoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#6272a4">//                    ch.pipeline().addLast(LOGGING_HANDLER);
</span><span style="color:#6272a4"></span>                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>MESSAGE_CODEC<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;client handler&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                        <span style="color:#6272a4">// 接收响应消息
</span><span style="color:#6272a4"></span>                        @Override
                        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;msg: {}&#34;</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>msg <span style="color:#ff79c6">instanceof</span> LoginResponseMessage<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                                LoginResponseMessage response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>LoginResponseMessage<span style="color:#ff79c6">)</span> msg<span style="color:#ff79c6">;</span>
                                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>response<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isSuccess</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                                    <span style="color:#6272a4">// 如果登录成功
</span><span style="color:#6272a4"></span>                                    LOGIN<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                <span style="color:#ff79c6">}</span>
                                <span style="color:#6272a4">// 唤醒 system in 线程
</span><span style="color:#6272a4"></span>                                WAIT_FOR_LOGIN<span style="color:#ff79c6">.</span><span style="color:#50fa7b">countDown</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                            <span style="color:#ff79c6">}</span>
                        <span style="color:#ff79c6">}</span>

                        <span style="color:#6272a4">// 在连接建立后触发 active 事件
</span><span style="color:#6272a4"></span>                        @Override
                        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelActive</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                            <span style="color:#6272a4">// 负责接收用户在控制台的输入，负责向服务器发送各种消息
</span><span style="color:#6272a4"></span>                            <span style="color:#ff79c6">new</span> Thread<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
                                Scanner scanner <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Scanner<span style="color:#ff79c6">(</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">in</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;请输入用户名:&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                String username <span style="color:#ff79c6">=</span> scanner<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nextLine</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;请输入密码:&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                String password <span style="color:#ff79c6">=</span> scanner<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nextLine</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                <span style="color:#6272a4">// 构造消息对象
</span><span style="color:#6272a4"></span>                                LoginRequestMessage message <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LoginRequestMessage<span style="color:#ff79c6">(</span>username<span style="color:#ff79c6">,</span> password<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                <span style="color:#6272a4">// 发送消息
</span><span style="color:#6272a4"></span>                                ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;等待后续操作...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                                    WAIT_FOR_LOGIN<span style="color:#ff79c6">.</span><span style="color:#50fa7b">await</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                                    e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                <span style="color:#ff79c6">}</span>
                                <span style="color:#6272a4">// 如果登录失败
</span><span style="color:#6272a4"></span>                                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>LOGIN<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                                    ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                    <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
                                <span style="color:#ff79c6">}</span>
                                <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;==================================&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;send [username] [content]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;gsend [group name] [content]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;gcreate [group name] [m1,m2,m3...]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;gmembers [group name]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;gjoin [group name]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;gquit [group name]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;quit&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;==================================&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                    String command <span style="color:#ff79c6">=</span> scanner<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nextLine</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                    String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> s <span style="color:#ff79c6">=</span> command<span style="color:#ff79c6">.</span><span style="color:#50fa7b">split</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; &#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                    <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">(</span>s<span style="color:#ff79c6">[</span>0<span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
                                        <span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;send&#34;</span><span style="color:#ff79c6">:</span>
                                            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChatRequestMessage<span style="color:#ff79c6">(</span>username<span style="color:#ff79c6">,</span> s<span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">]</span><span style="color:#ff79c6">,</span> s<span style="color:#ff79c6">[</span>2<span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                            <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
                                        <span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;gsend&#34;</span><span style="color:#ff79c6">:</span>
                                            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupChatRequestMessage<span style="color:#ff79c6">(</span>username<span style="color:#ff79c6">,</span> s<span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">]</span><span style="color:#ff79c6">,</span> s<span style="color:#ff79c6">[</span>2<span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                            <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
                                        <span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;gcreate&#34;</span><span style="color:#ff79c6">:</span>
                                            Set<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> set <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashSet<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span>Arrays<span style="color:#ff79c6">.</span><span style="color:#50fa7b">asList</span><span style="color:#ff79c6">(</span>s<span style="color:#ff79c6">[</span>2<span style="color:#ff79c6">]</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">split</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;,&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                            set<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>username<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 加入自己
</span><span style="color:#6272a4"></span>                                            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupCreateRequestMessage<span style="color:#ff79c6">(</span>s<span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">]</span><span style="color:#ff79c6">,</span> set<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                            <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
                                        <span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;gmembers&#34;</span><span style="color:#ff79c6">:</span>
                                            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupMembersRequestMessage<span style="color:#ff79c6">(</span>s<span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                            <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
                                        <span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;gjoin&#34;</span><span style="color:#ff79c6">:</span>
                                            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupJoinRequestMessage<span style="color:#ff79c6">(</span>username<span style="color:#ff79c6">,</span> s<span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                            <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
                                        <span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;gquit&#34;</span><span style="color:#ff79c6">:</span>
                                            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupQuitRequestMessage<span style="color:#ff79c6">(</span>username<span style="color:#ff79c6">,</span> s<span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                            <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
                                        <span style="color:#ff79c6">case</span> <span style="color:#f1fa8c">&#34;quit&#34;</span><span style="color:#ff79c6">:</span>
                                            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                                            <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
                                    <span style="color:#ff79c6">}</span>
                                <span style="color:#ff79c6">}</span>
                            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;system in&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">start</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                        <span style="color:#ff79c6">}</span>
                    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            Channel channel <span style="color:#ff79c6">=</span> bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;localhost&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;client error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            group<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="33-聊天室业务-单聊">3.3 聊天室业务-单聊</h3>
<p>服务器端将 handler 独立出来</p>
<p>登录 handler</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@ChannelHandler.Sharable
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">LoginRequestMessageHandler</span> <span style="color:#8be9fd;font-style:italic">extends</span> SimpleChannelInboundHandler<span style="color:#ff79c6">&lt;</span>LoginRequestMessage<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead0</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> LoginRequestMessage msg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        String username <span style="color:#ff79c6">=</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUsername</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        String password <span style="color:#ff79c6">=</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getPassword</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">boolean</span> login <span style="color:#ff79c6">=</span> UserServiceFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUserService</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">login</span><span style="color:#ff79c6">(</span>username<span style="color:#ff79c6">,</span> password<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        LoginResponseMessage message<span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>login<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            SessionFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSession</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> username<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            message <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LoginResponseMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;登录成功&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
            message <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LoginResponseMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;用户名或密码不正确&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>单聊 handler</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@ChannelHandler.Sharable
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">ChatRequestMessageHandler</span> <span style="color:#8be9fd;font-style:italic">extends</span> SimpleChannelInboundHandler<span style="color:#ff79c6">&lt;</span>ChatRequestMessage<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead0</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> ChatRequestMessage msg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        String to <span style="color:#ff79c6">=</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getTo</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        Channel channel <span style="color:#ff79c6">=</span> SessionFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSession</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getChannel</span><span style="color:#ff79c6">(</span>to<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 在线
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>channel <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChatResponseMessage<span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getFrom</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getContent</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#6272a4">// 不在线
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChatResponseMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;对方用户不存在或者不在线&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="34-聊天室业务-群聊">3.4 聊天室业务-群聊</h3>
<p>创建群聊</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@ChannelHandler.Sharable
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">GroupCreateRequestMessageHandler</span> <span style="color:#8be9fd;font-style:italic">extends</span> SimpleChannelInboundHandler<span style="color:#ff79c6">&lt;</span>GroupCreateRequestMessage<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead0</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> GroupCreateRequestMessage msg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        String groupName <span style="color:#ff79c6">=</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupName</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        Set<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> members <span style="color:#ff79c6">=</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMembers</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 群管理器
</span><span style="color:#6272a4"></span>        GroupSession groupSession <span style="color:#ff79c6">=</span> GroupSessionFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupSession</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        Group group <span style="color:#ff79c6">=</span> groupSession<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createGroup</span><span style="color:#ff79c6">(</span>groupName<span style="color:#ff79c6">,</span> members<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>group <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 发生成功消息
</span><span style="color:#6272a4"></span>            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupCreateResponseMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">,</span> groupName <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;创建成功&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#6272a4">// 发送拉群消息
</span><span style="color:#6272a4"></span>            List<span style="color:#ff79c6">&lt;</span>Channel<span style="color:#ff79c6">&gt;</span> channels <span style="color:#ff79c6">=</span> groupSession<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMembersChannel</span><span style="color:#ff79c6">(</span>groupName<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Channel channel <span style="color:#ff79c6">:</span> channels<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupCreateResponseMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;您已被拉入&#34;</span> <span style="color:#ff79c6">+</span> groupName<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupCreateResponseMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> groupName <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;已经存在&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>群聊</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@ChannelHandler.Sharable
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">GroupChatRequestMessageHandler</span> <span style="color:#8be9fd;font-style:italic">extends</span> SimpleChannelInboundHandler<span style="color:#ff79c6">&lt;</span>GroupChatRequestMessage<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead0</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> GroupChatRequestMessage msg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        List<span style="color:#ff79c6">&lt;</span>Channel<span style="color:#ff79c6">&gt;</span> channels <span style="color:#ff79c6">=</span> GroupSessionFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupSession</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
                <span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMembersChannel</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupName</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Channel channel <span style="color:#ff79c6">:</span> channels<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupChatResponseMessage<span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getFrom</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getContent</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>加入群聊</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@ChannelHandler.Sharable
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">GroupJoinRequestMessageHandler</span> <span style="color:#8be9fd;font-style:italic">extends</span> SimpleChannelInboundHandler<span style="color:#ff79c6">&lt;</span>GroupJoinRequestMessage<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead0</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> GroupJoinRequestMessage msg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        Group group <span style="color:#ff79c6">=</span> GroupSessionFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupSession</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">joinMember</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupName</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUsername</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>group <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupJoinResponseMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupName</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;群加入成功&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupJoinResponseMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupName</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;群不存在&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>退出群聊</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@ChannelHandler.Sharable
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">GroupQuitRequestMessageHandler</span> <span style="color:#8be9fd;font-style:italic">extends</span> SimpleChannelInboundHandler<span style="color:#ff79c6">&lt;</span>GroupQuitRequestMessage<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead0</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> GroupQuitRequestMessage msg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        Group group <span style="color:#ff79c6">=</span> GroupSessionFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupSession</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">removeMember</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupName</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getUsername</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>group <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupJoinResponseMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;已退出群&#34;</span> <span style="color:#ff79c6">+</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupName</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupJoinResponseMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupName</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;群不存在&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>查看成员</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@ChannelHandler.Sharable
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">GroupMembersRequestMessageHandler</span> <span style="color:#8be9fd;font-style:italic">extends</span> SimpleChannelInboundHandler<span style="color:#ff79c6">&lt;</span>GroupMembersRequestMessage<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead0</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> GroupMembersRequestMessage msg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        Set<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> members <span style="color:#ff79c6">=</span> GroupSessionFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupSession</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
                <span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMembers</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getGroupName</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> GroupMembersResponseMessage<span style="color:#ff79c6">(</span>members<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="35-聊天室业务-退出">3.5 聊天室业务-退出</h3>
<pre><code>@Slf4j
@ChannelHandler.Sharable
public class QuitHandler extends ChannelInboundHandlerAdapter {

    // 当连接断开时触发 inactive 事件
    @Override
    public void channelInactive(ChannelHandlerContext ctx) throws Exception {
        SessionFactory.getSession().unbind(ctx.channel());
        log.debug(&quot;{} 已经断开&quot;, ctx.channel());
    }

	// 当出现异常时触发
    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
        SessionFactory.getSession().unbind(ctx.channel());
        log.debug(&quot;{} 已经异常断开 异常是{}&quot;, ctx.channel(), cause.getMessage());
    }
}
</code></pre><h3 id="36-聊天室业务-空闲检测">3.6 聊天室业务-空闲检测</h3>
<h4 id="连接假死">连接假死</h4>
<p>原因</p>
<ul>
<li>网络设备出现故障，例如网卡，机房等，底层的 TCP 连接已经断开了，但应用程序没有感知到，仍然占用着资源。</li>
<li>公网网络不稳定，出现丢包。如果连续出现丢包，这时现象就是客户端数据发不出去，服务端也一直收不到数据，就这么一直耗着</li>
<li>应用程序线程阻塞，无法进行数据读写</li>
</ul>
<p>问题</p>
<ul>
<li>假死的连接占用的资源不能自动释放</li>
<li>向假死的连接发送数据，得到的反馈是发送超时</li>
</ul>
<p>服务器端解决</p>
<ul>
<li>怎么判断客户端连接是否假死呢？如果能收到客户端数据，说明没有假死。因此策略就可以定为，每隔一段时间就检查这段时间内是否接收到客户端数据，没有就可以判定为连接假死</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">// 用来判断是不是 读空闲时间过长，或 写空闲时间过长
</span><span style="color:#6272a4"></span><span style="color:#6272a4">// 5s 内如果没有收到 channel 的数据，会触发一个 IdleState#READER_IDLE 事件
</span><span style="color:#6272a4"></span>ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> IdleStateHandler<span style="color:#ff79c6">(</span>5<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#6272a4">// ChannelDuplexHandler 可以同时作为入站和出站处理器
</span><span style="color:#6272a4"></span>ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelDuplexHandler<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">// 用来触发特殊事件
</span><span style="color:#6272a4"></span>    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">userEventTriggered</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object evt<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception<span style="color:#ff79c6">{</span>
        IdleStateEvent event <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>IdleStateEvent<span style="color:#ff79c6">)</span> evt<span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 触发了读空闲事件
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>event<span style="color:#ff79c6">.</span><span style="color:#50fa7b">state</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> IdleState<span style="color:#ff79c6">.</span><span style="color:#50fa7b">READER_IDLE</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;已经 5s 没有读到数据了&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>客户端定时心跳</p>
<ul>
<li>客户端可以定时向服务器端发送数据，只要这个时间间隔小于服务器定义的空闲检测的时间间隔，那么就能防止前面提到的误判，客户端可以定义如下心跳处理器</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">// 用来判断是不是 读空闲时间过长，或 写空闲时间过长
</span><span style="color:#6272a4"></span><span style="color:#6272a4">// 3s 内如果没有向服务器写数据，会触发一个 IdleState#WRITER_IDLE 事件
</span><span style="color:#6272a4"></span>ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> IdleStateHandler<span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#6272a4">// ChannelDuplexHandler 可以同时作为入站和出站处理器
</span><span style="color:#6272a4"></span>ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelDuplexHandler<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">// 用来触发特殊事件
</span><span style="color:#6272a4"></span>    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">userEventTriggered</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object evt<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception<span style="color:#ff79c6">{</span>
        IdleStateEvent event <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>IdleStateEvent<span style="color:#ff79c6">)</span> evt<span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 触发了写空闲事件
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>event<span style="color:#ff79c6">.</span><span style="color:#50fa7b">state</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> IdleState<span style="color:#ff79c6">.</span><span style="color:#50fa7b">WRITER_IDLE</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">//                                log.debug(&#34;3s 没有写数据了，发送一个心跳包&#34;);
</span><span style="color:#6272a4"></span>            ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> PingMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div>

                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/1036netty%E5%85%A5%E9%97%A8/" data-toggle="tooltip" data-placement="top" title="2、Netty入门（Netty）">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/1038netty%E4%BC%98%E5%8C%96%E5%92%8C%E6%BA%90%E7%A0%81/" data-toggle="tooltip" data-placement="top" title="4、Netty优化和源码（Netty）">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">标签</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/activemq" title="activemq">
                            activemq
                        </a>
                        
                        
                        
                        <a href="/tags/ajax" title="ajax">
                            ajax
                        </a>
                        
                        
                        
                        <a href="/tags/cookie" title="cookie">
                            cookie
                        </a>
                        
                        
                        
                        <a href="/tags/datax" title="datax">
                            datax
                        </a>
                        
                        
                        
                        <a href="/tags/docker" title="docker">
                            docker
                        </a>
                        
                        
                        
                        <a href="/tags/elasticsearch" title="elasticsearch">
                            elasticsearch
                        </a>
                        
                        
                        
                        <a href="/tags/filter" title="filter">
                            filter
                        </a>
                        
                        
                        
                        <a href="/tags/hadoop" title="hadoop">
                            hadoop
                        </a>
                        
                        
                        
                        <a href="/tags/hbase" title="hbase">
                            hbase
                        </a>
                        
                        
                        
                        <a href="/tags/hive" title="hive">
                            hive
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/java" title="java">
                            java
                        </a>
                        
                        
                        
                        <a href="/tags/javascript" title="javascript">
                            javascript
                        </a>
                        
                        
                        
                        <a href="/tags/javaweb" title="javaweb">
                            javaweb
                        </a>
                        
                        
                        
                        <a href="/tags/jdbc" title="jdbc">
                            jdbc
                        </a>
                        
                        
                        
                        <a href="/tags/jquery" title="jquery">
                            jquery
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/jsp" title="jsp">
                            jsp
                        </a>
                        
                        
                        
                        <a href="/tags/juc" title="juc">
                            juc
                        </a>
                        
                        
                        
                        <a href="/tags/jvm" title="jvm">
                            jvm
                        </a>
                        
                        
                        
                        <a href="/tags/jwt" title="jwt">
                            jwt
                        </a>
                        
                        
                        
                        <a href="/tags/kafka" title="kafka">
                            kafka
                        </a>
                        
                        
                        
                        <a href="/tags/linux" title="linux">
                            linux
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/maven" title="maven">
                            maven
                        </a>
                        
                        
                        
                        <a href="/tags/minio" title="minio">
                            minio
                        </a>
                        
                        
                        
                        <a href="/tags/mongodb" title="mongodb">
                            mongodb
                        </a>
                        
                        
                        
                        <a href="/tags/mybatis" title="mybatis">
                            mybatis
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/mysql" title="mysql">
                            mysql
                        </a>
                        
                        
                        
                        <a href="/tags/netty" title="netty">
                            netty
                        </a>
                        
                        
                        
                        <a href="/tags/nginx" title="nginx">
                            nginx
                        </a>
                        
                        
                        
                        <a href="/tags/react" title="react">
                            react
                        </a>
                        
                        
                        
                        <a href="/tags/redis" title="redis">
                            redis
                        </a>
                        
                        
                        
                        <a href="/tags/scala" title="scala">
                            scala
                        </a>
                        
                        
                        
                        <a href="/tags/servlet" title="servlet">
                            servlet
                        </a>
                        
                        
                        
                        <a href="/tags/session" title="session">
                            session
                        </a>
                        
                        
                        
                        <a href="/tags/shiro" title="shiro">
                            shiro
                        </a>
                        
                        
                        
                        <a href="/tags/spark" title="spark">
                            spark
                        </a>
                        
                        
                        
                        <a href="/tags/spring" title="spring">
                            spring
                        </a>
                        
                        
                        
                        <a href="/tags/springboot" title="springboot">
                            springboot
                        </a>
                        
                        
                        
                        <a href="/tags/springcloud" title="springcloud">
                            springcloud
                        </a>
                        
                        
                        
                        <a href="/tags/springmvc" title="springmvc">
                            springmvc
                        </a>
                        
                        
                        
                        <a href="/tags/springsecurity" title="springsecurity">
                            springsecurity
                        </a>
                        
                        
                        
                        <a href="/tags/tomcat" title="tomcat">
                            tomcat
                        </a>
                        
                        
                        
                        <a href="/tags/vue" title="vue">
                            vue
                        </a>
                        
                        
                        
                        <a href="/tags/xml" title="xml">
                            xml
                        </a>
                        
                        
                        
                        <a href="/tags/zookeeper" title="zookeeper">
                            zookeeper
                        </a>
                        
                        
                        
                        <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95" title="数据结构与算法">
                            数据结构与算法
                        </a>
                        
                        
                        
                        <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" title="设计模式">
                            设计模式
                        </a>
                        
                        
                        
                        <a href="/tags/%E9%A1%B9%E7%9B%AE" title="项目">
                            项目
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:1424197205@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    <li>
                        <a target="_blank" href="/#">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/yiguan1573">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="亿观的博客" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; 亿观的博客 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>









<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





</body>
</html>
