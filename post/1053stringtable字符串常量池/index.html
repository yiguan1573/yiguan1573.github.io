<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="referrer" content="never">

    
    <meta property="og:site_name" content="亿观的博客">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://yiguan1573.github.io//img/01.jpg">
    <meta property="twitter:image" content="https://yiguan1573.github.io//img/01.jpg" />
    

    
    <meta name="title" content="13、StringTable(字符串常量池)（JVM）" />
    <meta property="og:title" content="13、StringTable(字符串常量池)（JVM）" />
    <meta property="twitter:title" content="13、StringTable(字符串常量池)（JVM）" />
    

    
    <meta name="description" content="">
    <meta property="og:description" content="" />
    <meta property="twitter:description" content="" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>13、StringTable(字符串常量池)（JVM） | yiguan1573</title>

    <link rel="canonical" href="/post/1053stringtable%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%B8%B8%E9%87%8F%E6%B1%A0/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>




<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">亿观的博客</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">首页</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/%E5%AD%A6%E4%B9%A0">学习</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/archive/">档案</a></li>
                    
                        <li><a href="/top/about/">关于</a></li>
                    

                    
		    <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		    </li>
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/03.JPG')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/jvm" title="JVM">
                            JVM
                        </a>
                        
                    </div>
                    <h1>13、StringTable(字符串常量池)（JVM）</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                亿观
                             
                            on 
                            Saturday, July 2, 2022
                            
                                <span id="/post/1053stringtable%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%B8%B8%E9%87%8F%E6%B1%A0/" class="leancloud_visitors meta_data_item" data-flag-title="">
    <span class="post-meta-item-icon">
      <span class="octicon octicon-eye"></span> 
    </span>
    <i class="fa fa-eye"></i>
    <span class="old-visitors-count" style="display: none;"></span>
    <span class="leancloud-visitors-count"></span>
</span>



<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>

<script>
	AV.initialize("", "");
</script>

<script type="text/javascript">
function showTime(Counter) {
    var query = new AV.Query(Counter);
    var entries = [];
    var $visitors = $(".leancloud_visitors");

    $visitors.each(function() {
        entries.push($(this).attr("id").trim());
    });

    query.containedIn('url', entries);
    query.find()
        .done(function(results) {
            var COUNT_CONTAINER_REF = '.leancloud-visitors-count';
            var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';

            
            
            
            

            for (var i = 0; i < results.length; i++) {
                var item = results[i];
                var url = item.get('url');
                var time = item.get('time');
                var element = document.getElementById(url);

                $(element).find(COUNT_CONTAINER_REF).text(time);
            }
            for (var i = 0; i < entries.length; i++) {
                var url = entries[i];
                var element = document.getElementById(url);
                var countSpan = $(element).find(COUNT_CONTAINER_REF);
                if (countSpan.text() == '') {
                    var oldCountSpan = $(element).find(OLD_COUNT_CONTAINER_REF).text();
                    if(oldCountSpan!=''){
                        countSpan.text(0+parseInt(oldCountSpan));
                    }else{
                        countSpan.text(0);          
                    }
                }
            }
        })
        .fail(function(object, error) {
            console.log("Error: " + error.code + " " + error.message);
        });
}

function addCount(Counter) {
    var $visitors = $(".leancloud_visitors");
    var url = $visitors.attr('id').trim();
    var title = $visitors.attr('data-flag-title').trim();
    var query = new AV.Query(Counter);

    query.equalTo("url", url);
    query.find({
        success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment("time");
                counter.save(null, {
                    success: function(counter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(counter.get('time'));
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
                var newcounter = new Counter();
                 
                var acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                newcounter.setACL(acl);
                 
                newcounter.set("title", title);
                newcounter.set("url", url);
                var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';
                var $element = $(document.getElementById(url));
                var oldCountSpan = $element.find(OLD_COUNT_CONTAINER_REF).text();
                if(oldCountSpan!=''){
                    newcounter.set("time", parseInt(oldCountSpan)+1);
                }else{
 	                    newcounter.set("time",  1);
                }
                newcounter.save(null, {
                    success: function(newcounter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                    },
                    error: function(newcounter, error) {
                        console.log('Failed to create');
                    }
                });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + " " + error.message);
        }
    });
}
$(function() {
    var Counter = AV.Object.extend("Counter");
    
    
    if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
    } else {
        showTime(Counter);
    }
});
</script>

                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h2 id="string的基本特性">String的基本特性</h2>
<ol>
<li>String：字符串，使用一对 “” 引起来表示</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  String s1 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;atguigu&#34;</span> <span style="color:#ff79c6">;</span>   			<span style="color:#6272a4">// 字面量的定义方式
</span><span style="color:#6272a4"></span>  String s2 <span style="color:#ff79c6">=</span>  <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;hello&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>     <span style="color:#6272a4">// new 对象的方式
</span></code></pre></div><ol start="2">
<li>
<p>String被声明为final的，不可被继承</p>
</li>
<li>
<p>String实现了Serializable接口：表示字符串是支持序列化的。实现了Comparable接口：表示String可以比较大小</p>
</li>
<li>
<p>String在jdk8及以前内部定义了<code>final char value[]</code>用于存储字符串数据。JDK9时改为<code>byte[]</code></p>
</li>
</ol>
<h2 id="为什么-jdk9-改变了-string-的结构">为什么 JDK9 改变了 String 的结构</h2>
<blockquote>
<p><strong>官方文档</strong>：http://openjdk.java.net/jeps/254</p>
</blockquote>
<p><strong>为什么改为 byte[] 存储？</strong></p>
<ol>
<li>String类的当前实现将字符存储在char数组中，每个字符使用两个字节(16位)。</li>
<li>从许多不同的应用程序收集的数据表明，字符串是堆使用的主要组成部分，而且大多数字符串对象只包含拉丁字符（Latin-1）。这些字符只需要一个字节的存储空间，因此这些字符串对象的内部char数组中有一半的空间将不会使用，产生了大量浪费。</li>
<li>之前 String 类使用 UTF-16 的 char[] 数组存储，现在改为 byte[] 数组 外加一个编码标识存储。该编码表示如果你的字符是ISO-8859-1或者Latin-1，那么只需要一个字节存。如果你是其它字符集，比如UTF-8，你仍然用两个字节存</li>
<li>结论：String再也不用char[] 来存储了，改成了byte [] 加上编码标记，节约了一些空间</li>
<li>同时基于String的数据结构，例如StringBuffer和StringBuilder也同样做了修改</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">// 之前
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">char</span> value<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">;</span>
<span style="color:#6272a4">// 之后
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> value
</code></pre></div><h3 id="string-的基本特性">String 的基本特性</h3>
<ul>
<li>String：代表不可变的字符序列。简称：不可变性。</li>
</ul>
<ol>
<li>当对字符串重新赋值时，需要重写指定内存区域赋值，不能使用原有的value进行赋值。</li>
<li>当对现有的字符串进行连接操作时，也需要重新指定内存区域赋值，不能使用原有的value进行赋值。</li>
<li>当调用String的replace()方法修改指定字符或字符串时，也需要重新指定内存区域赋值，不能使用原有的value进行赋值。</li>
</ol>
<ul>
<li>通过字面量的方式（区别于new）给一个字符串赋值，此时的字符串值声明在字符串常量池中。</li>
</ul>
<p><strong>当对字符串重新赋值时，需要重写指定内存区域赋值，不能使用原有的value进行赋值</strong></p>
<p>代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	@Test
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">test1</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        String s1 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;abc&#34;</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//字面量定义的方式，&#34;abc&#34;存储在字符串常量池中
</span><span style="color:#6272a4"></span>        String s2 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;abc&#34;</span><span style="color:#ff79c6">;</span>
        s1 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;hello&#34;</span><span style="color:#ff79c6">;</span>

        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s1 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//判断地址：true  --&gt; false
</span><span style="color:#6272a4"></span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//abc
</span><span style="color:#6272a4"></span>
    <span style="color:#ff79c6">}</span>
</code></pre></div><p>字节码指令</p>
<ul>
<li>取字符串 “abc” 时，使用的是同一个符号引用：#2</li>
<li>取字符串 “hello” 时，使用的是另一个符号引用：#3</li>
</ul>
<p><strong>当对现有的字符串进行连接操作时，也需要重新指定内存区域赋值，不能使用原有的value进行赋值</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">	@Test
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">test2</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        String s1 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;abc&#34;</span><span style="color:#ff79c6">;</span>
        String s2 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;abc&#34;</span><span style="color:#ff79c6">;</span>
        s2 <span style="color:#ff79c6">+</span><span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;def&#34;</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//abcdef
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//abc
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
</code></pre></div><p><strong>当调用string的replace()方法修改指定字符或字符串时，也需要重新指定内存区域赋值，不能使用原有的value进行赋值</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Test
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">test3</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    String s1 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;abc&#34;</span><span style="color:#ff79c6">;</span>
    String s2 <span style="color:#ff79c6">=</span> s1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">replace</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#39;a&#39;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#39;m&#39;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//abc
</span><span style="color:#6272a4"></span>    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//mbc
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">}</span>
</code></pre></div><p><strong>一道笔试题</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StringExer</span> <span style="color:#ff79c6">{</span>
    String str <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;good&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd">char</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> ch <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#39;t&#39;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#39;e&#39;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#39;s&#39;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#39;t&#39;</span><span style="color:#ff79c6">}</span><span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">change</span><span style="color:#ff79c6">(</span>String str<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">char</span> ch<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        str <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;test ok&#34;</span><span style="color:#ff79c6">;</span>
        ch<span style="color:#ff79c6">[</span>0<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;b&#39;</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        StringExer ex <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> StringExer<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        ex<span style="color:#ff79c6">.</span><span style="color:#50fa7b">change</span><span style="color:#ff79c6">(</span>ex<span style="color:#ff79c6">.</span><span style="color:#50fa7b">str</span><span style="color:#ff79c6">,</span> ex<span style="color:#ff79c6">.</span><span style="color:#50fa7b">ch</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>ex<span style="color:#ff79c6">.</span><span style="color:#50fa7b">str</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//good
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>ex<span style="color:#ff79c6">.</span><span style="color:#50fa7b">ch</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//best
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>

<span style="color:#ff79c6">}</span>
</code></pre></div><p>str 的内容并没有变：“test ok” 位于字符串常量池中的另一个区域（地址），进行赋值操作并没有修改原来 str 指向的引用的内容</p>
<h3 id="string-的底层结构">String 的底层结构</h3>
<p><strong>字符串常量池是不会存储相同内容的字符串的</strong></p>
<ol>
<li>String的String Pool（字符串常量池）是一个固定大小的Hashtable，默认值大小长度是1009。如果放进String Pool的String非常多，就会造成Hash冲突严重，从而导致链表会很长，而链表长了后直接会造成的影响就是当调用String.intern()方法时性能会大幅下降。</li>
<li>使用-XX:StringTablesize可设置StringTable的长度</li>
<li>在JDK6中StringTable是固定的，就是1009的长度，所以如果常量池中的字符串过多就会导致效率下降很快，StringTablesize设置没有要求</li>
<li>在JDK7中，StringTable的长度默认值是60013，StringTablesize设置没有要求</li>
<li>在JDK8中，StringTable的长度默认值是60013，StringTable可以设置的最小值为1009</li>
</ol>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p><strong>测试不同 StringTable 长度下，程序的性能</strong></p>
<p>代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * 产生10万个长度不超过10的字符串，包含a-z,A-Z
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">GenerateString</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
        FileWriter fw <span style="color:#ff79c6">=</span>  <span style="color:#ff79c6">new</span> FileWriter<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;words.txt&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> 100000<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">//1 - 10
</span><span style="color:#6272a4"></span>           <span style="color:#8be9fd">int</span> length <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">(</span>Math<span style="color:#ff79c6">.</span><span style="color:#50fa7b">random</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">(</span>10 <span style="color:#ff79c6">-</span> 1 <span style="color:#ff79c6">+</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> 1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            fw<span style="color:#ff79c6">.</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>getString<span style="color:#ff79c6">(</span>length<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;\n&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>

        fw<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String <span style="color:#50fa7b">getString</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> length<span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
        String str <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> length<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">//65 - 90, 97-122
</span><span style="color:#6272a4"></span>            <span style="color:#8be9fd">int</span> num <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">(</span>Math<span style="color:#ff79c6">.</span><span style="color:#50fa7b">random</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">(</span>90 <span style="color:#ff79c6">-</span> 65 <span style="color:#ff79c6">+</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> 65<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">(</span>Math<span style="color:#ff79c6">.</span><span style="color:#50fa7b">random</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">*</span> 2<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">*</span> 32<span style="color:#ff79c6">;</span>
            str <span style="color:#ff79c6">+</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">char</span><span style="color:#ff79c6">)</span>num<span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">return</span> str<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>

</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StringTest2</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>

        BufferedReader br <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            br <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> BufferedReader<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> FileReader<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;words.txt&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#8be9fd">long</span> start <span style="color:#ff79c6">=</span> System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentTimeMillis</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            String data<span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">while</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>data <span style="color:#ff79c6">=</span> br<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readLine</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
                data<span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">//如果字符串常量池中没有对应data的字符串的话，则在常量池中生成
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">}</span>

            <span style="color:#8be9fd">long</span> end <span style="color:#ff79c6">=</span> System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentTimeMillis</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;花费的时间为：&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">(</span>end <span style="color:#ff79c6">-</span> start<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//1009:143ms  100009:47ms
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>br <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                    br<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>

            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>

</code></pre></div><ul>
<li>
<p>-XX:StringTableSize=1009 ：程序耗时 143ms</p>
</li>
<li>
<p>-XX:StringTableSize=100009 ：程序耗时 47ms</p>
</li>
</ul>
<h2 id="string-的内存分配">String 的内存分配</h2>
<ol>
<li>
<p>在Java语言中有8种基本数据类型和一种比较特殊的类型String。这些类型为了使它们在运行过程中速度更快、更节省内存，都提供了一种常量池的概念。</p>
</li>
<li>
<p>常量池就类似一个Java系统级别提供的缓存。8种基本数据类型的常量池都是系统协调的，String类型的常量池比较特殊。它的主要使用方法有两种。</p>
<ul>
<li>
<p>直接使用双引号声明出来的String对象会直接存储在常量池中。比如：<code>String info=&quot;atguigu.com&quot;;</code></p>
</li>
<li>
<p>如果不是用双引号声明的String对象，可以使用String提供的intern()方法。这个后面重点谈</p>
</li>
</ul>
</li>
<li>
<p>Java 6及以前，字符串常量池存放在永久代</p>
</li>
<li>
<p>Java 7中 Oracle的工程师对字符串池的逻辑做了很大的改变，即将字符串常量池的位置调整到Java堆内</p>
<ul>
<li>所有的字符串都保存在堆（Heap）中，和其他普通对象一样，这样可以让你在进行调优应用时仅需要调整堆大小就可以了。</li>
<li>字符串常量池概念原本使用得比较多，但是这个改动使得我们有足够的理由让我们重新考虑在Java 7中使用String.intern()。</li>
</ul>
</li>
<li>
<p>Java8元空间，字符串常量在堆</p>
</li>
</ol>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h3 id="stringtable-为什么要调整">StringTable 为什么要调整？</h3>
<blockquote>
<p><strong>官方文档</strong>:https://www.oracle.com/java/technologies/javase/jdk7-relnotes.html#jdk7changes</p>
</blockquote>
<ol>
<li>为什么要调整位置？
<ul>
<li>永久代的默认空间大小比较小</li>
<li>永久代垃圾回收频率低，大量的字符串无法及时回收，容易进行Full GC产生STW或者容易产生OOM：PermGen Space</li>
<li>堆中空间足够大，字符串可被及时回收</li>
</ul>
</li>
<li>在JDK 7中，interned字符串不再在Java堆的永久代中分配，而是在Java堆的主要部分（称为年轻代和年老代）中分配，与应用程序创建的其他对象一起分配。</li>
<li>此更改将导致驻留在主Java堆中的数据更多，驻留在永久生成中的数据更少，因此可能需要调整堆大小。</li>
</ol>
<p><strong>代码示例</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * jdk6中：
</span><span style="color:#6272a4"> * -XX:PermSize=6m -XX:MaxPermSize=6m -Xms6m -Xmx6m
</span><span style="color:#6272a4"> *
</span><span style="color:#6272a4"> * jdk8中：
</span><span style="color:#6272a4"> * -XX:MetaspaceSize=6m -XX:MaxMetaspaceSize=6m -Xms6m -Xmx6m
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StringTest3</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//使用Set保持着常量池引用，避免full gc回收常量池行为
</span><span style="color:#6272a4"></span>        Set<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> set <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashSet<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">//在short可以取值的范围内足以让6MB的PermSize或heap产生OOM了。
</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd">short</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">while</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
            set<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>输出结果：我真没骗你，字符串真的在堆中（JDK8）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Exception in thread <span style="color:#f1fa8c">&#34;main&#34;</span> java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">lang</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">OutOfMemoryError</span><span style="color:#ff79c6">:</span> Java heap space
	at java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">util</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">HashMap</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">resize</span><span style="color:#ff79c6">(</span>HashMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">java</span><span style="color:#ff79c6">:</span>703<span style="color:#ff79c6">)</span>
	at java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">util</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">HashMap</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">putVal</span><span style="color:#ff79c6">(</span>HashMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">java</span><span style="color:#ff79c6">:</span>662<span style="color:#ff79c6">)</span>
	at java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">util</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">HashMap</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>HashMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">java</span><span style="color:#ff79c6">:</span>611<span style="color:#ff79c6">)</span>
	at java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">util</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">HashSet</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>HashSet<span style="color:#ff79c6">.</span><span style="color:#50fa7b">java</span><span style="color:#ff79c6">:</span>219<span style="color:#ff79c6">)</span>
	at com<span style="color:#ff79c6">.</span><span style="color:#50fa7b">atguigu</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">java</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">StringTest3</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>StringTest3<span style="color:#ff79c6">.</span><span style="color:#50fa7b">java</span><span style="color:#ff79c6">:</span>22<span style="color:#ff79c6">)</span>

Process finished with exit code 1
</code></pre></div><h2 id="string-的基本操作">String 的基本操作</h2>
<p>Java语言规范里要求完全相同的字符串字面量，应该包含同样的Unicode字符序列（包含同一份码点序列的常量），并且必须是指向同一个String类实例。</p>
<h3 id="举例1">举例1</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StringTest4</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//2293
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;1&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//2294
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;2&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;3&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;4&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;5&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;6&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;7&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;8&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;9&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;10&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//2303
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">//如下的字符串&#34;1&#34; 到 &#34;10&#34;不会再次加载
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;1&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//2304
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;2&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//2304
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;3&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;4&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;5&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;6&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;7&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;8&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;9&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;10&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//2304
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>分析字符串常量池的变化</p>
<p>1、程序启动时已经加载了 2293 个字符串常量</p>
<!-- raw HTML omitted -->
<p>2、加载了一个换行符（println），所以多了一个</p>
<!-- raw HTML omitted -->
<p>3、加载了字符串常量 “1”~“9”</p>
<!-- raw HTML omitted -->
<p>4、加载字符串常量 “10”</p>
<!-- raw HTML omitted -->
<p>5、之后的字符串&quot;1&rdquo; 到 &ldquo;10&quot;不会再次加载</p>
<!-- raw HTML omitted -->
<h3 id="举例2">举例2</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">//官方示例代码
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Memory</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span><span style="color:#6272a4">//line 1
</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 1<span style="color:#ff79c6">;</span><span style="color:#6272a4">//line 2
</span><span style="color:#6272a4"></span>        Object obj <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Object<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//line 3
</span><span style="color:#6272a4"></span>        Memory mem <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Memory<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//line 4
</span><span style="color:#6272a4"></span>        mem<span style="color:#ff79c6">.</span><span style="color:#50fa7b">foo</span><span style="color:#ff79c6">(</span>obj<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//line 5
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span><span style="color:#6272a4">//line 9
</span><span style="color:#6272a4"></span>
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">foo</span><span style="color:#ff79c6">(</span>Object param<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span><span style="color:#6272a4">//line 6
</span><span style="color:#6272a4"></span>        String str <span style="color:#ff79c6">=</span> param<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//line 7
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>str<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span><span style="color:#6272a4">//line 8
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">}</span>
</code></pre></div><p>分析运行时内存（foo() 方法是实例方法，其实图中少了一个 this 局部变量）</p>
<!-- raw HTML omitted -->
<h2 id="字符串拼接操作">字符串拼接操作</h2>
<h3 id="先说结论">先说结论</h3>
<ol>
<li>常量与常量的拼接结果在常量池，原理是编译期优化</li>
<li>常量池中不会存在相同内容的变量</li>
<li>拼接前后，只要其中有一个是变量，结果就在堆中。变量拼接的原理是StringBuilder</li>
<li>如果拼接的结果调用intern()方法，根据该字符串是否在常量池中存在，分为：
<ul>
<li>如果存在，则返回字符串在常量池中的地址</li>
<li>如果字符串常量池中不存在该字符串，则在常量池中创建一份，并返回此对象的地址</li>
</ul>
</li>
</ol>
<p><strong>1、常量与常量的拼接结果在常量池，原理是编译期优化</strong></p>
<p>代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Test
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">test1</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
        String s1 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;a&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;b&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;c&#34;</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//编译期优化：等同于&#34;abc&#34;
</span><span style="color:#6272a4"></span>        String s2 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;abc&#34;</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">//&#34;abc&#34;一定是放在字符串常量池中，将此地址赋给s2
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">/*
</span><span style="color:#6272a4">         * 最终.java编译成.class,再执行.class
</span><span style="color:#6272a4">         * String s1 = &#34;abc&#34;;
</span><span style="color:#6272a4">         * String s2 = &#34;abc&#34;
</span><span style="color:#6272a4">         */</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s1 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">//true
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>s2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">//true
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
</code></pre></div><p>从字节码指令看出：编译器做了优化，将 “a” + “b” + “c” 优化成了 “abc”</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">0 ldc #2 <span style="color:#ff79c6">&lt;</span>abc<span style="color:#ff79c6">&gt;</span>
2 astore_1
3 ldc #2 <span style="color:#ff79c6">&lt;</span>abc<span style="color:#ff79c6">&gt;</span>
5 astore_2
6 getstatic #3 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">&gt;</span>
9 aload_1
10 aload_2
11 if_acmpne <span style="color:#50fa7b">18</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>7<span style="color:#ff79c6">)</span>
14 iconst_1
15 <span style="color:#ff79c6">goto</span> <span style="color:#50fa7b">19</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>4<span style="color:#ff79c6">)</span>
18 iconst_0
19 invokevirtual #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>io<span style="color:#ff79c6">/</span>PrintStream<span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">&gt;</span>
22 getstatic #3 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">&gt;</span>
25 aload_1
26 aload_2
27 invokevirtual #5 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">&gt;</span>
30 invokevirtual #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>io<span style="color:#ff79c6">/</span>PrintStream<span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">&gt;</span>
33 <span style="color:#ff79c6">return</span>
</code></pre></div><p>IDEA 反编译 class 文件后，来看这个问题</p>
<!-- raw HTML omitted -->
<p><strong>2、拼接前后，只要其中有一个是变量，结果就在堆中</strong></p>
<p><strong>调用 intern() 方法，则主动将字符串对象存入字符串常量池中，并将其地址返回</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Test
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">test2</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
        String s1 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;javaEE&#34;</span><span style="color:#ff79c6">;</span>
        String s2 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;hadoop&#34;</span><span style="color:#ff79c6">;</span>

        String s3 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;javaEEhadoop&#34;</span><span style="color:#ff79c6">;</span>
        String s4 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;javaEE&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;hadoop&#34;</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//编译期优化
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">//如果拼接符号的前后出现了变量，则相当于在堆空间中new String()，具体的内容为拼接的结果：javaEEhadoop
</span><span style="color:#6272a4"></span>        String s5 <span style="color:#ff79c6">=</span> s1 <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;hadoop&#34;</span><span style="color:#ff79c6">;</span>
        String s6 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;javaEE&#34;</span> <span style="color:#ff79c6">+</span> s2<span style="color:#ff79c6">;</span>
        String s7 <span style="color:#ff79c6">=</span> s1 <span style="color:#ff79c6">+</span> s2<span style="color:#ff79c6">;</span>

        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s3 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s4<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//true
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s3 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s5<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//false
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s3 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s6<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//false
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s3 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s7<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//false
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s5 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s6<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//false
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s5 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s7<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//false
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s6 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s7<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//false
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">//intern():判断字符串常量池中是否存在javaEEhadoop值，如果存在，则返回常量池中javaEEhadoop的地址；
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">//如果字符串常量池中不存在javaEEhadoop，则在常量池中加载一份javaEEhadoop，并返回次对象的地址。
</span><span style="color:#6272a4"></span>        String s8 <span style="color:#ff79c6">=</span> s6<span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s3 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s8<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//true
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>

</code></pre></div><p>从字节码角度来看：拼接前后有变量，都会使用到 StringBuilder 类</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">0 ldc #6 <span style="color:#ff79c6">&lt;</span>javaEE<span style="color:#ff79c6">&gt;</span>
2 astore_1
3 ldc #7 <span style="color:#ff79c6">&lt;</span>hadoop<span style="color:#ff79c6">&gt;</span>
5 astore_2
6 ldc #8 <span style="color:#ff79c6">&lt;</span>javaEEhadoop<span style="color:#ff79c6">&gt;</span>
8 astore_3
9 ldc #8 <span style="color:#ff79c6">&lt;</span>javaEEhadoop<span style="color:#ff79c6">&gt;</span>
11 astore 4
13 <span style="color:#ff79c6">new</span> #9 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">&gt;</span>
16 dup
17 invokespecial #10 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#ff79c6">&lt;</span>init<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">&gt;</span>
20 aload_1
21 invokevirtual #11 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">&gt;</span>
24 ldc #7 <span style="color:#ff79c6">&lt;</span>hadoop<span style="color:#ff79c6">&gt;</span>
26 invokevirtual #11 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">&gt;</span>
29 invokevirtual #12 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">&gt;</span>
32 astore 5
34 <span style="color:#ff79c6">new</span> #9 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">&gt;</span>
37 dup
38 invokespecial #10 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#ff79c6">&lt;</span>init<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">&gt;</span>
41 ldc #6 <span style="color:#ff79c6">&lt;</span>javaEE<span style="color:#ff79c6">&gt;</span>
43 invokevirtual #11 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">&gt;</span>
46 aload_2
47 invokevirtual #11 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">&gt;</span>
50 invokevirtual #12 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">&gt;</span>
53 astore 6
55 <span style="color:#ff79c6">new</span> #9 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">&gt;</span>
58 dup
59 invokespecial #10 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#ff79c6">&lt;</span>init<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">&gt;</span>
62 aload_1
63 invokevirtual #11 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">&gt;</span>
66 aload_2
67 invokevirtual #11 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">&gt;</span>
70 invokevirtual #12 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">&gt;</span>
73 astore 7
75 getstatic #3 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">&gt;</span>
78 aload_3
79 aload 4
81 if_acmpne <span style="color:#50fa7b">88</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>7<span style="color:#ff79c6">)</span>
84 iconst_1
85 <span style="color:#ff79c6">goto</span> <span style="color:#50fa7b">89</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>4<span style="color:#ff79c6">)</span>
88 iconst_0
89 invokevirtual #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>io<span style="color:#ff79c6">/</span>PrintStream<span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">&gt;</span>
92 getstatic #3 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">&gt;</span>
95 aload_3
96 aload 5
98 if_acmpne <span style="color:#50fa7b">105</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>7<span style="color:#ff79c6">)</span>
101 iconst_1
102 <span style="color:#ff79c6">goto</span> <span style="color:#50fa7b">106</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>4<span style="color:#ff79c6">)</span>
105 iconst_0
106 invokevirtual #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>io<span style="color:#ff79c6">/</span>PrintStream<span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">&gt;</span>
109 getstatic #3 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">&gt;</span>
112 aload_3
113 aload 6
115 if_acmpne <span style="color:#50fa7b">122</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>7<span style="color:#ff79c6">)</span>
118 iconst_1
119 <span style="color:#ff79c6">goto</span> <span style="color:#50fa7b">123</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>4<span style="color:#ff79c6">)</span>
122 iconst_0
123 invokevirtual #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>io<span style="color:#ff79c6">/</span>PrintStream<span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">&gt;</span>
126 getstatic #3 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">&gt;</span>
129 aload_3
130 aload 7
132 if_acmpne <span style="color:#50fa7b">139</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>7<span style="color:#ff79c6">)</span>
135 iconst_1
136 <span style="color:#ff79c6">goto</span> <span style="color:#50fa7b">140</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>4<span style="color:#ff79c6">)</span>
139 iconst_0
140 invokevirtual #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>io<span style="color:#ff79c6">/</span>PrintStream<span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">&gt;</span>
143 getstatic #3 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">&gt;</span>
146 aload 5
148 aload 6
150 if_acmpne <span style="color:#50fa7b">157</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>7<span style="color:#ff79c6">)</span>
153 iconst_1
154 <span style="color:#ff79c6">goto</span> <span style="color:#50fa7b">158</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>4<span style="color:#ff79c6">)</span>
157 iconst_0
158 invokevirtual #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>io<span style="color:#ff79c6">/</span>PrintStream<span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">&gt;</span>
161 getstatic #3 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">&gt;</span>
164 aload 5
166 aload 7
168 if_acmpne <span style="color:#50fa7b">175</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>7<span style="color:#ff79c6">)</span>
171 iconst_1
172 <span style="color:#ff79c6">goto</span> <span style="color:#50fa7b">176</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>4<span style="color:#ff79c6">)</span>
175 iconst_0
176 invokevirtual #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>io<span style="color:#ff79c6">/</span>PrintStream<span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">&gt;</span>
179 getstatic #3 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">&gt;</span>
182 aload 6
184 aload 7
186 if_acmpne <span style="color:#50fa7b">193</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>7<span style="color:#ff79c6">)</span>
189 iconst_1
190 <span style="color:#ff79c6">goto</span> <span style="color:#50fa7b">194</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>4<span style="color:#ff79c6">)</span>
193 iconst_0
194 invokevirtual #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>io<span style="color:#ff79c6">/</span>PrintStream<span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">&gt;</span>
197 aload 6
199 invokevirtual #13 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">&gt;</span>
202 astore 8
204 getstatic #3 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">&gt;</span>
207 aload_3
208 aload 8
210 if_acmpne <span style="color:#50fa7b">217</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>7<span style="color:#ff79c6">)</span>
213 iconst_1
214 <span style="color:#ff79c6">goto</span> <span style="color:#50fa7b">218</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>4<span style="color:#ff79c6">)</span>
217 iconst_0
218 invokevirtual #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>io<span style="color:#ff79c6">/</span>PrintStream<span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">&gt;</span>
221 <span style="color:#ff79c6">return</span>
</code></pre></div><h3 id="字符串拼接的底层细节">字符串拼接的底层细节</h3>
<p><strong>举例1</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    @Test
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">test3</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
        String s1 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;a&#34;</span><span style="color:#ff79c6">;</span>
        String s2 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;b&#34;</span><span style="color:#ff79c6">;</span>
        String s3 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ab&#34;</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">/*
</span><span style="color:#6272a4">        如下的s1 + s2 的执行细节：(变量s是我临时定义的）
</span><span style="color:#6272a4">        ① StringBuilder s = new StringBuilder();
</span><span style="color:#6272a4">        ② s.append(&#34;a&#34;)
</span><span style="color:#6272a4">        ③ s.append(&#34;b&#34;)
</span><span style="color:#6272a4">        ④ s.toString()  --&gt; 约等于 new String(&#34;ab&#34;)，但不等价
</span><span style="color:#6272a4">
</span><span style="color:#6272a4">        补充：在jdk5.0之后使用的是StringBuilder,在jdk5.0之前使用的是StringBuffer
</span><span style="color:#6272a4">         */</span>
        String s4 <span style="color:#ff79c6">=</span> s1 <span style="color:#ff79c6">+</span> s2<span style="color:#ff79c6">;</span><span style="color:#6272a4">//
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s3 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s4<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//false
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
</code></pre></div><p>字节码指令</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">0 ldc #14 <span style="color:#ff79c6">&lt;</span>a<span style="color:#ff79c6">&gt;</span>
2 astore_1
3 ldc #15 <span style="color:#ff79c6">&lt;</span>b<span style="color:#ff79c6">&gt;</span>
5 astore_2
6 ldc #16 <span style="color:#ff79c6">&lt;</span>ab<span style="color:#ff79c6">&gt;</span>
8 astore_3
9 <span style="color:#ff79c6">new</span> #9 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">&gt;</span>
12 dup
13 invokespecial #10 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#ff79c6">&lt;</span>init<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">&gt;</span>
16 aload_1
17 invokevirtual #11 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">&gt;</span>
20 aload_2
21 invokevirtual #11 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">&gt;</span>
24 invokevirtual #12 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">&gt;</span>
27 astore 4
29 getstatic #3 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">&gt;</span>
32 aload_3
33 aload 4
35 if_acmpne <span style="color:#50fa7b">42</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>7<span style="color:#ff79c6">)</span>
38 iconst_1
39 <span style="color:#ff79c6">goto</span> <span style="color:#50fa7b">43</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>4<span style="color:#ff79c6">)</span>
42 iconst_0
43 invokevirtual #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>io<span style="color:#ff79c6">/</span>PrintStream<span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">&gt;</span>
46 <span style="color:#ff79c6">return</span>
</code></pre></div><p><strong>举例2</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/*
</span><span style="color:#6272a4">    1. 字符串拼接操作不一定使用的是StringBuilder!
</span><span style="color:#6272a4">       如果拼接符号左右两边都是字符串常量或常量引用，则仍然使用编译期优化，即非StringBuilder的方式。
</span><span style="color:#6272a4">    2. 针对于final修饰类、方法、基本数据类型、引用数据类型的量的结构时，能使用上final的时候建议使用上。
</span><span style="color:#6272a4">     */</span>
    @Test
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">test4</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
        <span style="color:#8be9fd;font-style:italic">final</span> String s1 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;a&#34;</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd;font-style:italic">final</span> String s2 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;b&#34;</span><span style="color:#ff79c6">;</span>
        String s3 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ab&#34;</span><span style="color:#ff79c6">;</span>
        String s4 <span style="color:#ff79c6">=</span> s1 <span style="color:#ff79c6">+</span> s2<span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s3 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s4<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//true
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
</code></pre></div><p>从字节码角度来看：为变量 s4 赋值时，直接使用 #16 符号引用，即字符串常量 “ab”</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">0 ldc #14 <span style="color:#ff79c6">&lt;</span>a<span style="color:#ff79c6">&gt;</span>
2 astore_1
3 ldc #15 <span style="color:#ff79c6">&lt;</span>b<span style="color:#ff79c6">&gt;</span>
5 astore_2
6 ldc #16 <span style="color:#ff79c6">&lt;</span>ab<span style="color:#ff79c6">&gt;</span>
8 astore_3
9 ldc #16 <span style="color:#ff79c6">&lt;</span>ab<span style="color:#ff79c6">&gt;</span>
11 astore 4
13 getstatic #3 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">&gt;</span>
16 aload_3
17 aload 4
19 if_acmpne <span style="color:#50fa7b">26</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>7<span style="color:#ff79c6">)</span>
22 iconst_1
23 <span style="color:#ff79c6">goto</span> <span style="color:#50fa7b">27</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">+</span>4<span style="color:#ff79c6">)</span>
26 iconst_0
27 invokevirtual #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>io<span style="color:#ff79c6">/</span>PrintStream<span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">&gt;</span>
30 <span style="color:#ff79c6">return</span>
</code></pre></div><p><strong>拼接操作与 append 操作的效率对比</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">
    @Test
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">test6</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>

        <span style="color:#8be9fd">long</span> start <span style="color:#ff79c6">=</span> System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentTimeMillis</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

<span style="color:#6272a4">//        method1(100000);//4014
</span><span style="color:#6272a4"></span>        method2<span style="color:#ff79c6">(</span>100000<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//7
</span><span style="color:#6272a4"></span>
        <span style="color:#8be9fd">long</span> end <span style="color:#ff79c6">=</span> System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentTimeMillis</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;花费的时间为：&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">(</span>end <span style="color:#ff79c6">-</span> start<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">method1</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> highLevel<span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
        String src <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">for</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>i <span style="color:#ff79c6">&lt;</span> highLevel<span style="color:#ff79c6">;</span>i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
            src <span style="color:#ff79c6">=</span> src <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;a&#34;</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//每次循环都会创建一个StringBuilder、String
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">}</span>
<span style="color:#6272a4">//        System.out.println(src);
</span><span style="color:#6272a4"></span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">method2</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> highLevel<span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//只需要创建一个StringBuilder
</span><span style="color:#6272a4"></span>        StringBuilder src <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> StringBuilder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> highLevel<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            src<span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;a&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
<span style="color:#6272a4">//        System.out.println(src);
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
</code></pre></div><ol>
<li>
<p>体会执行效率：通过StringBuilder的append()的方式添加字符串的效率要远高于使用String的字符串拼接方式！</p>
</li>
<li>
<p>原因：</p>
<ol>
<li>StringBuilder的append()的方式：
<ul>
<li>自始至终中只创建过一个StringBuilder的对象</li>
</ul>
</li>
<li>使用String的字符串拼接方式：
<ul>
<li>创建过多个StringBuilder和String（调的toString方法）的对象，内存占用更大；</li>
<li>如果进行GC，需要花费额外的时间（在拼接的过程中产生的一些中间字符串可能永远也用不到，会产生大量垃圾字符串）。</li>
</ul>
</li>
</ol>
</li>
<li>
<p>改进的空间：</p>
<ul>
<li>在实际开发中，如果基本确定要前前后后添加的字符串长度不高于某个限定值highLevel的情况下，建议使用构造器实例化：</li>
<li><code>StringBuilder s = new StringBuilder(highLevel); //new char[highLevel]</code></li>
<li>这样可以避免频繁扩容</li>
</ul>
</li>
</ol>
<h2 id="intern-的使用">intern() 的使用</h2>
<h3 id="intern-方法的说明">intern() 方法的说明</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">native</span> String <span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><ol>
<li>
<p>intern是一个native方法，调用的是底层C的方法</p>
</li>
<li>
<p>字符串常量池池最初是空的，由String类私有地维护。在调用intern方法时，如果池中已经包含了由equals(object)方法确定的与该字符串内容相等的字符串，则返回池中的字符串地址。否则，该字符串对象将被添加到池中，并返回对该字符串对象的地址。（这是源码里的大概翻译）</p>
</li>
<li>
<p>如果不是用双引号声明的String对象，可以使用String提供的intern方法：intern方法会从字符串常量池中查询当前字符串是否存在，若不存在就会将当前字符串放入常量池中。比如：</p>
<pre><code>String myInfo = new string(&quot;I love atguigu&quot;).intern();
</code></pre>
</li>
<li>
<p>也就是说，如果在任意字符串上调用String.intern方法，那么其返回结果所指向的那个类实例，必须和直接以常量形式出现的字符串实例完全相同。因此，下列表达式的值必定是true</p>
<pre><code>(&quot;a&quot;+&quot;b&quot;+&quot;c&quot;).intern()==&quot;abc&quot;
</code></pre>
</li>
<li>
<p>通俗点讲，Interned String就是确保字符串在内存里只有一份拷贝，这样可以节约内存空间，加快字符串操作任务的执行速度。注意，这个值会被存放在字符串内部池（String Intern Pool）</p>
</li>
</ol>
<h3 id="new-string-的说明">new String() 的说明</h3>
<h4 id="new-stringab会创建几个对象">new String(“ab”)会创建几个对象？</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * 题目：
</span><span style="color:#6272a4"> * new String(&#34;ab&#34;)会创建几个对象？看字节码，就知道是两个。
</span><span style="color:#6272a4"> *     一个对象是：new关键字在堆空间创建的
</span><span style="color:#6272a4"> *     另一个对象是：字符串常量池中的对象&#34;ab&#34;。 字节码指令：ldc
</span><span style="color:#6272a4"> *
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StringNewTest</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        String str <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;ab&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>字节码指令</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">0 <span style="color:#ff79c6">new</span> #2 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>String<span style="color:#ff79c6">&gt;</span>
3 dup
4 ldc #3 <span style="color:#ff79c6">&lt;</span>ab<span style="color:#ff79c6">&gt;</span>
6 invokespecial #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>String<span style="color:#ff79c6">.</span><span style="color:#ff79c6">&lt;</span>init<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">&gt;</span>
9 astore_1
10 <span style="color:#ff79c6">return</span>
</code></pre></div><p><code>0 new #2 &lt;java/lang/String&gt;</code>：在堆中创建了一个 String 对象</p>
<p><code>4 ldc #3 &lt;ab&gt;</code> ：在字符串常量池中放入 “ab”（如果之前字符串常量池中没有 “ab” 的话）</p>
<h4 id="new-stringa--new-stringb-会创建几个对象">new String(“a”) + new String(“b”) 会创建几个对象？</h4>
<p>代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * 思考：
</span><span style="color:#6272a4"> * new String(&#34;a&#34;) + new String(&#34;b&#34;)呢？
</span><span style="color:#6272a4"> *  对象1：new StringBuilder()
</span><span style="color:#6272a4"> *  对象2： new String(&#34;a&#34;)
</span><span style="color:#6272a4"> *  对象3： 常量池中的&#34;a&#34;
</span><span style="color:#6272a4"> *  对象4： new String(&#34;b&#34;)
</span><span style="color:#6272a4"> *  对象5： 常量池中的&#34;b&#34;
</span><span style="color:#6272a4"> *
</span><span style="color:#6272a4"> *  深入剖析： StringBuilder的toString():
</span><span style="color:#6272a4"> *      对象6 ：new String(&#34;ab&#34;)
</span><span style="color:#6272a4"> *       强调一下，toString()的调用，在字符串常量池中，没有生成&#34;ab&#34;
</span><span style="color:#6272a4"> *
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StringNewTest</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>

        String str <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;a&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;b&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>字节码指令</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">0 <span style="color:#ff79c6">new</span> #2 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">&gt;</span>
3 dup
4 invokespecial #3 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#ff79c6">&lt;</span>init<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">&gt;</span>
7 <span style="color:#ff79c6">new</span> #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>String<span style="color:#ff79c6">&gt;</span>
10 dup
11 ldc #5 <span style="color:#ff79c6">&lt;</span>a<span style="color:#ff79c6">&gt;</span>
13 invokespecial #6 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>String<span style="color:#ff79c6">.</span><span style="color:#ff79c6">&lt;</span>init<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">&gt;</span>
16 invokevirtual #7 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">&gt;</span>
19 <span style="color:#ff79c6">new</span> #4 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>String<span style="color:#ff79c6">&gt;</span>
22 dup
23 ldc #8 <span style="color:#ff79c6">&lt;</span>b<span style="color:#ff79c6">&gt;</span>
25 invokespecial #6 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>String<span style="color:#ff79c6">.</span><span style="color:#ff79c6">&lt;</span>init<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">&gt;</span>
28 invokevirtual #7 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">&gt;</span>
31 invokevirtual #9 <span style="color:#ff79c6">&lt;</span>java<span style="color:#ff79c6">/</span>lang<span style="color:#ff79c6">/</span>StringBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">&gt;</span>
34 astore_1
35 <span style="color:#ff79c6">return</span>
</code></pre></div><p><strong>答案是4个或5个或6个</strong></p>
<p>字节码指令分析：</p>
<ol>
<li><code>0 new #2 &lt;java/lang/StringBuilder&gt;</code> ：拼接字符串会创建一个 StringBuilder 对象</li>
<li><code>7 new #4 &lt;java/lang/String&gt;</code> ：创建 String 对象，对应于 new String(“a”)</li>
<li><code>11 ldc #5 &lt;a&gt;</code> ：在字符串常量池中放入 “a”（如果之前字符串常量池中没有 “a” 的话）</li>
<li><code>19 new #4 &lt;java/lang/String&gt;</code> ：创建 String 对象，对应于 new String(“b”)</li>
<li><code>23 ldc #8 &lt;b&gt;</code> ：在字符串常量池中放入 “b”（如果之前字符串常量池中没有 “b” 的话）</li>
<li><code>31 invokevirtual #9 &lt;java/lang/StringBuilder.toString&gt;</code> ：调用 StringBuilder 的 toString() 方法，会生成一个 String 对象</li>
</ol>
<!-- raw HTML omitted -->
<h3 id="有点难的面试题">有点难的面试题</h3>
<blockquote>
<p><strong>有点难的面试题</strong></p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#ff79c6">*</span><span style="color:#ff79c6">*</span>
 <span style="color:#ff79c6">*</span> 如何保证变量s指向的是字符串常量池中的数据呢？
 <span style="color:#ff79c6">*</span> 有两种方式：
 <span style="color:#ff79c6">*</span> 方式一： String s <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;shkstart&#34;</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//字面量定义的方式
</span><span style="color:#6272a4"></span> <span style="color:#ff79c6">*</span> 方式二： 调用intern<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
 <span style="color:#ff79c6">*</span>         String s <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;shkstart&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
 <span style="color:#ff79c6">*</span>         String s <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> StringBuilder<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;shkstart&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
 <span style="color:#ff79c6">*</span>
 <span style="color:#ff79c6">*</span><span style="color:#ff79c6">/</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> 	<span style="color:#50fa7b">StringIntern</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>

        String s <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;1&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//调用此方法之前，字符串常量池中已经存在了&#34;1&#34;
</span><span style="color:#6272a4"></span>        String s2 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;1&#34;</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//jdk6：false   jdk7/8：false
</span><span style="color:#6272a4"></span>        
        <span style="color:#6272a4">/*
</span><span style="color:#6272a4">         1、s3变量记录的地址为：new String(&#34;11&#34;)
</span><span style="color:#6272a4">         2、经过上面的分析，我们已经知道执行完pos_1的代码，在堆中有了一个new String(&#34;11&#34;)
</span><span style="color:#6272a4">         这样的String对象。但是在字符串常量池中没有&#34;11&#34;
</span><span style="color:#6272a4">         3、接着执行s3.intern()，在字符串常量池中生成&#34;11&#34;
</span><span style="color:#6272a4">           3-1、在JDK6的版本中，字符串常量池还在永久代，所以直接在永久代生成&#34;11&#34;,也就有了新的地址
</span><span style="color:#6272a4">           3-2、而在JDK7的后续版本中，字符串常量池被移动到了堆中，此时堆里已经有new String（&#34;11&#34;）了
</span><span style="color:#6272a4">           出于节省空间的目的，直接将堆中的那个字符串的引用地址储存在字符串常量池中。没错，字符串常量池
</span><span style="color:#6272a4">           中存的是new String（&#34;11&#34;）在堆中的地址
</span><span style="color:#6272a4">         4、所以在JDK7后续版本中，s3和s4指向的完全是同一个地址。
</span><span style="color:#6272a4">         */</span>
        String s3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;1&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;1&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//pos_1
</span><span style="color:#6272a4"></span>	    s3<span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        
        String s4 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;11&#34;</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//s4变量记录的地址：使用的是上一行代码代码执行时，在常量池中生成的&#34;11&#34;的地址
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s3 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s4<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//jdk6：false  jdk7/8：true
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>


<span style="color:#ff79c6">}</span>

</code></pre></div><p>解释的已经比较清楚了，下面看一下内存图</p>
<p><strong>内存分析</strong></p>
<p>JDK6 ：正常眼光判断即可</p>
<ul>
<li>new String() 即在堆中</li>
<li>str.intern() 则把字符串放入常量池中</li>
</ul>
<!-- raw HTML omitted -->
<p>JDK7及后续版本，<strong>注意大坑</strong></p>
<!-- raw HTML omitted -->
<h4 id="面试题的拓展">面试题的拓展</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * StringIntern.java中练习的拓展：
</span><span style="color:#6272a4"> *
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StringIntern1</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//执行完下一行代码以后，字符串常量池中，是否存在&#34;11&#34;呢？答案：不存在！！
</span><span style="color:#6272a4"></span>        String s3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;1&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;1&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//new String(&#34;11&#34;)
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">//在字符串常量池中生成对象&#34;11&#34;，代码顺序换一下，实打实的在字符串常量池里有一个&#34;11&#34;对象
</span><span style="color:#6272a4"></span>        String s4 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;11&#34;</span><span style="color:#ff79c6">;</span>  
        String s5 <span style="color:#ff79c6">=</span> s3<span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#6272a4">// s3 是堆中的 &#34;ab&#34; ，s4 是字符串常量池中的 &#34;ab&#34;
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s3 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s4<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//false
</span><span style="color:#6272a4"></span>
        <span style="color:#6272a4">// s5 是从字符串常量池中取回来的引用，当然和 s4 相等
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s5 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s4<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//true
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="intern-方法的练习">intern() 方法的练习</h3>
<p><strong>练习 1</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StringExer1</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        String x <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ab&#34;</span><span style="color:#ff79c6">;</span>
        String s <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;a&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;b&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//new String(&#34;ab&#34;)
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">//在上一行代码执行完以后，字符串常量池中并没有&#34;ab&#34;
</span><span style="color:#6272a4"></span>		<span style="color:#6272a4">/*
</span><span style="color:#6272a4">		1、jdk6中：在字符串常量池（此时在永久代）中创建一个字符串&#34;ab&#34;
</span><span style="color:#6272a4">        2、jdk8中：字符串常量池（此时在堆中）中没有创建字符串&#34;ab&#34;,而是创建一个引用，指向new String(&#34;ab&#34;)，		  将此引用返回
</span><span style="color:#6272a4">        3、详解看上面
</span><span style="color:#6272a4">		*/</span>
        String s2 <span style="color:#ff79c6">=</span> s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s2 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ab&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//jdk6:true  jdk8:true
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ab&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//jdk6:false  jdk8:true
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p><strong>JDK6</strong></p>
<p>
  <img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_009/0015.png" alt="image-20201116113423492">

</p>
<p><strong>JDK7/8</strong></p>
<!-- raw HTML omitted -->
<p><strong>练习2</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StringExer1</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//加一行这个
</span><span style="color:#6272a4"></span>        String x <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ab&#34;</span><span style="color:#ff79c6">;</span>
        String s <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;a&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;b&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//new String(&#34;ab&#34;)
</span><span style="color:#6272a4"></span>
        String s2 <span style="color:#ff79c6">=</span> s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s2 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ab&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//jdk6:true  jdk8:true
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ab&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//jdk6:false  jdk8:true
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><!-- raw HTML omitted -->
<p><strong>练习3</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StringExer2</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        String s1 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;ab&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//执行完以后，会在字符串常量池中会生成&#34;ab&#34;
</span><span style="color:#6272a4"></span>
        s1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        String s2 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ab&#34;</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s1 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//false
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p><strong>验证</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StringExer2</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">// 对象内存地址可以使用System.identityHashCode(object)方法获取
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        String s1 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;a&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;b&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span><span style="color:#6272a4">//执行完以后，不会在字符串常量池中会生成&#34;ab&#34;
</span><span style="color:#6272a4"></span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">identityHashCode</span><span style="color:#ff79c6">(</span>s1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        s1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">identityHashCode</span><span style="color:#ff79c6">(</span>s1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        String s2 <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;ab&#34;</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">identityHashCode</span><span style="color:#ff79c6">(</span>s2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>s1 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> s2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// true
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>输出结果：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">1836019240
1836019240
1836019240
<span style="color:#ff79c6">true</span>
</code></pre></div><h3 id="intern-的效率测试空间角度">intern() 的效率测试（空间角度）</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * 使用intern()测试执行效率：空间使用上
</span><span style="color:#6272a4"> *
</span><span style="color:#6272a4"> * 结论：对于程序中大量存在存在的字符串，尤其其中存在很多重复字符串时，使用intern()可以节省内存空间。
</span><span style="color:#6272a4"> *
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StringIntern2</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> MAX_COUNT <span style="color:#ff79c6">=</span> 1000 <span style="color:#ff79c6">*</span> 10000<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> arr <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">[</span>MAX_COUNT<span style="color:#ff79c6">]</span><span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        Integer<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> data <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Integer<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>1<span style="color:#ff79c6">,</span>2<span style="color:#ff79c6">,</span>3<span style="color:#ff79c6">,</span>4<span style="color:#ff79c6">,</span>5<span style="color:#ff79c6">,</span>6<span style="color:#ff79c6">,</span>7<span style="color:#ff79c6">,</span>8<span style="color:#ff79c6">,</span>9<span style="color:#ff79c6">,</span>10<span style="color:#ff79c6">}</span><span style="color:#ff79c6">;</span>

        <span style="color:#8be9fd">long</span> start <span style="color:#ff79c6">=</span> System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentTimeMillis</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> MAX_COUNT<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
<span style="color:#6272a4">//            arr[i] = new String(String.valueOf(data[i % data.length]));
</span><span style="color:#6272a4"></span>            arr<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>data<span style="color:#ff79c6">[</span>i <span style="color:#ff79c6">%</span> data<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">}</span>
        <span style="color:#8be9fd">long</span> end <span style="color:#ff79c6">=</span> System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentTimeMillis</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;花费的时间为：&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">(</span>end <span style="color:#ff79c6">-</span> start<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sleep</span><span style="color:#ff79c6">(</span>1000000<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">gc</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>1、直接 new String ：由于每个 String 对象都是 new 出来的，所以程序需要维护大量存放在堆空间中的 String 实例，程序内存占用也会变高</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">arr<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>data<span style="color:#ff79c6">[</span>i <span style="color:#ff79c6">%</span> data<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>2、使用 intern() 方法：由于数组中字符串的引用都指向字符串常量池中的字符串，所以程序需要维护的 String 对象更少，内存占用也更低</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">//调用了intern()方法使用了字符串常量池里的字符串，那么前面堆里的字符串便会被GC掉，这也是intern省内存的关键原因
</span><span style="color:#6272a4"></span>arr<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>data<span style="color:#ff79c6">[</span>i <span style="color:#ff79c6">%</span> data<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p><strong>结论</strong>：</p>
<ol>
<li>对于程序中大量使用存在的字符串时，尤其存在很多已经重复的字符串时，使用intern()方法能够节省很大的内存空间。</li>
<li>大的网站平台，需要内存中存储大量的字符串。比如社交网站，很多人都存储：北京市、海淀区等信息。这时候如果字符串都调用intern() 方法，就会很明显降低内存的大小。</li>
</ol>
<h2 id="stringtable-的垃圾回收">StringTable 的垃圾回收</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * String的垃圾回收:
</span><span style="color:#6272a4"> * -Xms15m -Xmx15m -XX:+PrintStringTableStatistics -XX:+PrintGCDetails
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StringGCTest</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> j <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> j <span style="color:#ff79c6">&lt;</span> 100000<span style="color:#ff79c6">;</span> j<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>j<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">intern</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>输出结果：</p>
<ul>
<li>在 PSYoungGen 区发生了垃圾回收</li>
<li>Number of entries 和 Number of literals 明显没有 100000</li>
<li>以上两点均说明 StringTable 区发生了垃圾回收</li>
</ul>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h2 id="g1-中的-string-去重操作">G1 中的 String 去重操作</h2>
<blockquote>
<p><strong>官方文档</strong>：http://openjdk.java.net/jeps/192</p>
</blockquote>
<p>暂时了解一下，后面会详解垃圾回收器</p>
<p><strong>String去重操作的背景</strong></p>
<blockquote>
<p>注意不是字符串常量池的去重操作，字符串常量池本身就没有重复的</p>
</blockquote>
<ol>
<li>背景：对许多Java应用（有大的也有小的）做的测试得出以下结果：
<ul>
<li>堆存活数据集合里面String对象占了25%</li>
<li>堆存活数据集合里面重复的String对象有13.5%</li>
<li>String对象的平均长度是45</li>
</ul>
</li>
<li>许多大规模的Java应用的瓶颈在于内存，测试表明，在这些类型的应用里面，Java堆中存活的数据集合差不多25%是String对象。更进一步，这里面差不多一半String对象是重复的，重复的意思是说：<code>str1.equals(str2)= true</code>。堆上存在重复的String对象必然是一种内存的浪费。这个项目将在G1垃圾收集器中实现自动持续对重复的String对象进行去重，这样就能避免浪费内存。</li>
</ol>
<p><strong>String 去重的的实现</strong></p>
<ol>
<li>当垃圾收集器工作的时候，会访问堆上存活的对象。对每一个访问的对象都会检查是否是候选的要去重的String对象。</li>
<li>如果是，把这个对象的一个引用插入到队列中等待后续的处理。一个去重的线程在后台运行，处理这个队列。处理队列的一个元素意味着从队列删除这个元素，然后尝试去重它引用的String对象。</li>
<li>使用一个Hashtable来记录所有的被String对象使用的不重复的char数组。当去重的时候，会查这个Hashtable，来看堆上是否已经存在一个一模一样的char数组。</li>
<li>如果存在，String对象会被调整引用那个数组，释放对原来的数组的引用，最终会被垃圾收集器回收掉。</li>
<li>如果查找失败，char数组会被插入到Hashtable，这样以后的时候就可以共享这个数组了。</li>
</ol>
<p><strong>命令行选项</strong></p>
<ol>
<li>UseStringDeduplication(bool) ：开启String去重，默认是不开启的，需要手动开启。</li>
<li>PrintStringDeduplicationStatistics(bool) ：打印详细的去重统计信息</li>
<li>stringDeduplicationAgeThreshold(uintx) ：达到这个年龄的String对象被认为是去重的候选对象</li>
</ol>


                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/1052%E6%89%A7%E8%A1%8C%E5%BC%95%E6%93%8E/" data-toggle="tooltip" data-placement="top" title="12、执行引擎（JVM）">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/1054%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%A6%82%E8%BF%B0%E5%92%8C%E7%9B%B8%E5%85%B3%E7%AE%97%E6%B3%95/" data-toggle="tooltip" data-placement="top" title="14、垃圾回收概述和相关算法（JVM）">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">标签</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/activemq" title="activemq">
                            activemq
                        </a>
                        
                        
                        
                        <a href="/tags/ajax" title="ajax">
                            ajax
                        </a>
                        
                        
                        
                        <a href="/tags/cookie" title="cookie">
                            cookie
                        </a>
                        
                        
                        
                        <a href="/tags/datax" title="datax">
                            datax
                        </a>
                        
                        
                        
                        <a href="/tags/docker" title="docker">
                            docker
                        </a>
                        
                        
                        
                        <a href="/tags/elasticsearch" title="elasticsearch">
                            elasticsearch
                        </a>
                        
                        
                        
                        <a href="/tags/filter" title="filter">
                            filter
                        </a>
                        
                        
                        
                        <a href="/tags/hadoop" title="hadoop">
                            hadoop
                        </a>
                        
                        
                        
                        <a href="/tags/hbase" title="hbase">
                            hbase
                        </a>
                        
                        
                        
                        <a href="/tags/hive" title="hive">
                            hive
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/java" title="java">
                            java
                        </a>
                        
                        
                        
                        <a href="/tags/javascript" title="javascript">
                            javascript
                        </a>
                        
                        
                        
                        <a href="/tags/javaweb" title="javaweb">
                            javaweb
                        </a>
                        
                        
                        
                        <a href="/tags/jdbc" title="jdbc">
                            jdbc
                        </a>
                        
                        
                        
                        <a href="/tags/jquery" title="jquery">
                            jquery
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/jsp" title="jsp">
                            jsp
                        </a>
                        
                        
                        
                        <a href="/tags/juc" title="juc">
                            juc
                        </a>
                        
                        
                        
                        <a href="/tags/jvm" title="jvm">
                            jvm
                        </a>
                        
                        
                        
                        <a href="/tags/jwt" title="jwt">
                            jwt
                        </a>
                        
                        
                        
                        <a href="/tags/kafka" title="kafka">
                            kafka
                        </a>
                        
                        
                        
                        <a href="/tags/linux" title="linux">
                            linux
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/maven" title="maven">
                            maven
                        </a>
                        
                        
                        
                        <a href="/tags/minio" title="minio">
                            minio
                        </a>
                        
                        
                        
                        <a href="/tags/mongodb" title="mongodb">
                            mongodb
                        </a>
                        
                        
                        
                        <a href="/tags/mybatis" title="mybatis">
                            mybatis
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/mysql" title="mysql">
                            mysql
                        </a>
                        
                        
                        
                        <a href="/tags/netty" title="netty">
                            netty
                        </a>
                        
                        
                        
                        <a href="/tags/nginx" title="nginx">
                            nginx
                        </a>
                        
                        
                        
                        <a href="/tags/react" title="react">
                            react
                        </a>
                        
                        
                        
                        <a href="/tags/redis" title="redis">
                            redis
                        </a>
                        
                        
                        
                        <a href="/tags/scala" title="scala">
                            scala
                        </a>
                        
                        
                        
                        <a href="/tags/servlet" title="servlet">
                            servlet
                        </a>
                        
                        
                        
                        <a href="/tags/session" title="session">
                            session
                        </a>
                        
                        
                        
                        <a href="/tags/shiro" title="shiro">
                            shiro
                        </a>
                        
                        
                        
                        <a href="/tags/spark" title="spark">
                            spark
                        </a>
                        
                        
                        
                        <a href="/tags/spring" title="spring">
                            spring
                        </a>
                        
                        
                        
                        <a href="/tags/springboot" title="springboot">
                            springboot
                        </a>
                        
                        
                        
                        <a href="/tags/springcloud" title="springcloud">
                            springcloud
                        </a>
                        
                        
                        
                        <a href="/tags/springmvc" title="springmvc">
                            springmvc
                        </a>
                        
                        
                        
                        <a href="/tags/springsecurity" title="springsecurity">
                            springsecurity
                        </a>
                        
                        
                        
                        <a href="/tags/tomcat" title="tomcat">
                            tomcat
                        </a>
                        
                        
                        
                        <a href="/tags/vue" title="vue">
                            vue
                        </a>
                        
                        
                        
                        <a href="/tags/xml" title="xml">
                            xml
                        </a>
                        
                        
                        
                        <a href="/tags/zookeeper" title="zookeeper">
                            zookeeper
                        </a>
                        
                        
                        
                        <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95" title="数据结构与算法">
                            数据结构与算法
                        </a>
                        
                        
                        
                        <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" title="设计模式">
                            设计模式
                        </a>
                        
                        
                        
                        <a href="/tags/%E9%A1%B9%E7%9B%AE" title="项目">
                            项目
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:1424197205@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    <li>
                        <a target="_blank" href="/#">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/yiguan1573">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="亿观的博客" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; 亿观的博客 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>









<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





</body>
</html>
