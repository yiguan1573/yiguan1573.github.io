<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="referrer" content="never">
	
    
    <meta property="og:site_name" content="亿观的博客">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://yiguan1573.gitee.io//img/01.jpg">
    <meta property="twitter:image" content="https://yiguan1573.gitee.io//img/01.jpg" />
    

    
    <meta name="title" content="3、Kafka 架构深入（Kafka）" />
    <meta property="og:title" content="3、Kafka 架构深入（Kafka）" />
    <meta property="twitter:title" content="3、Kafka 架构深入（Kafka）" />
    

    
    <meta name="description" content="">
    <meta property="og:description" content="" />
    <meta property="twitter:description" content="" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>3、Kafka 架构深入（Kafka）-yiguan1573</title>

    <link rel="canonical" href="/post/913kafka%E6%9E%B6%E6%9E%84%E6%B7%B1%E5%85%A5/">

    <link rel="stylesheet" href="/css/iDisqus.min.css"/>
	
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    
    <link rel="stylesheet" href="/css/syntax.css">
    
    
    <link rel="stylesheet" href="/css/zanshang.css">
    
    
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    
    

    
    
    <script src="/js/jquery.min.js"></script>
    
    
    <script src="/js/bootstrap.min.js"></script>
    
    
    <script src="/js/hux-blog.min.js"></script>

    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/docco.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    

</head>



<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">亿观的博客</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">主页</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/%E5%AD%A6%E4%B9%A0">学习</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/#">图书</a></li>
                    
                        <li><a href="/#">关于</a></li>
                    

                    
		    <li>
                        <a href="/search">搜索 <img src="/img/search.png" height="15" style="cursor: pointer;" alt="Search"></a>
		    </li>
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('http://ww1.sinaimg.cn/large/006QQPIfly1gh0wuilf8mj31hc0u0kh8.jpg')
    }
</style>
<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/kafka" title="Kafka">
                            Kafka
                        </a>
                        
                    </div>
                    <h1>3、Kafka 架构深入（Kafka）</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by 
                        
                                 &#34;亿观&#34;
                         
                        on 
                        Tuesday, October 12, 2021
                        
                        
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <header>
                    <h2></h2>
                </header>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#kafka工作流程及文件存储机制">Kafka工作流程及文件存储机制</a>
      <ul>
        <li><a href="#工作流程">工作流程</a></li>
        <li><a href="#文件存储">文件存储</a></li>
      </ul>
    </li>
    <li><a href="#kafka生产者">Kafka生产者</a>
      <ul>
        <li><a href="#分区策略">分区策略</a></li>
        <li><a href="#数据可靠性保证">数据可靠性保证</a></li>
        <li><a href="#exactly-once语义">Exactly Once语义</a></li>
      </ul>
    </li>
    <li><a href="#消费者">消费者</a>
      <ul>
        <li><a href="#消费方式">消费方式</a></li>
        <li><a href="#分区分配策略">分区分配策略</a></li>
        <li><a href="#offset的维护">offset的维护</a></li>
        <li><a href="#消费者案例">消费者案例</a></li>
      </ul>
    </li>
    <li><a href="#kafka高效读写数据">Kafka高效读写数据</a></li>
    <li><a href="#zookeeper在kafka中的作用">Zookeeper在Kafka中的作用</a></li>
    <li><a href="#kafka事务">Kafka事务</a>
      <ul>
        <li><a href="#producer事务">Producer事务</a></li>
        <li><a href="#consumer事务">Consumer事务</a></li>
      </ul>
    </li>
  </ul>
</nav>
                
                <h2 id="kafka工作流程及文件存储机制">Kafka工作流程及文件存储机制</h2>
<h3 id="工作流程">工作流程</h3>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvn2yscehdj61jn0podwp02.jpg" alt="QQ截图20211021175244.png"></p>
<ul>
<li>
<p>Kafka 中消息是以 topic 进行分类的， producer生产消息，consumer消费消息，都是面向 topic的。(从命令行操作看出)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">bin<span style="color:#ae81ff">\w</span>indows<span style="color:#ae81ff">\k</span>afka-console-producer.bat --broker-list localhost:9092 --topic test
  
bin<span style="color:#ae81ff">\w</span>indows<span style="color:#ae81ff">\k</span>afka-console-consumer.bat --bootstrap-server localhost:9092 --topic test --from-beginning
</code></pre></div></li>
<li>
<p>topic 是逻辑上的概念，而 partition 是物理上的概念，每个 partition 对应于一个 log 文件，该 log 文件中存储的就是 producer 生产的数据。（topic = N partition，partition = log）</p>
</li>
<li>
<p>Producer 生产的数据会被不断追加到该log 文件末端，且每条数据都有自己的 offset。 consumer组中的每个consumer， 都会实时记录自己消费到了哪个 offset，以便出错恢复时，从上次的位置继续消费。（producer -&gt; log with offset -&gt; consumer(s)）</p>
</li>
</ul>
<h3 id="文件存储">文件存储</h3>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvn2z8vi4dj61g50r67eq02.jpg" alt="QQ截图20211021175257.png"></p>
<ul>
<li>
<p>由于生产者生产的消息会不断追加到 log 文件末尾， 为防止 log 文件过大导致数据定位效率低下， Kafka 采取了<strong>分片</strong>和<strong>索引</strong>机制，将每个 partition 分为多个 segment。</p>
</li>
<li>
<p>每个 segment对应两个文件——“.index”文件和“.log”文件。 这些文件位于一个文件夹下， 该文件夹的命名规则为： topic 名称+分区序号。例如， first 这个 topic 有三个分区，则其对应的文件夹为 first-0,first-1,first-2。</p>
<pre><code>00000000000000000000.index
00000000000000000000.log
00000000000000170410.index
00000000000000170410.log
00000000000000239430.index
00000000000000239430.log
</code></pre></li>
<li>
<p>index 和 log 文件以当前 segment 的第一条消息的 offset 命名。下图为 index 文件和 log文件的结构示意图。</p>
</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvn2zkxvzrj61gu0ondt002.jpg" alt="QQ截图20211021175313.png"></p>
<ul>
<li><strong>“.index”文件存储大量的索引信息，“.log”文件存储大量的数据，索引文件中的元数据指向对应数据文件中 message 的物理偏移地址。</strong></li>
</ul>
<h2 id="kafka生产者">Kafka生产者</h2>
<h3 id="分区策略">分区策略</h3>
<ul>
<li>
<p>分区的原因</p>
<ul>
<li><strong>方便在集群中扩展</strong>，每个 Partition 可以通过调整以适应它所在的机器，而一个 topic又可以有多个 Partition 组成，因此整个集群就可以适应适合的数据了；</li>
<li><strong>可以提高并发</strong>，因为可以以 Partition 为单位读写了。（联想到ConcurrentHashMap在高并发环境下读写效率比HashTable的高效）</li>
</ul>
</li>
<li>
<p>分区的原则（将 producer 发送的数据封装成一个 <code>ProducerRecord</code> 对象）</p>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvn32m9dyqj60q903igq902.jpg" alt="QQ截图20211021175703.png"></p>
<ol>
<li>指明 partition 的情况下，直接将指明的值直接作为 partiton 值；</li>
<li>没有指明 partition 值但有 key 的情况下，将 key 的 hash 值与 topic 的 partition 数进行取余得到 partition 值；</li>
<li>既没有 partition 值又没有 key 值的情况下，第一次调用时随机生成一个整数（后面每次调用在这个整数上自增），将这个值与 topic 可用的 partition 总数取余得到 partition值，也就是常说的 round-robin 算法。</li>
</ol>
</li>
</ul>
<h3 id="数据可靠性保证">数据可靠性保证</h3>
<ul>
<li><strong>为保证 producer 发送的数据，能可靠的发送到指定的 topic， topic 的每个 partition 收到producer 发送的数据后，都需要向 producer 发送 ack（acknowledgement 确认收到），如果producer 收到 ack， 就会进行下一轮的发送，否则重新发送数据。</strong></li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvn356q7kjj61hd0nsk8j02.jpg" alt="QQ截图20211021175930.png"></p>
<ul>
<li>
<p><strong>何时发送ack？</strong></p>
<p>确保有follower与leader同步完成，leader再发送ack，这样才能保证leader挂掉之后，能在follower中选举出新的leader。</p>
</li>
<li>
<p><strong>多少个follower同步完成之后发送ack？</strong></p>
<ol>
<li>半数以上的follower同步完成，即可发送ack继续发送重新发送</li>
<li>全部的follower同步完成，才可以发送ack</li>
</ol>
</li>
<li>
<p><strong>副本数据同步策略</strong></p>
<table>
<thead>
<tr>
<th>序号</th>
<th align="center">方 案</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td align="center">半数以上完成同步， 就发送 ack</td>
<td>延迟低</td>
<td>选举新的 leader 时，容忍 n 台节点的故障，需要 2n+1 个副本。（如果集群有2n+1台机器，选举leader的时候至少需要半数以上即n+1台机器投票，那么能容忍的故障，最多就是n台机器发生故障）容错率：1/2</td>
</tr>
<tr>
<td>2</td>
<td align="center">全部完成同步，才发送ack</td>
<td>选举新的 leader 时， 容忍 n 台节点的故障，需要 n+1 个副本（如果集群有n+1台机器，选举leader的时候只要有一个副本就可以了）容错率：1</td>
<td>延迟高</td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Kafka 选择了第二种方案，原因如下：</p>
<ol>
<li>同样为了容忍 n 台节点的故障，第一种方案需要 2n+1 个副本，而第二种方案只需要 n+1 个副本，而 Kafka 的每个分区都有大量的数据， 第一种方案会造成大量数据的冗余。</li>
<li>虽然第二种方案的网络延迟会比较高，但网络延迟对 Kafka 的影响较小。</li>
</ol>
</li>
<li>
<p><strong>ISR</strong></p>
<ul>
<li>采用第二种方案之后，设想以下情景： leader 收到数据，所有 follower 都开始同步数据，但有一个 follower，因为某种故障，迟迟不能与 leader 进行同步，那 leader 就要一直等下去，直到它完成同步，才能发送 ack。这个问题怎么解决呢？</li>
<li><strong>Leader 维护了一个动态的 in-sync replica set (ISR)，意为和 leader 保持同步的 follower 集合。当 ISR 中的 follower 完成数据的同步之后，就会给 leader 发送 ack。如果 follower长时间未向leader同步数据，则该follower将被踢出ISR，该时间阈值由<code>replica.lag.time.max.ms</code>参数设定。 Leader 发生故障之后，就会从 ISR 中选举新的 leader。</strong></li>
</ul>
</li>
<li>
<p><strong>ack应答机制</strong></p>
<ul>
<li>
<p>对于某些不太重要的数据，对数据的可靠性要求不是很高，能够容忍数据的少量丢失，所以没必要等 ISR 中的 follower 全部接收成功。<strong>所以 Kafka 为用户提供了三种可靠性级别，用户根据对可靠性和延迟的要求进行权衡，选择以下的配置。</strong></p>
</li>
<li>
<p><strong>acks 参数配置</strong>：</p>
<ul>
<li>
<p>0： producer 不等待 broker 的 ack，这一操作提供了一个最低的延迟， broker 一接收到还没有写入磁盘就已经返回，当 broker 故障时有可能<strong>丢失数据</strong>；</p>
</li>
<li>
<p>1： producer 等待 broker 的 ack， partition 的 leader 落盘成功后返回 ack，如果在 follower同步成功之前 leader 故障，那么将会<strong>丢失数据</strong></p>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvo4g2lfuqj61e30mptez02.jpg" alt="QQ截图20211022152725.png"></p>
</li>
<li>
<p>-1（all） ： producer 等待 broker 的 ack， partition 的 leader 和 ISR 的follower 全部落盘成功后才返回 ack。但是如果在 follower 同步完成后， broker 发送 ack 之前， leader 发生故障，那么会造成<strong>数据重复</strong>。</p>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvo4ggy1lwj619z0k7dl702.jpg" alt="QQ截图20211022152743.png"></p>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>故障处理细节</p>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvo4ilf8tgj61h50ph4c202.jpg" alt="QQ截图20211022152802.png"></p>
<p><strong>LEO：指的是每个副本最大的offset</strong></p>
<p><strong>HW：指的是消费者能见到的最大的offset，ISR 队列中最小的LEO</strong>。</p>
<ul>
<li><strong>follower 故障</strong>：follower 发生故障后会被临时踢出 ISR，待该 follower 恢复后， follower 会读取本地磁盘记录的上次的 HW，并将 log 文件高于 HW 的部分截取掉，从 HW 开始向 leader 进行同步。等该 follower 的 LEO 大于等于该 Partition 的 HW，即 follower 追上 leader 之后，就可以重新加入 ISR 了。</li>
<li><strong>leader 故障</strong>：leader 发生故障之后，会从 ISR 中选出一个新的 leader，之后，为保证多个副本之间的数据一致性， 其余的 follower 会先将各自的 log 文件高于 HW 的部分截掉，然后从新的 leader同步数据。</li>
</ul>
<p><strong>注意： 这只能保证副本之间的数据一致性，并不能保证数据不丢失或者不重复。</strong></p>
</li>
</ul>
<h3 id="exactly-once语义">Exactly Once语义</h3>
<ul>
<li>
<p>将服务器的 ACK 级别设置为-1（all），可以保证 Producer 到 Server 之间不会丢失数据，即 <strong>At Least Once</strong> 语义。</p>
</li>
<li>
<p>相对的，将服务器 ACK 级别设置为 0，可以保证生产者每条消息只会被发送一次，即 <strong>At Most Once</strong> 语义。</p>
</li>
<li>
<p>At Least Once 可以保证数据不丢失，但是不能保证数据不重复；相对的， At Most Once可以保证数据不重复，但是不能保证数据不丢失。 但是，对于一些非常重要的信息，比如说<strong>交易数据</strong>，下游数据消费者要求数据既不重复也不丢失，即 <strong>Exactly Once</strong> 语义。</p>
</li>
<li>
<p>在 0.11 版本以前的 Kafka，对此是无能为力的，只能保证数据不丢失，再在下游消费者对数据做全局去重。对于多个下游应用的情况，每个都需要单独做全局去重，这就对性能造成了很大影响。</p>
</li>
<li>
<p>0.11 版本的 Kafka，引入了一项重大特性：<strong>幂等性</strong>。<strong>所谓的幂等性就是指 Producer 不论向 Server 发送多少次重复数据， Server 端都只会持久化一条</strong>。幂等性结合 At Least Once 语义，就构成了 Kafka 的 Exactly Once 语义。即：</p>
</li>
</ul>
<pre><code>At Least Once + 幂等性 = Exactly Once
</code></pre><ul>
<li>
<p>要启用幂等性，只需要将 Producer 的参数中 <code>enable.idempotence</code> 设置为 true 即可。 Kafka的幂等性实现其实就是将原来下游需要做的去重放在了数据上游。开启幂等性的 Producer 在初始化的时候会被分配一个 PID，发往同一 Partition 的消息会附带 Sequence Number。而Broker 端会对<code>&lt;PID, Partition, SeqNumber&gt;</code>做缓存，当具有相同主键的消息提交时， Broker 只会持久化一条。</p>
</li>
<li>
<p><strong>但是 PID 重启就会变化，同时不同的 Partition 也具有不同主键，所以幂等性无法保证跨分区跨会话的 Exactly Once。</strong></p>
</li>
</ul>
<h2 id="消费者">消费者</h2>
<h3 id="消费方式">消费方式</h3>
<ul>
<li><strong>consumer 采用 pull（拉） 模式从 broker 中读取数据</strong>。</li>
<li><strong>push（推）模式很难适应消费速率不同的消费者，因为消息发送速率是由 broker 决定的</strong>。它的目标是尽可能以最快速度传递消息，但是这样很容易造成 consumer 来不及处理消息，典型的表现就是拒绝服务以及网络拥塞。而 pull 模式则可以根据 consumer 的消费能力以适当的速率消费消息。</li>
<li><strong>pull 模式不足之处</strong>是，如果 kafka 没有数据，消费者可能会陷入循环中， 一直返回空数据。 针对这一点， Kafka 的消费者在消费数据时会传入一个时长参数 timeout，如果当前没有数据可供消费， consumer 会等待一段时间之后再返回，这段时长即为 timeout。</li>
</ul>
<h3 id="分区分配策略"><strong>分区分配策略</strong></h3>
<ul>
<li>一个 consumer group 中有多个 consumer，一个 topic 有多个 partition，所以必然会涉及到 partition 的分配问题，即确定那个 partition 由哪个 consumer 来消费。</li>
<li>Kafka 有两种分配策略：
<ul>
<li>round-robin循环</li>
<li>range</li>
</ul>
</li>
</ul>
<h4 id="round-robin">Round Robin</h4>
<ul>
<li>关于Roudn Robin重分配策略，其主要采用的是一种轮询的方式分配所有的分区，该策略主要实现的步骤如下。这里我们首先假设有三个topic：t0、t1和t2，这三个topic拥有的分区数分别为1、2和3，那么总共有六个分区，这六个分区分别为：t0-0、t1-0、t1-1、t2-0、t2-1和t2-2。这里假设我们有三个consumer：C0、C1和C2，它们订阅情况为：C0订阅t0，C1订阅t0和t1，C2订阅t0、t1和t2。那么这些分区的分配步骤如下：</li>
<li>首先将所有的partition和consumer按照字典序进行排序，所谓的字典序，就是按照其名称的字符串顺序，那么上面的六个分区和三个consumer排序之后分别为：</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvo4v70sgnj60x40hrmz002.jpg" alt="QQ截图20211022154444.png"></p>
<ul>
<li>然后依次以按顺序轮询的方式将这六个分区分配给三个consumer，如果当前consumer没有订阅当前分区所在的topic，则轮询的判断下一个consumer：</li>
<li>尝试将t0-0分配给C0，由于C0订阅了t0，因而可以分配成功；</li>
<li>尝试将t1-0分配给C1，由于C1订阅了t1，因而可以分配成功；</li>
<li>尝试将t1-1分配给C2，由于C2订阅了t1，因而可以分配成功；</li>
<li>尝试将t2-0分配给C0，由于C0没有订阅t2，因而会轮询下一个consumer；</li>
<li>尝试将t2-0分配给C1，由于C1没有订阅t2，因而会轮询下一个consumer；</li>
<li>尝试将t2-0分配给C2，由于C2订阅了t2，因而可以分配成功；</li>
<li>同理由于t2-1和t2-2所在的topic都没有被C0和C1所订阅，因而都不会分配成功，最终都会分配给C2。</li>
<li>按照上述的步骤将所有的分区都分配完毕之后，最终分区的订阅情况如下：</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvo4x0cjddj60uh08rdhk02.jpg" alt="QQ截图20211022154631.png"></p>
<ul>
<li>从上面的步骤分析可以看出，轮询的策略就是简单的将所有的partition和consumer按照字典序进行排序之后，然后依次将partition分配给各个consumer，<strong>如果当前的consumer没有订阅当前的partition，那么就会轮询下一个consumer</strong>，直至最终将所有的分区都分配完毕。<strong>但是从上面的分配结果可以看出，轮询的方式会导致每个consumer所承载的分区数量不一致，从而导致各个consumer压力不均一。</strong></li>
</ul>
<h4 id="range">Range</h4>
<ul>
<li>
<p>所谓的Range重分配策略，就是首先会计算各个consumer将会承载的分区数量，然后将指定数量的分区分配给该consumer。这里我们假设有两个consumer：C0和C1，两个topic：t0和t1，这两个topic分别都有三个分区，那么总共的分区有六个：t0-0、t0-1、t0-2、t1-0、t1-1和t1-2。那么Range分配策略将会按照如下步骤进行分区的分配：</p>
</li>
<li>
<p>需要注意的是，Range策略是按照topic依次进行分配的，比如我们以t0进行讲解，其首先会获取t0的所有分区：t0-0、t0-1和t0-2，以及所有订阅了该topic的consumer：C0和C1，并且会将这些分区和consumer按照字典序进行排序；</p>
</li>
<li>
<p>然后按照平均分配的方式计算每个consumer会得到多少个分区，如果没有除尽，则会将多出来的分区依次计算到前面几个consumer。比如这里是三个分区和两个consumer，那么每个consumer至少会得到1个分区，而3除以2后还余1，那么就会将多余的部分依次算到前面几个consumer，也就是这里的1会分配给第一个consumer，总结来说，那么C0将会从第0个分区开始，分配2个分区，而C1将会从第2个分区开始，分配1个分区；</p>
</li>
<li>
<p>同理，按照上面的步骤依次进行后面的topic的分配。</p>
</li>
<li>
<p>最终上面六个分区的分配情况如下：</p>
</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvo516ok64j60kh040mxr02.jpg" alt="QQ截图20211022155034.png"></p>
<ul>
<li>可以看到，如果按照<code>Range</code>分区方式进行分配，其本质上是依次遍历每个topic，然后将这些topic的分区按照其所订阅的consumer数量进行平均的范围分配。这种方式从计算原理上就会导致排序在前面的consumer分配到更多的分区，从而导致各个consumer的压力不均衡。</li>
</ul>
<h3 id="offset的维护">offset的维护</h3>
<ul>
<li>
<p>由于 consumer 在消费过程中可能会出现断电宕机等故障， consumer 恢复后，需要从故障前的位置的继续消费，所以 <strong>consumer 需要实时记录自己消费到了哪个 offset</strong>，以便故障恢复后继续消费。</p>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvo545ajzjj61fs0tr16v02.jpg" alt="QQ截图20211022155321.png"></p>
</li>
<li>
<p><strong>Kafka 0.9 版本之前， consumer 默认将 offset 保存在 Zookeeper 中，从 0.9 版本开始，consumer 默认将 offset 保存在 Kafka 一个内置的 topic 中，该 topic 为__consumer_offsets</strong>。</p>
<ul>
<li>
<p>修改配置文件 consumer.properties，<code>exclude.internal.topics=false</code>。</p>
</li>
<li>
<p>读取 offset</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">0.11.0.0 之前版本
bin/kafka-console-consumer.sh --topic __consumer_offsets --zookeeper hadoop102:2181 --formatter <span style="color:#e6db74">&#34;kafka.coordinator.GroupMetadataManager\$OffsetsMessageFormatter&#34;</span> --consumer.config config/consumer.properties --from-beginning
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">0.11.0.0 及之后版本
bin/kafka-console-consumer.sh --topic __consumer_offsets --zookeeper hadoop102:2181 --formatter <span style="color:#e6db74">&#34;kafka.coordinator.group.GroupMetadataManager\$OffsetsMessageFormatter&#34;</span> --consumer.config config/consumer.properties --from-beginning
</code></pre></div></li>
</ul>
</li>
</ul>
<h3 id="消费者案例">消费者案例</h3>
<ul>
<li>
<p>需求：测试同一个消费者组中的消费者， <strong>同一时刻只能有一个</strong>消费者消费</p>
</li>
<li>
<p>案例：</p>
<ul>
<li>
<p>在 hadoop102、hadoop103 上修改/opt/module/kafka/config/consumer.properties 配置文件中的 group.id 属性为任意组名。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>atguigu@hadoop103 config<span style="color:#f92672">]</span>$ vi consumer.properties
group.id<span style="color:#f92672">=</span>atguigu
</code></pre></div></li>
<li>
<p>在 hadoop102、hadoop103 上分别启动消费者</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>atguigu@hadoop102 kafka<span style="color:#f92672">]</span>$ bin/kafka-console-consumer.sh <span style="color:#ae81ff">\ </span>--zookeeper hadoop102:2181 --topic first --consumer.config config/consumer.properties
<span style="color:#f92672">[</span>atguigu@hadoop103 kafka<span style="color:#f92672">]</span>$ bin/kafka-console-consumer.sh --bootstrap-server hadoop102:9092 --topic first --consumer.config config/consumer.properties
</code></pre></div></li>
<li>
<p>在 hadoop104 上启动生产者</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#f92672">[</span>atguigu@hadoop104 kafka<span style="color:#f92672">]</span>$ bin/kafka-console-producer.sh <span style="color:#ae81ff">\ </span>--broker-list hadoop102:9092 --topic first
&gt;hello world
</code></pre></div></li>
<li>
<p>查看 hadoop102 和 hadoop103 的接收者,同一时刻只有一个消费者接收到消息</p>
</li>
</ul>
</li>
</ul>
<h2 id="kafka高效读写数据">Kafka高效读写数据</h2>
<ul>
<li>
<p>顺序写磁盘</p>
<ul>
<li>Kafka 的 producer 生产数据，要写入到 log 文件中，写的过程是一直追加到文件末端，为顺序写。 官网有数据表明，同样的磁盘，顺序写能到 600M/s，而随机写只有 100K/s。这与磁盘的机械机构有关，顺序写之所以快，是因为其<strong>省去了大量磁头寻址的时间</strong>。</li>
</ul>
</li>
<li>
<p>零复制技术</p>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvo5mqe3cbj60uc0cvq6o02.jpg" alt="QQ截图20211022160911.png"></p>
<ul>
<li>NIC network interface controller 网络接口控制器</li>
</ul>
</li>
</ul>
<h2 id="zookeeper在kafka中的作用">Zookeeper在Kafka中的作用</h2>
<ul>
<li>Kafka 集群中有一个 broker 会被选举为 Controller，负责管理集群 broker 的上下线，所有 topic 的分区副本分配和 leader 选举等工作。</li>
<li>Controller 的管理工作都是依赖于 Zookeeper 的。</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/006QQPIfly1gvo5pgduivj61ej0osdrl02.jpg" alt="QQ截图20211022161348.png"></p>
<h2 id="kafka事务">Kafka事务</h2>
<ul>
<li>Kafka 从 0.11 版本开始引入了事务支持。事务可以保证 Kafka 在 Exactly Once 语义的基础上，生产和消费可以跨分区和会话，要么全部成功，要么全部失败。</li>
</ul>
<h3 id="producer事务">Producer事务</h3>
<ul>
<li>为了实现跨分区跨会话的事务，需要引入一个全局唯一的 Transaction ID，并将 Producer 获得的PID 和Transaction ID 绑定。这样当Producer 重启后就可以通过正在进行的 TransactionID 获得原来的 PID。</li>
<li>为了管理 Transaction， Kafka 引入了一个新的组件 Transaction Coordinator。 Producer 就是通过和 Transaction Coordinator 交互获得 Transaction ID 对应的任务状态。 Transaction Coordinator 还负责将事务所有写入 Kafka 的一个内部 Topic，这样即使整个服务重启，由于事务状态得到保存，进行中的事务状态可以得到恢复，从而继续进行。</li>
</ul>
<h3 id="consumer事务">Consumer事务</h3>
<ul>
<li>上述事务机制主要是从 Producer 方面考虑，对于 Consumer 而言，事务的保证就会相对较弱，尤其时无法保证 Commit 的信息被精确消费。这是由于 Consumer 可以通过 offset 访问任意信息，而且不同的 Segment File 生命周期不同，同一事务的消息可能会出现重启后被删除的情况。</li>
</ul>


                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/896callable%E6%8E%A5%E5%8F%A3/" data-toggle="tooltip" data-placement="top" title="6、Callable接口（JUC）">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/899%E7%BA%BF%E7%A8%8B%E6%B1%A0/" data-toggle="tooltip" data-placement="top" title="9、线程池（JUC）">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>

                
<div id="disqus-comment"></div>



            </div>
            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">标签</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/activemq" title="activemq">
                            activemq
                        </a>
                        
                        
                        
                        <a href="/tags/ajax" title="ajax">
                            ajax
                        </a>
                        
                        
                        
                        <a href="/tags/cookie" title="cookie">
                            cookie
                        </a>
                        
                        
                        
                        <a href="/tags/datax" title="datax">
                            datax
                        </a>
                        
                        
                        
                        <a href="/tags/docker" title="docker">
                            docker
                        </a>
                        
                        
                        
                        <a href="/tags/filter" title="filter">
                            filter
                        </a>
                        
                        
                        
                        <a href="/tags/hadoop" title="hadoop">
                            hadoop
                        </a>
                        
                        
                        
                        <a href="/tags/hbase" title="hbase">
                            hbase
                        </a>
                        
                        
                        
                        <a href="/tags/hive" title="hive">
                            hive
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/java" title="java">
                            java
                        </a>
                        
                        
                        
                        <a href="/tags/javascript" title="javascript">
                            javascript
                        </a>
                        
                        
                        
                        <a href="/tags/javaweb" title="javaweb">
                            javaweb
                        </a>
                        
                        
                        
                        <a href="/tags/jdbc" title="jdbc">
                            jdbc
                        </a>
                        
                        
                        
                        <a href="/tags/jquery" title="jquery">
                            jquery
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/jsp" title="jsp">
                            jsp
                        </a>
                        
                        
                        
                        <a href="/tags/juc" title="juc">
                            juc
                        </a>
                        
                        
                        
                        <a href="/tags/jwt" title="jwt">
                            jwt
                        </a>
                        
                        
                        
                        <a href="/tags/kafka" title="kafka">
                            kafka
                        </a>
                        
                        
                        
                        <a href="/tags/linux" title="linux">
                            linux
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/maven" title="maven">
                            maven
                        </a>
                        
                        
                        
                        <a href="/tags/minio" title="minio">
                            minio
                        </a>
                        
                        
                        
                        <a href="/tags/mongodb" title="mongodb">
                            mongodb
                        </a>
                        
                        
                        
                        <a href="/tags/mybatis" title="mybatis">
                            mybatis
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/mysql" title="mysql">
                            mysql
                        </a>
                        
                        
                        
                        <a href="/tags/nginx" title="nginx">
                            nginx
                        </a>
                        
                        
                        
                        <a href="/tags/react" title="react">
                            react
                        </a>
                        
                        
                        
                        <a href="/tags/redis" title="redis">
                            redis
                        </a>
                        
                        
                        
                        <a href="/tags/scala" title="scala">
                            scala
                        </a>
                        
                        
                        
                        <a href="/tags/servlet" title="servlet">
                            servlet
                        </a>
                        
                        
                        
                        <a href="/tags/session" title="session">
                            session
                        </a>
                        
                        
                        
                        <a href="/tags/shiro" title="shiro">
                            shiro
                        </a>
                        
                        
                        
                        <a href="/tags/spark" title="spark">
                            spark
                        </a>
                        
                        
                        
                        <a href="/tags/spring" title="spring">
                            spring
                        </a>
                        
                        
                        
                        <a href="/tags/springboot" title="springboot">
                            springboot
                        </a>
                        
                        
                        
                        <a href="/tags/springcloud" title="springcloud">
                            springcloud
                        </a>
                        
                        
                        
                        <a href="/tags/springmvc" title="springmvc">
                            springmvc
                        </a>
                        
                        
                        
                        <a href="/tags/springsecurity" title="springsecurity">
                            springsecurity
                        </a>
                        
                        
                        
                        <a href="/tags/tomcat" title="tomcat">
                            tomcat
                        </a>
                        
                        
                        
                        <a href="/tags/vue" title="vue">
                            vue
                        </a>
                        
                        
                        
                        <a href="/tags/xml" title="xml">
                            xml
                        </a>
                        
                        
                        
                        <a href="/tags/zookeeper" title="zookeeper">
                            zookeeper
                        </a>
                        
                        
                        
                        <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95" title="数据结构与算法">
                            数据结构与算法
                        </a>
                        
                        
                        
                        <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" title="设计模式">
                            设计模式
                        </a>
                        
                        
                        
                        <a href="/tags/%E9%A1%B9%E7%9B%AE" title="项目">
                            项目
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
                <section>
                    <hr>
                    <h5>朋友</h5>
                    <ul class="list-inline">
                        
                        <li><a target="_blank" href=""></a></li>
                        
                    </ul>
                </section>
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                   
                 
                   
                    
                    <li>
                        <a href="mailto:1424197205@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    

                    

		    
                    
                    <li>
                        <a target="_blank" href="#">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-wechat fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    <li>
                        <a target="_blank" href="https://github.com/yiguan1573">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		    
                    
                    
                    
                    
                    
                    
                    
                    
            
                </ul>
		<p class="copyright text-muted">
                    Copyright &copy; 亿观的博客 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    async("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






</body>
</html>
