<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="referrer" content="never">

    
    <meta property="og:site_name" content="亿观的博客">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://yiguan1573.github.io//img/01.jpg">
    <meta property="twitter:image" content="https://yiguan1573.github.io//img/01.jpg" />
    

    
    <meta name="title" content="4、SparkStreaming（Spark）" />
    <meta property="og:title" content="4、SparkStreaming（Spark）" />
    <meta property="twitter:title" content="4、SparkStreaming（Spark）" />
    

    
    <meta name="description" content="">
    <meta property="og:description" content="" />
    <meta property="twitter:description" content="" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>4、SparkStreaming（Spark） | yiguan1573</title>

    <link rel="canonical" href="/post/944sparkstreaming/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>




<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">亿观的博客</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">首页</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/%E5%AD%A6%E4%B9%A0">学习</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/archive/">档案</a></li>
                    
                        <li><a href="/top/about/">关于</a></li>
                    

                    
		    <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		    </li>
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/05.JPG')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/spark" title="Spark">
                            Spark
                        </a>
                        
                    </div>
                    <h1>4、SparkStreaming（Spark）</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                     &#34;亿观&#34;
                             
                            on 
                            Tuesday, December 7, 2021
                            
                                <span id="/post/944sparkstreaming/" class="leancloud_visitors meta_data_item" data-flag-title="">
    <span class="post-meta-item-icon">
      <span class="octicon octicon-eye"></span> 
    </span>
    <i class="fa fa-eye"></i>
    <span class="old-visitors-count" style="display: none;"></span>
    <span class="leancloud-visitors-count"></span>
</span>



<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>

<script>
	AV.initialize("", "");
</script>

<script type="text/javascript">
function showTime(Counter) {
    var query = new AV.Query(Counter);
    var entries = [];
    var $visitors = $(".leancloud_visitors");

    $visitors.each(function() {
        entries.push($(this).attr("id").trim());
    });

    query.containedIn('url', entries);
    query.find()
        .done(function(results) {
            var COUNT_CONTAINER_REF = '.leancloud-visitors-count';
            var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';

            
            
            
            

            for (var i = 0; i < results.length; i++) {
                var item = results[i];
                var url = item.get('url');
                var time = item.get('time');
                var element = document.getElementById(url);

                $(element).find(COUNT_CONTAINER_REF).text(time);
            }
            for (var i = 0; i < entries.length; i++) {
                var url = entries[i];
                var element = document.getElementById(url);
                var countSpan = $(element).find(COUNT_CONTAINER_REF);
                if (countSpan.text() == '') {
                    var oldCountSpan = $(element).find(OLD_COUNT_CONTAINER_REF).text();
                    if(oldCountSpan!=''){
                        countSpan.text(0+parseInt(oldCountSpan));
                    }else{
                        countSpan.text(0);          
                    }
                }
            }
        })
        .fail(function(object, error) {
            console.log("Error: " + error.code + " " + error.message);
        });
}

function addCount(Counter) {
    var $visitors = $(".leancloud_visitors");
    var url = $visitors.attr('id').trim();
    var title = $visitors.attr('data-flag-title').trim();
    var query = new AV.Query(Counter);

    query.equalTo("url", url);
    query.find({
        success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment("time");
                counter.save(null, {
                    success: function(counter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(counter.get('time'));
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
                var newcounter = new Counter();
                 
                var acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                newcounter.setACL(acl);
                 
                newcounter.set("title", title);
                newcounter.set("url", url);
                var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';
                var $element = $(document.getElementById(url));
                var oldCountSpan = $element.find(OLD_COUNT_CONTAINER_REF).text();
                if(oldCountSpan!=''){
                    newcounter.set("time", parseInt(oldCountSpan)+1);
                }else{
 	                    newcounter.set("time",  1);
                }
                newcounter.save(null, {
                    success: function(newcounter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                    },
                    error: function(newcounter, error) {
                        console.log('Failed to create');
                    }
                });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + " " + error.message);
        }
    });
}
$(function() {
    var Counter = AV.Object.extend("Counter");
    
    
    if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
    } else {
        showTime(Counter);
    }
});
</script>

                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h2 id="sparkstreaming-概述"><strong>SparkStreaming</strong> <strong>概述</strong></h2>
<h3 id="spark-streaming-是什么"><strong>Spark Streaming</strong> <strong>是什么</strong></h3>
<ul>
<li>Spark 流使得构建可扩展的容错流应用程序变得更加容易。</li>
<li>**Spark Streaming 用于流式数据的处理。**Spark Streaming 支持的数据输入源很多，例如：Kafka、Flume、Twitter、ZeroMQ 和简单的 TCP 套接字等等。数据输入后可以用 Spark 的高度抽象原语如：map、reduce、join、window 等进行运算。而结果也能保存在很多地方，如 HDFS，数据库等。</li>
</ul>
<p>
  <img src="http://ww1.sinaimg.cn/large/006QQPIfly1gzlfgg6w9xj30pu08adga.jpg" alt="QQ截图20220221205406.jpg">

</p>
<ul>
<li>和 Spark 基于 RDD 的概念很相似，Spark Streaming 使用离散化流(discretized stream)作为抽象表示，叫作 DStream。DStream 是随时间推移而收到的数据的序列。在内部，每个时间区间收到的数据都作为 RDD 存在，而 DStream 是由这些 RDD 所组成的序列(因此得名“离散化”)。所以简单来将，DStream 就是对 RDD 在实时数据处理场景的一种封装。</li>
</ul>
<h3 id="spark-streaming-的特点"><strong>Spark Streaming</strong> <strong>的特点</strong></h3>
<ul>
<li>易用</li>
<li>容错</li>
<li>易整合到Spark体系</li>
</ul>
<h3 id="spark-streaming-架构"><strong>Spark Streaming</strong> <strong>架构</strong></h3>
<h4 id="架构图"><strong>架构图</strong></h4>
<ul>
<li>
<p>整体架构图</p>
<p>
  <img src="http://ww1.sinaimg.cn/large/006QQPIfly1gzlfjflcdwj30ni0a4wey.jpg" alt="QQ截图20220221205821.jpg">

</p>
</li>
<li>
<p><strong>SparkStreaming</strong> <strong>架构图</strong></p>
</li>
</ul>
<p>
  <img src="http://ww1.sinaimg.cn/large/006QQPIfly1gzlfjs8nmmj30mi09nq3k.jpg" alt="QQ截图20220221205901.jpg">

</p>
<h4 id="背压机制"><strong>背压机制</strong></h4>
<ul>
<li>Spark 1.5 以前版本，用户如果要限制 Receiver 的数据接收速率，可以通过设置静态配制参数“spark.streaming.receiver.maxRate”的值来实现，此举虽然可以通过限制接收速率，来适配当前的处理能力，防止内存溢出，但也会引入其它问题。比如：producer 数据生产高于 maxRate，当前集群处理能力也高于 maxRate，这就会造成资源利用率下降等问题。</li>
<li>为了更好的协调数据接收速率与资源处理能力，1.5 版本开始 Spark Streaming 可以动态控制数据接收速率来适配集群数据处理能力。背压机制（即 Spark Streaming Backpressure）: 根据JobScheduler 反馈作业的执行信息来动态调整 Receiver 数据接收率。</li>
<li>通过属性“spark.streaming.backpressure.enabled”来控制是否启用 backpressure 机制，默认值false，即不启用。</li>
</ul>
<h2 id="dstream-入门"><strong>Dstream</strong> <strong>入门</strong></h2>
<h3 id="wordcount-案例实操"><strong>WordCount</strong> <strong>案例实操</strong></h3>
<ul>
<li>
<p>需求：使用 netcat 工具向 9999 端口不断的发送数据，通过 SparkStreaming 读取端口数据并</p>
<p>统计不同单词出现的次数</p>
</li>
<li>
<p>添加依赖</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#ff79c6">&lt;dependency</span><span style="color:#ff79c6">&gt;</span>
    <span style="color:#ff79c6">&lt;groupId</span><span style="color:#ff79c6">&gt;</span>org.apache.spark<span style="color:#ff79c6">&lt;/groupId&gt;</span>
    <span style="color:#ff79c6">&lt;artifactId</span><span style="color:#ff79c6">&gt;</span>spark-streaming_2.12<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
    <span style="color:#ff79c6">&lt;version</span><span style="color:#ff79c6">&gt;</span>3.0.0<span style="color:#ff79c6">&lt;/version&gt;</span>
<span style="color:#ff79c6">&lt;/dependency&gt;</span>
</code></pre></div></li>
<li>
<p>编写代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">StreamWordCount</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//1.初始化 Spark 配置信息
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> sparkConf <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> 
        <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;StreamWordCount&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//2.初始化 SparkStreamingContext
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>sparkConf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//3.通过监控端口创建 DStream，读进来的数据为一行行
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> lineStreams <span style="color:#ff79c6">=</span> ssc<span style="color:#ff79c6">.</span>socketTextStream<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;linux1&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">9999</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//将每一行数据做切分，形成一个个单词
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> wordStreams <span style="color:#ff79c6">=</span> lineStreams<span style="color:#ff79c6">.</span>flatMap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; &#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//将单词映射成元组（word,1）
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> wordAndOneStreams <span style="color:#ff79c6">=</span> wordStreams<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//将相同的单词次数做统计
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> wordAndCountStreams <span style="color:#ff79c6">=</span> wordAndOneStreams<span style="color:#ff79c6">.</span>reduceByKey<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//打印
</span><span style="color:#6272a4"></span>        wordAndCountStreams<span style="color:#ff79c6">.</span>print<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//启动 SparkStreamingContext
</span><span style="color:#6272a4"></span>        ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<p>启动程序并通过 netcat 发送数据：</p>
<pre><code>nc -lk 9999
hello spark
</code></pre></li>
</ul>
<h3 id="wordcount-解析">WordCount 解析</h3>
<ul>
<li>
<p>Discretized Stream 是 Spark Streaming 的基础抽象，代表持续性的数据流和经过各种 Spark 原语操作后的结果数据流。在内部实现上，DStream 是一系列连续的 RDD 来表示。每个 RDD 含有一段时间间隔内的数据。</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h3g4w34ajaj30on0m7gn6.jpg" alt="QQ截图20220621202345.jpg">

</p>
</li>
</ul>
<h2 id="dstream-创建">DStream 创建</h2>
<h3 id="rdd-队列">RDD 队列</h3>
<ul>
<li>
<p>测试过程中，可以通过使用 ssc.queueStream(queueOfRDDs)来创建 DStream，每一个推送到这个队列中的 RDD，都会作为一个 DStream 处理。</p>
</li>
<li>
<p>需求：循环创建几个 RDD，将 RDD 放入队列。通过 SparkStream 创建 Dstream，计算WordCount</p>
</li>
<li>
<p>编写代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">RDDStream</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//1.初始化 Spark 配置信息
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> conf <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;RDDStream&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//2.初始化 SparkStreamingContext
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>conf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">4</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//3.创建 RDD 队列
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> rddQueue <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> mutable<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Queue</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//4.创建 QueueInputDStream
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> inputStream <span style="color:#ff79c6">=</span> ssc<span style="color:#ff79c6">.</span>queueStream<span style="color:#ff79c6">(</span>rddQueue<span style="color:#ff79c6">,</span>oneAtATime <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//5.处理队列中的 RDD 数据
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> mappedStream <span style="color:#ff79c6">=</span> inputStream<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> reducedStream <span style="color:#ff79c6">=</span> mappedStream<span style="color:#ff79c6">.</span>reduceByKey<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//6.打印结果
</span><span style="color:#6272a4"></span>        reducedStream<span style="color:#ff79c6">.</span>print<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//7.启动任务
</span><span style="color:#6272a4"></span>        ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//8.循环创建并向 RDD 队列中放入 RDD
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;-</span> <span style="color:#bd93f9">1</span> to <span style="color:#bd93f9">5</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            rddQueue <span style="color:#ff79c6">+=</span> ssc<span style="color:#ff79c6">.</span>sparkContext<span style="color:#ff79c6">.</span>makeRDD<span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span> to <span style="color:#bd93f9">300</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span>
            <span style="color:#50fa7b">Thread</span><span style="color:#ff79c6">.</span>sleep<span style="color:#ff79c6">(</span><span style="color:#bd93f9">2000</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span>
        ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<p>结果展示</p>
<pre><code></code></pre></li>
</ul>
<hr>
<h2 id="time-1539075280000-ms">Time: 1539075280000 ms</h2>
<h2 id="560">(4,60)
(0,60)
(6,60)
(8,60)
(2,60)
(1,60)
(3,60)
(7,60)
(9,60)
(5,60)</h2>
<h2 id="time-1539075284000-ms">Time: 1539075284000 ms</h2>
<h2 id="560-1">(4,60)
(0,60)
(6,60)
(8,60)
(2,60)
(1,60)
(3,60)
(7,60)
(9,60)
(5,60)</h2>
<h2 id="time-1539075288000-ms">Time: 1539075288000 ms</h2>
<h2 id="530">(4,30)
(0,30)
(6,30)
(8,30)
(2,30)
(1,30)
(3,30)
(7,30)
(9,30)
(5,30)</h2>
<h2 id="time-1539075292000-ms">Time: 1539075292000 ms</h2>
<pre><code>


### 自定义数据源

- 需要继承 Receiver，并实现 onStart、onStop 方法来自定义数据源采集

- 需求：自定义数据源，实现监控某个端口号，获取该端口号内容

- 自定义数据源

```scala
class CustomerReceiver(host: String, port: Int) extends 
Receiver[String](StorageLevel.MEMORY_ONLY) {
    //最初启动的时候，调用该方法，作用为：读数据并将数据发送给 Spark
    override def onStart(): Unit = {
        new Thread(&quot;Socket Receiver&quot;) {
            override def run() {
                receive()
            }
        }.start()
    }
    //读数据并将数据发送给 Spark
    def receive(): Unit = {
        //创建一个 Socket
        var socket: Socket = new Socket(host, port)
        //定义一个变量，用来接收端口传过来的数据
        var input: String = null
        //创建一个 BufferedReader 用于读取端口传来的数据
        val reader = new BufferedReader(new InputStreamReader(socket.getInputStream, 
                                                              StandardCharsets.UTF_8))
        //读取数据
        input = reader.readLine()
        //当 receiver 没有关闭并且输入数据不为空，则循环发送数据给 Spark
        while (!isStopped() &amp;&amp; input != null) {
            store(input)
            input = reader.readLine()
        }
        //跳出循环则关闭资源
        reader.close()
        socket.close()
        //重启任务
        restart(&quot;restart&quot;)
    }
    override def onStop(): Unit = {}
}
</code></pre><ul>
<li>
<p>使用自定义的数据源采集数据</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">FileStream</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//1.初始化 Spark 配置信息
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> sparkConf <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;StreamWordCount&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//2.初始化 SparkStreamingContext
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>sparkConf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">5</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//3.创建自定义 receiver 的 Streaming
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> lineStream <span style="color:#ff79c6">=</span> ssc<span style="color:#ff79c6">.</span>receiverStream<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#50fa7b">CustomerReceiver</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;hadoop102&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">9999</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//4.将每一行数据做切分，形成一个个单词
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> wordStream <span style="color:#ff79c6">=</span> lineStream<span style="color:#ff79c6">.</span>flatMap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;\t&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//5.将单词映射成元组（word,1）
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> wordAndOneStream <span style="color:#ff79c6">=</span> wordStream<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//6.将相同的单词次数做统计
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> wordAndCountStream <span style="color:#ff79c6">=</span> wordAndOneStream<span style="color:#ff79c6">.</span>reduceByKey<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//7.打印
</span><span style="color:#6272a4"></span>        wordAndCountStream<span style="color:#ff79c6">.</span>print<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//8.启动 SparkStreamingContext
</span><span style="color:#6272a4"></span>        ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
<h2 id="kafka-数据源">Kafka 数据源</h2>
<h3 id="版本选型">版本选型</h3>
<ul>
<li>ReceiverAPI：需要一个专门的 Executor 去接收数据，然后发送给其他的 Executor 做计算。存在的问题，接收数据的 Executor 和计算的 Executor 速度会有所不同，特别在接收数据的 Executor速度大于计算的 Executor 速度，会导致计算数据的节点内存溢出。<strong>早期版本中提供此方式，当前版本不适用</strong></li>
<li>DirectAPI：是由计算的 Executor 来主动消费 Kafka 的数据，速度由自身控制。</li>
<li></li>
</ul>
<h3 id="kafka-0-8-receiver-模式当前版本不适用">Kafka 0-8 Receiver 模式（当前版本不适用）</h3>
<ul>
<li>
<p>需求：通过 SparkStreaming 从 Kafka 读取数据，并将读取过来的数据做简单计算，最终打印到控制台</p>
</li>
<li>
<p>导入依赖</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#ff79c6">&lt;dependency</span><span style="color:#ff79c6">&gt;</span>
    <span style="color:#ff79c6">&lt;groupId</span><span style="color:#ff79c6">&gt;</span>org.apache.spark<span style="color:#ff79c6">&lt;/groupId&gt;</span>
    <span style="color:#ff79c6">&lt;artifactId</span><span style="color:#ff79c6">&gt;</span>spark-streaming-kafka-0-8_2.11<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
    <span style="color:#ff79c6">&lt;version</span><span style="color:#ff79c6">&gt;</span>2.4.5<span style="color:#ff79c6">&lt;/version&gt;</span>
<span style="color:#ff79c6">&lt;/dependency&gt;</span>
</code></pre></div></li>
<li>
<p>编写代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">package</span> com.atguigu.kafka
<span style="color:#ff79c6">import</span> org.apache.spark.SparkConf
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.dstream.ReceiverInputDStream
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.kafka.KafkaUtils
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">ReceiverAPI</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//1.创建 SparkConf
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> sparkConf<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkConf</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> 
        <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;ReceiverWordCount&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//2.创建 StreamingContext
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>sparkConf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//3.读取 Kafka 数据创建 DStream(基于 Receive 方式)
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> kafkaDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ReceiverInputDStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        <span style="color:#50fa7b">KafkaUtils</span><span style="color:#ff79c6">.</span>createStream<span style="color:#ff79c6">(</span>ssc<span style="color:#ff79c6">,</span>
                                <span style="color:#f1fa8c">&#34;linux1:2181,linux2:2181,linux3:2181&#34;</span><span style="color:#ff79c6">,</span>
                                <span style="color:#f1fa8c">&#34;atguigu&#34;</span><span style="color:#ff79c6">,</span>
                                <span style="color:#50fa7b">Map</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;atguigu&#34;</span> <span style="color:#ff79c6">-&gt;</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//4.计算 WordCount
</span><span style="color:#6272a4"></span>        kafkaDStream<span style="color:#ff79c6">.</span>map <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
            <span style="color:#ff79c6">(</span>value<span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">.</span>reduceByKey<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span>print<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//5.开启任务
</span><span style="color:#6272a4"></span>        ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
<h3 id="kafka-0-8-direct-模式当前版本不适用">Kafka 0-8 Direct 模式（当前版本不适用）</h3>
<ul>
<li>
<p>需求：通过 SparkStreaming 从 Kafka 读取数据，并将读取过来的数据做简单计算，最终打印到控制台。</p>
</li>
<li>
<p>导入依赖</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#ff79c6">&lt;dependency</span><span style="color:#ff79c6">&gt;</span>
    <span style="color:#ff79c6">&lt;groupId</span><span style="color:#ff79c6">&gt;</span>org.apache.spark<span style="color:#ff79c6">&lt;/groupId&gt;</span>
    <span style="color:#ff79c6">&lt;artifactId</span><span style="color:#ff79c6">&gt;</span>spark-streaming-kafka-0-8_2.11<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
    <span style="color:#ff79c6">&lt;version</span><span style="color:#ff79c6">&gt;</span>2.4.5<span style="color:#ff79c6">&lt;/version&gt;</span>
<span style="color:#ff79c6">&lt;/dependency&gt;</span>
</code></pre></div></li>
<li>
<p>编写代码（自动维护 offset）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> kafka.serializer.StringDecoder
<span style="color:#ff79c6">import</span> org.apache.kafka.clients.consumer.ConsumerConfig
<span style="color:#ff79c6">import</span> org.apache.spark.SparkConf
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.dstream.InputDStream
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.kafka.KafkaUtils
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">DirectAPIAuto02</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">val</span> getSSC1<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#50fa7b">StreamingContext</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">val</span> sparkConf<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkConf</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> 
        <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;ReceiverWordCount&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>sparkConf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        ssc
    <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">def</span> getSSC<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">StreamingContext</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//1.创建 SparkConf
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> sparkConf<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkConf</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> 
        <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;ReceiverWordCount&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//2.创建 StreamingContext
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>sparkConf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//设置 CK
</span><span style="color:#6272a4"></span>        ssc<span style="color:#ff79c6">.</span>checkpoint<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;./ck2&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//3.定义 Kafka 参数
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> kafkaPara<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Map</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Map</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span>
            <span style="color:#50fa7b">ConsumerConfig</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">BOOTSTRAP_SERVERS_CONFIG</span> <span style="color:#ff79c6">-&gt;</span> 
            <span style="color:#f1fa8c">&#34;linux1:9092,linux2:9092,linux3:9092&#34;</span><span style="color:#ff79c6">,</span>
            <span style="color:#50fa7b">ConsumerConfig</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">GROUP_ID_CONFIG</span> <span style="color:#ff79c6">-&gt;</span> <span style="color:#f1fa8c">&#34;atguigu&#34;</span>
        <span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//4.读取 Kafka 数据
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> kafkaDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">InputDStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        <span style="color:#50fa7b">KafkaUtils</span><span style="color:#ff79c6">.</span>createDirectStream<span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">StringDecoder</span>, <span style="color:#8be9fd">StringDecoder</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span>ssc<span style="color:#ff79c6">,</span>kafkaPara<span style="color:#ff79c6">,</span><span style="color:#50fa7b">Set</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;atguigu&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
          
        <span style="color:#6272a4">//5.计算 WordCount
</span><span style="color:#6272a4"></span>        kafkaDStream<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>_2<span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span>flatMap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; &#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span>reduceByKey<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span>print<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//6.返回数据
</span><span style="color:#6272a4"></span>        ssc
    <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//获取 SSC
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> ssc<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">StreamingContext</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">.</span>getActiveOrCreate<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;./ck2&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span> 
                                                                       getSSC<span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//开启任务
</span><span style="color:#6272a4"></span>        ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<p>编写代码（手动维护 offset）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> kafka.common.TopicAndPartition
<span style="color:#ff79c6">import</span> kafka.message.MessageAndMetadata
<span style="color:#ff79c6">import</span> kafka.serializer.StringDecoder
<span style="color:#ff79c6">import</span> org.apache.kafka.clients.consumer.ConsumerConfig
<span style="color:#ff79c6">import</span> org.apache.spark.SparkConf
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.dstream.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">DStream</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">InputDStream</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.kafka.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">HasOffsetRanges</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">KafkaUtils</span><span style="color:#ff79c6">,</span>
                                         <span style="color:#50fa7b">OffsetRange</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">DirectAPIHandler</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//1.创建 SparkConf
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> sparkConf<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkConf</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> 
        <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;ReceiverWordCount&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//2.创建 StreamingContext
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>sparkConf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//3.Kafka 参数
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> kafkaPara<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Map</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Map</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span>
            <span style="color:#50fa7b">ConsumerConfig</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">BOOTSTRAP_SERVERS_CONFIG</span> <span style="color:#ff79c6">-&gt;</span> 
            <span style="color:#f1fa8c">&#34;hadoop102:9092,hadoop103:9092,hadoop104:9092&#34;</span><span style="color:#ff79c6">,</span>
            <span style="color:#50fa7b">ConsumerConfig</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">GROUP_ID_CONFIG</span> <span style="color:#ff79c6">-&gt;</span> <span style="color:#f1fa8c">&#34;atguigu&#34;</span>
        <span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//4.获取上一次启动最后保留的 Offset=&gt;getOffset(MySQL)
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> fromOffsets<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Map</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">TopicAndPartition</span>, <span style="color:#8be9fd">Long</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Map</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">TopicAndPartition</span>, 
                                                            <span style="color:#8be9fd">Long</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">TopicAndPartition</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;atguigu&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-&gt;</span> <span style="color:#bd93f9">20</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//5.读取 Kafka 数据创建 DStream
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> kafkaDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">InputDStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">KafkaUtils</span><span style="color:#ff79c6">.</span>createDirectStream<span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>,<span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">StringDecoder</span>, <span style="color:#8be9fd">StringDecoder</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span>ssc<span style="color:#ff79c6">,</span>kafkaPara<span style="color:#ff79c6">,</span>fromOffsets<span style="color:#ff79c6">,</span><span style="color:#ff79c6">(</span>m<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">MessageAndMetadata</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span> m<span style="color:#ff79c6">.</span>message<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//6.创建一个数组用于存放当前消费数据的 offset 信息
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">var</span> offsetRanges <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Array</span><span style="color:#ff79c6">.</span>empty<span style="color:#ff79c6">[</span><span style="color:#8be9fd">OffsetRange</span><span style="color:#ff79c6">]</span>
        <span style="color:#6272a4">//7.获取当前消费数据的 offset 信息
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> wordToCountDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Int</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> kafkaDStream<span style="color:#ff79c6">.</span>transform <span style="color:#ff79c6">{</span> rdd 
                                                                                 <span style="color:#ff79c6">=&gt;</span>
            offsetRanges <span style="color:#ff79c6">=</span> rdd<span style="color:#ff79c6">.</span>asInstanceOf<span style="color:#ff79c6">[</span><span style="color:#8be9fd">HasOffsetRanges</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">.</span>offsetRanges
            rdd
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">.</span>flatMap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; &#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span>reduceByKey<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//8.打印 Offset 信息
</span><span style="color:#6272a4"></span>        wordToCountDStream<span style="color:#ff79c6">.</span>foreachRDD<span style="color:#ff79c6">(</span>rdd <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>o <span style="color:#ff79c6">&lt;-</span> offsetRanges<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                println<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">s&#34;</span><span style="color:#f1fa8c">${</span>o<span style="color:#ff79c6">.</span>topic<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:</span><span style="color:#f1fa8c">${</span>o<span style="color:#ff79c6">.</span>partition<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:</span><span style="color:#f1fa8c">${</span>o<span style="color:#ff79c6">.</span>fromOffset<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">:</span><span style="color:#f1fa8c">${</span>o<span style="color:#ff79c6">.</span>untilOffset<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">}</span>
            rdd<span style="color:#ff79c6">.</span>foreach<span style="color:#ff79c6">(</span>println<span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//9.开启任务
</span><span style="color:#6272a4"></span>        ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
<h3 id="kafka-0-10-direct-模式">Kafka 0-10 Direct 模式</h3>
<ul>
<li>
<p>需求：通过 SparkStreaming 从 Kafka 读取数据，并将读取过来的数据做简单计算，最终打印到控制台。</p>
</li>
<li>
<p>导入依赖</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#ff79c6">&lt;dependency</span><span style="color:#ff79c6">&gt;</span>
    <span style="color:#ff79c6">&lt;groupId</span><span style="color:#ff79c6">&gt;</span>org.apache.spark<span style="color:#ff79c6">&lt;/groupId&gt;</span>
    <span style="color:#ff79c6">&lt;artifactId</span><span style="color:#ff79c6">&gt;</span>spark-streaming-kafka-0-10_2.12<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
    <span style="color:#ff79c6">&lt;version</span><span style="color:#ff79c6">&gt;</span>3.0.0<span style="color:#ff79c6">&lt;/version&gt;</span>
<span style="color:#ff79c6">&lt;/dependency&gt;</span>
<span style="color:#ff79c6">&lt;dependency</span><span style="color:#ff79c6">&gt;</span>
    <span style="color:#ff79c6">&lt;groupId</span><span style="color:#ff79c6">&gt;</span>com.fasterxml.jackson.core<span style="color:#ff79c6">&lt;/groupId&gt;</span>
    <span style="color:#ff79c6">&lt;artifactId</span><span style="color:#ff79c6">&gt;</span>jackson-core<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
    <span style="color:#ff79c6">&lt;version</span><span style="color:#ff79c6">&gt;</span>2.10.1<span style="color:#ff79c6">&lt;/version&gt;</span>
<span style="color:#ff79c6">&lt;/dependency&gt;</span>
</code></pre></div></li>
<li>
<p>编写代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> org.apache.kafka.clients.consumer.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">ConsumerConfig</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">ConsumerRecord</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.spark.SparkConf
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.dstream.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">DStream</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">InputDStream</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.kafka010.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">ConsumerStrategies</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">KafkaUtils</span><span style="color:#ff79c6">,</span> 
                                            <span style="color:#50fa7b">LocationStrategies</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">DirectAPI</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//1.创建 SparkConf
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> sparkConf<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkConf</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> 
        <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;ReceiverWordCount&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//2.创建 StreamingContext
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>sparkConf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//3.定义 Kafka 参数
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> kafkaPara<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Map</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Object</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Map</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Object</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span>
            <span style="color:#50fa7b">ConsumerConfig</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">BOOTSTRAP_SERVERS_CONFIG</span> <span style="color:#ff79c6">-&gt;</span> 
            <span style="color:#f1fa8c">&#34;linux1:9092,linux2:9092,linux3:9092&#34;</span><span style="color:#ff79c6">,</span>
            <span style="color:#50fa7b">ConsumerConfig</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">GROUP_ID_CONFIG</span> <span style="color:#ff79c6">-&gt;</span> <span style="color:#f1fa8c">&#34;atguigu&#34;</span><span style="color:#ff79c6">,</span>
            <span style="color:#f1fa8c">&#34;key.deserializer&#34;</span> <span style="color:#ff79c6">-&gt;</span> 
            <span style="color:#f1fa8c">&#34;org.apache.kafka.common.serialization.StringDeserializer&#34;</span><span style="color:#ff79c6">,</span>
            <span style="color:#f1fa8c">&#34;value.deserializer&#34;</span> <span style="color:#ff79c6">-&gt;</span> 
            <span style="color:#f1fa8c">&#34;org.apache.kafka.common.serialization.StringDeserializer&#34;</span>
        <span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//4.读取 Kafka 数据创建 DStream
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> kafkaDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">InputDStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">ConsumerRecord</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        <span style="color:#50fa7b">KafkaUtils</span><span style="color:#ff79c6">.</span>createDirectStream<span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span>ssc<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">LocationStrategies</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">PreferConsistent</span><span style="color:#ff79c6">,</span><span style="color:#50fa7b">ConsumerStrategies</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Subscribe</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">Set</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;atguigu&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> kafkaPara<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//5.将每条消息的 KV 取出
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> valueDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> kafkaDStream<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span>record <span style="color:#ff79c6">=&gt;</span> record<span style="color:#ff79c6">.</span>value<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//6.计算 WordCount
</span><span style="color:#6272a4"></span>        valueDStream<span style="color:#ff79c6">.</span>flatMap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; &#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span>reduceByKey<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span>print<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//7.开启任务
</span><span style="color:#6272a4"></span>        ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div><p>查看 Kafka 消费进度</p>
<pre><code>bin/kafka-consumer-groups.sh --describe --bootstrap-server linux1:9092 --group 
atguigu
</code></pre></li>
</ul>
<h2 id="dstream-转换">DStream 转换</h2>
<ul>
<li>DStream 上的操作与 RDD 的类似，分为 Transformations（转换）和 Output Operations（输出）两种，此外转换操作中还有一些比较特殊的原语，如：updateStateByKey()、transform()以及各种 Window 相关的原语</li>
</ul>
<h3 id="无状态转化操作"><strong>无状态转化操作</strong></h3>
<ul>
<li>
<p>无状态转化操作就是把简单的 RDD 转化操作应用到每个批次上，也就是转化 DStream 中的每一个 RDD。部分无状态转化操作列在了下表中。注意，针对键值对的 DStream 转化操作(比如reduceByKey())要添加 import StreamingContext._才能在 Scala 中使用</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h3g5d5x5i9j30ox0ct0ty.jpg" alt="QQ截图20220621204013.jpg">

</p>
</li>
<li>
<p>需要记住的是，尽管这些函数看起来像作用在整个流上一样，但事实上每个 DStream 在内部是由许多 RDD（批次）组成，且无状态转化操作是分别应用到每个 RDD 上的。</p>
</li>
<li>
<p>例如：reduceByKey()会归约每个时间区间中的数据，但不会归约不同区间之间的数据。</p>
</li>
<li>
<p><strong>Transform</strong></p>
<ul>
<li>
<p>Transform 允许 DStream 上执行任意的 RDD-to-RDD 函数。即使这些函数并没有在 DStream的 API 中暴露出来，通过该函数可以方便的扩展 Spark API。该函数每一批次调度一次。其实也就是对 DStream 中的 RDD 应用转换。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">Transform</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//创建 SparkConf
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> sparkConf<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkConf</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> 
        <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;WordCount&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//创建 StreamingContext
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>sparkConf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//创建 DStream
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> lineDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ReceiverInputDStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> ssc<span style="color:#ff79c6">.</span>socketTextStream<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;linux1&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">9999</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//转换为 RDD 操作
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> wordAndCountDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Int</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> lineDStream<span style="color:#ff79c6">.</span>transform<span style="color:#ff79c6">(</span>rdd <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
                            <span style="color:#ff79c6">val</span> words<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> rdd<span style="color:#ff79c6">.</span>flatMap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; &#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
                            <span style="color:#ff79c6">val</span> wordAndOne<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Int</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> words<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
                            <span style="color:#ff79c6">val</span> value<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Int</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> wordAndOne<span style="color:#ff79c6">.</span>reduceByKey<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span>
                             value
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//打印
</span><span style="color:#6272a4"></span>        wordAndCountDStream<span style="color:#ff79c6">.</span>print
        <span style="color:#6272a4">//启动
</span><span style="color:#6272a4"></span>        ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p><strong>join</strong></p>
<ul>
<li>
<p>两个流之间的 join 需要两个流的批次大小一致，这样才能做到同时触发计算。计算过程就是对当前批次的两个流中各自的 RDD 进行 join，与两个 RDD 的 join 效果相同</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> org.apache.spark.SparkConf
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.dstream.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">DStream</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">ReceiverInputDStream</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">JoinTest</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//1.创建 SparkConf
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> sparkConf<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkConf</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> 
        <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;JoinTest&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//2.创建 StreamingContext
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>sparkConf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">5</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//3.从端口获取数据创建流
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> lineDStream1<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ReceiverInputDStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        ssc<span style="color:#ff79c6">.</span>socketTextStream<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;linux1&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">9999</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> lineDStream2<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ReceiverInputDStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        ssc<span style="color:#ff79c6">.</span>socketTextStream<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;linux2&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">8888</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//4.将两个流转换为 KV 类型
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> wordToOneDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Int</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> lineDStream1<span style="color:#ff79c6">.</span>flatMap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; &#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> wordToADStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> lineDStream2<span style="color:#ff79c6">.</span>flatMap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; &#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;a&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//5.流的 JOIN
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> joinDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#ff79c6">(</span><span style="color:#8be9fd">Int</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        wordToOneDStream<span style="color:#ff79c6">.</span>join<span style="color:#ff79c6">(</span>wordToADStream<span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//6.打印
</span><span style="color:#6272a4"></span>        joinDStream<span style="color:#ff79c6">.</span>print<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//7.启动任务
</span><span style="color:#6272a4"></span>        ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<h2 id="有状态转化操作"><strong>有状态转化操作</strong></h2>
<h3 id="updatestatebykey"><strong>UpdateStateByKey</strong></h3>
<ul>
<li>
<p>UpdateStateByKey 原语用于记录历史记录，有时，我们需要在 DStream 中跨批次维护状态(例如流计算中累加 wordcount)。针对这种情况，updateStateByKey()为我们提供了对一个状态变量的访问，用于键值对形式的 DStream。给定一个由(键，事件)对构成的 DStream，并传递一个指定如何根据新的事件更新每个键对应状态的函数，它可以构建出一个新的 DStream，其内部数据为(键，状态) 对。</p>
</li>
<li>
<p>updateStateByKey() 的结果会是一个新的 DStream，其内部的 RDD 序列是由每个时间区间对应的(键，状态)对组成的。</p>
</li>
<li>
<p>updateStateByKey 操作使得我们可以在用新信息进行更新时保持任意的状态。为使用这个功能，需要做下面两步：</p>
<ul>
<li>定义状态，状态可以是一个任意的数据类型。</li>
<li>定义状态更新函数，用此函数阐明如何使用之前的状态和来自输入流的新值对状态进行更新。</li>
</ul>
</li>
<li>
<p>使用 updateStateByKey 需要对检查点目录进行配置，会使用检查点来保存状态</p>
</li>
<li>
<p>更新版的 wordcount</p>
</li>
<li>
<p>编写代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">WorldCount</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 定义更新状态方法，参数 values 为当前批次单词频度，state 为以往批次单词频度
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> updateFunc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>values<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">,</span> state<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Option</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">val</span> currentCount <span style="color:#ff79c6">=</span> values<span style="color:#ff79c6">.</span>foldLeft<span style="color:#ff79c6">(</span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">val</span> previousCount <span style="color:#ff79c6">=</span> state<span style="color:#ff79c6">.</span>getOrElse<span style="color:#ff79c6">(</span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">)</span>
            <span style="color:#50fa7b">Some</span><span style="color:#ff79c6">(</span>currentCount <span style="color:#ff79c6">+</span> previousCount<span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">val</span> conf <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> 
        <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;NetworkWordCount&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>conf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>checkpoint<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;./ck&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">// Create a DStream that will connect to hostname:port, like hadoop102:9999
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> lines <span style="color:#ff79c6">=</span> ssc<span style="color:#ff79c6">.</span>socketTextStream<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;linux1&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">9999</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">// Split each line into words
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> words <span style="color:#ff79c6">=</span> lines<span style="color:#ff79c6">.</span>flatMap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; &#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//import org.apache.spark.streaming.StreamingContext._ // not necessary since 
</span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">Spark</span> <span style="color:#bd93f9">1.3</span>
        <span style="color:#6272a4">// Count each word in each batch
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> pairs <span style="color:#ff79c6">=</span> words<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span>word <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">(</span>word<span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">// 使用 updateStateByKey 来更新状态，统计从运行开始以来单词总的次数
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> stateDstream <span style="color:#ff79c6">=</span> pairs<span style="color:#ff79c6">.</span>updateStateByKey<span style="color:#ff79c6">[</span><span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span>updateFunc<span style="color:#ff79c6">)</span>
        stateDstream<span style="color:#ff79c6">.</span>print<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4">// Start the computation
</span><span style="color:#6272a4"></span>        ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4">// Wait for the computation to terminate
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">//ssc.stop()
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<p>启动程序并向 9999 端口发送数据</p>
<pre><code>nc -lk 9999
Hello World
Hello Scala
</code></pre></li>
<li>
<p>结果展示</p>
<pre><code></code></pre></li>
</ul>
<hr>
<h2 id="time-1504685175000-ms">Time: 1504685175000 ms</h2>
<hr>
<h2 id="time-1504685181000-ms">Time: 1504685181000 ms</h2>
<h2 id="ni1">(shi,1)
(shui,1)
(ni,1)</h2>
<h2 id="time-1504685187000-ms">Time: 1504685187000 ms</h2>
<p>(shi,1)
(ma,1)
(hao,1)
(shui,1)</p>
<pre><code>


### **WindowOperations**

- Window Operations 可以设置窗口的大小和滑动窗口的间隔来动态的获取当前 Steaming 的允许状态。所有基于窗口的操作都需要两个参数，分别为窗口时长以及滑动步长。

- 窗口时长：计算内容的时间范围；
- 滑动步长：隔多久触发一次计算。
- 注意：这两者都必须为采集周期大小的整数倍。

- WordCount 第三版：3 秒一个批次，窗口 12 秒，滑步 6 秒。

```scala
object WorldCount {
    def main(args: Array[String]) {
        val conf = new 
        SparkConf().setMaster(&quot;local[2]&quot;).setAppName(&quot;NetworkWordCount&quot;)
        val ssc = new StreamingContext(conf, Seconds(3))
        ssc.checkpoint(&quot;./ck&quot;)
        // Create a DStream that will connect to hostname:port, like localhost:9999
        val lines = ssc.socketTextStream(&quot;linux1&quot;, 9999)
        // Split each line into words
        val words = lines.flatMap(_.split(&quot; &quot;))
        // Count each word in each batch
        val pairs = words.map(word =&gt; (word, 1))
        val wordCounts = pairs.reduceByKeyAndWindow((a:Int,b:Int) =&gt; (a + b),Seconds(12), Seconds(6))
        // Print the first ten elements of each RDD generated in this DStream to the console
        wordCounts.print()
        ssc.start() // Start the computation
        ssc.awaitTermination() // Wait for the computation to terminate
    } 
}
</code></pre><ul>
<li>
<p>关于 Window 的操作还有如下方法：</p>
<ul>
<li>
<p>window(windowLength, slideInterval): 基于对源 DStream 窗化的批次进行计算返回一个新的 Dstream；</p>
</li>
<li>
<p>countByWindow(windowLength, slideInterval): 返回一个滑动窗口计数流中的元素个数</p>
</li>
<li>
<p>reduceByWindow(func, windowLength, slideInterval): 通过使用自定义函数整合滑动区间流元素来创建一个新的单元素流</p>
</li>
<li>
<p>reduceByKeyAndWindow(func, windowLength, slideInterval, [numTasks]): 当在一个(K,V)对的 DStream 上调用此函数，会返回一个新(K,V)对的 DStream，此处通过对滑动窗口中批次数据使用 reduce 函数来整合每个 key 的 value 值。</p>
</li>
<li>
<p>reduceByKeyAndWindow(func, invFunc, windowLength, slideInterval, [numTasks]): 这个函数是上述函数的变化版本，每个窗口的 reduce 值都是通过用前一个窗的 reduce 值来递增计算。通过 reduce 进入到滑动窗口数据并”反向 reduce”离开窗口的旧数据来实现这个操作。一个例子是随着窗口滑动对 keys 的“加”“减”计数。通过前边介绍可以想到，这个函数只适用于”可逆的 reduce 函数”，也就是这些 reduce 函数有相应的”反 reduce”函数(以参数 invFunc 形式传入)。如前述函数，reduce 任务的数量通过可选参数来配置</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h3g6oim0svj30qu0e4757.jpg" alt="QQ截图20220621212543.jpg">

</p>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">val</span> ipDStream <span style="color:#ff79c6">=</span> accessLogsDStream<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span>logEntry <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">(</span>logEntry<span style="color:#ff79c6">.</span>getIpAddress<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
<span style="color:#ff79c6">val</span> ipCountDStream <span style="color:#ff79c6">=</span> ipDStream<span style="color:#ff79c6">.</span>reduceByKeyAndWindow<span style="color:#ff79c6">(</span>
 <span style="color:#ff79c6">{</span><span style="color:#ff79c6">(</span>x<span style="color:#ff79c6">,</span> y<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span> x <span style="color:#ff79c6">+</span> y<span style="color:#ff79c6">}</span><span style="color:#ff79c6">,</span>
 <span style="color:#ff79c6">{</span><span style="color:#ff79c6">(</span>x<span style="color:#ff79c6">,</span> y<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span> x <span style="color:#ff79c6">-</span> y<span style="color:#ff79c6">}</span><span style="color:#ff79c6">,</span>
 <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">30</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span>
 <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
 <span style="color:#6272a4">//加上新进入窗口的批次中的元素 //移除离开窗口的老批次中的元素 //窗口时长// 滑动步长
</span></code></pre></div><ul>
<li>
<p>countByWindow()和 countByValueAndWindow()作为对数据进行计数操作的简写。</p>
</li>
<li>
<p>countByWindow()返回一个表示每个窗口中元素个数的 DStream，而 countByValueAndWindow()返回的 DStream 则包含窗口中每个值的个数。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">val</span> ipDStream <span style="color:#ff79c6">=</span> accessLogsDStream<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">{</span>entry <span style="color:#ff79c6">=&gt;</span> entry<span style="color:#ff79c6">.</span>getIpAddress<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">val</span> ipAddressRequestCount <span style="color:#ff79c6">=</span> ipDStream<span style="color:#ff79c6">.</span>countByValueAndWindow<span style="color:#ff79c6">(</span><span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">30</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> 
<span style="color:#ff79c6">val</span> requestCount <span style="color:#ff79c6">=</span> accessLogsDStream<span style="color:#ff79c6">.</span>countByWindow<span style="color:#ff79c6">(</span><span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">30</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
</code></pre></div></li>
</ul>
<h2 id="dstream-输出">DStream 输出</h2>
<ul>
<li>输出操作指定了对流数据经转化操作得到的数据所要执行的操作(例如把结果推入外部数据库或输出到屏幕上)。与 RDD 中的惰性求值类似，如果一个 DStream 及其派生出的 DStream 都没有被执行输出操作，那么这些 DStream 就都不会被求值。如果 StreamingContext 中没有设定输出操作，整个 context 就都不会启动。</li>
<li>输出操作如下：
<ul>
<li>print()：在运行流程序的驱动结点上打印 DStream 中每一批次数据的最开始 10 个元素。这用于开发和调试。在 Python API 中，同样的操作叫 print()。</li>
<li>saveAsTextFiles(prefix, [suffix])：以 text 文件形式存储这个 DStream 的内容。每一批次的存储文件名基于参数中的 prefix 和 suffix。”prefix-Time_IN_MS[.suffix]”。</li>
<li>saveAsObjectFiles(prefix, [suffix])：以 Java 对象序列化的方式将 Stream 中的数据保存为SequenceFiles . 每一批次的存储文件名基于参数中的为&quot;prefix-TIME_IN_MS[.suffix]&quot;. Python中目前不可用</li>
<li>saveAsHadoopFiles(prefix, [suffix])：将 Stream 中的数据保存为 Hadoop files. 每一批次的存储文件名基于参数中的为&quot;prefix-TIME_IN_MS[.suffix]&quot;。Python API 中目前不可用。</li>
<li>foreachRDD(func)：这是最通用的输出操作，即将函数 func 用于产生于 stream 的每一个RDD。其中参数传入的函数 func 应该实现将每一个 RDD 中数据推送到外部系统，如将RDD 存入文件或者通过网络将其写入数据库</li>
</ul>
</li>
<li>通用的输出操作 foreachRDD()，它用来对 DStream 中的 RDD 运行任意计算。这和 transform() 有些类似，都可以让我们访问任意 RDD。在 foreachRDD()中，可以重用我们在 Spark 中实现的所有行动操作。比如，常见的用例之一是把数据写到诸如 MySQL 的外部数据库中</li>
<li>注意：
<ul>
<li>连接不能写在 driver 层面（序列化）</li>
<li>如果写在 foreach 则每个 RDD 中的每一条数据都创建，得不偿失；</li>
<li>增加 foreachPartition，在分区创建（获取）</li>
</ul>
</li>
</ul>
<h2 id="优雅关闭">优雅关闭</h2>
<ul>
<li>
<p>流式任务需要 7*24 小时执行，但是有时涉及到升级代码需要主动停止程序，但是分布式程序，没办法做到一个个进程去杀死，所有配置优雅的关闭就显得至关重要了。使用外部文件系统来控制内部程序关闭</p>
</li>
<li>
<p>MonitorStop</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> java.net.URI
<span style="color:#ff79c6">import</span> org.apache.hadoop.conf.Configuration
<span style="color:#ff79c6">import</span> org.apache.hadoop.fs.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">FileSystem</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Path</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">StreamingContextState</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">MonitorStop</span><span style="color:#ff79c6">(</span>ssc<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">StreamingContext</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">extends</span> <span style="color:#50fa7b">Runnable</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> run<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">val</span> fs<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">FileSystem</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">FileSystem</span><span style="color:#ff79c6">.</span>get<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#50fa7b">URI</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;hdfs://linux1:9000&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">Configuration</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;atguigu&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">try</span>
            <span style="color:#50fa7b">Thread</span><span style="color:#ff79c6">.</span>sleep<span style="color:#ff79c6">(</span><span style="color:#bd93f9">5000</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">case</span> e<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">InterruptedException</span> <span style="color:#ff79c6">=&gt;</span>
                e<span style="color:#ff79c6">.</span>printStackTrace<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">val</span> state<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">StreamingContextState</span> <span style="color:#ff79c6">=</span> ssc<span style="color:#ff79c6">.</span>getState
            <span style="color:#ff79c6">val</span> bool<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Boolean</span> <span style="color:#ff79c6">=</span> fs<span style="color:#ff79c6">.</span>exists<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#50fa7b">Path</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;hdfs://linux1:9000/stopSpark&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>bool<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>state <span style="color:#ff79c6">==</span> <span style="color:#50fa7b">StreamingContextState</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">ACTIVE</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    ssc<span style="color:#ff79c6">.</span>stop<span style="color:#ff79c6">(</span>stopSparkContext <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">,</span> stopGracefully <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span>
                    <span style="color:#50fa7b">System</span><span style="color:#ff79c6">.</span>exit<span style="color:#ff79c6">(</span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">)</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<p>SparkTest</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> org.apache.spark.SparkConf
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.dstream.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">DStream</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">ReceiverInputDStream</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">SparkTest</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> createSSC<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#ff79c6">_</span><span style="color:#8be9fd">root_</span><span style="color:#8be9fd">.</span><span style="color:#8be9fd">org</span><span style="color:#8be9fd">.</span><span style="color:#8be9fd">apache</span><span style="color:#8be9fd">.</span><span style="color:#8be9fd">spark</span><span style="color:#8be9fd">.</span><span style="color:#8be9fd">streaming</span><span style="color:#8be9fd">.</span><span style="color:#8be9fd">StreamingContext</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">val</span> update<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Option</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#50fa7b">Some</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>values<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">,</span> status<span style="color:#ff79c6">:</span> 
                                                            <span style="color:#8be9fd">Option</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">//当前批次内容的计算
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">val</span> sum<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Int</span> <span style="color:#ff79c6">=</span> values<span style="color:#ff79c6">.</span>sum
            <span style="color:#6272a4">//取出状态信息中上一次状态
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">val</span> lastStatu<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Int</span> <span style="color:#ff79c6">=</span> status<span style="color:#ff79c6">.</span>getOrElse<span style="color:#ff79c6">(</span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">)</span>
            <span style="color:#50fa7b">Some</span><span style="color:#ff79c6">(</span>sum <span style="color:#ff79c6">+</span> lastStatu<span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">val</span> sparkConf<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkConf</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> 
        <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[4]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;SparkTest&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//设置优雅的关闭
</span><span style="color:#6272a4"></span>        sparkConf<span style="color:#ff79c6">.</span>set<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;spark.streaming.stopGracefullyOnShutdown&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;true&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>sparkConf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">5</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>checkpoint<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;./ck&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> line<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ReceiverInputDStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> ssc<span style="color:#ff79c6">.</span>socketTextStream<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;linux1&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">9999</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> word<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> line<span style="color:#ff79c6">.</span>flatMap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; &#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> wordAndOne<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Int</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> word<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> wordAndCount<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Int</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> wordAndOne<span style="color:#ff79c6">.</span>updateStateByKey<span style="color:#ff79c6">(</span>update<span style="color:#ff79c6">)</span>
        wordAndCount<span style="color:#ff79c6">.</span>print<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc
    <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">val</span> ssc<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">StreamingContext</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">.</span>getActiveOrCreate<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;./ck&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span> 
                                                                       createSSC<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">Thread</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#50fa7b">MonitorStop</span><span style="color:#ff79c6">(</span>ssc<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
<h2 id="sparkstreaming-案例实操">SparkStreaming 案例实操</h2>
<h3 id="环境准备"><strong>环境准备</strong></h3>
<ul>
<li>
<p><strong>pom</strong> <strong>文件</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#ff79c6">&lt;dependencies</span><span style="color:#ff79c6">&gt;</span>
    <span style="color:#ff79c6">&lt;dependency</span><span style="color:#ff79c6">&gt;</span>
        <span style="color:#ff79c6">&lt;groupId</span><span style="color:#ff79c6">&gt;</span>org.apache.spark<span style="color:#ff79c6">&lt;/groupId&gt;</span>
        <span style="color:#ff79c6">&lt;artifactId</span><span style="color:#ff79c6">&gt;</span>spark-core_2.12<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
        <span style="color:#ff79c6">&lt;version</span><span style="color:#ff79c6">&gt;</span>3.0.0<span style="color:#ff79c6">&lt;/version&gt;</span>
    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
    <span style="color:#ff79c6">&lt;dependency</span><span style="color:#ff79c6">&gt;</span>
        <span style="color:#ff79c6">&lt;groupId</span><span style="color:#ff79c6">&gt;</span>org.apache.spark<span style="color:#ff79c6">&lt;/groupId&gt;</span>
        <span style="color:#ff79c6">&lt;artifactId</span><span style="color:#ff79c6">&gt;</span>spark-streaming_2.12<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
        <span style="color:#ff79c6">&lt;version</span><span style="color:#ff79c6">&gt;</span>3.0.0<span style="color:#ff79c6">&lt;/version&gt;</span>
    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
    <span style="color:#ff79c6">&lt;dependency</span><span style="color:#ff79c6">&gt;</span>
        <span style="color:#ff79c6">&lt;groupId</span><span style="color:#ff79c6">&gt;</span>org.apache.spark<span style="color:#ff79c6">&lt;/groupId&gt;</span>
        <span style="color:#ff79c6">&lt;artifactId</span><span style="color:#ff79c6">&gt;</span>spark-streaming-kafka-0-10_2.12<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
        <span style="color:#ff79c6">&lt;version</span><span style="color:#ff79c6">&gt;</span>3.0.0<span style="color:#ff79c6">&lt;/version&gt;</span>
    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
    <span style="color:#6272a4">&lt;!--</span><span style="color:#6272a4"> https://mvnrepository.com/artifact/com.alibaba/druid </span><span style="color:#6272a4">--&gt;</span>
    <span style="color:#ff79c6">&lt;dependency</span><span style="color:#ff79c6">&gt;</span>
        <span style="color:#ff79c6">&lt;groupId</span><span style="color:#ff79c6">&gt;</span>com.alibaba<span style="color:#ff79c6">&lt;/groupId&gt;</span>
        <span style="color:#ff79c6">&lt;artifactId</span><span style="color:#ff79c6">&gt;</span>druid<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
        <span style="color:#ff79c6">&lt;version</span><span style="color:#ff79c6">&gt;</span>1.1.10<span style="color:#ff79c6">&lt;/version&gt;</span>
    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
    <span style="color:#ff79c6">&lt;dependency</span><span style="color:#ff79c6">&gt;</span>
        <span style="color:#ff79c6">&lt;groupId</span><span style="color:#ff79c6">&gt;</span>mysql<span style="color:#ff79c6">&lt;/groupId&gt;</span>
        <span style="color:#ff79c6">&lt;artifactId</span><span style="color:#ff79c6">&gt;</span>mysql-connector-java<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
        <span style="color:#ff79c6">&lt;version</span><span style="color:#ff79c6">&gt;</span>5.1.27<span style="color:#ff79c6">&lt;/version&gt;</span>
    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
    <span style="color:#ff79c6">&lt;dependency</span><span style="color:#ff79c6">&gt;</span>
        <span style="color:#ff79c6">&lt;groupId</span><span style="color:#ff79c6">&gt;</span>com.fasterxml.jackson.core<span style="color:#ff79c6">&lt;/groupId&gt;</span>
        <span style="color:#ff79c6">&lt;artifactId</span><span style="color:#ff79c6">&gt;</span>jackson-core<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
        <span style="color:#ff79c6">&lt;version</span><span style="color:#ff79c6">&gt;</span>2.10.1<span style="color:#ff79c6">&lt;/version&gt;</span>
    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
<span style="color:#ff79c6">&lt;/dependencies&gt;</span>
</code></pre></div></li>
<li>
<p><strong>PropertiesUtil</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> java.io.InputStreamReader
<span style="color:#ff79c6">import</span> java.util.Properties
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">PropertiesUtil</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> load<span style="color:#ff79c6">(</span>propertiesName<span style="color:#ff79c6">:</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Properties</span> <span style="color:#ff79c6">=</span><span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">val</span> prop<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> <span style="color:#50fa7b">Properties</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        prop<span style="color:#ff79c6">.</span>load<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#50fa7b">InputStreamReader</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">Thread</span><span style="color:#ff79c6">.</span>currentThread<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>getContextClassLoader<span style="color:#ff79c6">.</span>getResourceAsStream<span style="color:#ff79c6">(</span>propertiesName<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;UTF-8&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        prop
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
<h3 id="实时数据生成模块">实时数据生成模块</h3>
<ul>
<li>
<p>config.properties</p>
<pre><code class="language-properties" data-lang="properties">jdbc.datasource.size=10
jdbc.url=jdbc:mysql://linux1:3306/spark2020?useUnicode=true&amp;characterEncoding=utf
8&amp;rewriteBatchedStatements=true
jdbc.user=root
jdbc.password=000000
# Kafka 配置
kafka.broker.list=linux1:9092,linux2:9092,linux3:9092
</code></pre></li>
<li>
<p>CityInfo</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#6272a4">/*</span><span style="color:#6272a4">*</span><span style="color:#6272a4">
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*</span><span style="color:#6272a4">
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*</span><span style="color:#6272a4"> 城市信息表
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*</span><span style="color:#6272a4">
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*</span><span style="color:#6272a4"> @param city_id 城市 id
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*</span><span style="color:#6272a4"> @param city_name 城市名称
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*</span><span style="color:#6272a4"> @param area 城市所在大区
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*/</span>
<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">class</span> <span style="color:#50fa7b">CityInfo</span> <span style="color:#ff79c6">(</span>city_id<span style="color:#ff79c6">:</span><span style="color:#8be9fd">Long</span><span style="color:#ff79c6">,</span>
                     city_name<span style="color:#ff79c6">:</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">,</span>
                     area<span style="color:#ff79c6">:</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span>
</code></pre></div></li>
<li>
<p>RandomOptions</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> scala.util.Random
<span style="color:#ff79c6">case</span> <span style="color:#ff79c6">class</span> <span style="color:#50fa7b">RanOpt</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">T</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span>value<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">T</span><span style="color:#ff79c6">,</span> weight<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Int</span><span style="color:#ff79c6">)</span>
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">RandomOptions</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> apply<span style="color:#ff79c6">[</span><span style="color:#8be9fd">T</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span>opts<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RanOpt</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">T</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">*</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RandomOptions</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">T</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">val</span> randomOptions <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">RandomOptions</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">T</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>opt <span style="color:#ff79c6">&lt;-</span> opts<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            randomOptions<span style="color:#ff79c6">.</span>totalWeight <span style="color:#ff79c6">+=</span> opt<span style="color:#ff79c6">.</span>weight
            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;-</span> <span style="color:#bd93f9">1</span> to opt<span style="color:#ff79c6">.</span>weight<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                randomOptions<span style="color:#ff79c6">.</span>optsBuffer <span style="color:#ff79c6">+=</span> opt<span style="color:#ff79c6">.</span>value
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
        randomOptions
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">class</span> <span style="color:#50fa7b">RandomOptions</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">T</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span>opts<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RanOpt</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">T</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">*</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">var</span> totalWeight <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
    <span style="color:#ff79c6">var</span> optsBuffer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">ListBuffer</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">T</span><span style="color:#ff79c6">]</span>
    <span style="color:#ff79c6">def</span> getRandomOpt<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">T</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">val</span> randomNum<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Int</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">Random</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>nextInt<span style="color:#ff79c6">(</span>totalWeight<span style="color:#ff79c6">)</span>
        optsBuffer<span style="color:#ff79c6">(</span>randomNum<span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<p>MockerRealTime</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> java.util.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">Properties</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Random</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> com.atguigu.bean.CityInfo
<span style="color:#ff79c6">import</span> com.atguigu.utils.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">PropertiesUtil</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">RanOpt</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">RandomOptions</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.kafka.clients.producer.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">KafkaProducer</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">ProducerConfig</span><span style="color:#ff79c6">,</span> 
                                          <span style="color:#50fa7b">ProducerRecord</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> scala.collection.mutable.ArrayBuffer
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">MockerRealTime</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">/*</span><span style="color:#6272a4">*</span><span style="color:#6272a4">
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*</span><span style="color:#6272a4"> 模拟的数据
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*</span><span style="color:#6272a4">
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*</span><span style="color:#6272a4"> 格式 ：timestamp area city userid adid
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*</span><span style="color:#6272a4"> 某个时间点 某个地区 某个城市 某个用户 某个广告
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*/</span>
    <span style="color:#ff79c6">def</span> generateMockData<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">val</span> array<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ArrayBuffer</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">ArrayBuffer</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> <span style="color:#50fa7b">CityRandomOpt</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">RandomOptions</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">RanOpt</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">CityInfo</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;北京&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;华北&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">30</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span>
                                          <span style="color:#50fa7b">RanOpt</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">CityInfo</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;上海&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;华东&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">30</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span>
                                          <span style="color:#50fa7b">RanOpt</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">CityInfo</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;广州&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;华南&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span>
                                          <span style="color:#50fa7b">RanOpt</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">CityInfo</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">4</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;深圳&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;华南&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">20</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span>
                                          <span style="color:#50fa7b">RanOpt</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">CityInfo</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">5</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;天津&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;华北&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> random <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">Random</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">// 模拟实时数据：
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// timestamp province city userid adid
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;-</span> <span style="color:#bd93f9">0</span> to <span style="color:#bd93f9">50</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">val</span> timestamp<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Long</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">System</span><span style="color:#ff79c6">.</span>currentTimeMillis<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">val</span> cityInfo<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">CityInfo</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">CityRandomOpt</span><span style="color:#ff79c6">.</span>getRandomOpt
            <span style="color:#ff79c6">val</span> city<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> cityInfo<span style="color:#ff79c6">.</span>city_name
            <span style="color:#ff79c6">val</span> area<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> cityInfo<span style="color:#ff79c6">.</span>area
            <span style="color:#ff79c6">val</span> adid<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Int</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> random<span style="color:#ff79c6">.</span>nextInt<span style="color:#ff79c6">(</span><span style="color:#bd93f9">6</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">val</span> userid<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Int</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> random<span style="color:#ff79c6">.</span>nextInt<span style="color:#ff79c6">(</span><span style="color:#bd93f9">6</span><span style="color:#ff79c6">)</span>
            <span style="color:#6272a4">// 拼接实时数据
</span><span style="color:#6272a4"></span>            array <span style="color:#ff79c6">+=</span> timestamp <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34; &#34;</span> <span style="color:#ff79c6">+</span> area <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34; &#34;</span> <span style="color:#ff79c6">+</span> city <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34; &#34;</span> <span style="color:#ff79c6">+</span> userid <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34; &#34;</span> <span style="color:#ff79c6">+</span> adid
        <span style="color:#ff79c6">}</span>
        array<span style="color:#ff79c6">.</span>toArray
    <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">def</span> createKafkaProducer<span style="color:#ff79c6">(</span>broker<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">KafkaProducer</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 创建配置对象
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> prop <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">Properties</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">// 添加配置
</span><span style="color:#6272a4"></span>        prop<span style="color:#ff79c6">.</span>put<span style="color:#ff79c6">(</span><span style="color:#50fa7b">ProducerConfig</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">BOOTSTRAP_SERVERS_CONFIG</span><span style="color:#ff79c6">,</span> broker<span style="color:#ff79c6">)</span>
        prop<span style="color:#ff79c6">.</span>put<span style="color:#ff79c6">(</span><span style="color:#50fa7b">ProducerConfig</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">KEY_SERIALIZER_CLASS_CONFIG</span><span style="color:#ff79c6">,</span> 
                 <span style="color:#f1fa8c">&#34;org.apache.kafka.common.serialization.StringSerializer&#34;</span><span style="color:#ff79c6">)</span>
        prop<span style="color:#ff79c6">.</span>put<span style="color:#ff79c6">(</span><span style="color:#50fa7b">ProducerConfig</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">VALUE_SERIALIZER_CLASS_CONFIG</span><span style="color:#ff79c6">,</span> 
                 <span style="color:#f1fa8c">&#34;org.apache.kafka.common.serialization.StringSerializer&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">// 根据配置创建 Kafka 生产者
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">KafkaProducer</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span>prop<span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 获取配置文件 config.properties 中的 Kafka 配置参数
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> config<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Properties</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">PropertiesUtil</span><span style="color:#ff79c6">.</span>load<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;config.properties&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> broker<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> config<span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;kafka.broker.list&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> topic <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;test&#34;</span>
        <span style="color:#6272a4">// 创建 Kafka 消费者
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> kafkaProducer<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">KafkaProducer</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> createKafkaProducer<span style="color:#ff79c6">(</span>broker<span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 随机产生实时数据并通过 Kafka 生产者发送到 Kafka 集群中
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>line <span style="color:#ff79c6">&lt;-</span> generateMockData<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                kafkaProducer<span style="color:#ff79c6">.</span>send<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#50fa7b">ProducerRecord</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span>topic<span style="color:#ff79c6">,</span> line<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
                println<span style="color:#ff79c6">(</span>line<span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">}</span>
            <span style="color:#50fa7b">Thread</span><span style="color:#ff79c6">.</span>sleep<span style="color:#ff79c6">(</span><span style="color:#bd93f9">2000</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
<h2 id="需求一广告黑名单">需求一：广告黑名单</h2>
<ul>
<li>实现实时的动态黑名单机制：将每天对某个广告点击超过 100 次的用户拉黑。<strong>注：黑名单保存到 MySQL 中。</strong></li>
</ul>
<h3 id="思路分析">思路分析</h3>
<ul>
<li>读取 Kafka 数据之后，并对 MySQL 中存储的黑名单数据做校验</li>
<li>校验通过则对给用户点击广告次数累加一并存入 MySQL</li>
<li>在存入 MySQL 之后对数据做校验，如果单日超过 100 次则将该用户加入黑名单</li>
</ul>
<h3 id="mysql-建表">MySQL 建表</h3>
<ul>
<li>
<p>创建库 spark2020</p>
</li>
<li>
<p>存放黑名单用户的表</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#50fa7b">black_list</span> (userid <span style="color:#8be9fd">CHAR</span>(<span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">PRIMARY</span> <span style="color:#ff79c6">KEY</span>);
</code></pre></div></li>
<li>
<p>存放单日各用户点击每个广告的次数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#50fa7b">user_ad_count</span> (
    dt <span style="color:#8be9fd">varchar</span>(<span style="color:#bd93f9">255</span>),
    userid <span style="color:#8be9fd">CHAR</span> (<span style="color:#bd93f9">1</span>),
    adid <span style="color:#8be9fd">CHAR</span> (<span style="color:#bd93f9">1</span>),
    count <span style="color:#8be9fd">BIGINT</span>,
    <span style="color:#ff79c6">PRIMARY</span> <span style="color:#ff79c6">KEY</span> (dt, userid, adid)
);
</code></pre></div></li>
</ul>
<h3 id="环境准备-1"><strong>环境准备</strong></h3>
<ul>
<li>
<p>接下来开始实时需求的分析，需要用到 SparkStreaming 来做实时数据的处理，在生产环境中，绝大部分时候都是对接的 Kafka 数据源，创建一个 SparkStreaming 读取 Kafka 数据的工具类</p>
</li>
<li>
<p>MyKafkaUtil</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> java.util.Properties
<span style="color:#ff79c6">import</span> org.apache.kafka.clients.consumer.ConsumerRecord
<span style="color:#ff79c6">import</span> org.apache.kafka.common.serialization.StringDeserializer
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.StreamingContext
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.dstream.InputDStream
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.kafka010.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">ConsumerStrategies</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">KafkaUtils</span><span style="color:#ff79c6">,</span> 
                                            <span style="color:#50fa7b">LocationStrategies</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">MyKafkaUtil</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">//1.创建配置信息对象
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">val</span> properties<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Properties</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">PropertiesUtil</span><span style="color:#ff79c6">.</span>load<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;config.properties&#34;</span><span style="color:#ff79c6">)</span>
    <span style="color:#6272a4">//2.用于初始化链接到集群的地址
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">val</span> broker_list<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> properties<span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;kafka.broker.list&#34;</span><span style="color:#ff79c6">)</span>
    <span style="color:#6272a4">//3.kafka 消费者配置
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">val</span> kafkaParam <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Map</span><span style="color:#ff79c6">(</span>
        <span style="color:#f1fa8c">&#34;bootstrap.servers&#34;</span> <span style="color:#ff79c6">-&gt;</span> broker_list<span style="color:#ff79c6">,</span>
        <span style="color:#f1fa8c">&#34;key.deserializer&#34;</span> <span style="color:#ff79c6">-&gt;</span> classOf<span style="color:#ff79c6">[</span><span style="color:#8be9fd">StringDeserializer</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">,</span>
        <span style="color:#f1fa8c">&#34;value.deserializer&#34;</span> <span style="color:#ff79c6">-&gt;</span> classOf<span style="color:#ff79c6">[</span><span style="color:#8be9fd">StringDeserializer</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">,</span>
        <span style="color:#6272a4">//消费者组
</span><span style="color:#6272a4"></span>        <span style="color:#f1fa8c">&#34;group.id&#34;</span> <span style="color:#ff79c6">-&gt;</span> <span style="color:#f1fa8c">&#34;commerce-consumer-group&#34;</span><span style="color:#ff79c6">,</span>
        <span style="color:#6272a4">//如果没有初始化偏移量或者当前的偏移量不存在任何服务器上，可以使用这个配置属性
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">//可以使用这个配置，latest 自动重置偏移量为最新的偏移量
</span><span style="color:#6272a4"></span>        <span style="color:#f1fa8c">&#34;auto.offset.reset&#34;</span> <span style="color:#ff79c6">-&gt;</span> <span style="color:#f1fa8c">&#34;latest&#34;</span><span style="color:#ff79c6">,</span>
        <span style="color:#6272a4">//如果是 true，则这个消费者的偏移量会在后台自动提交,但是 kafka 宕机容易丢失数据
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">//如果是 false，会需要手动维护 kafka 偏移量
</span><span style="color:#6272a4"></span>        <span style="color:#f1fa8c">&#34;enable.auto.commit&#34;</span> <span style="color:#ff79c6">-&gt;</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">java</span><span style="color:#8be9fd">.</span><span style="color:#8be9fd">lang</span><span style="color:#8be9fd">.</span><span style="color:#8be9fd">Boolean</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">)</span>
    <span style="color:#6272a4">// 创建 DStream，返回接收到的输入数据
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// LocationStrategies：根据给定的主题和集群地址创建 consumer
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// LocationStrategies.PreferConsistent：持续的在所有 Executor 之间分配分区
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// ConsumerStrategies：选择如何在 Driver 和 Executor 上创建和配置 Kafka Consumer
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// ConsumerStrategies.Subscribe：订阅一系列主题
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">def</span> getKafkaStream<span style="color:#ff79c6">(</span>topic<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span><span style="color:#ff79c6">,</span> ssc<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">StreamingContext</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> 
    <span style="color:#8be9fd">InputDStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">ConsumerRecord</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">val</span> dStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">InputDStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">ConsumerRecord</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        <span style="color:#50fa7b">KafkaUtils</span><span style="color:#ff79c6">.</span>createDirectStream<span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span>ssc<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">LocationStrategies</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">PreferConsistent</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">ConsumerStrategies</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Subscribe</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>,<span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">Array</span><span style="color:#ff79c6">(</span>topic<span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> kafkaParam<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        dStream
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<p>JdbcUtil</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> java.sql.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">Connection</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">PreparedStatement</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">ResultSet</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> java.util.Properties
<span style="color:#ff79c6">import</span> javax.sql.DataSource
<span style="color:#ff79c6">import</span> com.alibaba.druid.pool.DruidDataSourceFactory
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">JdbcUtil</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">//初始化连接池
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">var</span> dataSource<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DataSource</span> <span style="color:#ff79c6">=</span> init<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#6272a4">//初始化连接池方法
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">def</span> init<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DataSource</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">val</span> properties <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">Properties</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> config<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Properties</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">PropertiesUtil</span><span style="color:#ff79c6">.</span>load<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;config.properties&#34;</span><span style="color:#ff79c6">)</span>
        properties<span style="color:#ff79c6">.</span>setProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;driverClassName&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;com.mysql.jdbc.Driver&#34;</span><span style="color:#ff79c6">)</span>
        properties<span style="color:#ff79c6">.</span>setProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;url&#34;</span><span style="color:#ff79c6">,</span> config<span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;jdbc.url&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        properties<span style="color:#ff79c6">.</span>setProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;username&#34;</span><span style="color:#ff79c6">,</span> config<span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;jdbc.user&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        properties<span style="color:#ff79c6">.</span>setProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;password&#34;</span><span style="color:#ff79c6">,</span> config<span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;jdbc.password&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        properties<span style="color:#ff79c6">.</span>setProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;maxActive&#34;</span><span style="color:#ff79c6">,</span> 
                               config<span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;jdbc.datasource.size&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#50fa7b">DruidDataSourceFactory</span><span style="color:#ff79c6">.</span>createDataSource<span style="color:#ff79c6">(</span>properties<span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span>
    <span style="color:#6272a4">//获取 MySQL 连接
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">def</span> getConnection<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Connection</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        dataSource<span style="color:#ff79c6">.</span>getConnection
    <span style="color:#ff79c6">}</span>
    <span style="color:#6272a4">//执行 SQL 语句,单条数据插入
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">def</span> executeUpdate<span style="color:#ff79c6">(</span>connection<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Connection</span><span style="color:#ff79c6">,</span> sql<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span><span style="color:#ff79c6">,</span> params<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Any</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Int</span> 
    <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">var</span> rtn <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
        <span style="color:#ff79c6">var</span> pstmt<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">PreparedStatement</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            connection<span style="color:#ff79c6">.</span>setAutoCommit<span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">)</span>
            pstmt <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span>prepareStatement<span style="color:#ff79c6">(</span>sql<span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>params <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> params<span style="color:#ff79c6">.</span>length <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;-</span> params<span style="color:#ff79c6">.</span>indices<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    pstmt<span style="color:#ff79c6">.</span>setObject<span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> params<span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span>
            rtn <span style="color:#ff79c6">=</span> pstmt<span style="color:#ff79c6">.</span>executeUpdate<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            connection<span style="color:#ff79c6">.</span>commit<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            pstmt<span style="color:#ff79c6">.</span>close<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">case</span> e<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Exception</span> <span style="color:#ff79c6">=&gt;</span> e<span style="color:#ff79c6">.</span>printStackTrace<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span>
        rtn
    <span style="color:#ff79c6">}</span>
    <span style="color:#6272a4">//执行 SQL 语句,批量数据插入
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">def</span> executeBatchUpdate<span style="color:#ff79c6">(</span>connection<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Connection</span><span style="color:#ff79c6">,</span> sql<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span><span style="color:#ff79c6">,</span> paramsList<span style="color:#ff79c6">:</span> 
                           <span style="color:#8be9fd">Iterable</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Any</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">var</span> rtn<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>
        <span style="color:#ff79c6">var</span> pstmt<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">PreparedStatement</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            connection<span style="color:#ff79c6">.</span>setAutoCommit<span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">)</span>
            pstmt <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span>prepareStatement<span style="color:#ff79c6">(</span>sql<span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>params <span style="color:#ff79c6">&lt;-</span> paramsList<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>params <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> params<span style="color:#ff79c6">.</span>length <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;-</span> params<span style="color:#ff79c6">.</span>indices<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                        pstmt<span style="color:#ff79c6">.</span>setObject<span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> params<span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
                    <span style="color:#ff79c6">}</span>
                    pstmt<span style="color:#ff79c6">.</span>addBatch<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span>
            rtn <span style="color:#ff79c6">=</span> pstmt<span style="color:#ff79c6">.</span>executeBatch<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            connection<span style="color:#ff79c6">.</span>commit<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            pstmt<span style="color:#ff79c6">.</span>close<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">case</span> e<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Exception</span> <span style="color:#ff79c6">=&gt;</span> e<span style="color:#ff79c6">.</span>printStackTrace<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span>
        rtn
    <span style="color:#ff79c6">}</span>
    <span style="color:#6272a4">//判断一条数据是否存在
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">def</span> isExist<span style="color:#ff79c6">(</span>connection<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Connection</span><span style="color:#ff79c6">,</span> sql<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span><span style="color:#ff79c6">,</span> params<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Any</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Boolean</span> <span style="color:#ff79c6">=</span> 
    <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">var</span> flag<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Boolean</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span>
        <span style="color:#ff79c6">var</span> pstmt<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">PreparedStatement</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            pstmt <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span>prepareStatement<span style="color:#ff79c6">(</span>sql<span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;-</span> params<span style="color:#ff79c6">.</span>indices<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                pstmt<span style="color:#ff79c6">.</span>setObject<span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> params<span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">}</span>
            flag <span style="color:#ff79c6">=</span> pstmt<span style="color:#ff79c6">.</span>executeQuery<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>next<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            pstmt<span style="color:#ff79c6">.</span>close<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">case</span> e<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Exception</span> <span style="color:#ff79c6">=&gt;</span> e<span style="color:#ff79c6">.</span>printStackTrace<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span>
        flag
    <span style="color:#ff79c6">}</span>
    <span style="color:#6272a4">//获取 MySQL 的一条数据
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">def</span> getDataFromMysql<span style="color:#ff79c6">(</span>connection<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Connection</span><span style="color:#ff79c6">,</span> sql<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span><span style="color:#ff79c6">,</span> params<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Any</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> 
    <span style="color:#8be9fd">Long</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">var</span> result<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Long</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0L</span>
        <span style="color:#ff79c6">var</span> pstmt<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">PreparedStatement</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            pstmt <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span>prepareStatement<span style="color:#ff79c6">(</span>sql<span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;-</span> params<span style="color:#ff79c6">.</span>indices<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                pstmt<span style="color:#ff79c6">.</span>setObject<span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> params<span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">val</span> resultSet<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ResultSet</span> <span style="color:#ff79c6">=</span> pstmt<span style="color:#ff79c6">.</span>executeQuery<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>resultSet<span style="color:#ff79c6">.</span>next<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                result <span style="color:#ff79c6">=</span> resultSet<span style="color:#ff79c6">.</span>getLong<span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">}</span>
            resultSet<span style="color:#ff79c6">.</span>close<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            pstmt<span style="color:#ff79c6">.</span>close<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">case</span> e<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Exception</span> <span style="color:#ff79c6">=&gt;</span> e<span style="color:#ff79c6">.</span>printStackTrace<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span>
        result
    <span style="color:#ff79c6">}</span>
    <span style="color:#6272a4">//主方法,用于测试上述方法
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
<h3 id="代码实现"><strong>代码实现</strong></h3>
<ul>
<li>
<p>Ads_log</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">case</span> <span style="color:#ff79c6">class</span> <span style="color:#50fa7b">Ads_log</span><span style="color:#ff79c6">(</span>timestamp<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Long</span><span style="color:#ff79c6">,</span>
                   area<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span><span style="color:#ff79c6">,</span>
                   city<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span><span style="color:#ff79c6">,</span>
                   userid<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span><span style="color:#ff79c6">,</span>
                   adid<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span>
</code></pre></div></li>
<li>
<p>BlackListHandler</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> java.sql.Connection
<span style="color:#ff79c6">import</span> java.text.SimpleDateFormat
<span style="color:#ff79c6">import</span> java.util.Date
<span style="color:#ff79c6">import</span> com.atguigu.bean.Ads_log
<span style="color:#ff79c6">import</span> com.atguigu.utils.JdbcUtil
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.dstream.DStream
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">BlackListHandler</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">//时间格式化对象
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">val</span> sdf <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">SimpleDateFormat</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;yyyy-MM-dd&#34;</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">def</span> addBlackList<span style="color:#ff79c6">(</span>filterAdsLogDSteam<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ads_log</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//统计当前批次中单日每个用户点击每个广告的总次数
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">//1.将数据接转换结构 ads_log=&gt;((date,user,adid),1)
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> dateUserAdToOne<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span>, <span style="color:#8be9fd">Long</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        filterAdsLogDSteam<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span>adsLog <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">//a.将时间戳转换为日期字符串
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">val</span> date<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> sdf<span style="color:#ff79c6">.</span>format<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#50fa7b">Date</span><span style="color:#ff79c6">(</span>adsLog<span style="color:#ff79c6">.</span>timestamp<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
            <span style="color:#6272a4">//b.返回值
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>date<span style="color:#ff79c6">,</span> adsLog<span style="color:#ff79c6">.</span>userid<span style="color:#ff79c6">,</span> adsLog<span style="color:#ff79c6">.</span>adid<span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1L</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//2.统计单日每个用户点击每个广告的总次数
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>date<span style="color:#ff79c6">,</span>user<span style="color:#ff79c6">,</span>adid<span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">=&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>date<span style="color:#ff79c6">,</span>user<span style="color:#ff79c6">,</span>adid<span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span>count<span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> dateUserAdToCount<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span>, <span style="color:#8be9fd">Long</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        dateUserAdToOne<span style="color:#ff79c6">.</span>reduceByKey<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span>
        dateUserAdToCount<span style="color:#ff79c6">.</span>foreachRDD<span style="color:#ff79c6">(</span>rdd <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
            rdd<span style="color:#ff79c6">.</span>foreachPartition<span style="color:#ff79c6">(</span>iter <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">val</span> connection<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Connection</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">.</span>getConnection
                iter<span style="color:#ff79c6">.</span>foreach <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>dt<span style="color:#ff79c6">,</span> user<span style="color:#ff79c6">,</span> ad<span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> count<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
                    <span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">.</span>executeUpdate<span style="color:#ff79c6">(</span>connection<span style="color:#ff79c6">,</span>
                     <span style="color:#f1fa8c">&#34;&#34;&#34;
</span><span style="color:#f1fa8c">                     |INSERT INTO user_ad_count (dt,userid,adid,count)
</span><span style="color:#f1fa8c">                     |VALUES (?,?,?,?)
</span><span style="color:#f1fa8c">                     |ON DUPLICATE KEY
</span><span style="color:#f1fa8c">                     |UPDATE count=count+?
</span><span style="color:#f1fa8c">                     &#34;&#34;&#34;</span><span style="color:#ff79c6">.</span>stripMargin<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Array</span><span style="color:#ff79c6">(</span>dt<span style="color:#ff79c6">,</span> user<span style="color:#ff79c6">,</span> ad<span style="color:#ff79c6">,</span> count<span style="color:#ff79c6">,</span> count<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
                    <span style="color:#ff79c6">val</span> ct<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Long</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">.</span>getDataFromMysql<span style="color:#ff79c6">(</span>connection<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;select count from user_ad_count where dt=? and userid=? and adid =?&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Array</span><span style="color:#ff79c6">(</span>dt<span style="color:#ff79c6">,</span> user<span style="color:#ff79c6">,</span> ad<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
                    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>ct <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">30</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                        <span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">.</span>executeUpdate<span style="color:#ff79c6">(</span>connection<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;INSERT INTO black_list (userid) VALUES (?) ON DUPLICATE KEY update userid=?&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Array</span><span style="color:#ff79c6">(</span>user<span style="color:#ff79c6">,</span> user<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
                    <span style="color:#ff79c6">}</span>
                <span style="color:#ff79c6">}</span>
                connection<span style="color:#ff79c6">.</span>close<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">def</span> filterByBlackList<span style="color:#ff79c6">(</span>adsLogDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ads_log</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ads_log</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        adsLogDStream<span style="color:#ff79c6">.</span>transform<span style="color:#ff79c6">(</span>rdd <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
            rdd<span style="color:#ff79c6">.</span>filter<span style="color:#ff79c6">(</span>adsLog <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">val</span> connection<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Connection</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">.</span>getConnection
                <span style="color:#ff79c6">val</span> bool<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Boolean</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">.</span>isExist<span style="color:#ff79c6">(</span>connection<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;select * from black_list 
</span><span style="color:#f1fa8c">where userid=?&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Array</span><span style="color:#ff79c6">(</span>adsLog<span style="color:#ff79c6">.</span>userid<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
                connection<span style="color:#ff79c6">.</span>close<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
                <span style="color:#ff79c6">!</span>bool
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<p>RealtimeApp</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> com.atguigu.bean.Ads_log
<span style="color:#ff79c6">import</span> com.atguigu.handler.BlackListHandler
<span style="color:#ff79c6">import</span> com.atguigu.utils.MyKafkaUtil
<span style="color:#ff79c6">import</span> org.apache.kafka.clients.consumer.ConsumerRecord
<span style="color:#ff79c6">import</span> org.apache.spark.SparkConf
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.dstream.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">DStream</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">InputDStream</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">RealTimeApp</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//1.创建 SparkConf
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> sparkConf<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkConf</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;RealTimeApp 
</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//2.创建 StreamingContext
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>sparkConf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//3.读取数据
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> kafkaDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">InputDStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">ConsumerRecord</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        <span style="color:#50fa7b">MyKafkaUtil</span><span style="color:#ff79c6">.</span>getKafkaStream<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;ads_log&#34;</span><span style="color:#ff79c6">,</span> ssc<span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//4.将从 Kafka 读出的数据转换为样例类对象
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> adsLogDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ads_log</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> kafkaDStream<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span>record <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">val</span> value<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> record<span style="color:#ff79c6">.</span>value<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">val</span> arr<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> value<span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; &#34;</span><span style="color:#ff79c6">)</span>
            <span style="color:#50fa7b">Ads_log</span><span style="color:#ff79c6">(</span>arr<span style="color:#ff79c6">(</span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>toLong<span style="color:#ff79c6">,</span> arr<span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> arr<span style="color:#ff79c6">(</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> arr<span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> arr<span style="color:#ff79c6">(</span><span style="color:#bd93f9">4</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//5.需求一：根据 MySQL 中的黑名单过滤当前数据集
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> filterAdsLogDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ads_log</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        <span style="color:#50fa7b">BlackListHandler2</span><span style="color:#ff79c6">.</span>filterByBlackList<span style="color:#ff79c6">(</span>adsLogDStream<span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//6.需求一：将满足要求的用户写入黑名单
</span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">BlackListHandler2</span><span style="color:#ff79c6">.</span>addBlackList<span style="color:#ff79c6">(</span>filterAdsLogDStream<span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//测试打印
</span><span style="color:#6272a4"></span>        filterAdsLogDStream<span style="color:#ff79c6">.</span>cache<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        filterAdsLogDStream<span style="color:#ff79c6">.</span>count<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>print<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//启动任务
</span><span style="color:#6272a4"></span>        ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
<h2 id="需求二广告点击量实时统计">需求二：广告点击量实时统计</h2>
<ul>
<li>描述：实时统计每天各地区各城市各广告的点击总流量，并将其存入 MySQL。</li>
</ul>
<h3 id="思路分析-1">思路分析</h3>
<ul>
<li>单个批次内对数据进行按照天维度的聚合统计</li>
<li>结合 MySQL 数据跟当前批次数据更新原有的数据</li>
</ul>
<h3 id="mysql-建表-1">MySQL 建表</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#50fa7b">area_city_ad_count</span> (
    dt <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">255</span>),
    area <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">255</span>),
    city <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">255</span>),
    adid <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">255</span>),
    count <span style="color:#8be9fd">BIGINT</span>,
    <span style="color:#ff79c6">PRIMARY</span> <span style="color:#ff79c6">KEY</span> (dt,area,city,adid)
);
</code></pre></div><h3 id="代码实现-1">代码实现</h3>
<ul>
<li>
<p>DateAreaCityAdCountHandler</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> java.sql.Connection
<span style="color:#ff79c6">import</span> java.text.SimpleDateFormat
<span style="color:#ff79c6">import</span> java.util.Date
<span style="color:#ff79c6">import</span> com.atguigu.bean.Ads_log
<span style="color:#ff79c6">import</span> com.atguigu.utils.JdbcUtil
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.dstream.DStream
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">DateAreaCityAdCountHandler</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">//时间格式化对象
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">val</span> sdf<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SimpleDateFormat</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">SimpleDateFormat</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;yyyy-MM-dd&#34;</span><span style="color:#ff79c6">)</span>
    <span style="color:#6272a4">/*</span><span style="color:#6272a4">*</span><span style="color:#6272a4">
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*</span><span style="color:#6272a4"> 统计每天各大区各个城市广告点击总数并保存至 MySQL 中
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*</span><span style="color:#6272a4">
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*</span><span style="color:#6272a4"> @param filterAdsLogDStream 根据黑名单过滤后的数据集
</span><span style="color:#6272a4"> </span><span style="color:#6272a4">*/</span>
    <span style="color:#ff79c6">def</span> saveDateAreaCityAdCountToMysql<span style="color:#ff79c6">(</span>filterAdsLogDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ads_log</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> 
    <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//1.统计每天各大区各个城市广告点击总数
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> dateAreaCityAdToCount<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span>, <span style="color:#8be9fd">Long</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        filterAdsLogDStream<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span>ads_log <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">//a.取出时间戳
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">val</span> timestamp<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Long</span> <span style="color:#ff79c6">=</span> ads_log<span style="color:#ff79c6">.</span>timestamp
            <span style="color:#6272a4">//b.格式化为日期字符串
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">val</span> dt<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> sdf<span style="color:#ff79c6">.</span>format<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#50fa7b">Date</span><span style="color:#ff79c6">(</span>timestamp<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
            <span style="color:#6272a4">//c.组合,返回
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>dt<span style="color:#ff79c6">,</span> ads_log<span style="color:#ff79c6">.</span>area<span style="color:#ff79c6">,</span> ads_log<span style="color:#ff79c6">.</span>city<span style="color:#ff79c6">,</span> ads_log<span style="color:#ff79c6">.</span>adid<span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1L</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>reduceByKey<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//2.将单个批次统计之后的数据集合 MySQL 数据对原有的数据更新
</span><span style="color:#6272a4"></span>        dateAreaCityAdToCount<span style="color:#ff79c6">.</span>foreachRDD<span style="color:#ff79c6">(</span>rdd <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">//对每个分区单独处理
</span><span style="color:#6272a4"></span>            rdd<span style="color:#ff79c6">.</span>foreachPartition<span style="color:#ff79c6">(</span>iter <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
                <span style="color:#6272a4">//a.获取连接
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">val</span> connection<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Connection</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">.</span>getConnection
                <span style="color:#6272a4">//b.写库
</span><span style="color:#6272a4"></span>                iter<span style="color:#ff79c6">.</span>foreach <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>dt<span style="color:#ff79c6">,</span> area<span style="color:#ff79c6">,</span> city<span style="color:#ff79c6">,</span> adid<span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> count<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
                    <span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">.</span>executeUpdate<span style="color:#ff79c6">(</span>connection<span style="color:#ff79c6">,</span>
                         <span style="color:#f1fa8c">&#34;&#34;&#34;
</span><span style="color:#f1fa8c">                         |INSERT INTO area_city_ad_count (dt,area,city,adid,count)
</span><span style="color:#f1fa8c">                         |VALUES(?,?,?,?,?)
</span><span style="color:#f1fa8c">                         |ON DUPLICATE KEY
</span><span style="color:#f1fa8c">                         |UPDATE count=count+?;
</span><span style="color:#f1fa8c">                         &#34;&#34;&#34;</span><span style="color:#ff79c6">.</span>stripMargin<span style="color:#ff79c6">,</span><span style="color:#50fa7b">Array</span><span style="color:#ff79c6">(</span>dt<span style="color:#ff79c6">,</span> area<span style="color:#ff79c6">,</span> city<span style="color:#ff79c6">,</span> adid<span style="color:#ff79c6">,</span> count<span style="color:#ff79c6">,</span> count<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
                <span style="color:#ff79c6">}</span>
                <span style="color:#6272a4">//c.释放连接
</span><span style="color:#6272a4"></span>                connection<span style="color:#ff79c6">.</span>close<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<p>RealTimeApp</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> java.sql.Connection
<span style="color:#ff79c6">import</span> com.atguigu.bean.Ads_log
<span style="color:#ff79c6">import</span> com.atguigu.handler.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">BlackListHandler</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">DateAreaCityAdCountHandler</span><span style="color:#ff79c6">,</span> 
                            <span style="color:#50fa7b">LastHourAdCountHandler</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> com.atguigu.utils.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">MyKafkaUtil</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">PropertiesUtil</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.kafka.clients.consumer.ConsumerRecord
<span style="color:#ff79c6">import</span> org.apache.spark.SparkConf
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.dstream.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">DStream</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">InputDStream</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">RealTimeApp</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//1.创建 SparkConf
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> sparkConf<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkConf</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> 
        <span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;RealTimeApp&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//2.创建 StreamingContext
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>sparkConf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//3.读取 Kafka 数据 1583288137305 华南 深圳 4 3
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> topic<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> 
        <span style="color:#50fa7b">PropertiesUtil</span><span style="color:#ff79c6">.</span>load<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;config.properties&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;kafka.topic&#34;</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">val</span> kafkaDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">InputDStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">ConsumerRecord</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        <span style="color:#50fa7b">MyKafkaUtil</span><span style="color:#ff79c6">.</span>getKafkaStream<span style="color:#ff79c6">(</span>topic<span style="color:#ff79c6">,</span> ssc<span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//4.将每一行数据转换为样例类对象
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> adsLogDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ads_log</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> kafkaDStream<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span>record <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">//a.取出 value 并按照&#34; &#34;切分
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">val</span> arr<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> record<span style="color:#ff79c6">.</span>value<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; &#34;</span><span style="color:#ff79c6">)</span>
            <span style="color:#6272a4">//b.封装为样例类对象
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//5.根据 MySQL 中的黑名单表进行数据过滤
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> filterAdsLogDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ads_log</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> adsLogDStream<span style="color:#ff79c6">.</span>filter<span style="color:#ff79c6">(</span>adsLog <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">//查询 MySQL,查看当前用户是否存在。
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">val</span> connection<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Connection</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">.</span>getConnection
            <span style="color:#ff79c6">val</span> bool<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Boolean</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">.</span>isExist<span style="color:#ff79c6">(</span>connection<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;select * from black_list 
</span><span style="color:#f1fa8c">where userid=?&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Array</span><span style="color:#ff79c6">(</span>adsLog<span style="color:#ff79c6">.</span>userid<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
            connection<span style="color:#ff79c6">.</span>close<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">!</span>bool
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
        filterAdsLogDStream<span style="color:#ff79c6">.</span>cache<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//6.对没有被加入黑名单的用户统计当前批次单日各个用户对各个广告点击的总次数,
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 并更新至 MySQL
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 之后查询更新之后的数据,判断是否超过 100 次。
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 如果超过则将给用户加入黑名单
</span><span style="color:#6272a4"></span>        <span style="color:#50fa7b">BlackListHandler</span><span style="color:#ff79c6">.</span>saveBlackListToMysql<span style="color:#ff79c6">(</span>filterAdsLogDStream<span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//7.统计每天各大区各个城市广告点击总数并保存至 MySQL 中
</span><span style="color:#6272a4"></span>        dateAreaCityAdCountHandler<span style="color:#ff79c6">.</span>saveDateAreaCityAdCountToMysql<span style="color:#ff79c6">(</span>filterAdsLogDStream<span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//10.开启任务
</span><span style="color:#6272a4"></span>        ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
<h2 id="需求三最近一小时广告点击量">需求三：最近一小时广告点击量</h2>
<ul>
<li>
<p>结果展示：</p>
<pre><code>1：List [15:50-&gt;10,15:51-&gt;25,15:52-&gt;30]
2：List [15:50-&gt;10,15:51-&gt;25,15:52-&gt;30]
3：List [15:50-&gt;10,15:51-&gt;25,15:52-&gt;30]
</code></pre></li>
</ul>
<h3 id="思路分析-2"><strong>思路分析</strong></h3>
<ul>
<li>开窗确定时间范围</li>
<li>在窗口内将数据转换数据结构为((adid,hm),count);</li>
<li>按照广告 id 进行分组处理，组内按照时分排序。</li>
</ul>
<h3 id="代码实现-2">代码实现</h3>
<ul>
<li>
<p>LastHourAdCountHandler</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> java.text.SimpleDateFormat
<span style="color:#ff79c6">import</span> java.util.Date
<span style="color:#ff79c6">import</span> com.atguigu.bean.Ads_log
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.Minutes
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.dstream.DStream
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">LastHourAdCountHandler</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">//时间格式化对象
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">val</span> sdf<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SimpleDateFormat</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">SimpleDateFormat</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;HH:mm&#34;</span><span style="color:#ff79c6">)</span>
    <span style="color:#6272a4">/*</span><span style="color:#6272a4">*</span><span style="color:#6272a4">
</span><span style="color:#6272a4">     </span><span style="color:#6272a4">*</span><span style="color:#6272a4"> 统计最近一小时(2 分钟)广告分时点击总数
</span><span style="color:#6272a4">     </span><span style="color:#6272a4">*</span><span style="color:#6272a4">
</span><span style="color:#6272a4">     </span><span style="color:#6272a4">*</span><span style="color:#6272a4"> @param filterAdsLogDStream 过滤后的数据集
</span><span style="color:#6272a4">     </span><span style="color:#6272a4">*</span><span style="color:#6272a4"> @return
</span><span style="color:#6272a4">     </span><span style="color:#6272a4">*/</span>
    <span style="color:#ff79c6">def</span> getAdHourMintToCount<span style="color:#ff79c6">(</span>filterAdsLogDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ads_log</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> 
    <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">List</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Long</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//1.开窗 =&gt; 时间间隔为 1 个小时 window()
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> windowAdsLogDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ads_log</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        filterAdsLogDStream<span style="color:#ff79c6">.</span>window<span style="color:#ff79c6">(</span><span style="color:#50fa7b">Minutes</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//2.转换数据结构 ads_log =&gt;((adid,hm),1L) map()
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> adHmToOneDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span>, <span style="color:#8be9fd">Long</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        windowAdsLogDStream<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span>adsLog <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">val</span> timestamp<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Long</span> <span style="color:#ff79c6">=</span> adsLog<span style="color:#ff79c6">.</span>timestamp
            <span style="color:#ff79c6">val</span> hm<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> sdf<span style="color:#ff79c6">.</span>format<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#50fa7b">Date</span><span style="color:#ff79c6">(</span>timestamp<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>adsLog<span style="color:#ff79c6">.</span>adid<span style="color:#ff79c6">,</span> hm<span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1L</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//3.统计总数 ((adid,hm),1L)=&gt;((adid,hm),sum) reduceBykey(_+_)
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> adHmToCountDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">)</span>, <span style="color:#8be9fd">Long</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        adHmToOneDStream<span style="color:#ff79c6">.</span>reduceByKey<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span>
        <span style="color:#6272a4">//4.转换数据结构 ((adid,hm),sum)=&gt;(adid,(hm,sum)) map()
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> adToHmCountDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Long</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
        adHmToCountDStream<span style="color:#ff79c6">.</span>map <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>adid<span style="color:#ff79c6">,</span> hm<span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> count<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
            <span style="color:#ff79c6">(</span>adid<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>hm<span style="color:#ff79c6">,</span> count<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#6272a4">//5.按照 adid 分组 (adid,(hm,sum))=&gt;(adid,Iter[(hm,sum),...]) groupByKey
</span><span style="color:#6272a4"></span>        adToHmCountDStream<span style="color:#ff79c6">.</span>groupByKey<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span>mapValues<span style="color:#ff79c6">(</span>iter <span style="color:#ff79c6">=&gt;</span>
                   iter<span style="color:#ff79c6">.</span>toList<span style="color:#ff79c6">.</span>sortWith<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>_1 <span style="color:#ff79c6">&lt;</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>_1<span style="color:#ff79c6">)</span>
                  <span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<p>RealTimeApp</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#ff79c6">import</span> java.sql.Connection
<span style="color:#ff79c6">import</span> com.atguigu.bean.Ads_log
<span style="color:#ff79c6">import</span> com.atguigu.handler.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">BlackListHandler</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">DateAreaCityAdCountHandler</span><span style="color:#ff79c6">,</span> 
<span style="color:#50fa7b">LastHourAdCountHandler</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> com.atguigu.utils.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">MyKafkaUtil</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">PropertiesUtil</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.kafka.clients.consumer.ConsumerRecord
<span style="color:#ff79c6">import</span> org.apache.spark.SparkConf
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.dstream.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">DStream</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">InputDStream</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">import</span> org.apache.spark.streaming.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">object</span> <span style="color:#50fa7b">RealTimeApp</span> <span style="color:#ff79c6">{</span>
 <span style="color:#ff79c6">def</span> main<span style="color:#ff79c6">(</span>args<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
     <span style="color:#6272a4">//1.创建 SparkConf
</span><span style="color:#6272a4"></span> <span style="color:#ff79c6">val</span> sparkConf<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkConf</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> 
<span style="color:#50fa7b">SparkConf</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setMaster<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>setAppName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;RealTimeApp&#34;</span><span style="color:#ff79c6">)</span>
 <span style="color:#6272a4">//2.创建 StreamingContext
</span><span style="color:#6272a4"></span> <span style="color:#ff79c6">val</span> ssc <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">StreamingContext</span><span style="color:#ff79c6">(</span>sparkConf<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seconds</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
 <span style="color:#6272a4">//3.读取 Kafka 数据 1583288137305 华南 深圳 4 3
</span><span style="color:#6272a4"></span> <span style="color:#ff79c6">val</span> topic<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> 
<span style="color:#50fa7b">PropertiesUtil</span><span style="color:#ff79c6">.</span>load<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;config.properties&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;kafka.topic&#34;</span><span style="color:#ff79c6">)</span>
 <span style="color:#ff79c6">val</span> kafkaDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">InputDStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">ConsumerRecord</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
<span style="color:#50fa7b">MyKafkaUtil</span><span style="color:#ff79c6">.</span>getKafkaStream<span style="color:#ff79c6">(</span>topic<span style="color:#ff79c6">,</span> ssc<span style="color:#ff79c6">)</span>
 <span style="color:#6272a4">//4.将每一行数据转换为样例类对象
</span><span style="color:#6272a4"></span> <span style="color:#ff79c6">val</span> adsLogDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ads_log</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> kafkaDStream<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span>record <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
 <span style="color:#6272a4">//a.取出 value 并按照&#34; &#34;切分
</span><span style="color:#6272a4"></span> <span style="color:#ff79c6">val</span> arr<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">String</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> record<span style="color:#ff79c6">.</span>value<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; &#34;</span><span style="color:#ff79c6">)</span>
 <span style="color:#6272a4">//b.封装为样例类对象
</span><span style="color:#6272a4"></span> <span style="color:#50fa7b">Ads_log</span><span style="color:#ff79c6">(</span>arr<span style="color:#ff79c6">(</span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span>toLong<span style="color:#ff79c6">,</span> arr<span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> arr<span style="color:#ff79c6">(</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> arr<span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> arr<span style="color:#ff79c6">(</span><span style="color:#bd93f9">4</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
 <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
 <span style="color:#6272a4">//5.根据 MySQL 中的黑名单表进行数据过滤
</span><span style="color:#6272a4"></span> <span style="color:#ff79c6">val</span> filterAdsLogDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ads_log</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> adsLogDStream<span style="color:#ff79c6">.</span>filter<span style="color:#ff79c6">(</span>adsLog <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">{</span>
 <span style="color:#6272a4">//查询 MySQL,查看当前用户是否存在。
</span><span style="color:#6272a4"></span> <span style="color:#ff79c6">val</span> connection<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Connection</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">.</span>getConnection
 <span style="color:#ff79c6">val</span> bool<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Boolean</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">JdbcUtil</span><span style="color:#ff79c6">.</span>isExist<span style="color:#ff79c6">(</span>connection<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;select * from black_list 
</span><span style="color:#f1fa8c">where userid=?&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Array</span><span style="color:#ff79c6">(</span>adsLog<span style="color:#ff79c6">.</span>userid<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
 connection<span style="color:#ff79c6">.</span>close<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
 <span style="color:#ff79c6">!</span>bool
 <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
 filterAdsLogDStream<span style="color:#ff79c6">.</span>cache<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
 <span style="color:#6272a4">//6.对没有被加入黑名单的用户统计当前批次单日各个用户对各个广告点击的总次数,
</span><span style="color:#6272a4"></span> <span style="color:#6272a4">// 并更新至 MySQL
</span><span style="color:#6272a4"></span> <span style="color:#6272a4">// 之后查询更新之后的数据,判断是否超过 100 次。
</span><span style="color:#6272a4"></span> <span style="color:#6272a4">// 如果超过则将给用户加入黑名单
</span><span style="color:#6272a4"></span> <span style="color:#50fa7b">BlackListHandler</span><span style="color:#ff79c6">.</span>saveBlackListToMysql<span style="color:#ff79c6">(</span>filterAdsLogDStream<span style="color:#ff79c6">)</span>
 <span style="color:#6272a4">//7.统计每天各大区各个城市广告点击总数并保存至 MySQL 中
</span><span style="color:#6272a4"></span> <span style="color:#50fa7b">DateAreaCityAdCountHandler</span><span style="color:#ff79c6">.</span>saveDateAreaCityAdCountToMysql<span style="color:#ff79c6">(</span>filterAdsLogDStream<span style="color:#ff79c6">)</span>
 <span style="color:#6272a4">//8.统计最近一小时(2 分钟)广告分时点击总数
</span><span style="color:#6272a4"></span> <span style="color:#ff79c6">val</span> adToHmCountListDStream<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DStream</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">List</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Long</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> 
<span style="color:#50fa7b">LastHourAdCountHandler</span><span style="color:#ff79c6">.</span>getAdHourMintToCount<span style="color:#ff79c6">(</span>filterAdsLogDStream<span style="color:#ff79c6">)</span>
 <span style="color:#6272a4">//9.打印
</span><span style="color:#6272a4"></span> adToHmCountListDStream<span style="color:#ff79c6">.</span>print<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
 <span style="color:#6272a4">//10.开启任务
</span><span style="color:#6272a4"></span> ssc<span style="color:#ff79c6">.</span>start<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
 ssc<span style="color:#ff79c6">.</span>awaitTermination<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
 <span style="color:#ff79c6">}</span> 
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>


                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/943sparksql/" data-toggle="tooltip" data-placement="top" title="3、SparkSql（Spark）">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/1001hive%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" data-toggle="tooltip" data-placement="top" title="1、Hive基本概念（Hive）">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">标签</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/activemq" title="activemq">
                            activemq
                        </a>
                        
                        
                        
                        <a href="/tags/ajax" title="ajax">
                            ajax
                        </a>
                        
                        
                        
                        <a href="/tags/cookie" title="cookie">
                            cookie
                        </a>
                        
                        
                        
                        <a href="/tags/datax" title="datax">
                            datax
                        </a>
                        
                        
                        
                        <a href="/tags/docker" title="docker">
                            docker
                        </a>
                        
                        
                        
                        <a href="/tags/elasticsearch" title="elasticsearch">
                            elasticsearch
                        </a>
                        
                        
                        
                        <a href="/tags/filter" title="filter">
                            filter
                        </a>
                        
                        
                        
                        <a href="/tags/hadoop" title="hadoop">
                            hadoop
                        </a>
                        
                        
                        
                        <a href="/tags/hbase" title="hbase">
                            hbase
                        </a>
                        
                        
                        
                        <a href="/tags/hive" title="hive">
                            hive
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/java" title="java">
                            java
                        </a>
                        
                        
                        
                        <a href="/tags/javascript" title="javascript">
                            javascript
                        </a>
                        
                        
                        
                        <a href="/tags/javaweb" title="javaweb">
                            javaweb
                        </a>
                        
                        
                        
                        <a href="/tags/jdbc" title="jdbc">
                            jdbc
                        </a>
                        
                        
                        
                        <a href="/tags/jquery" title="jquery">
                            jquery
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/jsp" title="jsp">
                            jsp
                        </a>
                        
                        
                        
                        <a href="/tags/juc" title="juc">
                            juc
                        </a>
                        
                        
                        
                        <a href="/tags/jvm" title="jvm">
                            jvm
                        </a>
                        
                        
                        
                        <a href="/tags/jwt" title="jwt">
                            jwt
                        </a>
                        
                        
                        
                        <a href="/tags/kafka" title="kafka">
                            kafka
                        </a>
                        
                        
                        
                        <a href="/tags/linux" title="linux">
                            linux
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/maven" title="maven">
                            maven
                        </a>
                        
                        
                        
                        <a href="/tags/minio" title="minio">
                            minio
                        </a>
                        
                        
                        
                        <a href="/tags/mongodb" title="mongodb">
                            mongodb
                        </a>
                        
                        
                        
                        <a href="/tags/mybatis" title="mybatis">
                            mybatis
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/mysql" title="mysql">
                            mysql
                        </a>
                        
                        
                        
                        <a href="/tags/netty" title="netty">
                            netty
                        </a>
                        
                        
                        
                        <a href="/tags/nginx" title="nginx">
                            nginx
                        </a>
                        
                        
                        
                        <a href="/tags/react" title="react">
                            react
                        </a>
                        
                        
                        
                        <a href="/tags/redis" title="redis">
                            redis
                        </a>
                        
                        
                        
                        <a href="/tags/scala" title="scala">
                            scala
                        </a>
                        
                        
                        
                        <a href="/tags/servlet" title="servlet">
                            servlet
                        </a>
                        
                        
                        
                        <a href="/tags/session" title="session">
                            session
                        </a>
                        
                        
                        
                        <a href="/tags/shiro" title="shiro">
                            shiro
                        </a>
                        
                        
                        
                        <a href="/tags/spark" title="spark">
                            spark
                        </a>
                        
                        
                        
                        <a href="/tags/spring" title="spring">
                            spring
                        </a>
                        
                        
                        
                        <a href="/tags/springboot" title="springboot">
                            springboot
                        </a>
                        
                        
                        
                        <a href="/tags/springcloud" title="springcloud">
                            springcloud
                        </a>
                        
                        
                        
                        <a href="/tags/springmvc" title="springmvc">
                            springmvc
                        </a>
                        
                        
                        
                        <a href="/tags/springsecurity" title="springsecurity">
                            springsecurity
                        </a>
                        
                        
                        
                        <a href="/tags/tomcat" title="tomcat">
                            tomcat
                        </a>
                        
                        
                        
                        <a href="/tags/vue" title="vue">
                            vue
                        </a>
                        
                        
                        
                        <a href="/tags/xml" title="xml">
                            xml
                        </a>
                        
                        
                        
                        <a href="/tags/zookeeper" title="zookeeper">
                            zookeeper
                        </a>
                        
                        
                        
                        <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95" title="数据结构与算法">
                            数据结构与算法
                        </a>
                        
                        
                        
                        <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" title="设计模式">
                            设计模式
                        </a>
                        
                        
                        
                        <a href="/tags/%E9%A1%B9%E7%9B%AE" title="项目">
                            项目
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:1424197205@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    <li>
                        <a target="_blank" href="/#">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/yiguan1573">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="亿观的博客" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; 亿观的博客 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>









<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





</body>
</html>
