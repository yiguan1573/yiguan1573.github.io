<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="referrer" content="never">

    
    <meta property="og:site_name" content="äº¿è§‚çš„åšå®¢">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://yiguan1573.github.io//img/01.jpg">
    <meta property="twitter:image" content="https://yiguan1573.github.io//img/01.jpg" />
    

    
    <meta name="title" content="2ã€Nettyå…¥é—¨ï¼ˆNettyï¼‰" />
    <meta property="og:title" content="2ã€Nettyå…¥é—¨ï¼ˆNettyï¼‰" />
    <meta property="twitter:title" content="2ã€Nettyå…¥é—¨ï¼ˆNettyï¼‰" />
    

    
    <meta name="description" content="">
    <meta property="og:description" content="" />
    <meta property="twitter:description" content="" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>2ã€Nettyå…¥é—¨ï¼ˆNettyï¼‰ | yiguan1573</title>

    <link rel="canonical" href="/post/1036netty%E5%85%A5%E9%97%A8/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>




<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">äº¿è§‚çš„åšå®¢</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">é¦–é¡µ</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/%E5%AD%A6%E4%B9%A0">å­¦ä¹ </a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/archive/">æ¡£æ¡ˆ</a></li>
                    
                        <li><a href="/top/about/">å…³äº</a></li>
                    

                    
		    <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		    </li>
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/03.JPG')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/netty" title="Netty">
                            Netty
                        </a>
                        
                    </div>
                    <h1>2ã€Nettyå…¥é—¨ï¼ˆNettyï¼‰</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                äº¿è§‚
                             
                            on 
                            Monday, May 16, 2022
                            
                                <span id="/post/1036netty%E5%85%A5%E9%97%A8/" class="leancloud_visitors meta_data_item" data-flag-title="">
    <span class="post-meta-item-icon">
      <span class="octicon octicon-eye"></span> 
    </span>
    <i class="fa fa-eye"></i>
    <span class="old-visitors-count" style="display: none;"></span>
    <span class="leancloud-visitors-count"></span>
</span>



<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>

<script>
	AV.initialize("", "");
</script>

<script type="text/javascript">
function showTime(Counter) {
    var query = new AV.Query(Counter);
    var entries = [];
    var $visitors = $(".leancloud_visitors");

    $visitors.each(function() {
        entries.push($(this).attr("id").trim());
    });

    query.containedIn('url', entries);
    query.find()
        .done(function(results) {
            var COUNT_CONTAINER_REF = '.leancloud-visitors-count';
            var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';

            
            
            
            

            for (var i = 0; i < results.length; i++) {
                var item = results[i];
                var url = item.get('url');
                var time = item.get('time');
                var element = document.getElementById(url);

                $(element).find(COUNT_CONTAINER_REF).text(time);
            }
            for (var i = 0; i < entries.length; i++) {
                var url = entries[i];
                var element = document.getElementById(url);
                var countSpan = $(element).find(COUNT_CONTAINER_REF);
                if (countSpan.text() == '') {
                    var oldCountSpan = $(element).find(OLD_COUNT_CONTAINER_REF).text();
                    if(oldCountSpan!=''){
                        countSpan.text(0+parseInt(oldCountSpan));
                    }else{
                        countSpan.text(0);          
                    }
                }
            }
        })
        .fail(function(object, error) {
            console.log("Error: " + error.code + " " + error.message);
        });
}

function addCount(Counter) {
    var $visitors = $(".leancloud_visitors");
    var url = $visitors.attr('id').trim();
    var title = $visitors.attr('data-flag-title').trim();
    var query = new AV.Query(Counter);

    query.equalTo("url", url);
    query.find({
        success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment("time");
                counter.save(null, {
                    success: function(counter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(counter.get('time'));
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
                var newcounter = new Counter();
                 
                var acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                newcounter.setACL(acl);
                 
                newcounter.set("title", title);
                newcounter.set("url", url);
                var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';
                var $element = $(document.getElementById(url));
                var oldCountSpan = $element.find(OLD_COUNT_CONTAINER_REF).text();
                if(oldCountSpan!=''){
                    newcounter.set("time", parseInt(oldCountSpan)+1);
                }else{
 	                    newcounter.set("time",  1);
                }
                newcounter.save(null, {
                    success: function(newcounter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                    },
                    error: function(newcounter, error) {
                        console.log('Failed to create');
                    }
                });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + " " + error.message);
        }
    });
}
$(function() {
    var Counter = AV.Object.extend("Counter");
    
    
    if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
    } else {
        showTime(Counter);
    }
});
</script>

                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h2 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h2>
<h3 id="11-netty-æ˜¯ä»€ä¹ˆ">1.1 Netty æ˜¯ä»€ä¹ˆï¼Ÿ</h3>
<pre><code>Netty is an asynchronous event-driven network application framework
for rapid development of maintainable high performance protocol servers &amp; clients.
</code></pre><p>Netty æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ã€åŸºäºäº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œç”¨äºå¿«é€Ÿå¼€å‘å¯ç»´æŠ¤ã€é«˜æ€§èƒ½çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯</p>
<h3 id="12-netty-çš„ä½œè€…">1.2 Netty çš„ä½œè€…</h3>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h385op7rj8j30vy0ht0tk.jpg" alt="QQæˆªå›¾20220614224644.jpg">

</p>
<p>ä»–è¿˜æ˜¯å¦ä¸€ä¸ªè‘—åç½‘ç»œåº”ç”¨æ¡†æ¶ Mina çš„é‡è¦è´¡çŒ®è€…</p>
<h3 id="13-netty-çš„åœ°ä½">1.3 Netty çš„åœ°ä½</h3>
<p>Netty åœ¨ Java ç½‘ç»œåº”ç”¨æ¡†æ¶ä¸­çš„åœ°ä½å°±å¥½æ¯”ï¼šSpring æ¡†æ¶åœ¨ JavaEE å¼€å‘ä¸­çš„åœ°ä½</p>
<p>ä»¥ä¸‹çš„æ¡†æ¶éƒ½ä½¿ç”¨äº† Nettyï¼Œå› ä¸ºå®ƒä»¬æœ‰ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼</p>
<ul>
<li>Cassandra - nosql æ•°æ®åº“</li>
<li>Spark - å¤§æ•°æ®åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶</li>
<li>Hadoop - å¤§æ•°æ®åˆ†å¸ƒå¼å­˜å‚¨æ¡†æ¶</li>
<li>RocketMQ - ali å¼€æºçš„æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>ElasticSearch - æœç´¢å¼•æ“</li>
<li>gRPC - rpc æ¡†æ¶</li>
<li>Dubbo - rpc æ¡†æ¶</li>
<li>Spring 5.x - flux api å®Œå…¨æŠ›å¼ƒäº† tomcat ï¼Œä½¿ç”¨ netty ä½œä¸ºæœåŠ¡å™¨ç«¯</li>
<li>Zookeeper - åˆ†å¸ƒå¼åè°ƒæ¡†æ¶</li>
</ul>
<h3 id="14-netty-çš„ä¼˜åŠ¿">1.4 Netty çš„ä¼˜åŠ¿</h3>
<ul>
<li>Netty vs NIOï¼Œå·¥ä½œé‡å¤§ï¼Œbug å¤š
<ul>
<li>éœ€è¦è‡ªå·±æ„å»ºåè®®</li>
<li>è§£å†³ TCP ä¼ è¾“é—®é¢˜ï¼Œå¦‚ç²˜åŒ…ã€åŠåŒ…</li>
<li>epoll ç©ºè½®è¯¢å¯¼è‡´ CPU 100%</li>
<li>å¯¹ API è¿›è¡Œå¢å¼ºï¼Œä½¿ä¹‹æ›´æ˜“ç”¨ï¼Œå¦‚ FastThreadLocal =&gt; ThreadLocalï¼ŒByteBuf =&gt; ByteBuffer</li>
</ul>
</li>
<li>Netty vs å…¶å®ƒç½‘ç»œåº”ç”¨æ¡†æ¶
<ul>
<li>Mina ç”± apache ç»´æŠ¤ï¼Œå°†æ¥ 3.x ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰è¾ƒå¤§é‡æ„ï¼Œç ´å API å‘ä¸‹å…¼å®¹æ€§ï¼ŒNetty çš„å¼€å‘è¿­ä»£æ›´è¿…é€Ÿï¼ŒAPI æ›´ç®€æ´ã€æ–‡æ¡£æ›´ä¼˜ç§€</li>
<li>ä¹…ç»è€ƒéªŒï¼Œ16å¹´ï¼ŒNetty ç‰ˆæœ¬
<ul>
<li>2.x 2004</li>
<li>3.x 2008</li>
<li>4.x 2013</li>
<li>5.x å·²åºŸå¼ƒï¼ˆæ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½æå‡ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼‰</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="2-hello-world">2. Hello World</h2>
<h3 id="21-ç›®æ ‡">2.1 ç›®æ ‡</h3>
<p>å¼€å‘ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯</p>
<ul>
<li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘é€ hello, world</li>
<li>æœåŠ¡å™¨ä»…æ¥æ”¶ï¼Œä¸è¿”å›</li>
</ul>
<p>åŠ å…¥ä¾èµ–</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#ff79c6">&lt;dependency</span><span style="color:#ff79c6">&gt;</span>
    <span style="color:#ff79c6">&lt;groupId</span><span style="color:#ff79c6">&gt;</span>io.netty<span style="color:#ff79c6">&lt;/groupId&gt;</span>
    <span style="color:#ff79c6">&lt;artifactId</span><span style="color:#ff79c6">&gt;</span>netty-all<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
    <span style="color:#ff79c6">&lt;version</span><span style="color:#ff79c6">&gt;</span>4.1.39.Final<span style="color:#ff79c6">&lt;/version&gt;</span>
<span style="color:#ff79c6">&lt;/dependency&gt;</span>
</code></pre></div><h3 id="22-æœåŠ¡å™¨ç«¯">2.2 æœåŠ¡å™¨ç«¯</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#ff79c6">new</span> ServerBootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4">// 1
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioServerSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4">// 2
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">childHandler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>NioSocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span> <span style="color:#6272a4">// 3
</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>NioSocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> StringDecoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 5
</span><span style="color:#6272a4"></span>            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> SimpleChannelInboundHandler<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span> <span style="color:#6272a4">// 6
</span><span style="color:#6272a4"></span>                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead0</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> String msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 4
</span></code></pre></div><p>ä»£ç è§£è¯»</p>
<ul>
<li>
<p>1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º <code>çº¿ç¨‹æ±  + Selector</code> åé¢ä¼šè¯¦ç»†å±•å¼€</p>
</li>
<li>
<p>2 å¤„ï¼Œé€‰æ‹©æœåŠ¡ Scoket å®ç°ç±»ï¼Œå…¶ä¸­ NioServerSocketChannel è¡¨ç¤ºåŸºäº NIO çš„æœåŠ¡å™¨ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h385rctj86j30s0032jvh.jpg" alt="0006.png">

</p>
</li>
<li>
<p>3 å¤„ï¼Œä¸ºå•¥æ–¹æ³•å« childHandlerï¼Œæ˜¯æ¥ä¸‹æ¥æ·»åŠ çš„å¤„ç†å™¨éƒ½æ˜¯ç»™ SocketChannel ç”¨çš„ï¼Œè€Œä¸æ˜¯ç»™ ServerSocketChannelã€‚ChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨</p>
</li>
<li>
<p>4 å¤„ï¼ŒServerSocketChannel ç»‘å®šçš„ç›‘å¬ç«¯å£</p>
</li>
<li>
<p>5 å¤„ï¼ŒSocketChannel çš„å¤„ç†å™¨ï¼Œè§£ç  ByteBuf =&gt; String</p>
</li>
<li>
<p>6 å¤„ï¼ŒSocketChannel çš„ä¸šåŠ¡å¤„ç†å™¨ï¼Œä½¿ç”¨ä¸Šä¸€ä¸ªå¤„ç†å™¨çš„å¤„ç†ç»“æœ</p>
</li>
</ul>
<h3 id="23-å®¢æˆ·ç«¯">2.3 å®¢æˆ·ç«¯</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4">// 1
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4">// 2
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>Channel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span> <span style="color:#6272a4">// 3
</span><span style="color:#6272a4"></span>        @Override
        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>Channel ch<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> StringEncoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 8
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span> <span style="color:#6272a4">// 4
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4">// 5
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4">// 6
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Date<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;: hello world!&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 7
</span></code></pre></div><p>ä»£ç è§£è¯»</p>
<ul>
<li>
<p>1 å¤„ï¼Œåˆ›å»º NioEventLoopGroupï¼ŒåŒ Server</p>
</li>
<li>
<p>2 å¤„ï¼Œé€‰æ‹©å®¢æˆ· Socket å®ç°ç±»ï¼ŒNioSocketChannel è¡¨ç¤ºåŸºäº NIO çš„å®¢æˆ·ç«¯å®ç°ï¼Œå…¶å®ƒå®ç°è¿˜æœ‰</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h385s84vm6j30qo032q6t.jpg" alt="0007.png">

</p>
</li>
<li>
<p>3 å¤„ï¼Œæ·»åŠ  SocketChannel çš„å¤„ç†å™¨ï¼ŒChannelInitializer å¤„ç†å™¨ï¼ˆä»…æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¾…å®¢æˆ·ç«¯ SocketChannel å»ºç«‹è¿æ¥åï¼Œæ‰§è¡Œ initChannel ä»¥ä¾¿æ·»åŠ æ›´å¤šçš„å¤„ç†å™¨</p>
</li>
<li>
<p>4 å¤„ï¼ŒæŒ‡å®šè¦è¿æ¥çš„æœåŠ¡å™¨å’Œç«¯å£</p>
</li>
<li>
<p>5 å¤„ï¼ŒNetty ä¸­å¾ˆå¤šæ–¹æ³•éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå¦‚ connectï¼Œè¿™æ—¶éœ€è¦ä½¿ç”¨ sync æ–¹æ³•ç­‰å¾… connect å»ºç«‹è¿æ¥å®Œæ¯•</p>
</li>
<li>
<p>6 å¤„ï¼Œè·å– channel å¯¹è±¡ï¼Œå®ƒå³ä¸ºé€šé“æŠ½è±¡ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®è¯»å†™æ“ä½œ</p>
</li>
<li>
<p>7 å¤„ï¼Œå†™å…¥æ¶ˆæ¯å¹¶æ¸…ç©ºç¼“å†²åŒº</p>
</li>
<li>
<p>8 å¤„ï¼Œæ¶ˆæ¯ä¼šç»è¿‡é€šé“ handler å¤„ç†ï¼Œè¿™é‡Œæ˜¯å°† String =&gt; ByteBuf å‘å‡º</p>
</li>
<li>
<p>æ•°æ®ç»è¿‡ç½‘ç»œä¼ è¾“ï¼Œåˆ°è¾¾æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯ 5 å’Œ 6 å¤„çš„ handler å…ˆåè¢«è§¦å‘ï¼Œèµ°å®Œä¸€ä¸ªæµç¨‹</p>
</li>
</ul>
<h3 id="24-æµç¨‹æ¢³ç†">2.4 æµç¨‹æ¢³ç†</h3>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h385snadpaj310e0iewvq.jpg" alt="0040.png">

</p>
<h4 id="-æç¤º">ğŸ’¡ æç¤º</h4>
<blockquote>
<p>ä¸€å¼€å§‹éœ€è¦æ ‘ç«‹æ­£ç¡®çš„è§‚å¿µ</p>
<ul>
<li>æŠŠ channel ç†è§£ä¸ºæ•°æ®çš„é€šé“</li>
<li>æŠŠ msg ç†è§£ä¸ºæµåŠ¨çš„æ•°æ®ï¼Œæœ€å¼€å§‹è¾“å…¥æ˜¯ ByteBufï¼Œä½†ç»è¿‡ pipeline çš„åŠ å·¥ï¼Œä¼šå˜æˆå…¶å®ƒç±»å‹å¯¹è±¡ï¼Œæœ€åè¾“å‡ºåˆå˜æˆ ByteBuf</li>
<li>æŠŠ handler ç†è§£ä¸ºæ•°æ®çš„å¤„ç†å·¥åº
<ul>
<li>å·¥åºæœ‰å¤šé“ï¼Œåˆåœ¨ä¸€èµ·å°±æ˜¯ pipelineï¼Œpipeline è´Ÿè´£å‘å¸ƒäº‹ä»¶ï¼ˆè¯»ã€è¯»å–å®Œæˆ&hellip;ï¼‰ä¼ æ’­ç»™æ¯ä¸ª handlerï¼Œ handler å¯¹è‡ªå·±æ„Ÿå…´è¶£çš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆé‡å†™äº†ç›¸åº”äº‹ä»¶å¤„ç†æ–¹æ³•ï¼‰</li>
<li>handler åˆ† Inbound å’Œ Outbound ä¸¤ç±»</li>
</ul>
</li>
<li>æŠŠ eventLoop ç†è§£ä¸ºå¤„ç†æ•°æ®çš„å·¥äºº
<ul>
<li>å·¥äººå¯ä»¥ç®¡ç†å¤šä¸ª channel çš„ io æ“ä½œï¼Œå¹¶ä¸”ä¸€æ—¦å·¥äººè´Ÿè´£äº†æŸä¸ª channelï¼Œå°±è¦è´Ÿè´£åˆ°åº•ï¼ˆç»‘å®šï¼‰</li>
<li>å·¥äººæ—¢å¯ä»¥æ‰§è¡Œ io æ“ä½œï¼Œä¹Ÿå¯ä»¥è¿›è¡Œä»»åŠ¡å¤„ç†ï¼Œæ¯ä½å·¥äººæœ‰ä»»åŠ¡é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é‡Œå¯ä»¥å †æ”¾å¤šä¸ª channel çš„å¾…å¤„ç†ä»»åŠ¡ï¼Œä»»åŠ¡åˆ†ä¸ºæ™®é€šä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡</li>
<li>å·¥äººæŒ‰ç…§ pipeline é¡ºåºï¼Œä¾æ¬¡æŒ‰ç…§ handler çš„è§„åˆ’ï¼ˆä»£ç ï¼‰å¤„ç†æ•°æ®ï¼Œå¯ä»¥ä¸ºæ¯é“å·¥åºæŒ‡å®šä¸åŒçš„å·¥äºº</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="3-ç»„ä»¶">3. ç»„ä»¶</h2>
<h3 id="31-eventloop">3.1 EventLoop</h3>
<p>äº‹ä»¶å¾ªç¯å¯¹è±¡</p>
<p>EventLoop æœ¬è´¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œå™¨ï¼ˆåŒæ—¶ç»´æŠ¤äº†ä¸€ä¸ª Selectorï¼‰ï¼Œé‡Œé¢æœ‰ run æ–¹æ³•å¤„ç† Channel ä¸Šæºæºä¸æ–­çš„ io äº‹ä»¶ã€‚</p>
<p>å®ƒçš„ç»§æ‰¿å…³ç³»æ¯”è¾ƒå¤æ‚</p>
<ul>
<li>ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª j.u.c.ScheduledExecutorService å› æ­¤åŒ…å«äº†çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„æ–¹æ³•</li>
<li>å¦ä¸€æ¡çº¿æ˜¯ç»§æ‰¿è‡ª netty è‡ªå·±çš„ OrderedEventExecutorï¼Œ
<ul>
<li>æä¾›äº† boolean inEventLoop(Thread thread) æ–¹æ³•åˆ¤æ–­ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦å±äºæ­¤ EventLoop</li>
<li>æä¾›äº† parent æ–¹æ³•æ¥çœ‹çœ‹è‡ªå·±å±äºå“ªä¸ª EventLoopGroup</li>
</ul>
</li>
</ul>
<p>äº‹ä»¶å¾ªç¯ç»„</p>
<p>EventLoopGroup æ˜¯ä¸€ç»„ EventLoopï¼ŒChannel ä¸€èˆ¬ä¼šè°ƒç”¨ EventLoopGroup çš„ register æ–¹æ³•æ¥ç»‘å®šå…¶ä¸­ä¸€ä¸ª EventLoopï¼Œåç»­è¿™ä¸ª Channel ä¸Šçš„ io äº‹ä»¶éƒ½ç”±æ­¤ EventLoop æ¥å¤„ç†ï¼ˆä¿è¯äº† io äº‹ä»¶å¤„ç†æ—¶çš„çº¿ç¨‹å®‰å…¨ï¼‰</p>
<ul>
<li>ç»§æ‰¿è‡ª netty è‡ªå·±çš„ EventExecutorGroup
<ul>
<li>å®ç°äº† Iterable æ¥å£æä¾›éå† EventLoop çš„èƒ½åŠ›</li>
<li>å¦æœ‰ next æ–¹æ³•è·å–é›†åˆä¸­ä¸‹ä¸€ä¸ª EventLoop</li>
</ul>
</li>
</ul>
<p>ä»¥ä¸€ä¸ªç®€å•çš„å®ç°ä¸ºä¾‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">// å†…éƒ¨åˆ›å»ºäº†ä¸¤ä¸ª EventLoop, æ¯ä¸ª EventLoop ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹
</span><span style="color:#6272a4"></span>DefaultEventLoopGroup group <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultEventLoopGroup<span style="color:#ff79c6">(</span>2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>group<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>group<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>group<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>io.netty.channel.DefaultEventLoop@60f82f98
io.netty.channel.DefaultEventLoop@35f983a6
io.netty.channel.DefaultEventLoop@60f82f98
</code></pre><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ for å¾ªç¯</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">DefaultEventLoopGroup group <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultEventLoopGroup<span style="color:#ff79c6">(</span>2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>EventExecutor eventLoop <span style="color:#ff79c6">:</span> group<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>eventLoop<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>io.netty.channel.DefaultEventLoop@60f82f98
io.netty.channel.DefaultEventLoop@35f983a6
</code></pre><h4 id="-ä¼˜é›…å…³é—­">ğŸ’¡ ä¼˜é›…å…³é—­</h4>
<p>ä¼˜é›…å…³é—­ <code>shutdownGracefully</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šé¦–å…ˆåˆ‡æ¢ <code>EventLoopGroup</code> åˆ°å…³é—­çŠ¶æ€ä»è€Œæ‹’ç»æ–°çš„ä»»åŠ¡çš„åŠ å…¥ï¼Œç„¶ååœ¨ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡éƒ½å¤„ç†å®Œæˆåï¼Œåœæ­¢çº¿ç¨‹çš„è¿è¡Œã€‚ä»è€Œç¡®ä¿æ•´ä½“åº”ç”¨æ˜¯åœ¨æ­£å¸¸æœ‰åºçš„çŠ¶æ€ä¸‹é€€å‡ºçš„</p>
<h4 id="æ¼”ç¤º-nioeventloop-å¤„ç†-io-äº‹ä»¶">æ¼”ç¤º NioEventLoop å¤„ç† io äº‹ä»¶</h4>
<p>æœåŠ¡å™¨ç«¯ä¸¤ä¸ª nio worker å·¥äºº</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#ff79c6">new</span> ServerBootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span>2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioServerSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">childHandler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>NioSocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>NioSocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    ByteBuf byteBuf <span style="color:#ff79c6">=</span> msg <span style="color:#ff79c6">instanceof</span> ByteBuf <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>ByteBuf<span style="color:#ff79c6">)</span> msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
                    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>byteBuf <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> buf <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>16<span style="color:#ff79c6">]</span><span style="color:#ff79c6">;</span>
                        ByteBuf len <span style="color:#ff79c6">=</span> byteBuf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readBytes</span><span style="color:#ff79c6">(</span>buf<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> byteBuf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readableBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>buf<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    <span style="color:#ff79c6">}</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>å®¢æˆ·ç«¯ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> InterruptedException <span style="color:#ff79c6">{</span>
    Channel channel <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>NioSocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>NioSocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;init...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;localhost&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
            <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>ByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;wangwu&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sleep</span><span style="color:#ff79c6">(</span>2000<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>ByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;wangwu&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>æœ€åè¾“å‡º</p>
<pre><code>22:03:34 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       
22:03:36 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - zhangsan       
22:05:36 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           
22:05:38 [DEBUG] [nioEventLoopGroup-3-2] c.i.o.EventLoopTest - lisi           
22:06:09 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu        
22:06:11 [DEBUG] [nioEventLoopGroup-3-1] c.i.o.EventLoopTest - wangwu         
</code></pre><p>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå·¥äººè½®æµå¤„ç† channelï¼Œä½†å·¥äººä¸ channel ä¹‹é—´è¿›è¡Œäº†ç»‘å®š</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h385tc1irsj30fz0d5jum.jpg" alt="0042.png">

</p>
<p>å†å¢åŠ ä¸¤ä¸ªé nio å·¥äºº</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">DefaultEventLoopGroup normalWorkers <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultEventLoopGroup<span style="color:#ff79c6">(</span>2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">new</span> ServerBootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span>2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioServerSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">childHandler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>NioSocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>NioSocketChannel ch<span style="color:#ff79c6">)</span>  <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>normalWorkers<span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;myhandler&#34;</span><span style="color:#ff79c6">,</span>
              <span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    ByteBuf byteBuf <span style="color:#ff79c6">=</span> msg <span style="color:#ff79c6">instanceof</span> ByteBuf <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>ByteBuf<span style="color:#ff79c6">)</span> msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
                    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>byteBuf <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> buf <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>16<span style="color:#ff79c6">]</span><span style="color:#ff79c6">;</span>
                        ByteBuf len <span style="color:#ff79c6">=</span> byteBuf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readBytes</span><span style="color:#ff79c6">(</span>buf<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> byteBuf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readableBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>buf<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    <span style="color:#ff79c6">}</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>å®¢æˆ·ç«¯ä»£ç ä¸å˜ï¼Œå¯åŠ¨ä¸‰æ¬¡ï¼Œåˆ†åˆ«ä¿®æ”¹å‘é€å­—ç¬¦ä¸²ä¸º zhangsanï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œlisiï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼Œwangwuï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p>
<p>è¾“å‡º</p>
<pre><code>22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] REGISTERED
22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] ACTIVE
22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |
+--------+-------------------------------------------------+----------------+
22:19:48 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ COMPLETE
22:19:48 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        
22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ: 8B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 7a 68 61 6e 67 73 61 6e                         |zhangsan        |
+--------+-------------------------------------------------+----------------+
22:19:50 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x251562d5, L:/127.0.0.1:8080 - R:/127.0.0.1:52588] READ COMPLETE
22:19:50 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - zhangsan        
22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] REGISTERED
22:20:24 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] ACTIVE
22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ: 4B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6c 69 73 69                                     |lisi            |
+--------+-------------------------------------------------+----------------+
22:20:25 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ COMPLETE
22:20:25 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            
22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ: 4B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 6c 69 73 69                                     |lisi            |
+--------+-------------------------------------------------+----------------+
22:20:27 [DEBUG] [nioEventLoopGroup-4-2] i.n.h.l.LoggingHandler - [id: 0x94b2a840, L:/127.0.0.1:8080 - R:/127.0.0.1:52612] READ COMPLETE
22:20:27 [DEBUG] [defaultEventLoopGroup-2-2] c.i.o.EventLoopTest - lisi            
22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] REGISTERED
22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] ACTIVE
22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ: 6B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 77 61 6e 67 77 75                               |wangwu          |
+--------+-------------------------------------------------+----------------+
22:20:38 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ COMPLETE
22:20:38 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          
22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ: 6B
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 77 61 6e 67 77 75                               |wangwu          |
+--------+-------------------------------------------------+----------------+
22:20:40 [DEBUG] [nioEventLoopGroup-4-1] i.n.h.l.LoggingHandler - [id: 0x79a26af9, L:/127.0.0.1:8080 - R:/127.0.0.1:52625] READ COMPLETE
22:20:40 [DEBUG] [defaultEventLoopGroup-2-1] c.i.o.EventLoopTest - wangwu          
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œnio å·¥äººå’Œ é nio å·¥äººä¹Ÿåˆ†åˆ«ç»‘å®šäº† channelï¼ˆLoggingHandler ç”± nio å·¥äººæ‰§è¡Œï¼Œè€Œæˆ‘ä»¬è‡ªå·±çš„ handler ç”±é nio å·¥äººæ‰§è¡Œï¼‰</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h385traxnij30k30h6dlb.jpg" alt="0041.png">

</p>
<h4 id="-handler-æ‰§è¡Œä¸­å¦‚ä½•æ¢äºº">ğŸ’¡ handler æ‰§è¡Œä¸­å¦‚ä½•æ¢äººï¼Ÿ</h4>
<p>å…³é”®ä»£ç  <code>io.netty.channel.AbstractChannelHandlerContext#invokeChannelRead()</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">invokeChannelRead</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> AbstractChannelHandlerContext next<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">final</span> Object m <span style="color:#ff79c6">=</span> next<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">touch</span><span style="color:#ff79c6">(</span>ObjectUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">checkNotNull</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;msg&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> next<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#6272a4">// ä¸‹ä¸€ä¸ª handler çš„äº‹ä»¶å¾ªç¯æ˜¯å¦ä¸å½“å‰çš„äº‹ä»¶å¾ªç¯æ˜¯åŒä¸€ä¸ªçº¿ç¨‹
</span><span style="color:#6272a4"></span>    EventExecutor executor <span style="color:#ff79c6">=</span> next<span style="color:#ff79c6">.</span><span style="color:#50fa7b">executor</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    
    <span style="color:#6272a4">// æ˜¯ï¼Œç›´æ¥è°ƒç”¨
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>executor<span style="color:#ff79c6">.</span><span style="color:#50fa7b">inEventLoop</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        next<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invokeChannelRead</span><span style="color:#ff79c6">(</span>m<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> 
    <span style="color:#6272a4">// ä¸æ˜¯ï¼Œå°†è¦æ‰§è¡Œçš„ä»£ç ä½œä¸ºä»»åŠ¡æäº¤ç»™ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯å¤„ç†ï¼ˆæ¢äººï¼‰
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
        executor<span style="color:#ff79c6">.</span><span style="color:#50fa7b">execute</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Runnable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            @Override
            <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">run</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                next<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invokeChannelRead</span><span style="color:#ff79c6">(</span>m<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><ul>
<li>å¦‚æœä¸¤ä¸ª handler ç»‘å®šçš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨</li>
<li>å¦åˆ™ï¼ŒæŠŠè¦è°ƒç”¨çš„ä»£ç å°è£…ä¸ºä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼Œç”±ä¸‹ä¸€ä¸ª handler çš„çº¿ç¨‹æ¥è°ƒç”¨</li>
</ul>
<h4 id="æ¼”ç¤º-nioeventloop-å¤„ç†æ™®é€šä»»åŠ¡">æ¼”ç¤º NioEventLoop å¤„ç†æ™®é€šä»»åŠ¡</h4>
<p>NioEventLoop é™¤äº†å¯ä»¥å¤„ç† io äº‹ä»¶ï¼ŒåŒæ ·å¯ä»¥å‘å®ƒæäº¤æ™®é€šä»»åŠ¡</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">NioEventLoopGroup nioWorkers <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span>2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;server start...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sleep</span><span style="color:#ff79c6">(</span>2000<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
nioWorkers<span style="color:#ff79c6">.</span><span style="color:#50fa7b">execute</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">{</span>
    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;normal task...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>22:30:36 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...
22:30:38 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - normal task...
</code></pre><blockquote>
<p>å¯ä»¥ç”¨æ¥æ‰§è¡Œè€—æ—¶è¾ƒé•¿çš„ä»»åŠ¡</p>
</blockquote>
<h4 id="æ¼”ç¤º-nioeventloop-å¤„ç†å®šæ—¶ä»»åŠ¡">æ¼”ç¤º NioEventLoop å¤„ç†å®šæ—¶ä»»åŠ¡</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">NioEventLoopGroup nioWorkers <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span>2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;server start...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sleep</span><span style="color:#ff79c6">(</span>2000<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
nioWorkers<span style="color:#ff79c6">.</span><span style="color:#50fa7b">scheduleAtFixedRate</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;running...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> 1<span style="color:#ff79c6">,</span> TimeUnit<span style="color:#ff79c6">.</span><span style="color:#50fa7b">SECONDS</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>22:35:15 [DEBUG] [main] c.i.o.EventLoopTest2 - server start...
22:35:17 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
22:35:18 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
22:35:19 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
22:35:20 [DEBUG] [nioEventLoopGroup-2-1] c.i.o.EventLoopTest2 - running...
...
</code></pre><blockquote>
<p>å¯ä»¥ç”¨æ¥æ‰§è¡Œå®šæ—¶ä»»åŠ¡</p>
</blockquote>
<h3 id="32-channel">3.2 Channel</h3>
<p>channel çš„ä¸»è¦ä½œç”¨</p>
<ul>
<li>close() å¯ä»¥ç”¨æ¥å…³é—­ channel</li>
<li>closeFuture() ç”¨æ¥å¤„ç† channel çš„å…³é—­
<ul>
<li>sync æ–¹æ³•ä½œç”¨æ˜¯åŒæ­¥ç­‰å¾… channel å…³é—­</li>
<li>è€Œ addListener æ–¹æ³•æ˜¯å¼‚æ­¥ç­‰å¾… channel å…³é—­</li>
</ul>
</li>
<li>pipeline() æ–¹æ³•æ·»åŠ å¤„ç†å™¨</li>
<li>write() æ–¹æ³•å°†æ•°æ®å†™å…¥</li>
<li>writeAndFlush() æ–¹æ³•å°†æ•°æ®å†™å…¥å¹¶åˆ·å‡º</li>
</ul>
<h4 id="channelfuture">ChannelFuture</h4>
<p>è¿™æ—¶åˆšæ‰çš„å®¢æˆ·ç«¯ä»£ç </p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>Channel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>Channel ch<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> StringEncoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Date<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;: hello world!&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>ç°åœ¨æŠŠå®ƒæ‹†å¼€æ¥çœ‹</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ChannelFuture channelFuture <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>Channel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>Channel ch<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> StringEncoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 1
</span><span style="color:#6272a4"></span>
channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Date<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;: hello world!&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><ul>
<li>1 å¤„è¿”å›çš„æ˜¯ ChannelFuture å¯¹è±¡ï¼Œå®ƒçš„ä½œç”¨æ˜¯åˆ©ç”¨ channel() æ–¹æ³•æ¥è·å– Channel å¯¹è±¡</li>
</ul>
<p><strong>æ³¨æ„</strong> connect æ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œæ„å‘³ç€ä¸ç­‰è¿æ¥å»ºç«‹ï¼Œæ–¹æ³•æ‰§è¡Œå°±è¿”å›äº†ã€‚å› æ­¤ channelFuture å¯¹è±¡ä¸­ä¸èƒ½ã€ç«‹åˆ»ã€‘è·å¾—åˆ°æ­£ç¡®çš„ Channel å¯¹è±¡</p>
<p>å®éªŒå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ChannelFuture channelFuture <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>Channel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>Channel ch<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> StringEncoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 1
</span><span style="color:#6272a4"></span>channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 2
</span><span style="color:#6272a4"></span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 3
</span></code></pre></div><ul>
<li>æ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° <code>[id: 0x2e1884dd]</code></li>
<li>æ‰§è¡Œåˆ° 2 æ—¶ï¼Œsync æ–¹æ³•æ˜¯åŒæ­¥ç­‰å¾…è¿æ¥å»ºç«‹å®Œæˆ</li>
<li>æ‰§è¡Œåˆ° 3 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†ï¼Œæ‰“å° <code>[id: 0x2e1884dd, L:/127.0.0.1:57191 - R:/127.0.0.1:8080]</code></li>
</ul>
<p>é™¤äº†ç”¨ sync æ–¹æ³•å¯ä»¥è®©å¼‚æ­¥æ“ä½œåŒæ­¥ä»¥å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å›è°ƒçš„æ–¹å¼ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ChannelFuture channelFuture <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>Channel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>Channel ch<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> StringEncoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 1
</span><span style="color:#6272a4"></span>channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addListener</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>ChannelFutureListener<span style="color:#ff79c6">)</span> future <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>future<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 2
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><ul>
<li>æ‰§è¡Œåˆ° 1 æ—¶ï¼Œè¿æ¥æœªå»ºç«‹ï¼Œæ‰“å° <code>[id: 0x749124ba]</code></li>
<li>ChannelFutureListener ä¼šåœ¨è¿æ¥å»ºç«‹æ—¶è¢«è°ƒç”¨ï¼ˆå…¶ä¸­ operationComplete æ–¹æ³•ï¼‰ï¼Œå› æ­¤æ‰§è¡Œåˆ° 2 æ—¶ï¼Œè¿æ¥è‚¯å®šå»ºç«‹äº†ï¼Œæ‰“å° <code>[id: 0x749124ba, L:/127.0.0.1:57351 - R:/127.0.0.1:8080]</code></li>
</ul>
<h4 id="closefuture">CloseFuture</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Slf4j
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">CloseFutureClient</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> InterruptedException <span style="color:#ff79c6">{</span>
        NioEventLoopGroup group <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">NioEventLoopGroup</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        ChannelFuture channelFuture <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
                <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>group<span style="color:#ff79c6">)</span>
                <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
                <span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>NioSocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    @Override <span style="color:#6272a4">// åœ¨è¿æ¥å»ºç«‹åè¢«è°ƒç”¨
</span><span style="color:#6272a4"></span>                    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>NioSocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                        ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                        ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> StringEncoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    <span style="color:#ff79c6">}</span>
                <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
                <span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> InetSocketAddress<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;localhost&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        Channel channel <span style="color:#ff79c6">=</span> channelFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{}&#34;</span><span style="color:#ff79c6">,</span> channel<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">new</span> Thread<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">{</span>
            Scanner scanner <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Scanner<span style="color:#ff79c6">(</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">in</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                String line <span style="color:#ff79c6">=</span> scanner<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nextLine</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;q&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>line<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// close å¼‚æ­¥æ“ä½œ 1s ä¹‹å
</span><span style="color:#6272a4"></span><span style="color:#6272a4">//                    log.debug(&#34;å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ&#34;); // ä¸èƒ½åœ¨è¿™é‡Œå–„å
</span><span style="color:#6272a4"></span>                    <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
                channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>line<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;input&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">start</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#6272a4">// è·å– CloseFuture å¯¹è±¡ï¼Œ 1) åŒæ­¥å¤„ç†å…³é—­ï¼Œ 2) å¼‚æ­¥å¤„ç†å…³é—­
</span><span style="color:#6272a4"></span>        ChannelFuture closeFuture <span style="color:#ff79c6">=</span> channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">/*log.debug(&#34;waiting close...&#34;);
</span><span style="color:#6272a4">        closeFuture.sync();
</span><span style="color:#6272a4">        log.debug(&#34;å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ&#34;);*/</span>
        closeFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addListener</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelFutureListener<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            @Override
            <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">operationComplete</span><span style="color:#ff79c6">(</span>ChannelFuture future<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;å¤„ç†å…³é—­ä¹‹åçš„æ“ä½œ&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                group<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="-å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ">ğŸ’¡ å¼‚æ­¥æå‡çš„æ˜¯ä»€ä¹ˆ</h4>
<ul>
<li>
<p>æœ‰äº›åŒå­¦çœ‹åˆ°è¿™é‡Œä¼šæœ‰ç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å»æ‰§è¡Œå»ºç«‹è¿æ¥ã€å»æ‰§è¡Œå…³é—­ channelï¼Œé‚£æ ·ä¸æ˜¯ä¹Ÿå¯ä»¥å—ï¼Ÿéè¦ç”¨è¿™ä¹ˆå¤æ‚çš„å¼‚æ­¥æ–¹å¼ï¼šæ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹å‘èµ·å»ºç«‹è¿æ¥ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å»çœŸæ­£å»ºç«‹è¿æ¥</p>
</li>
<li>
<p>è¿˜æœ‰åŒå­¦ä¼šç¬¼ç»Ÿåœ°å›ç­”ï¼Œå› ä¸º netty å¼‚æ­¥æ–¹å¼ç”¨äº†å¤šçº¿ç¨‹ã€å¤šçº¿ç¨‹å°±æ•ˆç‡é«˜ã€‚å…¶å®è¿™äº›è®¤è¯†éƒ½æ¯”è¾ƒç‰‡é¢ï¼Œå¤šçº¿ç¨‹å’Œå¼‚æ­¥æ‰€æå‡çš„æ•ˆç‡å¹¶ä¸æ˜¯æ‰€è®¤ä¸ºçš„</p>
</li>
</ul>
<p>è¦ç‚¹</p>
<ul>
<li>å•çº¿ç¨‹æ²¡æ³•å¼‚æ­¥æé«˜æ•ˆç‡ï¼Œå¿…é¡»é…åˆå¤šçº¿ç¨‹ã€å¤šæ ¸ cpu æ‰èƒ½å‘æŒ¥å¼‚æ­¥çš„ä¼˜åŠ¿</li>
<li>å¼‚æ­¥å¹¶æ²¡æœ‰ç¼©çŸ­å“åº”æ—¶é—´ï¼Œåè€Œæœ‰æ‰€å¢åŠ </li>
<li>åˆç†è¿›è¡Œä»»åŠ¡æ‹†åˆ†ï¼Œä¹Ÿæ˜¯åˆ©ç”¨å¼‚æ­¥çš„å…³é”®</li>
</ul>
<h3 id="33-future--promise">3.3 Future &amp; Promise</h3>
<p>åœ¨å¼‚æ­¥å¤„ç†æ—¶ï¼Œç»å¸¸ç”¨åˆ°è¿™ä¸¤ä¸ªæ¥å£</p>
<p>é¦–å…ˆè¦è¯´æ˜ netty ä¸­çš„ Future ä¸ jdk ä¸­çš„ Future åŒåï¼Œä½†æ˜¯æ˜¯ä¸¤ä¸ªæ¥å£ï¼Œnetty çš„ Future ç»§æ‰¿è‡ª jdk çš„ Futureï¼Œè€Œ Promise åˆå¯¹ netty Future è¿›è¡Œäº†æ‰©å±•</p>
<ul>
<li>jdk Future åªèƒ½åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸï¼ˆæˆ–æˆåŠŸã€æˆ–å¤±è´¥ï¼‰æ‰èƒ½å¾—åˆ°ç»“æœ</li>
<li>netty Future å¯ä»¥åŒæ­¥ç­‰å¾…ä»»åŠ¡ç»“æŸå¾—åˆ°ç»“æœï¼Œä¹Ÿå¯ä»¥å¼‚æ­¥æ–¹å¼å¾—åˆ°ç»“æœï¼Œä½†éƒ½æ˜¯è¦ç­‰ä»»åŠ¡ç»“æŸ</li>
<li>netty Promise ä¸ä»…æœ‰ netty Future çš„åŠŸèƒ½ï¼Œè€Œä¸”è„±ç¦»äº†ä»»åŠ¡ç‹¬ç«‹å­˜åœ¨ï¼Œåªä½œä¸ºä¸¤ä¸ªçº¿ç¨‹é—´ä¼ é€’ç»“æœçš„å®¹å™¨</li>
</ul>
<table>
<thead>
<tr>
<th>åŠŸèƒ½/åç§°</th>
<th>jdk Future</th>
<th>netty Future</th>
<th>Promise</th>
</tr>
</thead>
<tbody>
<tr>
<td>cancel</td>
<td>å–æ¶ˆä»»åŠ¡</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>isCanceled</td>
<td>ä»»åŠ¡æ˜¯å¦å–æ¶ˆ</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>isDone</td>
<td>ä»»åŠ¡æ˜¯å¦å®Œæˆï¼Œä¸èƒ½åŒºåˆ†æˆåŠŸå¤±è´¥</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>get</td>
<td>è·å–ä»»åŠ¡ç»“æœï¼Œé˜»å¡ç­‰å¾…</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>getNow</td>
<td>-</td>
<td>è·å–ä»»åŠ¡ç»“æœï¼Œéé˜»å¡ï¼Œè¿˜æœªäº§ç”Ÿç»“æœæ—¶è¿”å› null</td>
<td>-</td>
</tr>
<tr>
<td>await</td>
<td>-</td>
<td>ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼Œä¸ä¼šæŠ›å¼‚å¸¸ï¼Œè€Œæ˜¯é€šè¿‡ isSuccess åˆ¤æ–­</td>
<td>-</td>
</tr>
<tr>
<td>sync</td>
<td>-</td>
<td>ç­‰å¾…ä»»åŠ¡ç»“æŸï¼Œå¦‚æœä»»åŠ¡å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</td>
<td>-</td>
</tr>
<tr>
<td>isSuccess</td>
<td>-</td>
<td>åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æˆåŠŸ</td>
<td>-</td>
</tr>
<tr>
<td>cause</td>
<td>-</td>
<td>è·å–å¤±è´¥ä¿¡æ¯ï¼Œéé˜»å¡ï¼Œå¦‚æœæ²¡æœ‰å¤±è´¥ï¼Œè¿”å›null</td>
<td>-</td>
</tr>
<tr>
<td>addLinstener</td>
<td>-</td>
<td>æ·»åŠ å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ</td>
<td>-</td>
</tr>
<tr>
<td>setSuccess</td>
<td>-</td>
<td>-</td>
<td>è®¾ç½®æˆåŠŸç»“æœ</td>
</tr>
<tr>
<td>setFailure</td>
<td>-</td>
<td>-</td>
<td>è®¾ç½®å¤±è´¥ç»“æœ</td>
</tr>
</tbody>
</table>
<h4 id="ä¾‹1">ä¾‹1</h4>
<p>åŒæ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">DefaultEventLoop eventExecutors <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultEventLoop<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
DefaultPromise<span style="color:#ff79c6">&lt;</span>Integer<span style="color:#ff79c6">&gt;</span> promise <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultPromise<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span>eventExecutors<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

eventExecutors<span style="color:#ff79c6">.</span><span style="color:#50fa7b">execute</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sleep</span><span style="color:#ff79c6">(</span>1000<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;set success, {}&#34;</span><span style="color:#ff79c6">,</span>10<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setSuccess</span><span style="color:#ff79c6">(</span>10<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;start...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{}&#34;</span><span style="color:#ff79c6">,</span>promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getNow</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// è¿˜æ²¡æœ‰ç»“æœ
</span><span style="color:#6272a4"></span>log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{}&#34;</span><span style="color:#ff79c6">,</span>promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
11:51:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null
11:51:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10
11:51:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - 10
</code></pre><h4 id="ä¾‹2">ä¾‹2</h4>
<p>å¼‚æ­¥å¤„ç†ä»»åŠ¡æˆåŠŸ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">DefaultEventLoop eventExecutors <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultEventLoop<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
DefaultPromise<span style="color:#ff79c6">&lt;</span>Integer<span style="color:#ff79c6">&gt;</span> promise <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultPromise<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span>eventExecutors<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

<span style="color:#6272a4">// è®¾ç½®å›è°ƒï¼Œå¼‚æ­¥æ¥æ”¶ç»“æœ
</span><span style="color:#6272a4"></span>promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addListener</span><span style="color:#ff79c6">(</span>future <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">// è¿™é‡Œçš„ future å°±æ˜¯ä¸Šé¢çš„ promise
</span><span style="color:#6272a4"></span>    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{}&#34;</span><span style="color:#ff79c6">,</span>future<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getNow</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

<span style="color:#6272a4">// ç­‰å¾… 1000 åè®¾ç½®æˆåŠŸç»“æœ
</span><span style="color:#6272a4"></span>eventExecutors<span style="color:#ff79c6">.</span><span style="color:#50fa7b">execute</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sleep</span><span style="color:#ff79c6">(</span>1000<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;set success, {}&#34;</span><span style="color:#ff79c6">,</span>10<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setSuccess</span><span style="color:#ff79c6">(</span>10<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;start...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>11:49:30 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set success, 10
11:49:31 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - 10
</code></pre><h4 id="ä¾‹3">ä¾‹3</h4>
<p>åŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - sync &amp; get</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">DefaultEventLoop eventExecutors <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultEventLoop<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        DefaultPromise<span style="color:#ff79c6">&lt;</span>Integer<span style="color:#ff79c6">&gt;</span> promise <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultPromise<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span>eventExecutors<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        eventExecutors<span style="color:#ff79c6">.</span><span style="color:#50fa7b">execute</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sleep</span><span style="color:#ff79c6">(</span>1000<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
            RuntimeException e <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RuntimeException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;error...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;set failure, {}&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFailure</span><span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;start...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{}&#34;</span><span style="color:#ff79c6">,</span> promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getNow</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// sync() ä¹Ÿä¼šå‡ºç°å¼‚å¸¸ï¼Œåªæ˜¯ get ä¼šå†ç”¨ ExecutionException åŒ…ä¸€å±‚å¼‚å¸¸
</span></code></pre></div><p>è¾“å‡º</p>
<pre><code>12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
12:11:07 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null
12:11:08 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...
Exception in thread &quot;main&quot; java.util.concurrent.ExecutionException: java.lang.RuntimeException: error...
	at io.netty.util.concurrent.AbstractFuture.get(AbstractFuture.java:41)
	at com.itcast.oio.DefaultPromiseTest2.main(DefaultPromiseTest2.java:34)
Caused by: java.lang.RuntimeException: error...
	at com.itcast.oio.DefaultPromiseTest2.lambda$main$0(DefaultPromiseTest2.java:27)
	at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:745)
</code></pre><h4 id="ä¾‹4">ä¾‹4</h4>
<p>åŒæ­¥å¤„ç†ä»»åŠ¡å¤±è´¥ - await</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">DefaultEventLoop eventExecutors <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultEventLoop<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
DefaultPromise<span style="color:#ff79c6">&lt;</span>Integer<span style="color:#ff79c6">&gt;</span> promise <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultPromise<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span>eventExecutors<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

eventExecutors<span style="color:#ff79c6">.</span><span style="color:#50fa7b">execute</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sleep</span><span style="color:#ff79c6">(</span>1000<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
    RuntimeException e <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RuntimeException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;error...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;set failure, {}&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFailure</span><span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;start...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{}&#34;</span><span style="color:#ff79c6">,</span> promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getNow</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">await</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// ä¸ sync å’Œ get åŒºåˆ«åœ¨äºï¼Œä¸ä¼šæŠ›å¼‚å¸¸
</span><span style="color:#6272a4"></span>log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;result {}&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isSuccess</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span> promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getNow</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span> promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">cause</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
12:18:53 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - null
12:18:54 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...
12:18:54 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...
</code></pre><h4 id="ä¾‹5">ä¾‹5</h4>
<p>å¼‚æ­¥å¤„ç†ä»»åŠ¡å¤±è´¥</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">DefaultEventLoop eventExecutors <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultEventLoop<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
DefaultPromise<span style="color:#ff79c6">&lt;</span>Integer<span style="color:#ff79c6">&gt;</span> promise <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultPromise<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span>eventExecutors<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addListener</span><span style="color:#ff79c6">(</span>future <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;result {}&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isSuccess</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span> promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getNow</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span> promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">cause</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

eventExecutors<span style="color:#ff79c6">.</span><span style="color:#50fa7b">execute</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sleep</span><span style="color:#ff79c6">(</span>1000<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
    RuntimeException e <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RuntimeException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;error...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;set failure, {}&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFailure</span><span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;start...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>12:04:57 [DEBUG] [main] c.i.o.DefaultPromiseTest2 - start...
12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - set failure, java.lang.RuntimeException: error...
12:04:58 [DEBUG] [defaultEventLoop-1-1] c.i.o.DefaultPromiseTest2 - result java.lang.RuntimeException: error...
</code></pre><h4 id="ä¾‹6">ä¾‹6</h4>
<p>await æ­»é”æ£€æŸ¥</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">DefaultEventLoop eventExecutors <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultEventLoop<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
DefaultPromise<span style="color:#ff79c6">&lt;</span>Integer<span style="color:#ff79c6">&gt;</span> promise <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultPromise<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span>eventExecutors<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

eventExecutors<span style="color:#ff79c6">.</span><span style="color:#50fa7b">submit</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">{</span>
    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;1&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">await</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// æ³¨æ„ä¸èƒ½ä»…æ•è· InterruptedException å¼‚å¸¸
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// å¦åˆ™ æ­»é”æ£€æŸ¥æŠ›å‡ºçš„ BlockingOperationException ä¼šç»§ç»­å‘ä¸Šä¼ æ’­
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// è€Œæäº¤çš„ä»»åŠ¡ä¼šè¢«åŒ…è£…ä¸º PromiseTaskï¼Œå®ƒçš„ run æ–¹æ³•ä¸­ä¼š catch æ‰€æœ‰å¼‚å¸¸ç„¶åè®¾ç½®ä¸º Promise çš„å¤±è´¥ç»“æœè€Œä¸ä¼šæŠ›å‡º
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span> 
        e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;2&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
eventExecutors<span style="color:#ff79c6">.</span><span style="color:#50fa7b">submit</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">{</span>
    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;3&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">await</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;4&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>1
2
3
4
io.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)
	at io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)
	at io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)
	at com.itcast.oio.DefaultPromiseTest.lambda$main$0(DefaultPromiseTest.java:27)
	at io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)
	at io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)
	at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:745)
io.netty.util.concurrent.BlockingOperationException: DefaultPromise@47499c2a(incomplete)
	at io.netty.util.concurrent.DefaultPromise.checkDeadLock(DefaultPromise.java:384)
	at io.netty.util.concurrent.DefaultPromise.await(DefaultPromise.java:212)
	at com.itcast.oio.DefaultPromiseTest.lambda$main$1(DefaultPromiseTest.java:36)
	at io.netty.util.concurrent.PromiseTask$RunnableAdapter.call(PromiseTask.java:38)
	at io.netty.util.concurrent.PromiseTask.run(PromiseTask.java:73)
	at io.netty.channel.DefaultEventLoop.run(DefaultEventLoop.java:54)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:745)

</code></pre><h3 id="34-handler--pipeline">3.4 Handler &amp; Pipeline</h3>
<p>ChannelHandler ç”¨æ¥å¤„ç† Channel ä¸Šçš„å„ç§äº‹ä»¶ï¼Œåˆ†ä¸ºå…¥ç«™ã€å‡ºç«™ä¸¤ç§ã€‚æ‰€æœ‰ ChannelHandler è¢«è¿æˆä¸€ä¸²ï¼Œå°±æ˜¯ Pipeline</p>
<ul>
<li>å…¥ç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelInboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦ç”¨æ¥è¯»å–å®¢æˆ·ç«¯æ•°æ®ï¼Œå†™å›ç»“æœ</li>
<li>å‡ºç«™å¤„ç†å™¨é€šå¸¸æ˜¯ ChannelOutboundHandlerAdapter çš„å­ç±»ï¼Œä¸»è¦å¯¹å†™å›ç»“æœè¿›è¡ŒåŠ å·¥</li>
</ul>
<p>æ‰“ä¸ªæ¯”å–»ï¼Œæ¯ä¸ª Channel æ˜¯ä¸€ä¸ªäº§å“çš„åŠ å·¥è½¦é—´ï¼ŒPipeline æ˜¯è½¦é—´ä¸­çš„æµæ°´çº¿ï¼ŒChannelHandler å°±æ˜¯æµæ°´çº¿ä¸Šçš„å„é“å·¥åºï¼Œè€Œåé¢è¦è®²çš„ ByteBuf æ˜¯åŸææ–™ï¼Œç»è¿‡å¾ˆå¤šå·¥åºçš„åŠ å·¥ï¼šå…ˆç»è¿‡ä¸€é“é“å…¥ç«™å·¥åºï¼Œå†ç»è¿‡ä¸€é“é“å‡ºç«™å·¥åºæœ€ç»ˆå˜æˆäº§å“</p>
<p>å…ˆææ¸…æ¥šé¡ºåºï¼ŒæœåŠ¡ç«¯</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#ff79c6">new</span> ServerBootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioServerSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">childHandler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>NioSocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>NioSocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireChannelRead</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 1
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireChannelRead</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 2
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>3<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 3
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelOutboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">,</span> 
                                  ChannelPromise promise<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>4<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">,</span> promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 4
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelOutboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">,</span> 
                                  ChannelPromise promise<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>5<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">,</span> promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 5
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelOutboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">,</span> 
                                  ChannelPromise promise<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>6<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">,</span> promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 6
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>å®¢æˆ·ç«¯</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>Channel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>Channel ch<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> StringEncoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">addListener</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>ChannelFutureListener<span style="color:#ff79c6">)</span> future <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
        future<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;hello,world&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>æœåŠ¡å™¨ç«¯æ‰“å°ï¼š</p>
<pre><code>1
2
3
6
5
4
</code></pre><p>å¯ä»¥çœ‹åˆ°ï¼ŒChannelInboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é¡ºåºæ‰§è¡Œçš„ï¼Œè€Œ ChannelOutboundHandlerAdapter æ˜¯æŒ‰ç…§ addLast çš„é€†åºæ‰§è¡Œçš„ã€‚ChannelPipeline çš„å®ç°æ˜¯ä¸€ä¸ª ChannelHandlerContextï¼ˆåŒ…è£…äº† ChannelHandlerï¼‰ ç»„æˆçš„åŒå‘é“¾è¡¨</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h385vn6vw1j30rw03w75n.jpg" alt="0008.png">

</p>
<ul>
<li>å…¥ç«™å¤„ç†å™¨ä¸­ï¼Œctx.fireChannelRead(msg) æ˜¯ <strong>è°ƒç”¨ä¸‹ä¸€ä¸ªå…¥ç«™å¤„ç†å™¨</strong>
<ul>
<li>å¦‚æœæ³¨é‡Šæ‰ 1 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1</li>
<li>å¦‚æœæ³¨é‡Šæ‰ 2 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2</li>
</ul>
</li>
<li>3 å¤„çš„ ctx.channel().write(msg) ä¼š <strong>ä»å°¾éƒ¨å¼€å§‹è§¦å‘</strong> åç»­å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ
<ul>
<li>å¦‚æœæ³¨é‡Šæ‰ 3 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3</li>
</ul>
</li>
<li>ç±»ä¼¼çš„ï¼Œå‡ºç«™å¤„ç†å™¨ä¸­ï¼Œctx.write(msg, promise) çš„è°ƒç”¨ä¹Ÿä¼š <strong>è§¦å‘ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨</strong>
<ul>
<li>å¦‚æœæ³¨é‡Šæ‰ 6 å¤„ä»£ç ï¼Œåˆ™ä»…ä¼šæ‰“å° 1 2 3 6</li>
</ul>
</li>
<li>ctx.channel().write(msg) vs ctx.write(msg)
<ul>
<li>éƒ½æ˜¯è§¦å‘å‡ºç«™å¤„ç†å™¨çš„æ‰§è¡Œ</li>
<li>ctx.channel().write(msg) ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾å‡ºç«™å¤„ç†å™¨</li>
<li>ctx.write(msg) æ˜¯ä»å½“å‰èŠ‚ç‚¹æ‰¾ä¸Šä¸€ä¸ªå‡ºç«™å¤„ç†å™¨</li>
<li>3 å¤„çš„ ctx.channel().write(msg) å¦‚æœæ”¹ä¸º ctx.write(msg) ä»…ä¼šæ‰“å° 1 2 3ï¼Œå› ä¸ºèŠ‚ç‚¹3 ä¹‹å‰æ²¡æœ‰å…¶å®ƒå‡ºç«™å¤„ç†å™¨äº†</li>
<li>6 å¤„çš„ ctx.write(msg, promise) å¦‚æœæ”¹ä¸º ctx.channel().write(msg) ä¼šæ‰“å° 1 2 3 6 6 6&hellip; å› ä¸º ctx.channel().write() æ˜¯ä»å°¾éƒ¨å¼€å§‹æŸ¥æ‰¾ï¼Œç»“æœåˆæ˜¯èŠ‚ç‚¹6 è‡ªå·±</li>
</ul>
</li>
</ul>
<p>å›¾1 - æœåŠ¡ç«¯ pipeline è§¦å‘çš„åŸå§‹æµç¨‹ï¼Œå›¾ä¸­æ•°å­—ä»£è¡¨äº†å¤„ç†æ­¥éª¤çš„å…ˆåæ¬¡åº</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h385vzdjzhj30rx0730w0.jpg" alt="0009.png">

</p>
<h3 id="35-bytebuf">3.5 ByteBuf</h3>
<p>æ˜¯å¯¹å­—èŠ‚æ•°æ®çš„å°è£…</p>
<h4 id="1åˆ›å»º">1ï¼‰åˆ›å»º</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ByteBuf buffer <span style="color:#ff79c6">=</span> ByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span>10<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
log<span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>ä¸Šé¢ä»£ç åˆ›å»ºäº†ä¸€ä¸ªé»˜è®¤çš„ ByteBufï¼ˆæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBufï¼‰ï¼Œåˆå§‹å®¹é‡æ˜¯ 10</p>
<p>è¾“å‡º</p>
<pre><code>read index:0 write index:0 capacity:10
</code></pre><p>å…¶ä¸­ log æ–¹æ³•å‚è€ƒå¦‚ä¸‹</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">log</span><span style="color:#ff79c6">(</span>ByteBuf buffer<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd">int</span> length <span style="color:#ff79c6">=</span> buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readableBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd">int</span> rows <span style="color:#ff79c6">=</span> length <span style="color:#ff79c6">/</span> 16 <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">(</span>length <span style="color:#ff79c6">%</span> 15 <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> 0 <span style="color:#ff79c6">?</span> 0 <span style="color:#ff79c6">:</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> 4<span style="color:#ff79c6">;</span>
    StringBuilder buf <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> StringBuilder<span style="color:#ff79c6">(</span>rows <span style="color:#ff79c6">*</span> 80 <span style="color:#ff79c6">*</span> 2<span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;read index:&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readerIndex</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; write index:&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writerIndex</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; capacity:&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">capacity</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
        <span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">(</span>NEWLINE<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    appendPrettyHexDump<span style="color:#ff79c6">(</span>buf<span style="color:#ff79c6">,</span> buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="2ç›´æ¥å†…å­˜-vs-å †å†…å­˜">2ï¼‰ç›´æ¥å†…å­˜ vs å †å†…å­˜</h4>
<p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºå †çš„ ByteBuf</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ByteBuf buffer <span style="color:#ff79c6">=</span> ByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">heapBuffer</span><span style="color:#ff79c6">(</span>10<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ¥åˆ›å»ºæ± åŒ–åŸºäºç›´æ¥å†…å­˜çš„ ByteBuf</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ByteBuf buffer <span style="color:#ff79c6">=</span> ByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">directBuffer</span><span style="color:#ff79c6">(</span>10<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><ul>
<li>ç›´æ¥å†…å­˜åˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜‚è´µï¼Œä½†è¯»å†™æ€§èƒ½é«˜ï¼ˆå°‘ä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼‰ï¼Œé€‚åˆé…åˆæ± åŒ–åŠŸèƒ½ä¸€èµ·ç”¨</li>
<li>ç›´æ¥å†…å­˜å¯¹ GC å‹åŠ›å°ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å†…å­˜ä¸å— JVM åƒåœ¾å›æ”¶çš„ç®¡ç†ï¼Œä½†ä¹Ÿè¦æ³¨æ„åŠæ—¶ä¸»åŠ¨é‡Šæ”¾</li>
</ul>
<h4 id="3æ± åŒ–-vs-éæ± åŒ–">3ï¼‰æ± åŒ– vs éæ± åŒ–</h4>
<p>æ± åŒ–çš„æœ€å¤§æ„ä¹‰åœ¨äºå¯ä»¥é‡ç”¨ ByteBufï¼Œä¼˜ç‚¹æœ‰</p>
<ul>
<li>æ²¡æœ‰æ± åŒ–ï¼Œåˆ™æ¯æ¬¡éƒ½å¾—åˆ›å»ºæ–°çš„ ByteBuf å®ä¾‹ï¼Œè¿™ä¸ªæ“ä½œå¯¹ç›´æ¥å†…å­˜ä»£ä»·æ˜‚è´µï¼Œå°±ç®—æ˜¯å †å†…å­˜ï¼Œä¹Ÿä¼šå¢åŠ  GC å‹åŠ›</li>
<li>æœ‰äº†æ± åŒ–ï¼Œåˆ™å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œå¹¶ä¸”é‡‡ç”¨äº†ä¸ jemalloc ç±»ä¼¼çš„å†…å­˜åˆ†é…ç®—æ³•æå‡åˆ†é…æ•ˆç‡</li>
<li>é«˜å¹¶å‘æ—¶ï¼Œæ± åŒ–åŠŸèƒ½æ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½</li>
</ul>
<p>æ± åŒ–åŠŸèƒ½æ˜¯å¦å¼€å¯ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ç³»ç»Ÿç¯å¢ƒå˜é‡æ¥è®¾ç½®</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#ff79c6">-</span>Dio<span style="color:#ff79c6">.</span><span style="color:#50fa7b">netty</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">allocator</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">type</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">{</span>unpooled<span style="color:#ff79c6">|</span>pooled<span style="color:#ff79c6">}</span>
</code></pre></div><ul>
<li>4.1 ä»¥åï¼Œé Android å¹³å°é»˜è®¤å¯ç”¨æ± åŒ–å®ç°ï¼ŒAndroid å¹³å°å¯ç”¨éæ± åŒ–å®ç°</li>
<li>4.1 ä¹‹å‰ï¼Œæ± åŒ–åŠŸèƒ½è¿˜ä¸æˆç†Ÿï¼Œé»˜è®¤æ˜¯éæ± åŒ–å®ç°</li>
</ul>
<h4 id="4ç»„æˆ">4ï¼‰ç»„æˆ</h4>
<p>ByteBuf ç”±å››éƒ¨åˆ†ç»„æˆ</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h385wlpewqj30he05fgms.jpg" alt="0010.png">

</p>
<p>æœ€å¼€å§‹è¯»å†™æŒ‡é’ˆéƒ½åœ¨ 0 ä½ç½®</p>
<h4 id="5å†™å…¥">5ï¼‰å†™å…¥</h4>
<p>æ–¹æ³•åˆ—è¡¨ï¼Œçœç•¥ä¸€äº›ä¸é‡è¦çš„æ–¹æ³•</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•ç­¾å</th>
<th>å«ä¹‰</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>writeBoolean(boolean value)</td>
<td>å†™å…¥ boolean å€¼</td>
<td>ç”¨ä¸€å­—èŠ‚ 01|00 ä»£è¡¨ true|false</td>
</tr>
<tr>
<td>writeByte(int value)</td>
<td>å†™å…¥ byte å€¼</td>
<td></td>
</tr>
<tr>
<td>writeShort(int value)</td>
<td>å†™å…¥ short å€¼</td>
<td></td>
</tr>
<tr>
<td>writeInt(int value)</td>
<td>å†™å…¥ int å€¼</td>
<td>Big Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 00 00 02 50</td>
</tr>
<tr>
<td>writeIntLE(int value)</td>
<td>å†™å…¥ int å€¼</td>
<td>Little Endianï¼Œå³ 0x250ï¼Œå†™å…¥å 50 02 00 00</td>
</tr>
<tr>
<td>writeLong(long value)</td>
<td>å†™å…¥ long å€¼</td>
<td></td>
</tr>
<tr>
<td>writeChar(int value)</td>
<td>å†™å…¥ char å€¼</td>
<td></td>
</tr>
<tr>
<td>writeFloat(float value)</td>
<td>å†™å…¥ float å€¼</td>
<td></td>
</tr>
<tr>
<td>writeDouble(double value)</td>
<td>å†™å…¥ double å€¼</td>
<td></td>
</tr>
<tr>
<td>writeBytes(ByteBuf src)</td>
<td>å†™å…¥ netty çš„ ByteBuf</td>
<td></td>
</tr>
<tr>
<td>writeBytes(byte[] src)</td>
<td>å†™å…¥ byte[]</td>
<td></td>
</tr>
<tr>
<td>writeBytes(ByteBuffer src)</td>
<td>å†™å…¥ nio çš„ ByteBuffer</td>
<td></td>
</tr>
<tr>
<td>int writeCharSequence(CharSequence sequence, Charset charset)</td>
<td>å†™å…¥å­—ç¬¦ä¸²</td>
<td></td>
</tr>
</tbody>
</table>
<blockquote>
<p>æ³¨æ„</p>
<ul>
<li>è¿™äº›æ–¹æ³•çš„æœªæŒ‡æ˜è¿”å›å€¼çš„ï¼Œå…¶è¿”å›å€¼éƒ½æ˜¯ ByteBufï¼Œæ„å‘³ç€å¯ä»¥é“¾å¼è°ƒç”¨</li>
<li>ç½‘ç»œä¼ è¾“ï¼Œé»˜è®¤ä¹ æƒ¯æ˜¯ Big Endian</li>
</ul>
</blockquote>
<p>å…ˆå†™å…¥ 4 ä¸ªå­—èŠ‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>1<span style="color:#ff79c6">,</span> 2<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">,</span> 4<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
log<span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>ç»“æœæ˜¯</p>
<pre><code>read index:0 write index:4 capacity:10
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04                                     |....            |
+--------+-------------------------------------------------+----------------+
</code></pre><p>å†å†™å…¥ä¸€ä¸ª int æ•´æ•°ï¼Œä¹Ÿæ˜¯ 4 ä¸ªå­—èŠ‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeInt</span><span style="color:#ff79c6">(</span>5<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
log<span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>ç»“æœæ˜¯</p>
<pre><code>read index:0 write index:8 capacity:10
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 00 00 00 05                         |........        |
+--------+-------------------------------------------------+----------------+
</code></pre><p>è¿˜æœ‰ä¸€ç±»æ–¹æ³•æ˜¯ set å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å†™å…¥æ•°æ®ï¼Œä½†ä¸ä¼šæ”¹å˜å†™æŒ‡é’ˆä½ç½®</p>
<h4 id="6æ‰©å®¹">6ï¼‰æ‰©å®¹</h4>
<p>å†å†™å…¥ä¸€ä¸ª int æ•´æ•°æ—¶ï¼Œå®¹é‡ä¸å¤Ÿäº†ï¼ˆåˆå§‹å®¹é‡æ˜¯ 10ï¼‰ï¼Œè¿™æ—¶ä¼šå¼•å‘æ‰©å®¹</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeInt</span><span style="color:#ff79c6">(</span>6<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
log<span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>æ‰©å®¹è§„åˆ™æ˜¯</p>
<ul>
<li>å¦‚ä½•å†™å…¥åæ•°æ®å¤§å°æœªè¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 16 çš„æ•´æ•°å€ï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 12 ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 16</li>
<li>å¦‚æœå†™å…¥åæ•°æ®å¤§å°è¶…è¿‡ 512ï¼Œåˆ™é€‰æ‹©ä¸‹ä¸€ä¸ª 2^nï¼Œä¾‹å¦‚å†™å…¥åå¤§å°ä¸º 513ï¼Œåˆ™æ‰©å®¹å capacity æ˜¯ 2^10=1024ï¼ˆ2^9=512 å·²ç»ä¸å¤Ÿäº†ï¼‰</li>
<li>æ‰©å®¹ä¸èƒ½è¶…è¿‡ max capacity ä¼šæŠ¥é”™</li>
</ul>
<p>ç»“æœæ˜¯</p>
<pre><code>read index:0 write index:12 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 00 00 00 05 00 00 00 06             |............    |
+--------+-------------------------------------------------+----------------+
</code></pre><h4 id="7è¯»å–">7ï¼‰è¯»å–</h4>
<p>ä¾‹å¦‚è¯»äº† 4 æ¬¡ï¼Œæ¯æ¬¡ä¸€ä¸ªå­—èŠ‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
log<span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¯»è¿‡çš„å†…å®¹ï¼Œå°±å±äºåºŸå¼ƒéƒ¨åˆ†äº†ï¼Œå†è¯»åªèƒ½è¯»é‚£äº›å°šæœªè¯»å–çš„éƒ¨åˆ†</p>
<pre><code>1
2
3
4
read index:4 write index:12 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 05 00 00 00 06                         |........        |
+--------+-------------------------------------------------+----------------+
</code></pre><p>å¦‚æœéœ€è¦é‡å¤è¯»å– int æ•´æ•° 5ï¼Œæ€ä¹ˆåŠï¼Ÿ</p>
<p>å¯ä»¥åœ¨ read å‰å…ˆåšä¸ªæ ‡è®° mark</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">markReaderIndex</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
log<span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>ç»“æœ</p>
<pre><code>5
read index:8 write index:12 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 06                                     |....            |
+--------+-------------------------------------------------+----------------+
</code></pre><p>è¿™æ—¶è¦é‡å¤è¯»å–çš„è¯ï¼Œé‡ç½®åˆ°æ ‡è®°ä½ç½® reset</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">resetReaderIndex</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
log<span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¿™æ—¶</p>
<pre><code>read index:4 write index:12 capacity:16
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 00 00 00 05 00 00 00 06                         |........        |
+--------+-------------------------------------------------+----------------+
</code></pre><p>è¿˜æœ‰ç§åŠæ³•æ˜¯é‡‡ç”¨ get å¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸ä¼šæ”¹å˜ read index</p>
<h4 id="8retain--release">8ï¼‰retain &amp; release</h4>
<p>ç”±äº Netty ä¸­æœ‰å †å¤–å†…å­˜çš„ ByteBuf å®ç°ï¼Œå †å¤–å†…å­˜æœ€å¥½æ˜¯æ‰‹åŠ¨æ¥é‡Šæ”¾ï¼Œè€Œä¸æ˜¯ç­‰ GC åƒåœ¾å›æ”¶ã€‚</p>
<ul>
<li>UnpooledHeapByteBuf ä½¿ç”¨çš„æ˜¯ JVM å†…å­˜ï¼Œåªéœ€ç­‰ GC å›æ”¶å†…å­˜å³å¯</li>
<li>UnpooledDirectByteBuf ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥å†…å­˜äº†ï¼Œéœ€è¦ç‰¹æ®Šçš„æ–¹æ³•æ¥å›æ”¶å†…å­˜</li>
<li>PooledByteBuf å’Œå®ƒçš„å­ç±»ä½¿ç”¨äº†æ± åŒ–æœºåˆ¶ï¼Œéœ€è¦æ›´å¤æ‚çš„è§„åˆ™æ¥å›æ”¶å†…å­˜</li>
</ul>
<blockquote>
<p>å›æ”¶å†…å­˜çš„æºç å®ç°ï¼Œè¯·å…³æ³¨ä¸‹é¢æ–¹æ³•çš„ä¸åŒå®ç°</p>
<p><code>protected abstract void deallocate()</code></p>
</blockquote>
<p>Netty è¿™é‡Œé‡‡ç”¨äº†å¼•ç”¨è®¡æ•°æ³•æ¥æ§åˆ¶å›æ”¶å†…å­˜ï¼Œæ¯ä¸ª ByteBuf éƒ½å®ç°äº† ReferenceCounted æ¥å£</p>
<ul>
<li>æ¯ä¸ª ByteBuf å¯¹è±¡çš„åˆå§‹è®¡æ•°ä¸º 1</li>
<li>è°ƒç”¨ release æ–¹æ³•è®¡æ•°å‡ 1ï¼Œå¦‚æœè®¡æ•°ä¸º 0ï¼ŒByteBuf å†…å­˜è¢«å›æ”¶</li>
<li>è°ƒç”¨ retain æ–¹æ³•è®¡æ•°åŠ  1ï¼Œè¡¨ç¤ºè°ƒç”¨è€…æ²¡ç”¨å®Œä¹‹å‰ï¼Œå…¶å®ƒ handler å³ä½¿è°ƒç”¨äº† release ä¹Ÿä¸ä¼šé€ æˆå›æ”¶</li>
<li>å½“è®¡æ•°ä¸º 0 æ—¶ï¼Œåº•å±‚å†…å­˜ä¼šè¢«å›æ”¶ï¼Œè¿™æ—¶å³ä½¿ ByteBuf å¯¹è±¡è¿˜åœ¨ï¼Œå…¶å„ä¸ªæ–¹æ³•å‡æ— æ³•æ­£å¸¸ä½¿ç”¨</li>
</ul>
<p>è°æ¥è´Ÿè´£ release å‘¢ï¼Ÿ</p>
<p>ä¸æ˜¯æˆ‘ä»¬æƒ³è±¡çš„ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ï¼‰</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ByteBuf buf <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">.</span><span style="color:#ff79c6">.</span><span style="color:#ff79c6">.</span>
<span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">.</span><span style="color:#ff79c6">.</span><span style="color:#ff79c6">.</span>
<span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
    buf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">release</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>è¯·æ€è€ƒï¼Œå› ä¸º pipeline çš„å­˜åœ¨ï¼Œä¸€èˆ¬éœ€è¦å°† ByteBuf ä¼ é€’ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¦‚æœåœ¨ finally ä¸­ release äº†ï¼Œå°±å¤±å»äº†ä¼ é€’æ€§ï¼ˆå½“ç„¶ï¼Œå¦‚æœåœ¨è¿™ä¸ª ChannelHandler å†…è¿™ä¸ª ByteBuf å·²å®Œæˆäº†å®ƒçš„ä½¿å‘½ï¼Œé‚£ä¹ˆä¾¿æ— é¡»å†ä¼ é€’ï¼‰</p>
<p>åŸºæœ¬è§„åˆ™æ˜¯ï¼Œ<strong>è°æ˜¯æœ€åä½¿ç”¨è€…ï¼Œè°è´Ÿè´£ release</strong>ï¼Œè¯¦ç»†åˆ†æå¦‚ä¸‹</p>
<ul>
<li>èµ·ç‚¹ï¼Œå¯¹äº NIO å®ç°æ¥è®²ï¼Œåœ¨ io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read æ–¹æ³•ä¸­é¦–æ¬¡åˆ›å»º ByteBuf æ”¾å…¥ pipelineï¼ˆline 163 pipeline.fireChannelRead(byteBuf)ï¼‰</li>
<li>å…¥ç«™ ByteBuf å¤„ç†åŸåˆ™
<ul>
<li>å¯¹åŸå§‹ ByteBuf ä¸åšå¤„ç†ï¼Œè°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œè¿™æ—¶æ— é¡» release</li>
<li>å°†åŸå§‹ ByteBuf è½¬æ¢ä¸ºå…¶å®ƒç±»å‹çš„ Java å¯¹è±¡ï¼Œè¿™æ—¶ ByteBuf å°±æ²¡ç”¨äº†ï¼Œå¿…é¡» release</li>
<li>å¦‚æœä¸è°ƒç”¨ ctx.fireChannelRead(msg) å‘åä¼ é€’ï¼Œé‚£ä¹ˆä¹Ÿå¿…é¡» release</li>
<li>æ³¨æ„å„ç§å¼‚å¸¸ï¼Œå¦‚æœ ByteBuf æ²¡æœ‰æˆåŠŸä¼ é€’åˆ°ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œå¿…é¡» release</li>
<li>å‡è®¾æ¶ˆæ¯ä¸€ç›´å‘åä¼ ï¼Œé‚£ä¹ˆ TailContext ä¼šè´Ÿè´£é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯ï¼ˆåŸå§‹çš„ ByteBufï¼‰</li>
</ul>
</li>
<li>å‡ºç«™ ByteBuf å¤„ç†åŸåˆ™
<ul>
<li>å‡ºç«™æ¶ˆæ¯æœ€ç»ˆéƒ½ä¼šè½¬ä¸º ByteBuf è¾“å‡ºï¼Œä¸€ç›´å‘å‰ä¼ ï¼Œç”± HeadContext flush å release</li>
</ul>
</li>
<li>å¼‚å¸¸å¤„ç†åŸåˆ™
<ul>
<li>æœ‰æ—¶å€™ä¸æ¸…æ¥š ByteBuf è¢«å¼•ç”¨äº†å¤šå°‘æ¬¡ï¼Œä½†åˆå¿…é¡»å½»åº•é‡Šæ”¾ï¼Œå¯ä»¥å¾ªç¯è°ƒç”¨ release ç›´åˆ°è¿”å› true</li>
</ul>
</li>
</ul>
<p>TailContext é‡Šæ”¾æœªå¤„ç†æ¶ˆæ¯é€»è¾‘</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">// io.netty.channel.DefaultChannelPipeline#onUnhandledInboundMessage(java.lang.Object)
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">onUnhandledInboundMessage</span><span style="color:#ff79c6">(</span>Object msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span>
            <span style="color:#f1fa8c">&#34;Discarded inbound message {} that reached at the tail of the pipeline. &#34;</span> <span style="color:#ff79c6">+</span>
            <span style="color:#f1fa8c">&#34;Please check your pipeline configuration.&#34;</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
        ReferenceCountUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">release</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>å…·ä½“ä»£ç </p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">// io.netty.util.ReferenceCountUtil#release(java.lang.Object)
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">release</span><span style="color:#ff79c6">(</span>Object msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>msg <span style="color:#ff79c6">instanceof</span> ReferenceCounted<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>ReferenceCounted<span style="color:#ff79c6">)</span> msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">release</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="9slice">9ï¼‰slice</h4>
<p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯¹åŸå§‹ ByteBuf è¿›è¡Œåˆ‡ç‰‡æˆå¤šä¸ª ByteBufï¼Œåˆ‡ç‰‡åçš„ ByteBuf å¹¶æ²¡æœ‰å‘ç”Ÿå†…å­˜å¤åˆ¶ï¼Œè¿˜æ˜¯ä½¿ç”¨åŸå§‹ ByteBuf çš„å†…å­˜ï¼Œåˆ‡ç‰‡åçš„ ByteBuf ç»´æŠ¤ç‹¬ç«‹çš„ readï¼Œwrite æŒ‡é’ˆ</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h385wxsulcj30c2075jsi.jpg" alt="0011.png">

</p>
<p>ä¾‹ï¼ŒåŸå§‹ ByteBuf è¿›è¡Œä¸€äº›åˆå§‹æ“ä½œ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ByteBuf origin <span style="color:#ff79c6">=</span> ByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span>10<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
origin<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>1<span style="color:#ff79c6">,</span> 2<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">,</span> 4<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
origin<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>ByteBufUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">prettyHexDump</span><span style="color:#ff79c6">(</span>origin<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 02 03 04                                        |...             |
+--------+-------------------------------------------------+----------------+
</code></pre><p>è¿™æ—¶è°ƒç”¨ slice è¿›è¡Œåˆ‡ç‰‡ï¼Œæ— å‚ slice æ˜¯ä»åŸå§‹ ByteBuf çš„ read index åˆ° write index ä¹‹é—´çš„å†…å®¹è¿›è¡Œåˆ‡ç‰‡ï¼Œåˆ‡ç‰‡åçš„ max capacity è¢«å›ºå®šä¸ºè¿™ä¸ªåŒºé—´çš„å¤§å°ï¼Œå› æ­¤ä¸èƒ½è¿½åŠ  write</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ByteBuf slice <span style="color:#ff79c6">=</span> origin<span style="color:#ff79c6">.</span><span style="color:#50fa7b">slice</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>ByteBufUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">prettyHexDump</span><span style="color:#ff79c6">(</span>slice<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#6272a4">// slice.writeByte(5); å¦‚æœæ‰§è¡Œï¼Œä¼šæŠ¥ IndexOutOfBoundsException å¼‚å¸¸
</span></code></pre></div><p>è¾“å‡º</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 02 03 04                                        |...             |
+--------+-------------------------------------------------+----------------+
</code></pre><p>å¦‚æœåŸå§‹ ByteBuf å†æ¬¡è¯»æ“ä½œï¼ˆåˆè¯»äº†ä¸€ä¸ªå­—èŠ‚ï¼‰</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">origin<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>ByteBufUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">prettyHexDump</span><span style="color:#ff79c6">(</span>origin<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 03 04                                           |..              |
+--------+-------------------------------------------------+----------------+
</code></pre><p>è¿™æ—¶çš„ slice ä¸å—å½±å“ï¼Œå› ä¸ºå®ƒæœ‰ç‹¬ç«‹çš„è¯»å†™æŒ‡é’ˆ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>ByteBufUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">prettyHexDump</span><span style="color:#ff79c6">(</span>slice<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 02 03 04                                        |...             |
+--------+-------------------------------------------------+----------------+
</code></pre><p>å¦‚æœ slice çš„å†…å®¹å‘ç”Ÿäº†æ›´æ”¹</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">slice<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setByte</span><span style="color:#ff79c6">(</span>2<span style="color:#ff79c6">,</span> 5<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>ByteBufUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">prettyHexDump</span><span style="color:#ff79c6">(</span>slice<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 02 03 05                                        |...             |
+--------+-------------------------------------------------+----------------+
</code></pre><p>è¿™æ—¶ï¼ŒåŸå§‹ ByteBuf ä¹Ÿä¼šå—å½±å“ï¼Œå› ä¸ºåº•å±‚éƒ½æ˜¯åŒä¸€å—å†…å­˜</p>
<pre><code>System.out.println(ByteBufUtil.prettyHexDump(origin));
</code></pre><p>è¾“å‡º</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 03 05                                           |..              |
+--------+-------------------------------------------------+----------------+
</code></pre><h4 id="10duplicate">10ï¼‰duplicate</h4>
<p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå°±å¥½æ¯”æˆªå–äº†åŸå§‹ ByteBuf æ‰€æœ‰å†…å®¹ï¼Œå¹¶ä¸”æ²¡æœ‰ max capacity çš„é™åˆ¶ï¼Œä¹Ÿæ˜¯ä¸åŸå§‹ ByteBuf ä½¿ç”¨åŒä¸€å—åº•å±‚å†…å­˜ï¼Œåªæ˜¯è¯»å†™æŒ‡é’ˆæ˜¯ç‹¬ç«‹çš„</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h385xkuxmqj309u074754.jpg" alt="0012.png">

</p>
<h4 id="11copy">11ï¼‰copy</h4>
<p>ä¼šå°†åº•å±‚å†…å­˜æ•°æ®è¿›è¡Œæ·±æ‹·è´ï¼Œå› æ­¤æ— è®ºè¯»å†™ï¼Œéƒ½ä¸åŸå§‹ ByteBuf æ— å…³</p>
<h4 id="12compositebytebuf">12ï¼‰CompositeByteBuf</h4>
<p>ã€é›¶æ‹·è´ã€‘çš„ä½“ç°ä¹‹ä¸€ï¼Œå¯ä»¥å°†å¤šä¸ª ByteBuf åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBufï¼Œé¿å…æ‹·è´</p>
<p>æœ‰ä¸¤ä¸ª ByteBuf å¦‚ä¸‹</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ByteBuf buf1 <span style="color:#ff79c6">=</span> ByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span>5<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
buf1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>1<span style="color:#ff79c6">,</span> 2<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">,</span> 4<span style="color:#ff79c6">,</span> 5<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
ByteBuf buf2 <span style="color:#ff79c6">=</span> ByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span>5<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
buf2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>6<span style="color:#ff79c6">,</span> 7<span style="color:#ff79c6">,</span> 8<span style="color:#ff79c6">,</span> 9<span style="color:#ff79c6">,</span> 10<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>ByteBufUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">prettyHexDump</span><span style="color:#ff79c6">(</span>buf1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>ByteBufUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">prettyHexDump</span><span style="color:#ff79c6">(</span>buf2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05                                  |.....           |
+--------+-------------------------------------------------+----------------+
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 06 07 08 09 0a                                  |.....           |
+--------+-------------------------------------------------+----------------+
</code></pre><p>ç°åœ¨éœ€è¦ä¸€ä¸ªæ–°çš„ ByteBufï¼Œå†…å®¹æ¥è‡ªäºåˆšæ‰çš„ buf1 å’Œ buf2ï¼Œå¦‚ä½•å®ç°ï¼Ÿ</p>
<p>æ–¹æ³•1ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ByteBuf buf3 <span style="color:#ff79c6">=</span> ByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span>buf1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readableBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">+</span>buf2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readableBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
buf3<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>buf1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
buf3<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>buf2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>ByteBufUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">prettyHexDump</span><span style="color:#ff79c6">(</span>buf3<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>ç»“æœ</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
+--------+-------------------------------------------------+----------------+
</code></pre><p>è¿™ç§æ–¹æ³•å¥½ä¸å¥½ï¼Ÿå›ç­”æ˜¯ä¸å¤ªå¥½ï¼Œå› ä¸ºè¿›è¡Œäº†æ•°æ®çš„å†…å­˜å¤åˆ¶æ“ä½œ</p>
<p>æ–¹æ³•2ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">CompositeByteBuf buf3 <span style="color:#ff79c6">=</span> ByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">compositeBuffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#6272a4">// true è¡¨ç¤ºå¢åŠ æ–°çš„ ByteBuf è‡ªåŠ¨é€’å¢ write index, å¦åˆ™ write index ä¼šå§‹ç»ˆä¸º 0
</span><span style="color:#6272a4"></span>buf3<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addComponents</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">,</span> buf1<span style="color:#ff79c6">,</span> buf2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>ç»“æœæ˜¯ä¸€æ ·çš„</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
+--------+-------------------------------------------------+----------------+
</code></pre><p>CompositeByteBuf æ˜¯ä¸€ä¸ªç»„åˆçš„ ByteBufï¼Œå®ƒå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª Component æ•°ç»„ï¼Œæ¯ä¸ª Component ç®¡ç†ä¸€ä¸ª ByteBufï¼Œè®°å½•äº†è¿™ä¸ª ByteBuf ç›¸å¯¹äºæ•´ä½“åç§»é‡ç­‰ä¿¡æ¯ï¼Œä»£è¡¨ç€æ•´ä½“ä¸­æŸä¸€æ®µçš„æ•°æ®ã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼Œå¯¹å¤–æ˜¯ä¸€ä¸ªè™šæ‹Ÿè§†å›¾ï¼Œç»„åˆè¿™äº› ByteBuf ä¸ä¼šäº§ç”Ÿå†…å­˜å¤åˆ¶</li>
<li>ç¼ºç‚¹ï¼Œå¤æ‚äº†å¾ˆå¤šï¼Œå¤šæ¬¡æ“ä½œä¼šå¸¦æ¥æ€§èƒ½çš„æŸè€—</li>
</ul>
<h4 id="13unpooled">13ï¼‰Unpooled</h4>
<p>Unpooled æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œç±»å¦‚å…¶åï¼Œæä¾›äº†éæ± åŒ–çš„ ByteBuf åˆ›å»ºã€ç»„åˆã€å¤åˆ¶ç­‰æ“ä½œ</p>
<p>è¿™é‡Œä»…ä»‹ç»å…¶è·Ÿã€é›¶æ‹·è´ã€‘ç›¸å…³çš„ wrappedBuffer æ–¹æ³•ï¼Œå¯ä»¥ç”¨æ¥åŒ…è£… ByteBuf</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ByteBuf buf1 <span style="color:#ff79c6">=</span> ByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span>5<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
buf1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>1<span style="color:#ff79c6">,</span> 2<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">,</span> 4<span style="color:#ff79c6">,</span> 5<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
ByteBuf buf2 <span style="color:#ff79c6">=</span> ByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEFAULT</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span>5<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
buf2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>6<span style="color:#ff79c6">,</span> 7<span style="color:#ff79c6">,</span> 8<span style="color:#ff79c6">,</span> 9<span style="color:#ff79c6">,</span> 10<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

<span style="color:#6272a4">// å½“åŒ…è£… ByteBuf ä¸ªæ•°è¶…è¿‡ä¸€ä¸ªæ—¶, åº•å±‚ä½¿ç”¨äº† CompositeByteBuf
</span><span style="color:#6272a4"></span>ByteBuf buf3 <span style="color:#ff79c6">=</span> Unpooled<span style="color:#ff79c6">.</span><span style="color:#50fa7b">wrappedBuffer</span><span style="color:#ff79c6">(</span>buf1<span style="color:#ff79c6">,</span> buf2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>ByteBufUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">prettyHexDump</span><span style="color:#ff79c6">(</span>buf3<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06 07 08 09 0a                   |..........      |
+--------+-------------------------------------------------+----------------+
</code></pre><p>ä¹Ÿå¯ä»¥ç”¨æ¥åŒ…è£…æ™®é€šå­—èŠ‚æ•°ç»„ï¼Œåº•å±‚ä¹Ÿä¸ä¼šæœ‰æ‹·è´æ“ä½œ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">ByteBuf buf4 <span style="color:#ff79c6">=</span> Unpooled<span style="color:#ff79c6">.</span><span style="color:#50fa7b">wrappedBuffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>1<span style="color:#ff79c6">,</span> 2<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">}</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>4<span style="color:#ff79c6">,</span> 5<span style="color:#ff79c6">,</span> 6<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>buf4<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>ByteBufUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">prettyHexDump</span><span style="color:#ff79c6">(</span>buf4<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>è¾“å‡º</p>
<pre><code>class io.netty.buffer.CompositeByteBuf
         +-------------------------------------------------+
         |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 01 02 03 04 05 06                               |......          |
+--------+-------------------------------------------------+----------------+
</code></pre><h4 id="-bytebuf-ä¼˜åŠ¿">ğŸ’¡ ByteBuf ä¼˜åŠ¿</h4>
<ul>
<li>æ± åŒ– - å¯ä»¥é‡ç”¨æ± ä¸­ ByteBuf å®ä¾‹ï¼Œæ›´èŠ‚çº¦å†…å­˜ï¼Œå‡å°‘å†…å­˜æº¢å‡ºçš„å¯èƒ½</li>
<li>è¯»å†™æŒ‡é’ˆåˆ†ç¦»ï¼Œä¸éœ€è¦åƒ ByteBuffer ä¸€æ ·åˆ‡æ¢è¯»å†™æ¨¡å¼</li>
<li>å¯ä»¥è‡ªåŠ¨æ‰©å®¹</li>
<li>æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œä½¿ç”¨æ›´æµç•…</li>
<li>å¾ˆå¤šåœ°æ–¹ä½“ç°é›¶æ‹·è´ï¼Œä¾‹å¦‚ sliceã€duplicateã€CompositeByteBuf</li>
</ul>
<h2 id="4-åŒå‘é€šä¿¡">4. åŒå‘é€šä¿¡</h2>
<h3 id="41-ç»ƒä¹ ">4.1 ç»ƒä¹ </h3>
<p>å®ç°ä¸€ä¸ª echo server</p>
<p>ç¼–å†™ server</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#ff79c6">new</span> ServerBootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioServerSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">childHandler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>NioSocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>NioSocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    ByteBuf buffer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>ByteBuf<span style="color:#ff79c6">)</span> msg<span style="color:#ff79c6">;</span>
                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">(</span>Charset<span style="color:#ff79c6">.</span><span style="color:#50fa7b">defaultCharset</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

                    <span style="color:#6272a4">// å»ºè®®ä½¿ç”¨ ctx.alloc() åˆ›å»º ByteBuf
</span><span style="color:#6272a4"></span>                    ByteBuf response <span style="color:#ff79c6">=</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alloc</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    response<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>response<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

                    <span style="color:#6272a4">// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—
</span><span style="color:#6272a4"></span>                    <span style="color:#6272a4">// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ response å—
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>ç¼–å†™ client</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">NioEventLoopGroup group <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
Channel channel <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>group<span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>NioSocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>NioSocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> StringEncoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInboundHandlerAdapter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    ByteBuf buffer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>ByteBuf<span style="color:#ff79c6">)</span> msg<span style="color:#ff79c6">;</span>
                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>buffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">(</span>Charset<span style="color:#ff79c6">.</span><span style="color:#50fa7b">defaultCharset</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

                    <span style="color:#6272a4">// æ€è€ƒï¼šéœ€è¦é‡Šæ”¾ buffer å—
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addListener</span><span style="color:#ff79c6">(</span>future <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    group<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

<span style="color:#ff79c6">new</span> Thread<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    Scanner scanner <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Scanner<span style="color:#ff79c6">(</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">in</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        String line <span style="color:#ff79c6">=</span> scanner<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nextLine</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;q&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>line<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>line<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">start</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><h3 id="-è¯»å’Œå†™çš„è¯¯è§£">ğŸ’¡ è¯»å’Œå†™çš„è¯¯è§£</h3>
<p>æˆ‘æœ€åˆåœ¨è®¤è¯†ä¸Šæœ‰è¿™æ ·çš„è¯¯åŒºï¼Œè®¤ä¸ºåªæœ‰åœ¨ nettyï¼Œnio è¿™æ ·çš„å¤šè·¯å¤ç”¨ IO æ¨¡å‹æ—¶ï¼Œè¯»å†™æ‰ä¸ä¼šç›¸äº’é˜»å¡ï¼Œæ‰å¯ä»¥å®ç°é«˜æ•ˆçš„åŒå‘é€šä¿¡ï¼Œä½†å®é™…ä¸Šï¼ŒJava Socket æ˜¯å…¨åŒå·¥çš„ï¼šåœ¨ä»»æ„æ—¶åˆ»ï¼Œçº¿è·¯ä¸Šå­˜åœ¨<code>A åˆ° B</code> å’Œ <code>B åˆ° A</code> çš„åŒå‘ä¿¡å·ä¼ è¾“ã€‚å³ä½¿æ˜¯é˜»å¡ IOï¼Œè¯»å’Œå†™æ˜¯å¯ä»¥åŒæ—¶è¿›è¡Œçš„ï¼Œåªè¦åˆ†åˆ«é‡‡ç”¨è¯»çº¿ç¨‹å’Œå†™çº¿ç¨‹å³å¯ï¼Œè¯»ä¸ä¼šé˜»å¡å†™ã€å†™ä¹Ÿä¸ä¼šé˜»å¡è¯»</p>
<p>ä¾‹å¦‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">TestServer</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
        ServerSocket ss <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ServerSocket<span style="color:#ff79c6">(</span>8888<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        Socket s <span style="color:#ff79c6">=</span> ss<span style="color:#ff79c6">.</span><span style="color:#50fa7b">accept</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">new</span> Thread<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                BufferedReader reader <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> BufferedReader<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> InputStreamReader<span style="color:#ff79c6">(</span>s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getInputStream</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>reader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readLine</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">start</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">new</span> Thread<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                BufferedWriter writer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> BufferedWriter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> OutputStreamWriter<span style="color:#ff79c6">(</span>s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getOutputStream</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#6272a4">// ä¾‹å¦‚åœ¨è¿™ä¸ªä½ç½®åŠ å…¥ thread çº§åˆ«æ–­ç‚¹ï¼Œå¯ä»¥å‘ç°å³ä½¿ä¸å†™å…¥æ•°æ®ï¼Œä¹Ÿä¸å¦¨ç¢å‰é¢çº¿ç¨‹è¯»å–å®¢æˆ·ç«¯æ•°æ®
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> 100<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    writer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    writer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newLine</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    writer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">flush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">start</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>å®¢æˆ·ç«¯</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">TestClient</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
        Socket s <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Socket<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;localhost&#34;</span><span style="color:#ff79c6">,</span> 8888<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">new</span> Thread<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                BufferedReader reader <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> BufferedReader<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> InputStreamReader<span style="color:#ff79c6">(</span>s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getInputStream</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>reader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readLine</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">start</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">new</span> Thread<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                BufferedWriter writer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> BufferedWriter<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> OutputStreamWriter<span style="color:#ff79c6">(</span>s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getOutputStream</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> 100<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    writer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    writer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newLine</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    writer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">flush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">start</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div>

                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/1035nio/" data-toggle="tooltip" data-placement="top" title="1ã€NIOï¼ˆNettyï¼‰">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/1037netty%E8%BF%9B%E9%98%B6/" data-toggle="tooltip" data-placement="top" title="3ã€Nettyè¿›é˜¶ï¼ˆNettyï¼‰">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">æ ‡ç­¾</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/activemq" title="activemq">
                            activemq
                        </a>
                        
                        
                        
                        <a href="/tags/ajax" title="ajax">
                            ajax
                        </a>
                        
                        
                        
                        <a href="/tags/cookie" title="cookie">
                            cookie
                        </a>
                        
                        
                        
                        <a href="/tags/datax" title="datax">
                            datax
                        </a>
                        
                        
                        
                        <a href="/tags/docker" title="docker">
                            docker
                        </a>
                        
                        
                        
                        <a href="/tags/elasticsearch" title="elasticsearch">
                            elasticsearch
                        </a>
                        
                        
                        
                        <a href="/tags/filter" title="filter">
                            filter
                        </a>
                        
                        
                        
                        <a href="/tags/hadoop" title="hadoop">
                            hadoop
                        </a>
                        
                        
                        
                        <a href="/tags/hbase" title="hbase">
                            hbase
                        </a>
                        
                        
                        
                        <a href="/tags/hive" title="hive">
                            hive
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/java" title="java">
                            java
                        </a>
                        
                        
                        
                        <a href="/tags/javascript" title="javascript">
                            javascript
                        </a>
                        
                        
                        
                        <a href="/tags/javaweb" title="javaweb">
                            javaweb
                        </a>
                        
                        
                        
                        <a href="/tags/jdbc" title="jdbc">
                            jdbc
                        </a>
                        
                        
                        
                        <a href="/tags/jquery" title="jquery">
                            jquery
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/jsp" title="jsp">
                            jsp
                        </a>
                        
                        
                        
                        <a href="/tags/juc" title="juc">
                            juc
                        </a>
                        
                        
                        
                        <a href="/tags/jvm" title="jvm">
                            jvm
                        </a>
                        
                        
                        
                        <a href="/tags/jwt" title="jwt">
                            jwt
                        </a>
                        
                        
                        
                        <a href="/tags/kafka" title="kafka">
                            kafka
                        </a>
                        
                        
                        
                        <a href="/tags/linux" title="linux">
                            linux
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/maven" title="maven">
                            maven
                        </a>
                        
                        
                        
                        <a href="/tags/minio" title="minio">
                            minio
                        </a>
                        
                        
                        
                        <a href="/tags/mongodb" title="mongodb">
                            mongodb
                        </a>
                        
                        
                        
                        <a href="/tags/mybatis" title="mybatis">
                            mybatis
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/mysql" title="mysql">
                            mysql
                        </a>
                        
                        
                        
                        <a href="/tags/netty" title="netty">
                            netty
                        </a>
                        
                        
                        
                        <a href="/tags/nginx" title="nginx">
                            nginx
                        </a>
                        
                        
                        
                        <a href="/tags/react" title="react">
                            react
                        </a>
                        
                        
                        
                        <a href="/tags/redis" title="redis">
                            redis
                        </a>
                        
                        
                        
                        <a href="/tags/scala" title="scala">
                            scala
                        </a>
                        
                        
                        
                        <a href="/tags/servlet" title="servlet">
                            servlet
                        </a>
                        
                        
                        
                        <a href="/tags/session" title="session">
                            session
                        </a>
                        
                        
                        
                        <a href="/tags/shiro" title="shiro">
                            shiro
                        </a>
                        
                        
                        
                        <a href="/tags/spark" title="spark">
                            spark
                        </a>
                        
                        
                        
                        <a href="/tags/spring" title="spring">
                            spring
                        </a>
                        
                        
                        
                        <a href="/tags/springboot" title="springboot">
                            springboot
                        </a>
                        
                        
                        
                        <a href="/tags/springcloud" title="springcloud">
                            springcloud
                        </a>
                        
                        
                        
                        <a href="/tags/springmvc" title="springmvc">
                            springmvc
                        </a>
                        
                        
                        
                        <a href="/tags/springsecurity" title="springsecurity">
                            springsecurity
                        </a>
                        
                        
                        
                        <a href="/tags/tomcat" title="tomcat">
                            tomcat
                        </a>
                        
                        
                        
                        <a href="/tags/vue" title="vue">
                            vue
                        </a>
                        
                        
                        
                        <a href="/tags/xml" title="xml">
                            xml
                        </a>
                        
                        
                        
                        <a href="/tags/zookeeper" title="zookeeper">
                            zookeeper
                        </a>
                        
                        
                        
                        <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95" title="æ•°æ®ç»“æ„ä¸ç®—æ³•">
                            æ•°æ®ç»“æ„ä¸ç®—æ³•
                        </a>
                        
                        
                        
                        <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" title="è®¾è®¡æ¨¡å¼">
                            è®¾è®¡æ¨¡å¼
                        </a>
                        
                        
                        
                        <a href="/tags/%E9%A1%B9%E7%9B%AE" title="é¡¹ç›®">
                            é¡¹ç›®
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:1424197205@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    <li>
                        <a target="_blank" href="/#">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/yiguan1573">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="äº¿è§‚çš„åšå®¢" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; äº¿è§‚çš„åšå®¢ 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>









<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





</body>
</html>
