<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="referrer" content="never">

    
    <meta property="og:site_name" content="亿观的博客">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://yiguan1573.gitee.io//img/01.jpg">
    <meta property="twitter:image" content="https://yiguan1573.gitee.io//img/01.jpg" />
    

    
    <meta name="title" content="4、Netty优化和源码（Netty）" />
    <meta property="og:title" content="4、Netty优化和源码（Netty）" />
    <meta property="twitter:title" content="4、Netty优化和源码（Netty）" />
    

    
    <meta name="description" content="">
    <meta property="og:description" content="" />
    <meta property="twitter:description" content="" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>4、Netty优化和源码（Netty） | yiguan1573</title>

    <link rel="canonical" href="/post/1038netty%E4%BC%98%E5%8C%96%E5%92%8C%E6%BA%90%E7%A0%81/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>




<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">亿观的博客</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">首页</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/%E5%AD%A6%E4%B9%A0">学习</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/archive/">档案</a></li>
                    
                        <li><a href="/top/about/">关于</a></li>
                    

                    
		    <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		    </li>
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/03.JPG')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/netty" title="Netty">
                            Netty
                        </a>
                        
                    </div>
                    <h1>4、Netty优化和源码（Netty）</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                亿观
                             
                            on 
                            Wednesday, May 18, 2022
                            
                                <span id="/post/1038netty%E4%BC%98%E5%8C%96%E5%92%8C%E6%BA%90%E7%A0%81/" class="leancloud_visitors meta_data_item" data-flag-title="">
    <span class="post-meta-item-icon">
      <span class="octicon octicon-eye"></span> 
    </span>
    <i class="fa fa-eye"></i>
    <span class="old-visitors-count" style="display: none;"></span>
    <span class="leancloud-visitors-count"></span>
</span>



<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>

<script>
	AV.initialize("", "");
</script>

<script type="text/javascript">
function showTime(Counter) {
    var query = new AV.Query(Counter);
    var entries = [];
    var $visitors = $(".leancloud_visitors");

    $visitors.each(function() {
        entries.push($(this).attr("id").trim());
    });

    query.containedIn('url', entries);
    query.find()
        .done(function(results) {
            var COUNT_CONTAINER_REF = '.leancloud-visitors-count';
            var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';

            
            
            
            

            for (var i = 0; i < results.length; i++) {
                var item = results[i];
                var url = item.get('url');
                var time = item.get('time');
                var element = document.getElementById(url);

                $(element).find(COUNT_CONTAINER_REF).text(time);
            }
            for (var i = 0; i < entries.length; i++) {
                var url = entries[i];
                var element = document.getElementById(url);
                var countSpan = $(element).find(COUNT_CONTAINER_REF);
                if (countSpan.text() == '') {
                    var oldCountSpan = $(element).find(OLD_COUNT_CONTAINER_REF).text();
                    if(oldCountSpan!=''){
                        countSpan.text(0+parseInt(oldCountSpan));
                    }else{
                        countSpan.text(0);          
                    }
                }
            }
        })
        .fail(function(object, error) {
            console.log("Error: " + error.code + " " + error.message);
        });
}

function addCount(Counter) {
    var $visitors = $(".leancloud_visitors");
    var url = $visitors.attr('id').trim();
    var title = $visitors.attr('data-flag-title').trim();
    var query = new AV.Query(Counter);

    query.equalTo("url", url);
    query.find({
        success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment("time");
                counter.save(null, {
                    success: function(counter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(counter.get('time'));
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
                var newcounter = new Counter();
                 
                var acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                newcounter.setACL(acl);
                 
                newcounter.set("title", title);
                newcounter.set("url", url);
                var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';
                var $element = $(document.getElementById(url));
                var oldCountSpan = $element.find(OLD_COUNT_CONTAINER_REF).text();
                if(oldCountSpan!=''){
                    newcounter.set("time", parseInt(oldCountSpan)+1);
                }else{
 	                    newcounter.set("time",  1);
                }
                newcounter.save(null, {
                    success: function(newcounter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                    },
                    error: function(newcounter, error) {
                        console.log('Failed to create');
                    }
                });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + " " + error.message);
        }
    });
}
$(function() {
    var Counter = AV.Object.extend("Counter");
    
    
    if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
    } else {
        showTime(Counter);
    }
});
</script>

                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <h2 id="1-优化">1. 优化</h2>
<h3 id="11-扩展序列化算法">1.1 扩展序列化算法</h3>
<p>序列化，反序列化主要用在消息正文的转换上</p>
<ul>
<li>序列化时，需要将 Java 对象变为要传输的数据（可以是 byte[]，或 json 等，最终都需要变成 byte[]）</li>
<li>反序列化时，需要将传入的正文数据还原成 Java 对象，便于处理</li>
</ul>
<p>目前的代码仅支持 Java 自带的序列化，反序列化机制，核心代码如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">// 反序列化
</span><span style="color:#6272a4"></span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> body <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>bodyLength<span style="color:#ff79c6">]</span><span style="color:#ff79c6">;</span>
byteByf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readBytes</span><span style="color:#ff79c6">(</span>body<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
ObjectInputStream in <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectInputStream<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ByteArrayInputStream<span style="color:#ff79c6">(</span>body<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
Message message <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Message<span style="color:#ff79c6">)</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setSequenceId</span><span style="color:#ff79c6">(</span>sequenceId<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

<span style="color:#6272a4">// 序列化
</span><span style="color:#6272a4"></span>ByteArrayOutputStream out <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayOutputStream<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">new</span> ObjectOutputStream<span style="color:#ff79c6">(</span>out<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> bytes <span style="color:#ff79c6">=</span> out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toByteArray</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>为了支持更多序列化算法，抽象一个 Serializer 接口</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">interface</span> <span style="color:#50fa7b">Serializer</span> <span style="color:#ff79c6">{</span>

    <span style="color:#6272a4">// 反序列化方法
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> T <span style="color:#50fa7b">deserialize</span><span style="color:#ff79c6">(</span>Class<span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> clazz<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> bytes<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">// 序列化方法
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> <span style="color:#50fa7b">serialize</span><span style="color:#ff79c6">(</span>T object<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

<span style="color:#ff79c6">}</span>
</code></pre></div><p>提供两个实现，我这里直接将实现加入了枚举类 Serializer.Algorithm 中</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">enum</span> SerializerAlgorithm <span style="color:#8be9fd;font-style:italic">implements</span> Serializer <span style="color:#ff79c6">{</span>
	<span style="color:#6272a4">// Java 实现
</span><span style="color:#6272a4"></span>    Java <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> T <span style="color:#50fa7b">deserialize</span><span style="color:#ff79c6">(</span>Class<span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> clazz<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> bytes<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                ObjectInputStream in <span style="color:#ff79c6">=</span> 
                    <span style="color:#ff79c6">new</span> ObjectInputStream<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ByteArrayInputStream<span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                Object object <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">(</span>T<span style="color:#ff79c6">)</span> object<span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException <span style="color:#ff79c6">|</span> ClassNotFoundException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> RuntimeException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;SerializerAlgorithm.Java 反序列化错误&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>

        @Override
        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> <span style="color:#50fa7b">serialize</span><span style="color:#ff79c6">(</span>T object<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                ByteArrayOutputStream out <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayOutputStream<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">new</span> ObjectOutputStream<span style="color:#ff79c6">(</span>out<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>object<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">return</span> out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toByteArray</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> RuntimeException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;SerializerAlgorithm.Java 序列化错误&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">,</span> 
    <span style="color:#6272a4">// Json 实现(引入了 Gson 依赖)
</span><span style="color:#6272a4"></span>    Json <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> T <span style="color:#50fa7b">deserialize</span><span style="color:#ff79c6">(</span>Class<span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> clazz<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> bytes<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Gson<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">fromJson</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">,</span> StandardCharsets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">UTF_8</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> clazz<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>

        @Override
        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> <span style="color:#50fa7b">serialize</span><span style="color:#ff79c6">(</span>T object<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Gson<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">toJson</span><span style="color:#ff79c6">(</span>object<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span>StandardCharsets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">UTF_8</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">// 需要从协议的字节中得到是哪种序列化算法
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> SerializerAlgorithm <span style="color:#50fa7b">getByInt</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> type<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        SerializerAlgorithm<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> array <span style="color:#ff79c6">=</span> SerializerAlgorithm<span style="color:#ff79c6">.</span><span style="color:#50fa7b">values</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>type <span style="color:#ff79c6">&lt;</span> 0 <span style="color:#ff79c6">|</span><span style="color:#ff79c6">|</span> type <span style="color:#ff79c6">&gt;</span> array<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span> <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> IllegalArgumentException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;超过 SerializerAlgorithm 范围&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">return</span> array<span style="color:#ff79c6">[</span>type<span style="color:#ff79c6">]</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>增加配置类和配置文件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">abstract</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Config</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">static</span> Properties properties<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">(</span>InputStream in <span style="color:#ff79c6">=</span> Config<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getResourceAsStream</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;/application.properties&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            properties <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Properties<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            properties<span style="color:#ff79c6">.</span><span style="color:#50fa7b">load</span><span style="color:#ff79c6">(</span>in<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> ExceptionInInitializerError<span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">getServerPort</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        String value <span style="color:#ff79c6">=</span> properties<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getProperty</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;server.port&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>value <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">return</span> 8080<span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">return</span> Integer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">parseInt</span><span style="color:#ff79c6">(</span>value<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> Serializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Algorithm</span> <span style="color:#50fa7b">getSerializerAlgorithm</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        String value <span style="color:#ff79c6">=</span> properties<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getProperty</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;serializer.algorithm&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>value <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">return</span> Serializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Algorithm</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Java</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">return</span> Serializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Algorithm</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>value<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>配置文件</p>
<pre><code class="language-properties" data-lang="properties">serializer.algorithm=Json
</code></pre><p>修改编解码器</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">/**
</span><span style="color:#6272a4"> * 必须和 LengthFieldBasedFrameDecoder 一起使用，确保接到的 ByteBuf 消息是完整的
</span><span style="color:#6272a4"> */</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MessageCodecSharable</span> <span style="color:#8be9fd;font-style:italic">extends</span> MessageToMessageCodec<span style="color:#ff79c6">&lt;</span>ByteBuf<span style="color:#ff79c6">,</span> Message<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">encode</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Message msg<span style="color:#ff79c6">,</span> List<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> outList<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        ByteBuf out <span style="color:#ff79c6">=</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">alloc</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 1. 4 字节的魔数
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>1<span style="color:#ff79c6">,</span> 2<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">,</span> 4<span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 2. 1 字节的版本,
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 3. 1 字节的序列化方式 jdk 0 , json 1
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>Config<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSerializerAlgorithm</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">ordinal</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 4. 1 字节的指令类型
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMessageType</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 5. 4 个字节
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeInt</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSequenceId</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 无意义，对齐填充
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByte</span><span style="color:#ff79c6">(</span>0xff<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 6. 获取内容的字节数组
</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> bytes <span style="color:#ff79c6">=</span> Config<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSerializerAlgorithm</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">serialize</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 7. 长度
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeInt</span><span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 8. 写入内容
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeBytes</span><span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        outList<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>out<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">decode</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> ByteBuf in<span style="color:#ff79c6">,</span> List<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> out<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        <span style="color:#8be9fd">int</span> magicNum <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">byte</span> version <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">byte</span> serializerAlgorithm <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 0 或 1
</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd">byte</span> messageType <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 0,1,2...
</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd">int</span> sequenceId <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readByte</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">int</span> length <span style="color:#ff79c6">=</span> in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readInt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> bytes <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>length<span style="color:#ff79c6">]</span><span style="color:#ff79c6">;</span>
        in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readBytes</span><span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> length<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#6272a4">// 找到反序列化算法
</span><span style="color:#6272a4"></span>        Serializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Algorithm</span> algorithm <span style="color:#ff79c6">=</span> Serializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Algorithm</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">values</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">[</span>serializerAlgorithm<span style="color:#ff79c6">]</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 确定具体消息类型
</span><span style="color:#6272a4"></span>        Class<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span> <span style="color:#8be9fd;font-style:italic">extends</span> Message<span style="color:#ff79c6">&gt;</span> messageClass <span style="color:#ff79c6">=</span> Message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMessageClass</span><span style="color:#ff79c6">(</span>messageType<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        Message message <span style="color:#ff79c6">=</span> algorithm<span style="color:#ff79c6">.</span><span style="color:#50fa7b">deserialize</span><span style="color:#ff79c6">(</span>messageClass<span style="color:#ff79c6">,</span> bytes<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#6272a4">//        log.debug(&#34;{}, {}, {}, {}, {}, {}&#34;, magicNum, version, serializerType, messageType, sequenceId, length);
</span><span style="color:#6272a4"></span><span style="color:#6272a4">//        log.debug(&#34;{}&#34;, message);
</span><span style="color:#6272a4"></span>        out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>其中确定具体消息类型，可以根据 <code>消息类型字节</code> 获取到对应的 <code>消息 class</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Data
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">abstract</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Message</span> <span style="color:#8be9fd;font-style:italic">implements</span> Serializable <span style="color:#ff79c6">{</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 根据消息类型字节，获得对应的消息 class
</span><span style="color:#6272a4">     * @param messageType 消息类型字节
</span><span style="color:#6272a4">     * @return 消息 class
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> Class<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span> <span style="color:#8be9fd;font-style:italic">extends</span> Message<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">getMessageClass</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> messageType<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>messageType<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">int</span> sequenceId<span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">int</span> messageType<span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">abstract</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">getMessageType</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> LoginRequestMessage <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> LoginResponseMessage <span style="color:#ff79c6">=</span> 1<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> ChatRequestMessage <span style="color:#ff79c6">=</span> 2<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> ChatResponseMessage <span style="color:#ff79c6">=</span> 3<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> GroupCreateRequestMessage <span style="color:#ff79c6">=</span> 4<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> GroupCreateResponseMessage <span style="color:#ff79c6">=</span> 5<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> GroupJoinRequestMessage <span style="color:#ff79c6">=</span> 6<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> GroupJoinResponseMessage <span style="color:#ff79c6">=</span> 7<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> GroupQuitRequestMessage <span style="color:#ff79c6">=</span> 8<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> GroupQuitResponseMessage <span style="color:#ff79c6">=</span> 9<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> GroupChatRequestMessage <span style="color:#ff79c6">=</span> 10<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> GroupChatResponseMessage <span style="color:#ff79c6">=</span> 11<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> GroupMembersRequestMessage <span style="color:#ff79c6">=</span> 12<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> GroupMembersResponseMessage <span style="color:#ff79c6">=</span> 13<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> PingMessage <span style="color:#ff79c6">=</span> 14<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> PongMessage <span style="color:#ff79c6">=</span> 15<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> Map<span style="color:#ff79c6">&lt;</span>Integer<span style="color:#ff79c6">,</span> Class<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span> <span style="color:#8be9fd;font-style:italic">extends</span> Message<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">&gt;</span> messageClasses <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#ff79c6">{</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>LoginRequestMessage<span style="color:#ff79c6">,</span> LoginRequestMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>LoginResponseMessage<span style="color:#ff79c6">,</span> LoginResponseMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>ChatRequestMessage<span style="color:#ff79c6">,</span> ChatRequestMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>ChatResponseMessage<span style="color:#ff79c6">,</span> ChatResponseMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>GroupCreateRequestMessage<span style="color:#ff79c6">,</span> GroupCreateRequestMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>GroupCreateResponseMessage<span style="color:#ff79c6">,</span> GroupCreateResponseMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>GroupJoinRequestMessage<span style="color:#ff79c6">,</span> GroupJoinRequestMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>GroupJoinResponseMessage<span style="color:#ff79c6">,</span> GroupJoinResponseMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>GroupQuitRequestMessage<span style="color:#ff79c6">,</span> GroupQuitRequestMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>GroupQuitResponseMessage<span style="color:#ff79c6">,</span> GroupQuitResponseMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>GroupChatRequestMessage<span style="color:#ff79c6">,</span> GroupChatRequestMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>GroupChatResponseMessage<span style="color:#ff79c6">,</span> GroupChatResponseMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>GroupMembersRequestMessage<span style="color:#ff79c6">,</span> GroupMembersRequestMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>GroupMembersResponseMessage<span style="color:#ff79c6">,</span> GroupMembersResponseMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="12-参数调优">1.2 参数调优</h3>
<h4 id="1connect_timeout_millis">1）CONNECT_TIMEOUT_MILLIS</h4>
<ul>
<li>
<p>属于 SocketChannal 参数</p>
</li>
<li>
<p>用在客户端建立连接时，如果在指定毫秒内无法连接，会抛出 timeout 异常</p>
</li>
<li>
<p>SO_TIMEOUT 主要用在阻塞 IO，阻塞 IO 中 accept，read 等都是无限等待的，如果不希望永远阻塞，使用它调整超时时间</p>
</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Slf4j
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">TestConnectionTimeout</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        NioEventLoopGroup group <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            Bootstrap bootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span>
                    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>group<span style="color:#ff79c6">)</span>
                    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">option</span><span style="color:#ff79c6">(</span>ChannelOption<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CONNECT_TIMEOUT_MILLIS</span><span style="color:#ff79c6">,</span> 300<span style="color:#ff79c6">)</span>
                    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
                    <span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ChannelFuture future <span style="color:#ff79c6">=</span> bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            future<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 断点1
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;timeout&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            group<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>另外源码部分 <code>io.netty.channel.nio.AbstractNioChannel.AbstractNioUnsafe#connect</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Override
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span>
        <span style="color:#8be9fd;font-style:italic">final</span> SocketAddress remoteAddress<span style="color:#ff79c6">,</span> <span style="color:#8be9fd;font-style:italic">final</span> SocketAddress localAddress<span style="color:#ff79c6">,</span> <span style="color:#8be9fd;font-style:italic">final</span> ChannelPromise promise<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">// ...
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// Schedule connect timeout.
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd">int</span> connectTimeoutMillis <span style="color:#ff79c6">=</span> config<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnectTimeoutMillis</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>connectTimeoutMillis <span style="color:#ff79c6">&gt;</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        connectTimeoutFuture <span style="color:#ff79c6">=</span> eventLoop<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">schedule</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Runnable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            @Override
            <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">run</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>                
                ChannelPromise connectPromise <span style="color:#ff79c6">=</span> AbstractNioChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">connectPromise</span><span style="color:#ff79c6">;</span>
                ConnectTimeoutException cause <span style="color:#ff79c6">=</span>
                    <span style="color:#ff79c6">new</span> ConnectTimeoutException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;connection timed out: &#34;</span> <span style="color:#ff79c6">+</span> remoteAddress<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// 断点2
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>connectPromise <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span> connectPromise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">tryFailure</span><span style="color:#ff79c6">(</span>cause<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    close<span style="color:#ff79c6">(</span>voidPromise<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">,</span> connectTimeoutMillis<span style="color:#ff79c6">,</span> TimeUnit<span style="color:#ff79c6">.</span><span style="color:#50fa7b">MILLISECONDS</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
	<span style="color:#6272a4">// ...
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="2so_backlog">2）SO_BACKLOG</h4>
<ul>
<li>属于 ServerSocketChannal 参数</li>
</ul>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h38647psf2j319613jdh5.jpg" alt="QQ截图20220614230141.jpg">

</p>
<ol>
<li>第一次握手，client 发送 SYN 到 server，状态修改为 SYN_SEND，server 收到，状态改变为 SYN_REVD，并将该请求放入 sync queue 队列</li>
<li>第二次握手，server 回复 SYN + ACK 给 client，client 收到，状态改变为 ESTABLISHED，并发送 ACK 给 server</li>
<li>第三次握手，server 收到 ACK，状态改变为 ESTABLISHED，将该请求从 sync queue 放入 accept queue</li>
</ol>
<p>其中</p>
<ul>
<li>
<p>在 linux 2.2 之前，backlog 大小包括了两个队列的大小，在 2.2 之后，分别用下面两个参数来控制</p>
</li>
<li>
<p>sync queue - 半连接队列</p>
<ul>
<li>大小通过 /proc/sys/net/ipv4/tcp_max_syn_backlog 指定，在 <code>syncookies</code> 启用的情况下，逻辑上没有最大值限制，这个设置便被忽略</li>
</ul>
</li>
<li>
<p>accept queue - 全连接队列</p>
<ul>
<li>其大小通过 /proc/sys/net/core/somaxconn 指定，在使用 listen 函数时，内核会根据传入的 backlog 参数与系统参数，取二者的较小值</li>
<li>如果 accpet queue 队列满了，server 将发送一个拒绝连接的错误信息到 client</li>
</ul>
</li>
</ul>
<p>netty 中</p>
<p>可以通过  option(ChannelOption.SO_BACKLOG, 值) 来设置大小</p>
<p>可以通过下面源码查看默认大小</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">DefaultServerSocketChannelConfig</span> <span style="color:#8be9fd;font-style:italic">extends</span> DefaultChannelConfig
                                              <span style="color:#8be9fd;font-style:italic">implements</span> ServerSocketChannelConfig <span style="color:#ff79c6">{</span>

    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">volatile</span> <span style="color:#8be9fd">int</span> backlog <span style="color:#ff79c6">=</span> NetUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">SOMAXCONN</span><span style="color:#ff79c6">;</span>
    <span style="color:#6272a4">// ...
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">}</span>
</code></pre></div><p>课堂调试关键断点为：<code>io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p>
<p>oio 中更容易说明，不用 debug 模式</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Server</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
        ServerSocket ss <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ServerSocket<span style="color:#ff79c6">(</span>8888<span style="color:#ff79c6">,</span> 2<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        Socket accept <span style="color:#ff79c6">=</span> ss<span style="color:#ff79c6">.</span><span style="color:#50fa7b">accept</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>accept<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">in</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">read</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>客户端启动 4 个</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Client</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            Socket s <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Socket<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Date<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#34; connecting...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> InetSocketAddress<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;localhost&#34;</span><span style="color:#ff79c6">,</span> 8888<span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span>1000<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Date<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#34; connected...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getOutputStream</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">in</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">read</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Date<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#34; connecting timeout...&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>第 1，2，3 个客户端都打印，但除了第一个处于 accpet 外，其它两个都处于 accept queue 中</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Tue Apr 21 20<span style="color:#ff79c6">:</span>30<span style="color:#ff79c6">:</span>28 CST 2020 connecting<span style="color:#ff79c6">.</span><span style="color:#ff79c6">.</span><span style="color:#ff79c6">.</span>
Tue Apr 21 20<span style="color:#ff79c6">:</span>30<span style="color:#ff79c6">:</span>28 CST 2020 connected<span style="color:#ff79c6">.</span><span style="color:#ff79c6">.</span><span style="color:#ff79c6">.</span>
</code></pre></div><p>第 4 个客户端连接时</p>
<pre><code>Tue Apr 21 20:53:58 CST 2020 connecting...
Tue Apr 21 20:53:59 CST 2020 connecting timeout...
java.net.SocketTimeoutException: connect timed out
</code></pre><h4 id="3ulimit--n">3）ulimit -n</h4>
<ul>
<li>属于操作系统参数</li>
</ul>
<h4 id="4tcp_nodelay">4）TCP_NODELAY</h4>
<ul>
<li>属于 SocketChannal 参数</li>
</ul>
<h4 id="5so_sndbuf--so_rcvbuf">5）SO_SNDBUF &amp; SO_RCVBUF</h4>
<ul>
<li>SO_SNDBUF 属于 SocketChannal 参数</li>
<li>SO_RCVBUF 既可用于 SocketChannal 参数，也可以用于 ServerSocketChannal 参数（建议设置到 ServerSocketChannal 上）</li>
</ul>
<h4 id="6allocator">6）ALLOCATOR</h4>
<ul>
<li>属于 SocketChannal 参数</li>
<li>用来分配 ByteBuf， ctx.alloc()</li>
</ul>
<h4 id="7rcvbuf_allocator">7）RCVBUF_ALLOCATOR</h4>
<ul>
<li>属于 SocketChannal 参数</li>
<li>控制 netty 接收缓冲区大小</li>
<li>负责入站数据的分配，决定入站缓冲区的大小（并可动态调整），统一采用 direct 直接内存，具体池化还是非池化由 allocator 决定</li>
</ul>
<h3 id="13-rpc-框架">1.3 RPC 框架</h3>
<h4 id="1准备工作">1）准备工作</h4>
<p>这些代码可以认为是现成的，无需从头编写练习</p>
<p>为了简化起见，在原来聊天项目的基础上新增 Rpc 请求和响应消息</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Data
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">abstract</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Message</span> <span style="color:#8be9fd;font-style:italic">implements</span> Serializable <span style="color:#ff79c6">{</span>

    <span style="color:#6272a4">// 省略旧的代码
</span><span style="color:#6272a4"></span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> RPC_MESSAGE_TYPE_REQUEST <span style="color:#ff79c6">=</span> 101<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span>  RPC_MESSAGE_TYPE_RESPONSE <span style="color:#ff79c6">=</span> 102<span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// ...
</span><span style="color:#6272a4"></span>        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>RPC_MESSAGE_TYPE_REQUEST<span style="color:#ff79c6">,</span> RpcRequestMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        messageClasses<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>RPC_MESSAGE_TYPE_RESPONSE<span style="color:#ff79c6">,</span> RpcResponseMessage<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

<span style="color:#ff79c6">}</span>
</code></pre></div><p>请求消息</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Getter
@ToString<span style="color:#ff79c6">(</span>callSuper <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RpcRequestMessage</span> <span style="color:#8be9fd;font-style:italic">extends</span> Message <span style="color:#ff79c6">{</span>

    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 调用的接口全限定名，服务端根据它找到实现
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">private</span> String interfaceName<span style="color:#ff79c6">;</span>
    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 调用接口中的方法名
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">private</span> String methodName<span style="color:#ff79c6">;</span>
    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 方法返回类型
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">private</span> Class<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span><span style="color:#ff79c6">&gt;</span> returnType<span style="color:#ff79c6">;</span>
    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 方法参数类型数组
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">private</span> Class<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> parameterTypes<span style="color:#ff79c6">;</span>
    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 方法参数值数组
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">private</span> Object<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> parameterValue<span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">RpcRequestMessage</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> sequenceId<span style="color:#ff79c6">,</span> String interfaceName<span style="color:#ff79c6">,</span> String methodName<span style="color:#ff79c6">,</span> Class<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span><span style="color:#ff79c6">&gt;</span> returnType<span style="color:#ff79c6">,</span> Class<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> parameterTypes<span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> parameterValue<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">setSequenceId</span><span style="color:#ff79c6">(</span>sequenceId<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">interfaceName</span> <span style="color:#ff79c6">=</span> interfaceName<span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">methodName</span> <span style="color:#ff79c6">=</span> methodName<span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">returnType</span> <span style="color:#ff79c6">=</span> returnType<span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">parameterTypes</span> <span style="color:#ff79c6">=</span> parameterTypes<span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">parameterValue</span> <span style="color:#ff79c6">=</span> parameterValue<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">getMessageType</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> RPC_MESSAGE_TYPE_REQUEST<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>响应消息</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Data
@ToString<span style="color:#ff79c6">(</span>callSuper <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RpcResponseMessage</span> <span style="color:#8be9fd;font-style:italic">extends</span> Message <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 返回值
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">private</span> Object returnValue<span style="color:#ff79c6">;</span>
    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * 异常值
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">private</span> Exception exceptionValue<span style="color:#ff79c6">;</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">getMessageType</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> RPC_MESSAGE_TYPE_RESPONSE<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>服务器架子</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Slf4j
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RpcServer</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        NioEventLoopGroup boss <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        NioEventLoopGroup worker <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        LoggingHandler LOGGING_HANDLER <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        MessageCodecSharable MESSAGE_CODEC <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> MessageCodecSharable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        
        <span style="color:#6272a4">// rpc 请求消息处理器，待实现
</span><span style="color:#6272a4"></span>        RpcRequestMessageHandler RPC_HANDLER <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RpcRequestMessageHandler<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            ServerBootstrap serverBootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ServerBootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioServerSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>boss<span style="color:#ff79c6">,</span> worker<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">childHandler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ProcotolFrameDecoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>LOGGING_HANDLER<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>MESSAGE_CODEC<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>RPC_HANDLER<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            Channel channel <span style="color:#ff79c6">=</span> serverBootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;server error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            boss<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            worker<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>客户端架子</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RpcClient</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        NioEventLoopGroup group <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        LoggingHandler LOGGING_HANDLER <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        MessageCodecSharable MESSAGE_CODEC <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> MessageCodecSharable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        
        <span style="color:#6272a4">// rpc 响应消息处理器，待实现
</span><span style="color:#6272a4"></span>        RpcResponseMessageHandler RPC_HANDLER <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RpcResponseMessageHandler<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            Bootstrap bootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>group<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ProcotolFrameDecoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>LOGGING_HANDLER<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>MESSAGE_CODEC<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>RPC_HANDLER<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            Channel channel <span style="color:#ff79c6">=</span> bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;localhost&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;client error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            group<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>服务器端的 service 获取</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">ServicesFactory</span> <span style="color:#ff79c6">{</span>

    <span style="color:#8be9fd;font-style:italic">static</span> Properties properties<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">static</span> Map<span style="color:#ff79c6">&lt;</span>Class<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">&gt;</span> map <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ConcurrentHashMap<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">(</span>InputStream in <span style="color:#ff79c6">=</span> Config<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getResourceAsStream</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;/application.properties&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            properties <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Properties<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            properties<span style="color:#ff79c6">.</span><span style="color:#50fa7b">load</span><span style="color:#ff79c6">(</span>in<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            Set<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> names <span style="color:#ff79c6">=</span> properties<span style="color:#ff79c6">.</span><span style="color:#50fa7b">stringPropertyNames</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>String name <span style="color:#ff79c6">:</span> names<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">.</span><span style="color:#50fa7b">endsWith</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Service&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    Class<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span><span style="color:#ff79c6">&gt;</span> interfaceClass <span style="color:#ff79c6">=</span> Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">forName</span><span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    Class<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span><span style="color:#ff79c6">&gt;</span> instanceClass <span style="color:#ff79c6">=</span> Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">forName</span><span style="color:#ff79c6">(</span>properties<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getProperty</span><span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>interfaceClass<span style="color:#ff79c6">,</span> instanceClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newInstance</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException <span style="color:#ff79c6">|</span> ClassNotFoundException <span style="color:#ff79c6">|</span> InstantiationException <span style="color:#ff79c6">|</span> IllegalAccessException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> ExceptionInInitializerError<span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> T <span style="color:#50fa7b">getService</span><span style="color:#ff79c6">(</span>Class<span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> interfaceClass<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">(</span>T<span style="color:#ff79c6">)</span> map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>interfaceClass<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>相关配置 application.properties</p>
<pre><code>serializer.algorithm=Json
cn.itcast.server.service.HelloService=cn.itcast.server.service.HelloServiceImpl
</code></pre><h4 id="2服务器-handler">2）服务器 handler</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Slf4j
@ChannelHandler.Sharable
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RpcRequestMessageHandler</span> <span style="color:#8be9fd;font-style:italic">extends</span> SimpleChannelInboundHandler<span style="color:#ff79c6">&lt;</span>RpcRequestMessage<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead0</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> RpcRequestMessage message<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        RpcResponseMessage response <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RpcResponseMessage<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        response<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setSequenceId</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSequenceId</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 获取真正的实现对象
</span><span style="color:#6272a4"></span>            HelloService service <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>HelloService<span style="color:#ff79c6">)</span>
                    ServicesFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getService</span><span style="color:#ff79c6">(</span>Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">forName</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getInterfaceName</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            
            <span style="color:#6272a4">// 获取要调用的方法
</span><span style="color:#6272a4"></span>            Method method <span style="color:#ff79c6">=</span> service<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMethod</span><span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMethodName</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getParameterTypes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            
            <span style="color:#6272a4">// 调用方法
</span><span style="color:#6272a4"></span>            Object invoke <span style="color:#ff79c6">=</span> method<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>service<span style="color:#ff79c6">,</span> message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getParameterValue</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#6272a4">// 调用成功
</span><span style="color:#6272a4"></span>            response<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setReturnValue</span><span style="color:#ff79c6">(</span>invoke<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#6272a4">// 调用异常
</span><span style="color:#6272a4"></span>            response<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setExceptionValue</span><span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#6272a4">// 返回结果
</span><span style="color:#6272a4"></span>        ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>response<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="3客户端代码第一版">3）客户端代码第一版</h4>
<p>只发消息</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Slf4j
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RpcClient</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        NioEventLoopGroup group <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        LoggingHandler LOGGING_HANDLER <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        MessageCodecSharable MESSAGE_CODEC <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> MessageCodecSharable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        RpcResponseMessageHandler RPC_HANDLER <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RpcResponseMessageHandler<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            Bootstrap bootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>group<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ProcotolFrameDecoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>LOGGING_HANDLER<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>MESSAGE_CODEC<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>RPC_HANDLER<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            Channel channel <span style="color:#ff79c6">=</span> bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;localhost&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

            ChannelFuture future <span style="color:#ff79c6">=</span> channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> RpcRequestMessage<span style="color:#ff79c6">(</span>
                    1<span style="color:#ff79c6">,</span>
                    <span style="color:#f1fa8c">&#34;cn.itcast.server.service.HelloService&#34;</span><span style="color:#ff79c6">,</span>
                    <span style="color:#f1fa8c">&#34;sayHello&#34;</span><span style="color:#ff79c6">,</span>
                    String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span>
                    <span style="color:#ff79c6">new</span> Class<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">}</span><span style="color:#ff79c6">,</span>
                    <span style="color:#ff79c6">new</span> Object<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span><span style="color:#f1fa8c">&#34;张三&#34;</span><span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addListener</span><span style="color:#ff79c6">(</span>promise <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isSuccess</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    Throwable cause <span style="color:#ff79c6">=</span> promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">cause</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;error&#34;</span><span style="color:#ff79c6">,</span> cause<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

            channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;client error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            group<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="4客户端-handler-第一版">4）客户端 handler 第一版</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Slf4j
@ChannelHandler.Sharable
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RpcResponseMessageHandler</span> <span style="color:#8be9fd;font-style:italic">extends</span> SimpleChannelInboundHandler<span style="color:#ff79c6">&lt;</span>RpcResponseMessage<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
    @Override
    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead0</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> RpcResponseMessage msg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{}&#34;</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="5客户端代码-第二版">5）客户端代码 第二版</h4>
<p>包括 channel 管理，代理，接收结果</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Slf4j
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RpcClientManager</span> <span style="color:#ff79c6">{</span>


    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        HelloService service <span style="color:#ff79c6">=</span> getProxyService<span style="color:#ff79c6">(</span>HelloService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>service<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sayHello</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;zhangsan&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#6272a4">//        System.out.println(service.sayHello(&#34;lisi&#34;));
</span><span style="color:#6272a4"></span><span style="color:#6272a4">//        System.out.println(service.sayHello(&#34;wangwu&#34;));
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>

    <span style="color:#6272a4">// 创建代理类
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> T <span style="color:#50fa7b">getProxyService</span><span style="color:#ff79c6">(</span>Class<span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> serviceClass<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        ClassLoader loader <span style="color:#ff79c6">=</span> serviceClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClassLoader</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        Class<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> interfaces <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Class<span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span><span style="color:#ff79c6">{</span>serviceClass<span style="color:#ff79c6">}</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">//                                                            sayHello  &#34;张三&#34;
</span><span style="color:#6272a4"></span>        Object o <span style="color:#ff79c6">=</span> Proxy<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newProxyInstance</span><span style="color:#ff79c6">(</span>loader<span style="color:#ff79c6">,</span> interfaces<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>proxy<span style="color:#ff79c6">,</span> method<span style="color:#ff79c6">,</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 1. 将方法调用转换为 消息对象
</span><span style="color:#6272a4"></span>            <span style="color:#8be9fd">int</span> sequenceId <span style="color:#ff79c6">=</span> SequenceIdGenerator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nextId</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            RpcRequestMessage msg <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RpcRequestMessage<span style="color:#ff79c6">(</span>
                    sequenceId<span style="color:#ff79c6">,</span>
                    serviceClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span>
                    method<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span>
                    method<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getReturnType</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span>
                    method<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getParameterTypes</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span>
                    args
            <span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#6272a4">// 2. 将消息对象发送出去
</span><span style="color:#6272a4"></span>            getChannel<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeAndFlush</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

            <span style="color:#6272a4">// 3. 准备一个空 Promise 对象，来接收结果             指定 promise 对象异步接收结果线程
</span><span style="color:#6272a4"></span>            DefaultPromise<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> promise <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> DefaultPromise<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span>getChannel<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">eventLoop</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            RpcResponseMessageHandler<span style="color:#ff79c6">.</span><span style="color:#50fa7b">PROMISES</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>sequenceId<span style="color:#ff79c6">,</span> promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

<span style="color:#6272a4">//            promise.addListener(future -&gt; {
</span><span style="color:#6272a4"></span><span style="color:#6272a4">//                // 线程
</span><span style="color:#6272a4"></span><span style="color:#6272a4">//            });
</span><span style="color:#6272a4"></span>
            <span style="color:#6272a4">// 4. 等待 promise 结果
</span><span style="color:#6272a4"></span>            promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">await</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isSuccess</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#6272a4">// 调用正常
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">return</span> promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getNow</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
                <span style="color:#6272a4">// 调用失败
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> RuntimeException<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">cause</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">(</span>T<span style="color:#ff79c6">)</span> o<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> Channel channel <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> Object LOCK <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Object<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">// 获取唯一的 channel 对象
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> Channel <span style="color:#50fa7b">getChannel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>channel <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">return</span> channel<span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#8be9fd;font-style:italic">synchronized</span> <span style="color:#ff79c6">(</span>LOCK<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span> <span style="color:#6272a4">//  t2
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>channel <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span> <span style="color:#6272a4">// t1
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">return</span> channel<span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
            initChannel<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">return</span> channel<span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#6272a4">// 初始化 channel 方法
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        NioEventLoopGroup group <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioEventLoopGroup<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        LoggingHandler LOGGING_HANDLER <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LoggingHandler<span style="color:#ff79c6">(</span>LogLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">DEBUG</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        MessageCodecSharable MESSAGE_CODEC <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> MessageCodecSharable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        RpcResponseMessageHandler RPC_HANDLER <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> RpcResponseMessageHandler<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        Bootstrap bootstrap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Bootstrap<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span>NioSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span>group<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>SocketChannel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            @Override
            <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>SocketChannel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ProcotolFrameDecoder<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>LOGGING_HANDLER<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>MESSAGE_CODEC<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>RPC_HANDLER<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            channel <span style="color:#ff79c6">=</span> bootstrap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;localhost&#34;</span><span style="color:#ff79c6">,</span> 8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sync</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">closeFuture</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addListener</span><span style="color:#ff79c6">(</span>future <span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
                group<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shutdownGracefully</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">error</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;client error&#34;</span><span style="color:#ff79c6">,</span> e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="6客户端-handler-第二版">6）客户端 handler 第二版</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Slf4j
@ChannelHandler.Sharable
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RpcResponseMessageHandler</span> <span style="color:#8be9fd;font-style:italic">extends</span> SimpleChannelInboundHandler<span style="color:#ff79c6">&lt;</span>RpcResponseMessage<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>

    <span style="color:#6272a4">//                       序号      用来接收结果的 promise 对象
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> Map<span style="color:#ff79c6">&lt;</span>Integer<span style="color:#ff79c6">,</span> Promise<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">&gt;</span> PROMISES <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ConcurrentHashMap<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    @Override

    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead0</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> RpcResponseMessage msg<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
        log<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;{}&#34;</span><span style="color:#ff79c6">,</span> msg<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 拿到空的 promise
</span><span style="color:#6272a4"></span>        Promise<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> promise <span style="color:#ff79c6">=</span> PROMISES<span style="color:#ff79c6">.</span><span style="color:#50fa7b">remove</span><span style="color:#ff79c6">(</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSequenceId</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>promise <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            Object returnValue <span style="color:#ff79c6">=</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getReturnValue</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            Exception exceptionValue <span style="color:#ff79c6">=</span> msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getExceptionValue</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>exceptionValue <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFailure</span><span style="color:#ff79c6">(</span>exceptionValue<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
                promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setSuccess</span><span style="color:#ff79c6">(</span>returnValue<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h2 id="2-源码分析">2. 源码分析</h2>
<h3 id="21-启动剖析">2.1 启动剖析</h3>
<p>我们就来看看 netty 中对下面的代码是怎样进行处理的</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">//1 netty 中使用 NioEventLoopGroup （简称 nio boss 线程）来封装线程和 selector
</span><span style="color:#6272a4"></span>Selector selector <span style="color:#ff79c6">=</span> Selector<span style="color:#ff79c6">.</span><span style="color:#50fa7b">open</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> 

<span style="color:#6272a4">//2 创建 NioServerSocketChannel，同时会初始化它关联的 handler，以及为原生 ssc 存储 config
</span><span style="color:#6272a4"></span>NioServerSocketChannel attachment <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> NioServerSocketChannel<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

<span style="color:#6272a4">//3 创建 NioServerSocketChannel 时，创建了 java 原生的 ServerSocketChannel
</span><span style="color:#6272a4"></span>ServerSocketChannel serverSocketChannel <span style="color:#ff79c6">=</span> ServerSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">open</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span> 
serverSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">configureBlocking</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

<span style="color:#6272a4">//4 启动 nio boss 线程执行接下来的操作
</span><span style="color:#6272a4"></span>
<span style="color:#6272a4">//5 注册（仅关联 selector 和 NioServerSocketChannel），未关注事件
</span><span style="color:#6272a4"></span>SelectionKey selectionKey <span style="color:#ff79c6">=</span> serverSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">register</span><span style="color:#ff79c6">(</span>selector<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> attachment<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

<span style="color:#6272a4">//6 head -&gt; 初始化器 -&gt; ServerBootstrapAcceptor -&gt; tail，初始化器是一次性的，只为添加 acceptor
</span><span style="color:#6272a4"></span>
<span style="color:#6272a4">//7 绑定端口
</span><span style="color:#6272a4"></span>serverSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> InetSocketAddress<span style="color:#ff79c6">(</span>8080<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

<span style="color:#6272a4">//8 触发 channel active 事件，在 head 中关注 op_accept 事件
</span><span style="color:#6272a4"></span>selectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">interestOps</span><span style="color:#ff79c6">(</span>SelectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">OP_ACCEPT</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
</code></pre></div><p>入口 <code>io.netty.bootstrap.ServerBootstrap#bind</code></p>
<p>关键代码 <code>io.netty.bootstrap.AbstractBootstrap#doBind</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">private</span> ChannelFuture <span style="color:#50fa7b">doBind</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> SocketAddress localAddress<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
	<span style="color:#6272a4">// 1. 执行初始化和注册 regFuture 会由 initAndRegister 设置其是否完成，从而回调 3.2 处代码
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> ChannelFuture regFuture <span style="color:#ff79c6">=</span> initAndRegister<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">final</span> Channel channel <span style="color:#ff79c6">=</span> regFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>regFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">cause</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span> regFuture<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#6272a4">// 2. 因为是 initAndRegister 异步执行，需要分两种情况来看，调试时也需要通过 suspend 断点类型加以区分
</span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// 2.1 如果已经完成
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>regFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isDone</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        ChannelPromise promise <span style="color:#ff79c6">=</span> channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newPromise</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 3.1 立刻调用 doBind0
</span><span style="color:#6272a4"></span>        doBind0<span style="color:#ff79c6">(</span>regFuture<span style="color:#ff79c6">,</span> channel<span style="color:#ff79c6">,</span> localAddress<span style="color:#ff79c6">,</span> promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">return</span> promise<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> 
    <span style="color:#6272a4">// 2.2 还没有完成
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
        <span style="color:#8be9fd;font-style:italic">final</span> PendingRegistrationPromise promise <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> PendingRegistrationPromise<span style="color:#ff79c6">(</span>channel<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 3.2 回调 doBind0
</span><span style="color:#6272a4"></span>        regFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addListener</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelFutureListener<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            @Override
            <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">operationComplete</span><span style="color:#ff79c6">(</span>ChannelFuture future<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                Throwable cause <span style="color:#ff79c6">=</span> future<span style="color:#ff79c6">.</span><span style="color:#50fa7b">cause</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>cause <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    <span style="color:#6272a4">// 处理异常...
</span><span style="color:#6272a4"></span>                    promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFailure</span><span style="color:#ff79c6">(</span>cause<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
                    promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">registered</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
					<span style="color:#6272a4">// 3. 由注册线程去执行 doBind0
</span><span style="color:#6272a4"></span>                    doBind0<span style="color:#ff79c6">(</span>regFuture<span style="color:#ff79c6">,</span> channel<span style="color:#ff79c6">,</span> localAddress<span style="color:#ff79c6">,</span> promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">return</span> promise<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>关键代码 <code>io.netty.bootstrap.AbstractBootstrap#initAndRegister</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">final</span> ChannelFuture <span style="color:#50fa7b">initAndRegister</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    Channel channel <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        channel <span style="color:#ff79c6">=</span> channelFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newChannel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 1.1 初始化 - 做的事就是添加一个初始化器 ChannelInitializer
</span><span style="color:#6272a4"></span>        init<span style="color:#ff79c6">(</span>channel<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable t<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 处理异常...
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> DefaultChannelPromise<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> FailedChannel<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">,</span> GlobalEventExecutor<span style="color:#ff79c6">.</span><span style="color:#50fa7b">INSTANCE</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFailure</span><span style="color:#ff79c6">(</span>t<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#6272a4">// 1.2 注册 - 做的事就是将原生 channel 注册到 selector 上
</span><span style="color:#6272a4"></span>    ChannelFuture regFuture <span style="color:#ff79c6">=</span> config<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">group</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">register</span><span style="color:#ff79c6">(</span>channel<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>regFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">cause</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 处理异常...
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">return</span> regFuture<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>关键代码 <code>io.netty.bootstrap.ServerBootstrap#init</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">// 这里 channel 实际上是 NioServerSocketChannel
</span><span style="color:#6272a4"></span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">init</span><span style="color:#ff79c6">(</span>Channel channel<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">final</span> Map<span style="color:#ff79c6">&lt;</span>ChannelOption<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">&gt;</span> options <span style="color:#ff79c6">=</span> options0<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">synchronized</span> <span style="color:#ff79c6">(</span>options<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        setChannelOptions<span style="color:#ff79c6">(</span>channel<span style="color:#ff79c6">,</span> options<span style="color:#ff79c6">,</span> logger<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#8be9fd;font-style:italic">final</span> Map<span style="color:#ff79c6">&lt;</span>AttributeKey<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">&gt;</span> attrs <span style="color:#ff79c6">=</span> attrs0<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">synchronized</span> <span style="color:#ff79c6">(</span>attrs<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">&lt;</span>AttributeKey<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">&gt;</span> e<span style="color:#ff79c6">:</span> attrs<span style="color:#ff79c6">.</span><span style="color:#50fa7b">entrySet</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            @SuppressWarnings<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;unchecked&#34;</span><span style="color:#ff79c6">)</span>
            AttributeKey<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> key <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>AttributeKey<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">)</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getKey</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">attr</span><span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getValue</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>

    ChannelPipeline p <span style="color:#ff79c6">=</span> channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">final</span> EventLoopGroup currentChildGroup <span style="color:#ff79c6">=</span> childGroup<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">final</span> ChannelHandler currentChildHandler <span style="color:#ff79c6">=</span> childHandler<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">final</span> Entry<span style="color:#ff79c6">&lt;</span>ChannelOption<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> currentChildOptions<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">final</span> Entry<span style="color:#ff79c6">&lt;</span>AttributeKey<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">[</span><span style="color:#ff79c6">]</span> currentChildAttrs<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">synchronized</span> <span style="color:#ff79c6">(</span>childOptions<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        currentChildOptions <span style="color:#ff79c6">=</span> childOptions<span style="color:#ff79c6">.</span><span style="color:#50fa7b">entrySet</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">toArray</span><span style="color:#ff79c6">(</span>newOptionArray<span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
    <span style="color:#8be9fd;font-style:italic">synchronized</span> <span style="color:#ff79c6">(</span>childAttrs<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        currentChildAttrs <span style="color:#ff79c6">=</span> childAttrs<span style="color:#ff79c6">.</span><span style="color:#50fa7b">entrySet</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">toArray</span><span style="color:#ff79c6">(</span>newAttrArray<span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
	
    <span style="color:#6272a4">// 为 NioServerSocketChannel 添加初始化器
</span><span style="color:#6272a4"></span>    p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelInitializer<span style="color:#ff79c6">&lt;</span>Channel<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> Channel ch<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
            <span style="color:#8be9fd;font-style:italic">final</span> ChannelPipeline pipeline <span style="color:#ff79c6">=</span> ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ChannelHandler handler <span style="color:#ff79c6">=</span> config<span style="color:#ff79c6">.</span><span style="color:#50fa7b">handler</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>handler <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>handler<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>

            <span style="color:#6272a4">// 初始化器的职责是将 ServerBootstrapAcceptor 加入至 NioServerSocketChannel
</span><span style="color:#6272a4"></span>            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">eventLoop</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">execute</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Runnable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">run</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ServerBootstrapAcceptor<span style="color:#ff79c6">(</span>
                            ch<span style="color:#ff79c6">,</span> currentChildGroup<span style="color:#ff79c6">,</span> currentChildHandler<span style="color:#ff79c6">,</span> currentChildOptions<span style="color:#ff79c6">,</span> currentChildAttrs<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>关键代码 <code>io.netty.channel.AbstractChannel.AbstractUnsafe#register</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">register</span><span style="color:#ff79c6">(</span>EventLoop eventLoop<span style="color:#ff79c6">,</span> <span style="color:#8be9fd;font-style:italic">final</span> ChannelPromise promise<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">// 一些检查，略...
</span><span style="color:#6272a4"></span>
    AbstractChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">eventLoop</span> <span style="color:#ff79c6">=</span> eventLoop<span style="color:#ff79c6">;</span>

    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>eventLoop<span style="color:#ff79c6">.</span><span style="color:#50fa7b">inEventLoop</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        register0<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 首次执行 execute 方法时，会启动 nio 线程，之后注册等操作在 nio 线程上执行
</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// 因为只有一个 NioServerSocketChannel 因此，也只会有一个 boss nio 线程
</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// 这行代码完成的事实是 main -&gt; nio boss 线程的切换
</span><span style="color:#6272a4"></span>            eventLoop<span style="color:#ff79c6">.</span><span style="color:#50fa7b">execute</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Runnable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">run</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    register0<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable t<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 日志记录...
</span><span style="color:#6272a4"></span>            closeForcibly<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            closeFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setClosed</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            safeSetFailure<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">,</span> t<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p><code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">register0</span><span style="color:#ff79c6">(</span>ChannelPromise promise<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setUncancellable</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">|</span><span style="color:#ff79c6">|</span> <span style="color:#ff79c6">!</span>ensureOpen<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#8be9fd">boolean</span> firstRegistration <span style="color:#ff79c6">=</span> neverRegistered<span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 1.2.1 原生的 nio channel 绑定到 selector 上，注意此时没有注册 selector 关注事件，附件为 NioServerSocketChannel
</span><span style="color:#6272a4"></span>        doRegister<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        neverRegistered <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
        registered <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>

        <span style="color:#6272a4">// 1.2.2 执行 NioServerSocketChannel 初始化器的 initChannel
</span><span style="color:#6272a4"></span>        pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invokeHandlerAddedIfNeeded</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#6272a4">// 回调 3.2 io.netty.bootstrap.AbstractBootstrap#doBind0
</span><span style="color:#6272a4"></span>        safeSetSuccess<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireChannelRegistered</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        
        <span style="color:#6272a4">// 对应 server socket channel 还未绑定，isActive 为 false
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>isActive<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>firstRegistration<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireChannelActive</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>config<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">isAutoRead</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                beginRead<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable t<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// Close the channel directly to avoid FD leak.
</span><span style="color:#6272a4"></span>        closeForcibly<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        closeFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setClosed</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        safeSetFailure<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">,</span> t<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>关键代码 <code>io.netty.channel.ChannelInitializer#initChannel</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">initChannel</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>initMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>ctx<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span> <span style="color:#6272a4">// Guard against re-entrance.
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 1.2.2.1 执行初始化
</span><span style="color:#6272a4"></span>            initChannel<span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>C<span style="color:#ff79c6">)</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable cause<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            exceptionCaught<span style="color:#ff79c6">(</span>ctx<span style="color:#ff79c6">,</span> cause<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 1.2.2.2 移除初始化器
</span><span style="color:#6272a4"></span>            ChannelPipeline pipeline <span style="color:#ff79c6">=</span> ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">context</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">remove</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>关键代码 <code>io.netty.bootstrap.AbstractBootstrap#doBind0</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">// 3.1 或 3.2 执行 doBind0
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">doBind0</span><span style="color:#ff79c6">(</span>
        <span style="color:#8be9fd;font-style:italic">final</span> ChannelFuture regFuture<span style="color:#ff79c6">,</span> <span style="color:#8be9fd;font-style:italic">final</span> Channel channel<span style="color:#ff79c6">,</span>
        <span style="color:#8be9fd;font-style:italic">final</span> SocketAddress localAddress<span style="color:#ff79c6">,</span> <span style="color:#8be9fd;font-style:italic">final</span> ChannelPromise promise<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>

    channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">eventLoop</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">execute</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Runnable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">run</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>regFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isSuccess</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>localAddress<span style="color:#ff79c6">,</span> promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addListener</span><span style="color:#ff79c6">(</span>ChannelFutureListener<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLOSE_ON_FAILURE</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
                promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFailure</span><span style="color:#ff79c6">(</span>regFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">cause</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>关键代码 <code>io.netty.channel.AbstractChannel.AbstractUnsafe#bind</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> SocketAddress localAddress<span style="color:#ff79c6">,</span> <span style="color:#8be9fd;font-style:italic">final</span> ChannelPromise promise<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    assertEventLoop<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setUncancellable</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">|</span><span style="color:#ff79c6">|</span> <span style="color:#ff79c6">!</span>ensureOpen<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>Boolean<span style="color:#ff79c6">.</span><span style="color:#50fa7b">TRUE</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>config<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getOption</span><span style="color:#ff79c6">(</span>ChannelOption<span style="color:#ff79c6">.</span><span style="color:#50fa7b">SO_BROADCAST</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span>
        localAddress <span style="color:#ff79c6">instanceof</span> InetSocketAddress <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span>
        <span style="color:#ff79c6">!</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>InetSocketAddress<span style="color:#ff79c6">)</span> localAddress<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getAddress</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">isAnyLocalAddress</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span>
        <span style="color:#ff79c6">!</span>PlatformDependent<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isWindows</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span> <span style="color:#ff79c6">!</span>PlatformDependent<span style="color:#ff79c6">.</span><span style="color:#50fa7b">maybeSuperUser</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 记录日志...
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>

    <span style="color:#8be9fd">boolean</span> wasActive <span style="color:#ff79c6">=</span> isActive<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 3.3 执行端口绑定
</span><span style="color:#6272a4"></span>        doBind<span style="color:#ff79c6">(</span>localAddress<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable t<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        safeSetFailure<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">,</span> t<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        closeIfClosed<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>wasActive <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span> isActive<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        invokeLater<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Runnable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            @Override
            <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">run</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#6272a4">// 3.4 触发 active 事件
</span><span style="color:#6272a4"></span>                pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireChannelActive</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    safeSetSuccess<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>3.3 关键代码 <code>io.netty.channel.socket.nio.NioServerSocketChannel#doBind</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">doBind</span><span style="color:#ff79c6">(</span>SocketAddress localAddress<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>PlatformDependent<span style="color:#ff79c6">.</span><span style="color:#50fa7b">javaVersion</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">=</span> 7<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        javaChannel<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>localAddress<span style="color:#ff79c6">,</span> config<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBacklog</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
        javaChannel<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">socket</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>localAddress<span style="color:#ff79c6">,</span> config<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBacklog</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>3.4 关键代码 <code>io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelActive</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireChannelActive</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
	<span style="color:#6272a4">// 触发 read (NioServerSocketChannel 上的 read 不是读取数据，只是为了触发 channel 的事件注册)
</span><span style="color:#6272a4"></span>    readIfIsAutoRead<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>关键代码 <code>io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">doBeginRead</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">// Channel.read() or ChannelHandlerContext.read() was called
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> SelectionKey selectionKey <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">selectionKey</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>selectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isValid</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    readPending <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> interestOps <span style="color:#ff79c6">=</span> selectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">interestOps</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#6272a4">// readInterestOp 取值是 16，在 NioServerSocketChannel 创建时初始化好，代表关注 accept 事件
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>interestOps <span style="color:#ff79c6">&amp;</span> readInterestOp<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        selectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">interestOps</span><span style="color:#ff79c6">(</span>interestOps <span style="color:#ff79c6">|</span> readInterestOp<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="22-nioeventloop-剖析">2.2 NioEventLoop 剖析</h3>
<p>NioEventLoop 线程不仅要处理 IO 事件，还要处理 Task（包括普通任务和定时任务），</p>
<p>提交任务代码 <code>io.netty.util.concurrent.SingleThreadEventExecutor#execute</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">execute</span><span style="color:#ff79c6">(</span>Runnable task<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>task <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> NullPointerException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;task&#34;</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#8be9fd">boolean</span> inEventLoop <span style="color:#ff79c6">=</span> inEventLoop<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#6272a4">// 添加任务，其中队列使用了 jctools 提供的 mpsc 无锁队列
</span><span style="color:#6272a4"></span>    addTask<span style="color:#ff79c6">(</span>task<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>inEventLoop<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// inEventLoop 如果为 false 表示由其它线程来调用 execute，即首次调用，这时需要向 eventLoop 提交首个任务，启动死循环，会执行到下面的 doStartThread
</span><span style="color:#6272a4"></span>        startThread<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>isShutdown<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 如果已经 shutdown，做拒绝逻辑，代码略...
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>addTaskWakesUp <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span> wakesUpForTask<span style="color:#ff79c6">(</span>task<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 如果线程由于 IO select 阻塞了，添加的任务的线程需要负责唤醒 NioEventLoop 线程
</span><span style="color:#6272a4"></span>        wakeup<span style="color:#ff79c6">(</span>inEventLoop<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>唤醒 select 阻塞线程<code>io.netty.channel.nio.NioEventLoop#wakeup</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Override
<span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">wakeup</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">boolean</span> inEventLoop<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>inEventLoop <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span> wakenUp<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSet</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        selector<span style="color:#ff79c6">.</span><span style="color:#50fa7b">wakeup</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>启动 EventLoop 主循环 <code>io.netty.util.concurrent.SingleThreadEventExecutor#doStartThread</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">doStartThread</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">assert</span> thread <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
    executor<span style="color:#ff79c6">.</span><span style="color:#50fa7b">execute</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Runnable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        @Override
        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">run</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 将线程池的当前线程保存在成员变量中，以便后续使用
</span><span style="color:#6272a4"></span>            thread <span style="color:#ff79c6">=</span> Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentThread</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>interrupted<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">interrupt</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>

            <span style="color:#8be9fd">boolean</span> success <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
            updateLastExecutionTime<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                <span style="color:#6272a4">// 调用外部类 SingleThreadEventExecutor 的 run 方法，进入死循环，run 方法见下
</span><span style="color:#6272a4"></span>                SingleThreadEventExecutor<span style="color:#ff79c6">.</span><span style="color:#50fa7b">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">run</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                success <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable t<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                logger<span style="color:#ff79c6">.</span><span style="color:#50fa7b">warn</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Unexpected exception from an event executor: &#34;</span><span style="color:#ff79c6">,</span> t<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
				<span style="color:#6272a4">// 清理工作，代码略...
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p><code>io.netty.channel.nio.NioEventLoop#run</code> 主要任务是执行死循环，不断看有没有新任务，有没有 IO 事件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">run</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">;</span><span style="color:#ff79c6">;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                <span style="color:#6272a4">// calculateStrategy 的逻辑如下：
</span><span style="color:#6272a4"></span>                <span style="color:#6272a4">// 有任务，会执行一次 selectNow，清除上一次的 wakeup 结果，无论有没有 IO 事件，都会跳过 switch
</span><span style="color:#6272a4"></span>                <span style="color:#6272a4">// 没有任务，会匹配 SelectStrategy.SELECT，看是否应当阻塞
</span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">switch</span> <span style="color:#ff79c6">(</span>selectStrategy<span style="color:#ff79c6">.</span><span style="color:#50fa7b">calculateStrategy</span><span style="color:#ff79c6">(</span>selectNowSupplier<span style="color:#ff79c6">,</span> hasTasks<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    <span style="color:#ff79c6">case</span> SelectStrategy<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CONTINUE</span><span style="color:#ff79c6">:</span>
                        <span style="color:#ff79c6">continue</span><span style="color:#ff79c6">;</span>

                    <span style="color:#ff79c6">case</span> SelectStrategy<span style="color:#ff79c6">.</span><span style="color:#50fa7b">BUSY_WAIT</span><span style="color:#ff79c6">:</span>

                    <span style="color:#ff79c6">case</span> SelectStrategy<span style="color:#ff79c6">.</span><span style="color:#50fa7b">SELECT</span><span style="color:#ff79c6">:</span>
                        <span style="color:#6272a4">// 因为 IO 线程和提交任务线程都有可能执行 wakeup，而 wakeup 属于比较昂贵的操作，因此使用了一个原子布尔对象 wakenUp，它取值为 true 时，表示该由当前线程唤醒
</span><span style="color:#6272a4"></span>                        <span style="color:#6272a4">// 进行 select 阻塞，并设置唤醒状态为 false
</span><span style="color:#6272a4"></span>                        <span style="color:#8be9fd">boolean</span> oldWakenUp <span style="color:#ff79c6">=</span> wakenUp<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getAndSet</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                        
                        <span style="color:#6272a4">// 如果在这个位置，非 EventLoop 线程抢先将 wakenUp 置为 true，并 wakeup
</span><span style="color:#6272a4"></span>                        <span style="color:#6272a4">// 下面的 select 方法不会阻塞
</span><span style="color:#6272a4"></span>                        <span style="color:#6272a4">// 等 runAllTasks 处理完成后，到再循环进来这个阶段新增的任务会不会及时执行呢?
</span><span style="color:#6272a4"></span>                        <span style="color:#6272a4">// 因为 oldWakenUp 为 true，因此下面的 select 方法就会阻塞，直到超时
</span><span style="color:#6272a4"></span>                        <span style="color:#6272a4">// 才能执行，让 select 方法无谓阻塞
</span><span style="color:#6272a4"></span>                        select<span style="color:#ff79c6">(</span>oldWakenUp<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

                        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>wakenUp<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                            selector<span style="color:#ff79c6">.</span><span style="color:#50fa7b">wakeup</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                        <span style="color:#ff79c6">}</span>
                    <span style="color:#ff79c6">default</span><span style="color:#ff79c6">:</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                rebuildSelector0<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                handleLoopException<span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">continue</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>

            cancelledKeys <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
            needsToSelectAgain <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
            <span style="color:#6272a4">// ioRatio 默认是 50
</span><span style="color:#6272a4"></span>            <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> ioRatio <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">ioRatio</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>ioRatio <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> 100<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                    processSelectedKeys<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
                    <span style="color:#6272a4">// ioRatio 为 100 时，总是运行完所有非 IO 任务
</span><span style="color:#6272a4"></span>                    runAllTasks<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>                
                <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> ioStartTime <span style="color:#ff79c6">=</span> System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nanoTime</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                    processSelectedKeys<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
                    <span style="color:#6272a4">// 记录 io 事件处理耗时
</span><span style="color:#6272a4"></span>                    <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> ioTime <span style="color:#ff79c6">=</span> System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nanoTime</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">-</span> ioStartTime<span style="color:#ff79c6">;</span>
                    <span style="color:#6272a4">// 运行非 IO 任务，一旦超时会退出 runAllTasks
</span><span style="color:#6272a4"></span>                    runAllTasks<span style="color:#ff79c6">(</span>ioTime <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">(</span>100 <span style="color:#ff79c6">-</span> ioRatio<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">/</span> ioRatio<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable t<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            handleLoopException<span style="color:#ff79c6">(</span>t<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>isShuttingDown<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                closeAll<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>confirmShutdown<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable t<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            handleLoopException<span style="color:#ff79c6">(</span>t<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="-注意">⚠️ 注意</h4>
<blockquote>
<p>这里有个费解的地方就是 wakeup，它既可以由提交任务的线程来调用（比较好理解），也可以由 EventLoop 线程来调用（比较费解），这里要知道 wakeup 方法的效果：</p>
<ul>
<li>由非 EventLoop 线程调用，会唤醒当前在执行 select 阻塞的 EventLoop 线程</li>
<li>由 EventLoop 自己调用，会本次的 wakeup 会取消下一次的 select 操作</li>
</ul>
</blockquote>
<p>参考下图</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h38658xadwj310e0jbk62.jpg" alt="0032.png">

</p>
<p><code>io.netty.channel.nio.NioEventLoop#select</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">select</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">boolean</span> oldWakenUp<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
    Selector selector <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">selector</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        <span style="color:#8be9fd">int</span> selectCnt <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
        <span style="color:#8be9fd">long</span> currentTimeNanos <span style="color:#ff79c6">=</span> System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nanoTime</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 计算等待时间
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// * 没有 scheduledTask，超时时间为 1s
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// * 有 scheduledTask，超时时间为 `下一个定时任务执行时间 - 当前时间`
</span><span style="color:#6272a4"></span>        <span style="color:#8be9fd">long</span> selectDeadLineNanos <span style="color:#ff79c6">=</span> currentTimeNanos <span style="color:#ff79c6">+</span> delayNanos<span style="color:#ff79c6">(</span>currentTimeNanos<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">;</span><span style="color:#ff79c6">;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#8be9fd">long</span> timeoutMillis <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>selectDeadLineNanos <span style="color:#ff79c6">-</span> currentTimeNanos <span style="color:#ff79c6">+</span> 500000L<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">/</span> 1000000L<span style="color:#ff79c6">;</span>
            <span style="color:#6272a4">// 如果超时，退出循环
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>timeoutMillis <span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>selectCnt <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    selector<span style="color:#ff79c6">.</span><span style="color:#50fa7b">selectNow</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                    selectCnt <span style="color:#ff79c6">=</span> 1<span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>

            <span style="color:#6272a4">// 如果期间又有 task 退出循环，如果没这个判断，那么任务就会等到下次 select 超时时才能被执行
</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// wakenUp.compareAndSet(false, true) 是让非 NioEventLoop 不必再执行 wakeup
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>hasTasks<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span> wakenUp<span style="color:#ff79c6">.</span><span style="color:#50fa7b">compareAndSet</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                selector<span style="color:#ff79c6">.</span><span style="color:#50fa7b">selectNow</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                selectCnt <span style="color:#ff79c6">=</span> 1<span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>

            <span style="color:#6272a4">// select 有限时阻塞
</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// 注意 nio 有 bug，当 bug 出现时，select 方法即使没有时间发生，也不会阻塞住，导致不断空轮询，cpu 占用 100%
</span><span style="color:#6272a4"></span>            <span style="color:#8be9fd">int</span> selectedKeys <span style="color:#ff79c6">=</span> selector<span style="color:#ff79c6">.</span><span style="color:#50fa7b">select</span><span style="color:#ff79c6">(</span>timeoutMillis<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#6272a4">// 计数加 1
</span><span style="color:#6272a4"></span>            selectCnt <span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">;</span>

            <span style="color:#6272a4">// 醒来后，如果有 IO 事件、或是由非 EventLoop 线程唤醒，或者有任务，退出循环
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>selectedKeys <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> 0 <span style="color:#ff79c6">|</span><span style="color:#ff79c6">|</span> oldWakenUp <span style="color:#ff79c6">|</span><span style="color:#ff79c6">|</span> wakenUp<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">|</span><span style="color:#ff79c6">|</span> hasTasks<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">|</span><span style="color:#ff79c6">|</span> hasScheduledTasks<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">interrupted</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
               	<span style="color:#6272a4">// 线程被打断，退出循环
</span><span style="color:#6272a4"></span>                <span style="color:#6272a4">// 记录日志
</span><span style="color:#6272a4"></span>                selectCnt <span style="color:#ff79c6">=</span> 1<span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>

            <span style="color:#8be9fd">long</span> time <span style="color:#ff79c6">=</span> System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nanoTime</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>time <span style="color:#ff79c6">-</span> TimeUnit<span style="color:#ff79c6">.</span><span style="color:#50fa7b">MILLISECONDS</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">toNanos</span><span style="color:#ff79c6">(</span>timeoutMillis<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">=</span> currentTimeNanos<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#6272a4">// 如果超时，计数重置为 1，下次循环就会 break
</span><span style="color:#6272a4"></span>                selectCnt <span style="color:#ff79c6">=</span> 1<span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span> 
            <span style="color:#6272a4">// 计数超过阈值，由 io.netty.selectorAutoRebuildThreshold 指定，默认 512
</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// 这是为了解决 nio 空轮询 bug
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>SELECTOR_AUTO_REBUILD_THRESHOLD <span style="color:#ff79c6">&gt;</span> 0 <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span>
                    selectCnt <span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">=</span> SELECTOR_AUTO_REBUILD_THRESHOLD<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#6272a4">// 重建 selector
</span><span style="color:#6272a4"></span>                selector <span style="color:#ff79c6">=</span> selectRebuildSelector<span style="color:#ff79c6">(</span>selectCnt<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                selectCnt <span style="color:#ff79c6">=</span> 1<span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>

            currentTimeNanos <span style="color:#ff79c6">=</span> time<span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>

        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>selectCnt <span style="color:#ff79c6">&gt;</span> MIN_PREMATURE_SELECTOR_RETURNS<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 记录日志
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>CancelledKeyException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 记录日志
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>处理 keys <code>io.netty.channel.nio.NioEventLoop#processSelectedKeys</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">processSelectedKeys</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>selectedKeys <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 通过反射将 Selector 实现类中的就绪事件集合替换为 SelectedSelectionKeySet 
</span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// SelectedSelectionKeySet 底层为数组实现，可以提高遍历性能（原本为 HashSet）
</span><span style="color:#6272a4"></span>        processSelectedKeysOptimized<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
        processSelectedKeysPlain<span style="color:#ff79c6">(</span>selector<span style="color:#ff79c6">.</span><span style="color:#50fa7b">selectedKeys</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p><code>io.netty.channel.nio.NioEventLoop#processSelectedKey</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">processSelectedKey</span><span style="color:#ff79c6">(</span>SelectionKey k<span style="color:#ff79c6">,</span> AbstractNioChannel ch<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">final</span> AbstractNioChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">NioUnsafe</span> unsafe <span style="color:#ff79c6">=</span> ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">unsafe</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#6272a4">// 当 key 取消或关闭时会导致这个 key 无效
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>k<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isValid</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 无效时处理...
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        <span style="color:#8be9fd">int</span> readyOps <span style="color:#ff79c6">=</span> k<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readyOps</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 连接事件
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>readyOps <span style="color:#ff79c6">&amp;</span> SelectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">OP_CONNECT</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#8be9fd">int</span> ops <span style="color:#ff79c6">=</span> k<span style="color:#ff79c6">.</span><span style="color:#50fa7b">interestOps</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            ops <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">~</span>SelectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">OP_CONNECT</span><span style="color:#ff79c6">;</span>
            k<span style="color:#ff79c6">.</span><span style="color:#50fa7b">interestOps</span><span style="color:#ff79c6">(</span>ops<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

            unsafe<span style="color:#ff79c6">.</span><span style="color:#50fa7b">finishConnect</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>

        <span style="color:#6272a4">// 可写事件
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>readyOps <span style="color:#ff79c6">&amp;</span> SelectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">OP_WRITE</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            ch<span style="color:#ff79c6">.</span><span style="color:#50fa7b">unsafe</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">forceFlush</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>

        <span style="color:#6272a4">// 可读或可接入事件
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>readyOps <span style="color:#ff79c6">&amp;</span> <span style="color:#ff79c6">(</span>SelectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">OP_READ</span> <span style="color:#ff79c6">|</span> SelectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">OP_ACCEPT</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> 0 <span style="color:#ff79c6">|</span><span style="color:#ff79c6">|</span> readyOps <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 如果是可接入 io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read
</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// 如果是可读 io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read
</span><span style="color:#6272a4"></span>            unsafe<span style="color:#ff79c6">.</span><span style="color:#50fa7b">read</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>CancelledKeyException ignored<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        unsafe<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">(</span>unsafe<span style="color:#ff79c6">.</span><span style="color:#50fa7b">voidPromise</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="23-accept-剖析">2.3 accept 剖析</h3>
<p>nio 中如下代码，在 netty 中的流程</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#6272a4">//1 阻塞直到事件发生
</span><span style="color:#6272a4"></span>selector<span style="color:#ff79c6">.</span><span style="color:#50fa7b">select</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

Iterator<span style="color:#ff79c6">&lt;</span>SelectionKey<span style="color:#ff79c6">&gt;</span> iter <span style="color:#ff79c6">=</span> selector<span style="color:#ff79c6">.</span><span style="color:#50fa7b">selectedKeys</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">iterator</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>iter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hasNext</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>    
    <span style="color:#6272a4">//2 拿到一个事件
</span><span style="color:#6272a4"></span>    SelectionKey key <span style="color:#ff79c6">=</span> iter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    
    <span style="color:#6272a4">//3 如果是 accept 事件
</span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isAcceptable</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        
        <span style="color:#6272a4">//4 执行 accept
</span><span style="color:#6272a4"></span>        SocketChannel channel <span style="color:#ff79c6">=</span> serverSocketChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">accept</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">configureBlocking</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        
        <span style="color:#6272a4">//5 关注 read 事件
</span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">register</span><span style="color:#ff79c6">(</span>selector<span style="color:#ff79c6">,</span> SelectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">OP_READ</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
    <span style="color:#6272a4">// ...
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">}</span>
</code></pre></div><p>先来看可接入事件处理（accept）</p>
<p><code>io.netty.channel.nio.AbstractNioMessageChannel.NioMessageUnsafe#read</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">read</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">assert</span> eventLoop<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">inEventLoop</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">final</span> ChannelConfig config <span style="color:#ff79c6">=</span> config<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">final</span> ChannelPipeline pipeline <span style="color:#ff79c6">=</span> pipeline<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>    
    <span style="color:#8be9fd;font-style:italic">final</span> RecvByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Handle</span> allocHandle <span style="color:#ff79c6">=</span> unsafe<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">recvBufAllocHandle</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    allocHandle<span style="color:#ff79c6">.</span><span style="color:#50fa7b">reset</span><span style="color:#ff79c6">(</span>config<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd">boolean</span> closed <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
    Throwable exception <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">do</span> <span style="color:#ff79c6">{</span>
				<span style="color:#6272a4">// doReadMessages 中执行了 accept 并创建 NioSocketChannel 作为消息放入 readBuf
</span><span style="color:#6272a4"></span>                <span style="color:#6272a4">// readBuf 是一个 ArrayList 用来缓存消息
</span><span style="color:#6272a4"></span>                <span style="color:#8be9fd">int</span> localRead <span style="color:#ff79c6">=</span> doReadMessages<span style="color:#ff79c6">(</span>readBuf<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>localRead <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>localRead <span style="color:#ff79c6">&lt;</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    closed <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
                    <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
				<span style="color:#6272a4">// localRead 为 1，就一条消息，即接收一个客户端连接
</span><span style="color:#6272a4"></span>                allocHandle<span style="color:#ff79c6">.</span><span style="color:#50fa7b">incMessagesRead</span><span style="color:#ff79c6">(</span>localRead<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>allocHandle<span style="color:#ff79c6">.</span><span style="color:#50fa7b">continueReading</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable t<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            exception <span style="color:#ff79c6">=</span> t<span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>

        <span style="color:#8be9fd">int</span> size <span style="color:#ff79c6">=</span> readBuf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">size</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> size<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">+</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            readPending <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
            <span style="color:#6272a4">// 触发 read 事件，让 pipeline 上的 handler 处理，这时是处理
</span><span style="color:#6272a4"></span>            <span style="color:#6272a4">// io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead
</span><span style="color:#6272a4"></span>            pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireChannelRead</span><span style="color:#ff79c6">(</span>readBuf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        readBuf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">clear</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        allocHandle<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readComplete</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireChannelReadComplete</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>exception <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            closed <span style="color:#ff79c6">=</span> closeOnReadError<span style="color:#ff79c6">(</span>exception<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

            pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireExceptionCaught</span><span style="color:#ff79c6">(</span>exception<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>

        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>closed<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            inputShutdown <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>isOpen<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                close<span style="color:#ff79c6">(</span>voidPromise<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>readPending <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span> <span style="color:#ff79c6">!</span>config<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isAutoRead</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            removeReadOp<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>关键代码 <code>io.netty.bootstrap.ServerBootstrap.ServerBootstrapAcceptor#channelRead</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelRead</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">,</span> Object msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">// 这时的 msg 是 NioSocketChannel
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> Channel child <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Channel<span style="color:#ff79c6">)</span> msg<span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">// NioSocketChannel 添加  childHandler 即初始化器
</span><span style="color:#6272a4"></span>    child<span style="color:#ff79c6">.</span><span style="color:#50fa7b">pipeline</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addLast</span><span style="color:#ff79c6">(</span>childHandler<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">// 设置选项
</span><span style="color:#6272a4"></span>    setChannelOptions<span style="color:#ff79c6">(</span>child<span style="color:#ff79c6">,</span> childOptions<span style="color:#ff79c6">,</span> logger<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">&lt;</span>AttributeKey<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">?</span><span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">&gt;</span> e<span style="color:#ff79c6">:</span> childAttrs<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        child<span style="color:#ff79c6">.</span><span style="color:#50fa7b">attr</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>AttributeKey<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span><span style="color:#ff79c6">)</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getKey</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getValue</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 注册 NioSocketChannel 到 nio worker 线程，接下来的处理也移交至 nio worker 线程
</span><span style="color:#6272a4"></span>        childGroup<span style="color:#ff79c6">.</span><span style="color:#50fa7b">register</span><span style="color:#ff79c6">(</span>child<span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">addListener</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ChannelFutureListener<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            @Override
            <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">operationComplete</span><span style="color:#ff79c6">(</span>ChannelFuture future<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>future<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isSuccess</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    forceClose<span style="color:#ff79c6">(</span>child<span style="color:#ff79c6">,</span> future<span style="color:#ff79c6">.</span><span style="color:#50fa7b">cause</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable t<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        forceClose<span style="color:#ff79c6">(</span>child<span style="color:#ff79c6">,</span> t<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>又回到了熟悉的 <code>io.netty.channel.AbstractChannel.AbstractUnsafe#register</code>  方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">register</span><span style="color:#ff79c6">(</span>EventLoop eventLoop<span style="color:#ff79c6">,</span> <span style="color:#8be9fd;font-style:italic">final</span> ChannelPromise promise<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">// 一些检查，略...
</span><span style="color:#6272a4"></span>
    AbstractChannel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">eventLoop</span> <span style="color:#ff79c6">=</span> eventLoop<span style="color:#ff79c6">;</span>

    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>eventLoop<span style="color:#ff79c6">.</span><span style="color:#50fa7b">inEventLoop</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        register0<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 这行代码完成的事实是 nio boss -&gt; nio worker 线程的切换
</span><span style="color:#6272a4"></span>            eventLoop<span style="color:#ff79c6">.</span><span style="color:#50fa7b">execute</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Runnable<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                @Override
                <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">run</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    register0<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable t<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// 日志记录...
</span><span style="color:#6272a4"></span>            closeForcibly<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            closeFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setClosed</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            safeSetFailure<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">,</span> t<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p><code>io.netty.channel.AbstractChannel.AbstractUnsafe#register0</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">register0</span><span style="color:#ff79c6">(</span>ChannelPromise promise<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>promise<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setUncancellable</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">|</span><span style="color:#ff79c6">|</span> <span style="color:#ff79c6">!</span>ensureOpen<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#8be9fd">boolean</span> firstRegistration <span style="color:#ff79c6">=</span> neverRegistered<span style="color:#ff79c6">;</span>
        doRegister<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        neverRegistered <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
        registered <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
		
        <span style="color:#6272a4">// 执行初始化器，执行前 pipeline 中只有 head -&gt; 初始化器 -&gt; tail
</span><span style="color:#6272a4"></span>        pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invokeHandlerAddedIfNeeded</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 执行后就是 head -&gt; logging handler -&gt; my handler -&gt; tail
</span><span style="color:#6272a4"></span>
        safeSetSuccess<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireChannelRegistered</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>isActive<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>firstRegistration<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                <span style="color:#6272a4">// 触发 pipeline 上 active 事件
</span><span style="color:#6272a4"></span>                pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireChannelActive</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>config<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">isAutoRead</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                beginRead<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable t<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        closeForcibly<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        closeFuture<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setClosed</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        safeSetFailure<span style="color:#ff79c6">(</span>promise<span style="color:#ff79c6">,</span> t<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p>回到了熟悉的代码 <code>io.netty.channel.DefaultChannelPipeline.HeadContext#channelActive</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">channelActive</span><span style="color:#ff79c6">(</span>ChannelHandlerContext ctx<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    ctx<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireChannelActive</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
	<span style="color:#6272a4">// 触发 read (NioSocketChannel 这里 read，只是为了触发 channel 的事件注册，还未涉及数据读取)
</span><span style="color:#6272a4"></span>    readIfIsAutoRead<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p><code>io.netty.channel.nio.AbstractNioChannel#doBeginRead</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">doBeginRead</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">// Channel.read() or ChannelHandlerContext.read() was called
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> SelectionKey selectionKey <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">selectionKey</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>selectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isValid</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>

    readPending <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
	<span style="color:#6272a4">// 这时候 interestOps 是 0
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> interestOps <span style="color:#ff79c6">=</span> selectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">interestOps</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">(</span>interestOps <span style="color:#ff79c6">&amp;</span> readInterestOp<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=</span><span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// 关注 read 事件
</span><span style="color:#6272a4"></span>        selectionKey<span style="color:#ff79c6">.</span><span style="color:#50fa7b">interestOps</span><span style="color:#ff79c6">(</span>interestOps <span style="color:#ff79c6">|</span> readInterestOp<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="24-read-剖析">2.4 read 剖析</h3>
<p>再来看可读事件 <code>io.netty.channel.nio.AbstractNioByteChannel.NioByteUnsafe#read</code>，注意发送的数据未必能够一次读完，因此会触发多次 nio read 事件，一次事件内会触发多次 pipeline read，一次事件会触发一次 pipeline read complete</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">read</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#8be9fd;font-style:italic">final</span> ChannelConfig config <span style="color:#ff79c6">=</span> config<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>shouldBreakReadReady<span style="color:#ff79c6">(</span>config<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        clearReadPending<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
    <span style="color:#8be9fd;font-style:italic">final</span> ChannelPipeline pipeline <span style="color:#ff79c6">=</span> pipeline<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#6272a4">// io.netty.allocator.type 决定 allocator 的实现
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> ByteBufAllocator allocator <span style="color:#ff79c6">=</span> config<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getAllocator</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#6272a4">// 用来分配 byteBuf，确定单次读取大小
</span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">final</span> RecvByteBufAllocator<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Handle</span> allocHandle <span style="color:#ff79c6">=</span> recvBufAllocHandle<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    allocHandle<span style="color:#ff79c6">.</span><span style="color:#50fa7b">reset</span><span style="color:#ff79c6">(</span>config<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

    ByteBuf byteBuf <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd">boolean</span> close <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">do</span> <span style="color:#ff79c6">{</span>
            byteBuf <span style="color:#ff79c6">=</span> allocHandle<span style="color:#ff79c6">.</span><span style="color:#50fa7b">allocate</span><span style="color:#ff79c6">(</span>allocator<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#6272a4">// 读取
</span><span style="color:#6272a4"></span>            allocHandle<span style="color:#ff79c6">.</span><span style="color:#50fa7b">lastBytesRead</span><span style="color:#ff79c6">(</span>doReadBytes<span style="color:#ff79c6">(</span>byteBuf<span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>allocHandle<span style="color:#ff79c6">.</span><span style="color:#50fa7b">lastBytesRead</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                byteBuf<span style="color:#ff79c6">.</span><span style="color:#50fa7b">release</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
                byteBuf <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
                close <span style="color:#ff79c6">=</span> allocHandle<span style="color:#ff79c6">.</span><span style="color:#50fa7b">lastBytesRead</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;</span> 0<span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>close<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                    readPending <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
                <span style="color:#ff79c6">}</span>
                <span style="color:#ff79c6">break</span><span style="color:#ff79c6">;</span>
            <span style="color:#ff79c6">}</span>

            allocHandle<span style="color:#ff79c6">.</span><span style="color:#50fa7b">incMessagesRead</span><span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            readPending <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
            <span style="color:#6272a4">// 触发 read 事件，让 pipeline 上的 handler 处理，这时是处理 NioSocketChannel 上的 handler
</span><span style="color:#6272a4"></span>            pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireChannelRead</span><span style="color:#ff79c6">(</span>byteBuf<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
            byteBuf <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span> 
        <span style="color:#6272a4">// 是否要继续循环
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>allocHandle<span style="color:#ff79c6">.</span><span style="color:#50fa7b">continueReading</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        allocHandle<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readComplete</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#6272a4">// 触发 read complete 事件
</span><span style="color:#6272a4"></span>        pipeline<span style="color:#ff79c6">.</span><span style="color:#50fa7b">fireChannelReadComplete</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>

        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>close<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            closeOnRead<span style="color:#ff79c6">(</span>pipeline<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable t<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        handleReadException<span style="color:#ff79c6">(</span>pipeline<span style="color:#ff79c6">,</span> byteBuf<span style="color:#ff79c6">,</span> t<span style="color:#ff79c6">,</span> close<span style="color:#ff79c6">,</span> allocHandle<span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>readPending <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span> <span style="color:#ff79c6">!</span>config<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isAutoRead</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            removeReadOp<span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><p><code>io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator.MaxMessageHandle#continueReading(io.netty.util.UncheckedBooleanSupplier)</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">boolean</span> <span style="color:#50fa7b">continueReading</span><span style="color:#ff79c6">(</span>UncheckedBooleanSupplier maybeMoreDataSupplier<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
    <span style="color:#ff79c6">return</span> 
           <span style="color:#6272a4">// 一般为 true
</span><span style="color:#6272a4"></span>           config<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isAutoRead</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span>
           <span style="color:#6272a4">// respectMaybeMoreData 默认为 true
</span><span style="color:#6272a4"></span>           <span style="color:#6272a4">// maybeMoreDataSupplier 的逻辑是如果预期读取字节与实际读取字节相等，返回 true
</span><span style="color:#6272a4"></span>           <span style="color:#ff79c6">(</span><span style="color:#ff79c6">!</span>respectMaybeMoreData <span style="color:#ff79c6">|</span><span style="color:#ff79c6">|</span> maybeMoreDataSupplier<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span>
           <span style="color:#6272a4">// 小于最大次数，maxMessagePerRead 默认 16
</span><span style="color:#6272a4"></span>           totalMessages <span style="color:#ff79c6">&lt;</span> maxMessagePerRead <span style="color:#ff79c6">&amp;</span><span style="color:#ff79c6">&amp;</span>
           <span style="color:#6272a4">// 实际读到了数据
</span><span style="color:#6272a4"></span>           totalBytesRead <span style="color:#ff79c6">&gt;</span> 0<span style="color:#ff79c6">;</span>
<span style="color:#ff79c6">}</span>
</code></pre></div>

                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/1037netty%E8%BF%9B%E9%98%B6/" data-toggle="tooltip" data-placement="top" title="3、Netty进阶（Netty）">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/1039elasticsearch/" data-toggle="tooltip" data-placement="top" title="1、ElasticSearch（ElasticSearch）">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">标签</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/activemq" title="activemq">
                            activemq
                        </a>
                        
                        
                        
                        <a href="/tags/ajax" title="ajax">
                            ajax
                        </a>
                        
                        
                        
                        <a href="/tags/cookie" title="cookie">
                            cookie
                        </a>
                        
                        
                        
                        <a href="/tags/datax" title="datax">
                            datax
                        </a>
                        
                        
                        
                        <a href="/tags/docker" title="docker">
                            docker
                        </a>
                        
                        
                        
                        <a href="/tags/dubbo" title="dubbo">
                            dubbo
                        </a>
                        
                        
                        
                        <a href="/tags/elasticsearch" title="elasticsearch">
                            elasticsearch
                        </a>
                        
                        
                        
                        <a href="/tags/filter" title="filter">
                            filter
                        </a>
                        
                        
                        
                        <a href="/tags/hadoop" title="hadoop">
                            hadoop
                        </a>
                        
                        
                        
                        <a href="/tags/hbase" title="hbase">
                            hbase
                        </a>
                        
                        
                        
                        <a href="/tags/hive" title="hive">
                            hive
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/java" title="java">
                            java
                        </a>
                        
                        
                        
                        <a href="/tags/javascript" title="javascript">
                            javascript
                        </a>
                        
                        
                        
                        <a href="/tags/javaweb" title="javaweb">
                            javaweb
                        </a>
                        
                        
                        
                        <a href="/tags/jdbc" title="jdbc">
                            jdbc
                        </a>
                        
                        
                        
                        <a href="/tags/jquery" title="jquery">
                            jquery
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/jsp" title="jsp">
                            jsp
                        </a>
                        
                        
                        
                        <a href="/tags/juc" title="juc">
                            juc
                        </a>
                        
                        
                        
                        <a href="/tags/jvm" title="jvm">
                            jvm
                        </a>
                        
                        
                        
                        <a href="/tags/jwt" title="jwt">
                            jwt
                        </a>
                        
                        
                        
                        <a href="/tags/kafka" title="kafka">
                            kafka
                        </a>
                        
                        
                        
                        <a href="/tags/linux" title="linux">
                            linux
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/maven" title="maven">
                            maven
                        </a>
                        
                        
                        
                        <a href="/tags/minio" title="minio">
                            minio
                        </a>
                        
                        
                        
                        <a href="/tags/mongodb" title="mongodb">
                            mongodb
                        </a>
                        
                        
                        
                        <a href="/tags/mybatis" title="mybatis">
                            mybatis
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/mysql" title="mysql">
                            mysql
                        </a>
                        
                        
                        
                        <a href="/tags/netty" title="netty">
                            netty
                        </a>
                        
                        
                        
                        <a href="/tags/nginx" title="nginx">
                            nginx
                        </a>
                        
                        
                        
                        <a href="/tags/react" title="react">
                            react
                        </a>
                        
                        
                        
                        <a href="/tags/redis" title="redis">
                            redis
                        </a>
                        
                        
                        
                        <a href="/tags/scala" title="scala">
                            scala
                        </a>
                        
                        
                        
                        <a href="/tags/servlet" title="servlet">
                            servlet
                        </a>
                        
                        
                        
                        <a href="/tags/session" title="session">
                            session
                        </a>
                        
                        
                        
                        <a href="/tags/shiro" title="shiro">
                            shiro
                        </a>
                        
                        
                        
                        <a href="/tags/spark" title="spark">
                            spark
                        </a>
                        
                        
                        
                        <a href="/tags/spring" title="spring">
                            spring
                        </a>
                        
                        
                        
                        <a href="/tags/springboot" title="springboot">
                            springboot
                        </a>
                        
                        
                        
                        <a href="/tags/springcloud" title="springcloud">
                            springcloud
                        </a>
                        
                        
                        
                        <a href="/tags/springmvc" title="springmvc">
                            springmvc
                        </a>
                        
                        
                        
                        <a href="/tags/springsecurity" title="springsecurity">
                            springsecurity
                        </a>
                        
                        
                        
                        <a href="/tags/tomcat" title="tomcat">
                            tomcat
                        </a>
                        
                        
                        
                        <a href="/tags/vue" title="vue">
                            vue
                        </a>
                        
                        
                        
                        <a href="/tags/xml" title="xml">
                            xml
                        </a>
                        
                        
                        
                        <a href="/tags/zookeeper" title="zookeeper">
                            zookeeper
                        </a>
                        
                        
                        
                        <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81" title="分布式锁">
                            分布式锁
                        </a>
                        
                        
                        
                        <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95" title="数据结构与算法">
                            数据结构与算法
                        </a>
                        
                        
                        
                        <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" title="设计模式">
                            设计模式
                        </a>
                        
                        
                        
                        <a href="/tags/%E9%A1%B9%E7%9B%AE" title="项目">
                            项目
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:1424197205@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    <li>
                        <a target="_blank" href="/#">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/yiguan1573">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="亿观的博客" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; 亿观的博客 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>









<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





</body>
</html>
