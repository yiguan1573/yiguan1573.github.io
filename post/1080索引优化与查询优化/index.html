<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="referrer" content="never">

    
    <meta property="og:site_name" content="亿观的博客">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="https://yiguan1573.github.io//img/01.jpg">
    <meta property="twitter:image" content="https://yiguan1573.github.io//img/01.jpg" />
    

    
    <meta name="title" content="10、索引优化与查询优化（索引与调优篇）" />
    <meta property="og:title" content="10、索引优化与查询优化（索引与调优篇）" />
    <meta property="twitter:title" content="10、索引优化与查询优化（索引与调优篇）" />
    

    
    <meta name="description" content="">
    <meta property="og:description" content="" />
    <meta property="twitter:description" content="" />
    

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>10、索引优化与查询优化（索引与调优篇） | yiguan1573</title>

    <link rel="canonical" href="/post/1080%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E4%B8%8E%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/">

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.css">

    
    <link href="https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css" rel="stylesheet" type="text/css">

    
    

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    

</head>




<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">亿观的博客</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">首页</a>
                    </li>
                    
                        
                        <li>
                            <a href="/categories/%E5%AD%A6%E4%B9%A0">学习</a>
                        </li>
                        
                    
                    
		    
                        <li><a href="/top/archive/">档案</a></li>
                    
                        <li><a href="/top/about/">关于</a></li>
                    

                    
		    <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		    </li>
                    
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/04.JPG')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/mysql" title="mysql">
                            mysql
                        </a>
                        
                    </div>
                    <h1>10、索引优化与查询优化（索引与调优篇）</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                亿观
                             
                            on 
                            Friday, September 23, 2022
                            
                                <span id="/post/1080%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E4%B8%8E%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/" class="leancloud_visitors meta_data_item" data-flag-title="">
    <span class="post-meta-item-icon">
      <span class="octicon octicon-eye"></span> 
    </span>
    <i class="fa fa-eye"></i>
    <span class="old-visitors-count" style="display: none;"></span>
    <span class="leancloud-visitors-count"></span>
</span>



<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>

<script>
	AV.initialize("", "");
</script>

<script type="text/javascript">
function showTime(Counter) {
    var query = new AV.Query(Counter);
    var entries = [];
    var $visitors = $(".leancloud_visitors");

    $visitors.each(function() {
        entries.push($(this).attr("id").trim());
    });

    query.containedIn('url', entries);
    query.find()
        .done(function(results) {
            var COUNT_CONTAINER_REF = '.leancloud-visitors-count';
            var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';

            
            
            
            

            for (var i = 0; i < results.length; i++) {
                var item = results[i];
                var url = item.get('url');
                var time = item.get('time');
                var element = document.getElementById(url);

                $(element).find(COUNT_CONTAINER_REF).text(time);
            }
            for (var i = 0; i < entries.length; i++) {
                var url = entries[i];
                var element = document.getElementById(url);
                var countSpan = $(element).find(COUNT_CONTAINER_REF);
                if (countSpan.text() == '') {
                    var oldCountSpan = $(element).find(OLD_COUNT_CONTAINER_REF).text();
                    if(oldCountSpan!=''){
                        countSpan.text(0+parseInt(oldCountSpan));
                    }else{
                        countSpan.text(0);          
                    }
                }
            }
        })
        .fail(function(object, error) {
            console.log("Error: " + error.code + " " + error.message);
        });
}

function addCount(Counter) {
    var $visitors = $(".leancloud_visitors");
    var url = $visitors.attr('id').trim();
    var title = $visitors.attr('data-flag-title').trim();
    var query = new AV.Query(Counter);

    query.equalTo("url", url);
    query.find({
        success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment("time");
                counter.save(null, {
                    success: function(counter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(counter.get('time'));
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
                var newcounter = new Counter();
                 
                var acl = new AV.ACL();
                acl.setPublicReadAccess(true);
                acl.setPublicWriteAccess(true);
                newcounter.setACL(acl);
                 
                newcounter.set("title", title);
                newcounter.set("url", url);
                var OLD_COUNT_CONTAINER_REF = '.old-visitors-count';
                var $element = $(document.getElementById(url));
                var oldCountSpan = $element.find(OLD_COUNT_CONTAINER_REF).text();
                if(oldCountSpan!=''){
                    newcounter.set("time", parseInt(oldCountSpan)+1);
                }else{
 	                    newcounter.set("time",  1);
                }
                newcounter.save(null, {
                    success: function(newcounter) {
                        var $element = $(document.getElementById(url));
                        $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
                    },
                    error: function(newcounter, error) {
                        console.log('Failed to create');
                    }
                });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + " " + error.message);
        }
    });
}
$(function() {
    var Counter = AV.Object.extend("Counter");
    
    
    if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
    } else {
        showTime(Counter);
    }
});
</script>

                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <p>都有哪些维度可以进行数据库调优？简言之：</p>
<ul>
<li>索引失效、没有充分利用到索引——建立索引</li>
<li>关联查询太多JOIN（设计缺陷或不得已的需求）——SQL优化</li>
<li>服务器调优及各个参数设置（缓冲、线程数等）——调整my.cnf</li>
<li>数据过多——分库分表</li>
</ul>
<p>关于数据库调优的知识非常分散。不同的DBMS，不同的公司，不同的职位，不同的项目遇到的问题都不尽相同。这里我们分为三个章节进行细致讲解。</p>
<p>虽然SQL查询优化的技术有很多，但是大方向上完全可以分成<code>物理查询优化</code>和<code>逻辑查询优化</code>两大块。</p>
<ul>
<li>物理查询优化是通过<code>索引</code>和<code>表连接方式</code>等技术来进行优化，这里重点需要掌握索引的使用。</li>
<li>逻辑查询优化就是通过SQL<code>等价变换</code>提升查询效率，直白一点就是说，换一种查询写法效率可能更高。</li>
</ul>
<h2 id="1-数据准备">1. 数据准备</h2>
<p><code>学员表</code> 插 <code>50万</code> 条，<code> 班级表</code> 插 <code>1万</code> 条。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">DATABASE</span> atguigudb2;
<span style="color:#ff79c6">USE</span> atguigudb2;
</code></pre></div><p><strong>步骤1：建表</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#ff79c6">`</span>class<span style="color:#ff79c6">`</span> (
    <span style="color:#ff79c6">`</span>id<span style="color:#ff79c6">`</span> <span style="color:#8be9fd">INT</span>(<span style="color:#bd93f9">11</span>) <span style="color:#ff79c6">NOT</span> NULL <span style="color:#ff79c6">AUTO_INCREMENT</span>,
    <span style="color:#ff79c6">`</span>className<span style="color:#ff79c6">`</span> <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">30</span>) <span style="color:#ff79c6">DEFAULT</span> NULL,
    <span style="color:#ff79c6">`</span>address<span style="color:#ff79c6">`</span> <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">40</span>) <span style="color:#ff79c6">DEFAULT</span> NULL,
    <span style="color:#ff79c6">`</span>monitor<span style="color:#ff79c6">`</span> <span style="color:#8be9fd">INT</span> NULL ,
    <span style="color:#ff79c6">PRIMARY</span> <span style="color:#ff79c6">KEY</span> (<span style="color:#ff79c6">`</span>id<span style="color:#ff79c6">`</span>)
) <span style="color:#ff79c6">ENGINE</span><span style="color:#ff79c6">=</span>INNODB <span style="color:#ff79c6">AUTO_INCREMENT</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">DEFAULT</span> <span style="color:#ff79c6">CHARSET</span><span style="color:#ff79c6">=</span>utf8;

<span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#ff79c6">`</span>student<span style="color:#ff79c6">`</span> (
    <span style="color:#ff79c6">`</span>id<span style="color:#ff79c6">`</span> <span style="color:#8be9fd">INT</span>(<span style="color:#bd93f9">11</span>) <span style="color:#ff79c6">NOT</span> NULL <span style="color:#ff79c6">AUTO_INCREMENT</span>,
    <span style="color:#ff79c6">`</span>stuno<span style="color:#ff79c6">`</span> <span style="color:#8be9fd">INT</span> <span style="color:#ff79c6">NOT</span> NULL ,
    <span style="color:#ff79c6">`</span>name<span style="color:#ff79c6">`</span> <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">20</span>) <span style="color:#ff79c6">DEFAULT</span> NULL,
    <span style="color:#ff79c6">`</span>age<span style="color:#ff79c6">`</span> <span style="color:#8be9fd">INT</span>(<span style="color:#bd93f9">3</span>) <span style="color:#ff79c6">DEFAULT</span> NULL,
    <span style="color:#ff79c6">`</span>classId<span style="color:#ff79c6">`</span> <span style="color:#8be9fd">INT</span>(<span style="color:#bd93f9">11</span>) <span style="color:#ff79c6">DEFAULT</span> NULL,
    <span style="color:#ff79c6">PRIMARY</span> <span style="color:#ff79c6">KEY</span> (<span style="color:#ff79c6">`</span>id<span style="color:#ff79c6">`</span>)
    <span style="color:#6272a4">#CONSTRAINT `fk_class_id` FOREIGN KEY (`classId`) REFERENCES `t_class` (`id`)
</span><span style="color:#6272a4"></span>) <span style="color:#ff79c6">ENGINE</span><span style="color:#ff79c6">=</span>INNODB <span style="color:#ff79c6">AUTO_INCREMENT</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">DEFAULT</span> <span style="color:#ff79c6">CHARSET</span><span style="color:#ff79c6">=</span>utf8;
</code></pre></div><p><strong>步骤2：设置参数</strong></p>
<ul>
<li>命令开启：允许创建函数设置：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#8be9fd">set</span> global log_bin_trust_function_creators<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>; <span style="color:#6272a4"># 不加global只是当前窗口有效。
</span></code></pre></div><p><strong>步骤3：创建函数</strong></p>
<p>保证每条数据都不同。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4">#随机产生字符串
</span><span style="color:#6272a4"></span>DELIMITER <span style="color:#ff79c6">/</span><span style="color:#ff79c6">/</span>
<span style="color:#ff79c6">CREATE</span> FUNCTION <span style="color:#50fa7b">rand_string</span>(n <span style="color:#8be9fd">INT</span>) RETURNS <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">255</span>)
BEGIN
<span style="color:#ff79c6">DECLARE</span> chars_str <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">100</span>) <span style="color:#ff79c6">DEFAULT</span>
<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ</span><span style="color:#f1fa8c">&#39;</span>;
<span style="color:#ff79c6">DECLARE</span> return_str <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">255</span>) <span style="color:#ff79c6">DEFAULT</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">&#39;</span>;
<span style="color:#ff79c6">DECLARE</span> i <span style="color:#8be9fd">INT</span> <span style="color:#ff79c6">DEFAULT</span> <span style="color:#bd93f9">0</span>;
<span style="color:#ff79c6">WHILE</span> i <span style="color:#ff79c6">&lt;</span> n DO
<span style="color:#8be9fd">SET</span> return_str <span style="color:#ff79c6">=</span><span style="color:#50fa7b">CONCAT</span>(return_str,<span style="color:#50fa7b">SUBSTRING</span>(chars_str,<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span><span style="color:#ff79c6">+</span><span style="color:#50fa7b">RAND</span>()<span style="color:#ff79c6">*</span><span style="color:#bd93f9">52</span>),<span style="color:#bd93f9">1</span>));
<span style="color:#8be9fd">SET</span> i <span style="color:#ff79c6">=</span> i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>;
END <span style="color:#ff79c6">WHILE</span>;
<span style="color:#ff79c6">RETURN</span> return_str;
END <span style="color:#ff79c6">/</span><span style="color:#ff79c6">/</span>
DELIMITER ;
<span style="color:#6272a4">#假如要删除
</span><span style="color:#6272a4"></span><span style="color:#6272a4">#drop function rand_string;
</span></code></pre></div><p>随机产生班级编号</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4">#用于随机产生多少到多少的编号
</span><span style="color:#6272a4"></span>DELIMITER <span style="color:#ff79c6">/</span><span style="color:#ff79c6">/</span>
<span style="color:#ff79c6">CREATE</span> FUNCTION <span style="color:#50fa7b">rand_num</span> (from_num <span style="color:#8be9fd">INT</span> ,to_num <span style="color:#8be9fd">INT</span>) RETURNS <span style="color:#8be9fd">INT</span>(<span style="color:#bd93f9">11</span>)
BEGIN
<span style="color:#ff79c6">DECLARE</span> i <span style="color:#8be9fd">INT</span> <span style="color:#ff79c6">DEFAULT</span> <span style="color:#bd93f9">0</span>;
<span style="color:#8be9fd">SET</span> i <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">FLOOR</span>(from_num <span style="color:#ff79c6">+</span><span style="color:#50fa7b">RAND</span>()<span style="color:#ff79c6">*</span>(to_num <span style="color:#ff79c6">-</span> from_num<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span>)) ;
<span style="color:#ff79c6">RETURN</span> i;
END <span style="color:#ff79c6">/</span><span style="color:#ff79c6">/</span>
DELIMITER ;
<span style="color:#6272a4">#假如要删除
</span><span style="color:#6272a4"></span><span style="color:#6272a4">#drop function rand_num;
</span></code></pre></div><p><strong>步骤4：创建存储过程</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4">#创建往stu表中插入数据的存储过程
</span><span style="color:#6272a4"></span>DELIMITER <span style="color:#ff79c6">/</span><span style="color:#ff79c6">/</span>
<span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">PROCEDURE</span> <span style="color:#50fa7b">insert_stu</span>( START <span style="color:#8be9fd">INT</span> , max_num <span style="color:#8be9fd">INT</span> )
BEGIN
<span style="color:#ff79c6">DECLARE</span> i <span style="color:#8be9fd">INT</span> <span style="color:#ff79c6">DEFAULT</span> <span style="color:#bd93f9">0</span>;
<span style="color:#8be9fd">SET</span> autocommit <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>; <span style="color:#6272a4">#设置手动提交事务
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">REPEAT</span> <span style="color:#6272a4">#循环
</span><span style="color:#6272a4"></span><span style="color:#8be9fd">SET</span> i <span style="color:#ff79c6">=</span> i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>; <span style="color:#6272a4">#赋值
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">student</span> (stuno, name ,age ,classId ) <span style="color:#ff79c6">VALUES</span>
((START<span style="color:#ff79c6">+</span>i),<span style="color:#50fa7b">rand_string</span>(<span style="color:#bd93f9">6</span>),<span style="color:#50fa7b">rand_num</span>(<span style="color:#bd93f9">1</span>,<span style="color:#bd93f9">50</span>),<span style="color:#50fa7b">rand_num</span>(<span style="color:#bd93f9">1</span>,<span style="color:#bd93f9">1000</span>));
UNTIL i <span style="color:#ff79c6">=</span> max_num
END <span style="color:#ff79c6">REPEAT</span>;
COMMIT; <span style="color:#6272a4">#提交事务
</span><span style="color:#6272a4"></span>END <span style="color:#ff79c6">/</span><span style="color:#ff79c6">/</span>
DELIMITER ;
<span style="color:#6272a4">#假如要删除
</span><span style="color:#6272a4"></span><span style="color:#6272a4">#drop PROCEDURE insert_stu;
</span></code></pre></div><p>创建往class表中插入数据的存储过程</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4">#执行存储过程，往class表添加随机数据
</span><span style="color:#6272a4"></span>DELIMITER <span style="color:#ff79c6">/</span><span style="color:#ff79c6">/</span>
<span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">PROCEDURE</span> <span style="color:#ff79c6">`</span>insert_class<span style="color:#ff79c6">`</span>( max_num <span style="color:#8be9fd">INT</span> )
BEGIN
<span style="color:#ff79c6">DECLARE</span> i <span style="color:#8be9fd">INT</span> <span style="color:#ff79c6">DEFAULT</span> <span style="color:#bd93f9">0</span>;
<span style="color:#8be9fd">SET</span> autocommit <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
<span style="color:#ff79c6">REPEAT</span>
<span style="color:#8be9fd">SET</span> i <span style="color:#ff79c6">=</span> i <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span>;
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">class</span> ( classname,address,monitor ) <span style="color:#ff79c6">VALUES</span>
(<span style="color:#50fa7b">rand_string</span>(<span style="color:#bd93f9">8</span>),<span style="color:#50fa7b">rand_string</span>(<span style="color:#bd93f9">10</span>),<span style="color:#50fa7b">rand_num</span>(<span style="color:#bd93f9">1</span>,<span style="color:#bd93f9">100000</span>));
UNTIL i <span style="color:#ff79c6">=</span> max_num
END <span style="color:#ff79c6">REPEAT</span>;
COMMIT;
END <span style="color:#ff79c6">/</span><span style="color:#ff79c6">/</span>
DELIMITER ;
<span style="color:#6272a4">#假如要删除
</span><span style="color:#6272a4"></span><span style="color:#6272a4">#drop PROCEDURE insert_class;
</span></code></pre></div><p><strong>步骤5：调用存储过程</strong></p>
<p>class</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4">#执行存储过程，往class表添加1万条数据
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">CALL</span> <span style="color:#50fa7b">insert_class</span>(<span style="color:#bd93f9">10000</span>);
</code></pre></div><p>stu</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4">#执行存储过程，往stu表添加50万条数据
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">CALL</span> <span style="color:#50fa7b">insert_stu</span>(<span style="color:#bd93f9">100000</span>,<span style="color:#bd93f9">500000</span>);
</code></pre></div><p><strong>步骤6：删除某表上的索引</strong></p>
<p>创建存储过程</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">DELIMITER <span style="color:#ff79c6">/</span><span style="color:#ff79c6">/</span>
<span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">PROCEDURE</span> <span style="color:#ff79c6">`</span>proc_drop_index<span style="color:#ff79c6">`</span>(dbname <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">200</span>),tablename <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">200</span>))
BEGIN
        <span style="color:#ff79c6">DECLARE</span> done <span style="color:#8be9fd">INT</span> <span style="color:#ff79c6">DEFAULT</span> <span style="color:#bd93f9">0</span>;
        <span style="color:#ff79c6">DECLARE</span> ct <span style="color:#8be9fd">INT</span> <span style="color:#ff79c6">DEFAULT</span> <span style="color:#bd93f9">0</span>;
        <span style="color:#ff79c6">DECLARE</span> _index <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">200</span>) <span style="color:#ff79c6">DEFAULT</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">&#39;</span>;
        <span style="color:#ff79c6">DECLARE</span> _cur <span style="color:#ff79c6">CURSOR</span> <span style="color:#ff79c6">FOR</span> <span style="color:#ff79c6">SELECT</span> index_name <span style="color:#ff79c6">FROM</span>
information_schema.STATISTICS <span style="color:#ff79c6">WHERE</span> table_schema<span style="color:#ff79c6">=</span>dbname <span style="color:#ff79c6">AND</span> table_name<span style="color:#ff79c6">=</span>tablename <span style="color:#ff79c6">AND</span>
seq_in_index<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">AND</span> index_name <span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">PRIMARY</span><span style="color:#f1fa8c">&#39;</span> ;
<span style="color:#6272a4">#每个游标必须使用不同的declare continue handler for not found set done=1来控制游标的结束
</span><span style="color:#6272a4"></span>		<span style="color:#ff79c6">DECLARE</span> <span style="color:#ff79c6">CONTINUE</span> HANDLER <span style="color:#ff79c6">FOR</span> <span style="color:#ff79c6">NOT</span> FOUND <span style="color:#8be9fd">set</span> done<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span> ;
<span style="color:#6272a4">#若没有数据返回,程序继续,并将变量done设为2
</span><span style="color:#6272a4"></span>        OPEN _cur;
        <span style="color:#ff79c6">FETCH</span> _cur <span style="color:#ff79c6">INTO</span> _index;
        <span style="color:#ff79c6">WHILE</span> _index<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">&#39;</span> DO
            <span style="color:#8be9fd">SET</span> <span style="color:#ff79c6">@</span>str <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">CONCAT</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">drop index </span><span style="color:#f1fa8c">&#34;</span> , _index , <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c"> on </span><span style="color:#f1fa8c">&#34;</span> , tablename );
            PREPARE sql_str <span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">@</span>str ;
            EXECUTE sql_str;
            DEALLOCATE PREPARE sql_str;
            <span style="color:#8be9fd">SET</span> _index<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">&#39;</span>;
            <span style="color:#ff79c6">FETCH</span> _cur <span style="color:#ff79c6">INTO</span> _index;
        END <span style="color:#ff79c6">WHILE</span>;
    CLOSE _cur;
END <span style="color:#ff79c6">/</span><span style="color:#ff79c6">/</span>
DELIMITER ;
</code></pre></div><p>执行存储过程</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CALL</span> <span style="color:#50fa7b">proc_drop_index</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">dbname</span><span style="color:#f1fa8c">&#34;</span>,<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#34;</span><span style="color:#f1fa8c">tablename</span><span style="color:#f1fa8c">&#34;</span>);
</code></pre></div><h2 id="2-索引失效案例">2. 索引失效案例</h2>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yytoe7xbj30ny095tfc.jpg" alt="image-20220704202453482.png">

</p>
<h3 id="21-全值匹配我最爱">2.1 全值匹配我最爱</h3>
<p>系统中经常出现的sql语句如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age<span style="color:#ff79c6">=</span><span style="color:#bd93f9">30</span>;
<span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age<span style="color:#ff79c6">=</span><span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> classId<span style="color:#ff79c6">=</span><span style="color:#bd93f9">4</span>;
<span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age<span style="color:#ff79c6">=</span><span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> classId<span style="color:#ff79c6">=</span><span style="color:#bd93f9">4</span> <span style="color:#ff79c6">AND</span> name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abcd</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>建立索引前执行：（关注执行时间）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age<span style="color:#ff79c6">=</span><span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> classId<span style="color:#ff79c6">=</span><span style="color:#bd93f9">4</span> <span style="color:#ff79c6">AND</span> name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abcd</span><span style="color:#f1fa8c">&#39;</span>;
Empty <span style="color:#8be9fd">set</span>, <span style="color:#bd93f9">1</span> <span style="color:#50fa7b">warning</span> (<span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">28</span> sec)
</code></pre></div><p><strong>建立索引</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">INDEX</span> idx_age <span style="color:#ff79c6">ON</span> <span style="color:#50fa7b">student</span>(age);
<span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">INDEX</span> idx_age_classid <span style="color:#ff79c6">ON</span> <span style="color:#50fa7b">student</span>(age,classId);
<span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">INDEX</span> idx_age_classid_name <span style="color:#ff79c6">ON</span> <span style="color:#50fa7b">student</span>(age,classId,name);
</code></pre></div><p>建立索引后执行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age<span style="color:#ff79c6">=</span><span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> classId<span style="color:#ff79c6">=</span><span style="color:#bd93f9">4</span> <span style="color:#ff79c6">AND</span> name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abcd</span><span style="color:#f1fa8c">&#39;</span>;
Empty <span style="color:#8be9fd">set</span>, <span style="color:#bd93f9">1</span> <span style="color:#50fa7b">warning</span> (<span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">01</span> sec)
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yyug6oqwj30nt01ijs6.jpg" alt="image-20220704204140589.png">

</p>
<h3 id="22-最佳左前缀法则">2.2 最佳左前缀法则</h3>
<p>在MySQL建立联合索引时会遵守最佳左前缀原则，即最左优先，在检索数据时从联合索引的最左边开始匹配。</p>
<p>举例1：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> student.age<span style="color:#ff79c6">=</span><span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> student.name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abcd</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>举例2：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> student.classId<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">AND</span> student.name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abcd</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>举例3：索引<code>idx_age_classid_name</code>还能否正常使用？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> student.classId<span style="color:#ff79c6">=</span><span style="color:#bd93f9">4</span> <span style="color:#ff79c6">AND</span> student.age<span style="color:#ff79c6">=</span><span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> student.name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abcd</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>如果索引了多列，要遵守最左前缀法则。指的是查询从索引的最左前列开始并且不跳过索引中的列。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> student.age<span style="color:#ff79c6">=</span><span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> student.name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abcd</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yyvhbq92j30nq02pmyt.jpg" alt="image-20220704211116351.png">

</p>
<p>虽然可以正常使用，但是只有部分被使用到了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> student.classId<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">AND</span> student.name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abcd</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yyw7sd25j30no03gq4w.jpg" alt="image-20220704211254581.png">

</p>
<p>完全没有使用上索引。</p>
<p>结论：MySQL可以为多个字段创建索引，一个索引可以包含16个字段。对于多列索引，<strong>过滤条件要使用索引必须按照索引建立时的顺序，依次满足，一旦跳过某个字段，索引后面的字段都无法被使用</strong>。如果查询条件中没有用这些字段中第一个字段时，多列（或联合）索引不会被使用。</p>
<blockquote>
<p>拓展：Alibaba《Java开发手册》</p>
<p>索引文件具有 B-Tree 的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索引。</p>
</blockquote>
<h3 id="23-主键插入顺序">2.3 主键插入顺序</h3>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yywz7howj30o008bdkr.jpg" alt="image-20220704212354041.png">

</p>
<p>如果此时再插入一条主键值为 9 的记录，那它插入的位置就如下图：</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yyxdduocj30gi079wfb.jpg" alt="image-20220704212428607.png">

</p>
<p>可这个数据页已经满了，再插进来咋办呢？我们需要把当前 <code>页面分裂</code> 成两个页面，把本页中的一些记录移动到新创建的这个页中。页面分裂和记录移位意味着什么？意味着： <code>性能损耗</code> ！所以如果我们想尽量避免这样无谓的性能损耗，最好让插入的记录的 <code>主键值依次递增</code> ，这样就不会发生这样的性能损耗了。 所以我们建议：让主键具有 <code>AUTO_INCREMENT</code> ，让存储引擎自己为表生成主键，而不是我们手动插入 ， 比如： <code>person_info</code> 表：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#50fa7b">person_info</span>(
    id <span style="color:#8be9fd">INT</span> <span style="color:#ff79c6">UNSIGNED</span> <span style="color:#ff79c6">NOT</span> NULL <span style="color:#ff79c6">AUTO_INCREMENT</span>,
    name <span style="color:#8be9fd">VARCHAR</span>(<span style="color:#bd93f9">100</span>) <span style="color:#ff79c6">NOT</span> NULL,
    birthday <span style="color:#8be9fd">DATE</span> <span style="color:#ff79c6">NOT</span> NULL,
    phone_number <span style="color:#8be9fd">CHAR</span>(<span style="color:#bd93f9">11</span>) <span style="color:#ff79c6">NOT</span> NULL,
    country <span style="color:#8be9fd">varchar</span>(<span style="color:#bd93f9">100</span>) <span style="color:#ff79c6">NOT</span> NULL,
    <span style="color:#ff79c6">PRIMARY</span> <span style="color:#ff79c6">KEY</span> (id),
    <span style="color:#ff79c6">KEY</span> <span style="color:#50fa7b">idx_name_birthday_phone_number</span> (<span style="color:#50fa7b">name</span>(<span style="color:#bd93f9">10</span>), birthday, phone_number)
);
</code></pre></div><p>我们自定义的主键列 <code>id</code> 拥有 <code>AUTO_INCREMENT</code> 属性，在插入记录时存储引擎会自动为我们填入自增的主键值。这样的主键占用空间小，顺序写入，减少页分裂。</p>
<h3 id="24-计算函数类型转换自动或手动导致索引失效">2.4 计算、函数、类型转换(自动或手动)导致索引失效</h3>
<ol>
<li>
<p>这两条sql哪种写法更好</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> student.name <span style="color:#ff79c6">LIKE</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abc%</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> <span style="color:#ff79c6">LEFT</span>(student.name,<span style="color:#bd93f9">3</span>) <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abc</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div></li>
<li>
<p>创建索引</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">INDEX</span> idx_name <span style="color:#ff79c6">ON</span> <span style="color:#50fa7b">student</span>(NAME);
</code></pre></div></li>
<li>
<p>第一种：索引优化生效</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> student.name <span style="color:#ff79c6">LIKE</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abc%</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> student.name <span style="color:#ff79c6">LIKE</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abc%</span><span style="color:#f1fa8c">&#39;</span>;
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#ff79c6">|</span> id <span style="color:#ff79c6">|</span> stuno <span style="color:#ff79c6">|</span> name <span style="color:#ff79c6">|</span> age <span style="color:#ff79c6">|</span> classId <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">5301379</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1233401</span> <span style="color:#ff79c6">|</span> AbCHEa <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">164</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">259</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">7170042</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3102064</span> <span style="color:#ff79c6">|</span> ABcHeB <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">199</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">161</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1901614</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1833636</span> <span style="color:#ff79c6">|</span> ABcHeC <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">226</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">275</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">5195021</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1127043</span> <span style="color:#ff79c6">|</span> abchEC <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">486</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">72</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">4047089</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3810031</span> <span style="color:#ff79c6">|</span> AbCHFd <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">268</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">210</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">4917074</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">849096</span> <span style="color:#ff79c6">|</span> ABcHfD <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">264</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">442</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1540859</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">141979</span> <span style="color:#ff79c6">|</span> abchFF <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">119</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">140</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">5121801</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1053823</span> <span style="color:#ff79c6">|</span> AbCHFg <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">412</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">327</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">2441254</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">2373276</span> <span style="color:#ff79c6">|</span> abchFJ <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">170</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">362</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">7039146</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">2971168</span> <span style="color:#ff79c6">|</span> ABcHgI <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">502</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">465</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1636826</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1580286</span> <span style="color:#ff79c6">|</span> ABcHgK <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">71</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">262</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">374344</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">474345</span> <span style="color:#ff79c6">|</span> abchHL <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">367</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">212</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1596534</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">169191</span> <span style="color:#ff79c6">|</span> AbCHHl <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">102</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">146</span> <span style="color:#ff79c6">|</span>
...
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">5266837</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1198859</span> <span style="color:#ff79c6">|</span> abclXe <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">292</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">298</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">8126968</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">4058990</span> <span style="color:#ff79c6">|</span> aBClxE <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">316</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">150</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">4298305</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">399962</span> <span style="color:#ff79c6">|</span> AbCLXF <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">72</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">423</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">5813628</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1745650</span> <span style="color:#ff79c6">|</span> aBClxF <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">356</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">323</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">6980448</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">2912470</span> <span style="color:#ff79c6">|</span> AbCLXF <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">107</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">78</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">7881979</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3814001</span> <span style="color:#ff79c6">|</span> AbCLXF <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">89</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">497</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">4955576</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">887598</span> <span style="color:#ff79c6">|</span> ABcLxg <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">121</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">385</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3653460</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3585482</span> <span style="color:#ff79c6">|</span> AbCLXJ <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">130</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">174</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1231990</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1283439</span> <span style="color:#ff79c6">|</span> AbCLYH <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">189</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">429</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">6110615</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">2042637</span> <span style="color:#ff79c6">|</span> ABcLyh <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">157</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">40</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#bd93f9">401</span> rows <span style="color:#ff79c6">in</span> <span style="color:#8be9fd">set</span>, <span style="color:#bd93f9">1</span> <span style="color:#50fa7b">warning</span> (<span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">01</span> sec)
</code></pre></div></li>
<li>
<p>第二种：索引优化失效</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> <span style="color:#ff79c6">LEFT</span>(student.name,<span style="color:#bd93f9">3</span>) <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abc</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yyxwfxybj30gg02gwg1.jpg" alt="image-20220704214905412.png">

</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> <span style="color:#ff79c6">LEFT</span>(student.name,<span style="color:#bd93f9">3</span>) <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abc</span><span style="color:#f1fa8c">&#39;</span>;
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#ff79c6">|</span> id <span style="color:#ff79c6">|</span> stuno <span style="color:#ff79c6">|</span> name <span style="color:#ff79c6">|</span> age <span style="color:#ff79c6">|</span> classId <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">5301379</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1233401</span> <span style="color:#ff79c6">|</span> AbCHEa <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">164</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">259</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">7170042</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3102064</span> <span style="color:#ff79c6">|</span> ABcHeB <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">199</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">161</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1901614</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1833636</span> <span style="color:#ff79c6">|</span> ABcHeC <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">226</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">275</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">5195021</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1127043</span> <span style="color:#ff79c6">|</span> abchEC <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">486</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">72</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">4047089</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3810031</span> <span style="color:#ff79c6">|</span> AbCHFd <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">268</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">210</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">4917074</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">849096</span> <span style="color:#ff79c6">|</span> ABcHfD <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">264</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">442</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1540859</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">141979</span> <span style="color:#ff79c6">|</span> abchFF <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">119</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">140</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">5121801</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1053823</span> <span style="color:#ff79c6">|</span> AbCHFg <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">412</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">327</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">2441254</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">2373276</span> <span style="color:#ff79c6">|</span> abchFJ <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">170</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">362</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">7039146</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">2971168</span> <span style="color:#ff79c6">|</span> ABcHgI <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">502</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">465</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1636826</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1580286</span> <span style="color:#ff79c6">|</span> ABcHgK <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">71</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">262</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">374344</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">474345</span> <span style="color:#ff79c6">|</span> abchHL <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">367</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">212</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1596534</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">169191</span> <span style="color:#ff79c6">|</span> AbCHHl <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">102</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">146</span> <span style="color:#ff79c6">|</span>
...
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">5266837</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1198859</span> <span style="color:#ff79c6">|</span> abclXe <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">292</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">298</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">8126968</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">4058990</span> <span style="color:#ff79c6">|</span> aBClxE <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">316</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">150</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">4298305</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">399962</span> <span style="color:#ff79c6">|</span> AbCLXF <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">72</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">423</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">5813628</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1745650</span> <span style="color:#ff79c6">|</span> aBClxF <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">356</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">323</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">6980448</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">2912470</span> <span style="color:#ff79c6">|</span> AbCLXF <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">107</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">78</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">7881979</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3814001</span> <span style="color:#ff79c6">|</span> AbCLXF <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">89</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">497</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">4955576</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">887598</span> <span style="color:#ff79c6">|</span> ABcLxg <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">121</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">385</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3653460</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3585482</span> <span style="color:#ff79c6">|</span> AbCLXJ <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">130</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">174</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1231990</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1283439</span> <span style="color:#ff79c6">|</span> AbCLYH <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">189</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">429</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">6110615</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">2042637</span> <span style="color:#ff79c6">|</span> ABcLyh <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">157</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">40</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#bd93f9">401</span> rows <span style="color:#ff79c6">in</span> <span style="color:#8be9fd">set</span>, <span style="color:#bd93f9">1</span> <span style="color:#50fa7b">warning</span> (<span style="color:#bd93f9">3</span>.<span style="color:#bd93f9">62</span> sec)
</code></pre></div><p>type为“ALL”，表示没有使用到索引，查询时间为 3.62 秒，查询效率较之前低很多。</p>
</li>
</ol>
<p><strong>再举例：</strong></p>
<ul>
<li>
<p>student表的字段stuno上设置有索引</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">INDEX</span> idx_sno <span style="color:#ff79c6">ON</span> <span style="color:#50fa7b">student</span>(stuno);
</code></pre></div></li>
<li>
<p>索引优化失效：（假设：student表的字段stuno上设置有索引）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE id, stuno, NAME <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> stuno<span style="color:#ff79c6">+</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">900001</span>;

</code></pre></div></li>
</ul>
<p>运行结果：</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yyygf83vj30gf02f75u.jpg" alt="image-20220704215159768.png">

</p>
<ul>
<li>
<p>索引优化生效：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE id, stuno, NAME <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> stuno <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">900000</span>;
</code></pre></div></li>
</ul>
<p><strong>再举例：</strong></p>
<ul>
<li>
<p>student表的字段name上设置有索引</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">INDEX</span> idx_name <span style="color:#ff79c6">ON</span> <span style="color:#50fa7b">student</span>(NAME);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> id, stuno, name <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> <span style="color:#50fa7b">SUBSTRING</span>(name, <span style="color:#bd93f9">1</span>,<span style="color:#bd93f9">3</span>)<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abc</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div></li>
</ul>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yyz4cdfcj30ga02e0ud.jpg" alt="image-20220704215533871.png">

</p>
<ul>
<li>
<p>索引优化生效</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> id, stuno, NAME <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> NAME <span style="color:#ff79c6">LIKE</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abc%</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yyzlzavbj30gf02a0u3.jpg" alt="image-20220704215600507.png">

</p>
</li>
</ul>
<h3 id="25-类型转换导致索引失效">2.5 类型转换导致索引失效</h3>
<p>下列哪个sql语句可以用到索引。（假设name字段上设置有索引）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4"># 未使用到索引
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> name<span style="color:#ff79c6">=</span><span style="color:#bd93f9">123</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yyzy16osj30km02ymza.jpg" alt="image-20220704215658526.png">

</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4"># 使用到索引
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">123</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yz0e44w9j30kn0340uv.jpg" alt="image-20220704215721216.png">

</p>
<p>name=123发生类型转换，索引失效。</p>
<h3 id="26-范围条件右边的列索引失效">2.6 范围条件右边的列索引失效</h3>
<ol>
<li>系统经常出现的sql如下：</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">ALTER</span> <span style="color:#ff79c6">TABLE</span> student <span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_name;
<span style="color:#ff79c6">ALTER</span> <span style="color:#ff79c6">TABLE</span> student <span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_age;
<span style="color:#ff79c6">ALTER</span> <span style="color:#ff79c6">TABLE</span> student <span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_age_classid;

<span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student
<span style="color:#ff79c6">WHERE</span> student.age<span style="color:#ff79c6">=</span><span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> student.classId<span style="color:#ff79c6">&gt;</span><span style="color:#bd93f9">20</span> <span style="color:#ff79c6">AND</span> student.name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abc</span><span style="color:#f1fa8c">&#39;</span> ;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yz0voc1xj30w203hq6n.jpg" alt="image-20220704220123647.png">

</p>
<ol start="2">
<li>那么索引 idx_age_classId_name 这个索引还能正常使用么？</li>
</ol>
<ul>
<li>不能，范围右边的列不能使用。比如：(&lt;) (&lt;=) (&gt;) (&gt;=) 和 between 等</li>
<li>如果这种sql出现较多，应该建立：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">create</span> <span style="color:#ff79c6">index</span> idx_age_name_classId <span style="color:#ff79c6">on</span> <span style="color:#50fa7b">student</span>(age,name,classId);
</code></pre></div><ul>
<li>将范围查询条件放置语句最后：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> student.age<span style="color:#ff79c6">=</span><span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> student.name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abc</span><span style="color:#f1fa8c">&#39;</span> <span style="color:#ff79c6">AND</span> student.classId<span style="color:#ff79c6">&gt;</span><span style="color:#bd93f9">20</span>;
</code></pre></div><blockquote>
<p>应用开发中范围查询，例如：金额查询，日期查询往往都是范围查询。应将查询条件放置where语句最后。（创建的联合索引中，务必把范围涉及到的字段写在最后）</p>
</blockquote>
<ol start="3">
<li>效果</li>
</ol>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yz1bthtpj30w403ewhz.jpg" alt="image-20220704223211981.png">

</p>
<h3 id="27-不等于-或者索引失效">2.7 不等于(!= 或者&lt;&gt;)索引失效</h3>
<ul>
<li>为name字段创建索引</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">INDEX</span> idx_name <span style="color:#ff79c6">ON</span> <span style="color:#50fa7b">student</span>(NAME);
</code></pre></div><ul>
<li>查看索引是否失效</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> student.name <span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abc</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yz1s03ubj30nq03iwge.jpg" alt="image-20220704224552374.png">

</p>
<p>或者</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> student.name <span style="color:#ff79c6">!</span><span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">abc</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yz24h8vzj30nr03hgnf.jpg" alt="image-20220704224916117.png">

</p>
<p>场景举例：用户提出需求，将财务数据，产品利润金额不等于0的都统计出来。</p>
<h3 id="28-is-null可以使用索引is-not-null无法使用索引">2.8 is null可以使用索引，is not null无法使用索引</h3>
<ul>
<li>IS NULL: 可以触发索引</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age <span style="color:#ff79c6">IS</span> NULL;
</code></pre></div><ul>
<li>IS NOT NULL: 无法触发索引</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age <span style="color:#ff79c6">IS</span> <span style="color:#ff79c6">NOT</span> NULL;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yz9qirepj30ns02r75x.jpg" alt="image-20220704225333199.png">

</p>
<blockquote>
<p>结论：最好在设计数据库的时候就将<code>字段设置为 NOT NULL 约束</code>，比如你可以将 INT 类型的字段，默认值设置为0。将字符类型的默认值设置为空字符串('')。</p>
<p>扩展：同理，在查询中使用<code>not like</code>也无法使用索引，导致全表扫描。</p>
</blockquote>
<h3 id="29-like以通配符开头索引失效">2.9 like以通配符%开头索引失效</h3>
<p>在使用LIKE关键字进行查询的查询语句中，如果匹配字符串的第一个字符为&rsquo;%'，索引就不会起作用。只有&rsquo;%&lsquo;不在第一个位置，索引才会起作用。</p>
<ul>
<li>使用到索引</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> name <span style="color:#ff79c6">LIKE</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">ab%</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yza4qx75j30ns02twgk.jpg" alt="image-20220705131643304.png">

</p>
<ul>
<li>未使用到索引</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> name <span style="color:#ff79c6">LIKE</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">%ab%</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzag8bbrj30nr03f76m.jpg" alt="image-20220705131717329.png">

</p>
<blockquote>
<p>拓展：Alibaba《Java开发手册》</p>
<p>【强制】页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决。</p>
</blockquote>
<h3 id="210-or-前后存在非索引的列索引失效">2.10 OR 前后存在非索引的列，索引失效</h3>
<p>在WHERE子句中，如果在OR前的条件列进行了索引，而在OR后的条件列没有进行索引，那么索引会失效。也就是说，<strong>OR前后的两个条件中的列都是索引时，查询中才使用索引。</strong></p>
<p>因为OR的含义就是两个只要满足一个即可，因此<code>只有一个条件列进行了索引是没有意义的</code>，只要有条件列没有进行索引，就会进行<code>全表扫描</code>，因此所以的条件列也会失效。</p>
<p>查询语句使用OR关键字的情况：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4"># 未使用到索引
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">10</span> <span style="color:#ff79c6">OR</span> classid <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">100</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzas7n0rj30w303u42q.jpg" alt="image-20220705132221045.png">

</p>
<p>因为classId字段上没有索引，所以上述查询语句没有使用索引。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4">#使用到索引
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">10</span> <span style="color:#ff79c6">OR</span> name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">Abel</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzb3zi5ej30w502ztbq.jpg" alt="image-20220705132239232.png">

</p>
<p>因为age字段和name字段上都有索引，所以查询中使用了索引。你能看到这里使用到了<code>index_merge</code>，简单来说index_merge就是对age和name分别进行了扫描，然后将这两个结果集进行了合并。这样做的好处就是<code>避免了全表扫描</code>。</p>
<h3 id="211-数据库和表的字符集统一使用utf8mb4">2.11 数据库和表的字符集统一使用utf8mb4</h3>
<p>统一使用utf8mb4( 5.5.3版本以上支持)兼容性更好，统一字符集可以避免由于字符集转换产生的乱码。不 同的 <code>字符集</code> 进行比较前需要进行 <code>转换</code> 会造成索引失效。</p>
<h3 id="212-练习及一般性建议">2.12 练习及一般性建议</h3>
<p>**练习：**假设：index(a,b,c)</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzbifh6rj30o80ifwkk.jpg" alt="image-20220705145225852.png">

</p>
<p><strong>一般性建议</strong></p>
<ul>
<li>对于单列索引，尽量选择针对当前query过滤性更好的索引</li>
<li>在选择组合索引的时候，当前query中过滤性最好的字段在索引字段顺序中，位置越靠前越好。</li>
<li>在选择组合索引的时候，尽量选择能够当前query中where子句中更多的索引。</li>
<li>在选择组合索引的时候，如果某个字段可能出现范围查询时，尽量把这个字段放在索引次序的最后面。</li>
</ul>
<p><strong>总之，书写SQL语句时，尽量避免造成索引失效的情况</strong></p>
<h2 id="3-关联查询优化">3. 关联查询优化</h2>
<h3 id="31-数据准备">3.1 数据准备</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4"># 分类
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#ff79c6">IF</span> <span style="color:#ff79c6">NOT</span> <span style="color:#ff79c6">EXISTS</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span> (
<span style="color:#ff79c6">`</span>id<span style="color:#ff79c6">`</span> <span style="color:#8be9fd">INT</span>(<span style="color:#bd93f9">10</span>) <span style="color:#ff79c6">UNSIGNED</span> <span style="color:#ff79c6">NOT</span> NULL <span style="color:#ff79c6">AUTO_INCREMENT</span>,
<span style="color:#ff79c6">`</span>card<span style="color:#ff79c6">`</span> <span style="color:#8be9fd">INT</span>(<span style="color:#bd93f9">10</span>) <span style="color:#ff79c6">UNSIGNED</span> <span style="color:#ff79c6">NOT</span> NULL,
<span style="color:#ff79c6">PRIMARY</span> <span style="color:#ff79c6">KEY</span> (<span style="color:#ff79c6">`</span>id<span style="color:#ff79c6">`</span>)
);
<span style="color:#6272a4">#图书
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#ff79c6">IF</span> <span style="color:#ff79c6">NOT</span> <span style="color:#ff79c6">EXISTS</span> <span style="color:#ff79c6">`</span>book<span style="color:#ff79c6">`</span> (
<span style="color:#ff79c6">`</span>bookid<span style="color:#ff79c6">`</span> <span style="color:#8be9fd">INT</span>(<span style="color:#bd93f9">10</span>) <span style="color:#ff79c6">UNSIGNED</span> <span style="color:#ff79c6">NOT</span> NULL <span style="color:#ff79c6">AUTO_INCREMENT</span>,
<span style="color:#ff79c6">`</span>card<span style="color:#ff79c6">`</span> <span style="color:#8be9fd">INT</span>(<span style="color:#bd93f9">10</span>) <span style="color:#ff79c6">UNSIGNED</span> <span style="color:#ff79c6">NOT</span> NULL,
<span style="color:#ff79c6">PRIMARY</span> <span style="color:#ff79c6">KEY</span> (<span style="color:#ff79c6">`</span>bookid<span style="color:#ff79c6">`</span>)
);

<span style="color:#6272a4">#向分类表中添加20条记录
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));

<span style="color:#6272a4">#向图书表中添加20条记录
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
</code></pre></div><h3 id="32-采用左外连接">3.2 采用左外连接</h3>
<p>下面开始 EXPLAIN 分析</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span> <span style="color:#ff79c6">LEFT</span> <span style="color:#ff79c6">JOIN</span> book <span style="color:#ff79c6">ON</span> type.card <span style="color:#ff79c6">=</span> book.card;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzbxt3kij30w3049gpa.jpg" alt="image-20220705160504018.png">

</p>
<p>结论：type 有All</p>
<p>添加索引优化</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">ALTER</span> <span style="color:#ff79c6">TABLE</span> book <span style="color:#ff79c6">ADD</span> <span style="color:#ff79c6">INDEX</span> <span style="color:#50fa7b">Y</span> ( card); <span style="color:#6272a4">#【被驱动表】，可以避免全表扫描
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span> <span style="color:#ff79c6">LEFT</span> <span style="color:#ff79c6">JOIN</span> book <span style="color:#ff79c6">ON</span> type.card <span style="color:#ff79c6">=</span> book.card;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzc8twzzj30w504vdjv.jpg" alt="image-20220705160935109.png">

</p>
<p>可以看到第二行的 type 变为了 ref，rows 也变成了优化比较明显。这是由左连接特性决定的。LEFT JOIN 条件用于确定如何从右表搜索行，左边一定都有，所以 <code>右边是我们的关键点,一定需要建立索引</code> 。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">ALTER</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span> <span style="color:#ff79c6">ADD</span> <span style="color:#ff79c6">INDEX</span> <span style="color:#50fa7b">X</span> (card); <span style="color:#6272a4">#【驱动表】，无法避免全表扫描
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span> <span style="color:#ff79c6">LEFT</span> <span style="color:#ff79c6">JOIN</span> book <span style="color:#ff79c6">ON</span> type.card <span style="color:#ff79c6">=</span> book.card;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzckpmx7j30w504utcu.jpg" alt="image-20220705161243838.png">

</p>
<p>接着：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> Y <span style="color:#ff79c6">ON</span> book;
<span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span> <span style="color:#ff79c6">LEFT</span> <span style="color:#ff79c6">JOIN</span> book <span style="color:#ff79c6">ON</span> type.card <span style="color:#ff79c6">=</span> book.card;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzcvmqs2j30vz04dq7u.jpg" alt="image-20220705161515545.png">

</p>
<h3 id="33-采用内连接">3.3 采用内连接</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">drop</span> <span style="color:#ff79c6">index</span> X <span style="color:#ff79c6">on</span> type;
<span style="color:#ff79c6">drop</span> <span style="color:#ff79c6">index</span> Y <span style="color:#ff79c6">on</span> book;（如果已经删除了可以不用再执行该操作）
</code></pre></div><p>换成 inner join（MySQL自动选择驱动表）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> type <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> book <span style="color:#ff79c6">ON</span> type.card<span style="color:#ff79c6">=</span>book.card;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzdaw6gsj30w604fq76.jpg" alt="image-20220705161602362.png">

</p>
<p>添加索引优化</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">ALTER</span> <span style="color:#ff79c6">TABLE</span> book <span style="color:#ff79c6">ADD</span> <span style="color:#ff79c6">INDEX</span> <span style="color:#50fa7b">Y</span> (card);
<span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> type <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> book <span style="color:#ff79c6">ON</span> type.card<span style="color:#ff79c6">=</span>book.card;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzdmfn50j30w1053gq7.jpg" alt="image-20220705161746184.png">

</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">ALTER</span> <span style="color:#ff79c6">TABLE</span> type <span style="color:#ff79c6">ADD</span> <span style="color:#ff79c6">INDEX</span> <span style="color:#50fa7b">X</span> (card);
<span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> type <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> book <span style="color:#ff79c6">ON</span> type.card<span style="color:#ff79c6">=</span>book.card;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzdxm7pqj30w204wq79.jpg" alt="image-20220705161843558.png">

</p>
<p>对于内连接来说，查询优化器可以决定谁作为驱动表，谁作为被驱动表出现的</p>
<p>接着：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> X <span style="color:#ff79c6">ON</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>;
<span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> TYPE <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> book <span style="color:#ff79c6">ON</span> type.card<span style="color:#ff79c6">=</span>book.card;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yze982qaj30w503qn1z.jpg" alt="image-20220705161929544.png">

</p>
<p>接着：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">ALTER</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span> <span style="color:#ff79c6">ADD</span> <span style="color:#ff79c6">INDEX</span> <span style="color:#50fa7b">X</span> (card);
<span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span> <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> book <span style="color:#ff79c6">ON</span> type.card<span style="color:#ff79c6">=</span>book.card;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzekuezoj30w204wn1h.jpg" alt="image-20220705162009145.png">

</p>
<p>接着：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4">#向图书表中添加20条记录
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> <span style="color:#50fa7b">book</span>(card) <span style="color:#ff79c6">VALUES</span>(<span style="color:#50fa7b">FLOOR</span>(<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (<span style="color:#50fa7b">RAND</span>() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">20</span>)));

<span style="color:#ff79c6">ALTER</span> <span style="color:#ff79c6">TABLE</span> book <span style="color:#ff79c6">ADD</span> <span style="color:#ff79c6">INDEX</span> <span style="color:#50fa7b">Y</span> (card);
<span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span> <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> book <span style="color:#ff79c6">ON</span> <span style="color:#ff79c6">`</span>type<span style="color:#ff79c6">`</span>.card <span style="color:#ff79c6">=</span> book.card;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzfe3emnj30nr02sac4.jpg" alt="image-20220705163833445.png">

</p>
<p>图中发现，由于type表数据大于book表数据，MySQL选择将type作为被驱动表。</p>
<h3 id="34-join语句原理">3.4 join语句原理</h3>
<p>join方式连接多个表，本质就是各个表之间数据的循环匹配。MySQL5.5版本之前，MySQL只支持一种表间关联方式，就是嵌套循环(Nested Loop Join)。如果关联表的数据量很大，则join关联的执行时间会很长。在MySQL5.5以后的版本中，MySQL通过引入BNLJ算法来优化嵌套执行。</p>
<h4 id="1-驱动表和被驱动表">1. 驱动表和被驱动表</h4>
<p>驱动表就是主表，被驱动表就是从表、非驱动表。</p>
<ul>
<li>对于内连接来说：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> A <span style="color:#ff79c6">JOIN</span> B <span style="color:#ff79c6">ON</span> ...
</code></pre></div><p>A一定是驱动表吗？不一定，优化器会根据你查询语句做优化，决定先查哪张表。先查询的那张表就是驱动表，反之就是被驱动表。通过explain关键字可以查看。</p>
<ul>
<li>对于外连接来说：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> A <span style="color:#ff79c6">LEFT</span> <span style="color:#ff79c6">JOIN</span> B <span style="color:#ff79c6">ON</span> ...
<span style="color:#6272a4"># 或
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> B <span style="color:#ff79c6">RIGHT</span> <span style="color:#ff79c6">JOIN</span> A <span style="color:#ff79c6">ON</span> ... 
</code></pre></div><p>通常，大家会认为A就是驱动表，B就是被驱动表。但也未必。测试如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#50fa7b">a</span>(f1 <span style="color:#8be9fd">INT</span>, f2 <span style="color:#8be9fd">INT</span>, <span style="color:#ff79c6">INDEX</span>(f1)) <span style="color:#ff79c6">ENGINE</span><span style="color:#ff79c6">=</span>INNODB;
<span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">TABLE</span> <span style="color:#50fa7b">b</span>(f1 <span style="color:#8be9fd">INT</span>, f2 <span style="color:#8be9fd">INT</span>) <span style="color:#ff79c6">ENGINE</span><span style="color:#ff79c6">=</span>INNODB;

<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> a <span style="color:#ff79c6">VALUES</span>(<span style="color:#bd93f9">1</span>,<span style="color:#bd93f9">1</span>),(<span style="color:#bd93f9">2</span>,<span style="color:#bd93f9">2</span>),(<span style="color:#bd93f9">3</span>,<span style="color:#bd93f9">3</span>),(<span style="color:#bd93f9">4</span>,<span style="color:#bd93f9">4</span>),(<span style="color:#bd93f9">5</span>,<span style="color:#bd93f9">5</span>),(<span style="color:#bd93f9">6</span>,<span style="color:#bd93f9">6</span>);
<span style="color:#ff79c6">INSERT</span> <span style="color:#ff79c6">INTO</span> b <span style="color:#ff79c6">VALUES</span>(<span style="color:#bd93f9">3</span>,<span style="color:#bd93f9">3</span>),(<span style="color:#bd93f9">4</span>,<span style="color:#bd93f9">4</span>),(<span style="color:#bd93f9">5</span>,<span style="color:#bd93f9">5</span>),(<span style="color:#bd93f9">6</span>,<span style="color:#bd93f9">6</span>),(<span style="color:#bd93f9">7</span>,<span style="color:#bd93f9">7</span>),(<span style="color:#bd93f9">8</span>,<span style="color:#bd93f9">8</span>);

<span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> b;

<span style="color:#6272a4"># 测试1
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> a <span style="color:#ff79c6">LEFT</span> <span style="color:#ff79c6">JOIN</span> b <span style="color:#ff79c6">ON</span>(a.f1<span style="color:#ff79c6">=</span>b.f1) <span style="color:#ff79c6">WHERE</span> (a.f2<span style="color:#ff79c6">=</span>b.f2);

<span style="color:#6272a4"># 测试2
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> a <span style="color:#ff79c6">LEFT</span> <span style="color:#ff79c6">JOIN</span> b <span style="color:#ff79c6">ON</span>(a.f1<span style="color:#ff79c6">=</span>b.f1) <span style="color:#ff79c6">AND</span> (a.f2<span style="color:#ff79c6">=</span>b.f2);
</code></pre></div><h4 id="2-simple-nested-loop-join-简单嵌套循环连接">2. Simple Nested-Loop Join (简单嵌套循环连接)</h4>
<p>算法相当简单，从表A中取出一条数据1，遍历表B，将匹配到的数据放到result.. 以此类推，驱动表A中的每一条记录与被驱动表B的记录进行判断：</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzfvir3hj30pm0b4dhp.jpg" alt="image-20220705165559127.png">

</p>
<p>可以看到这种方式效率是非常低的，以上述表A数据100条，表B数据1000条计算，则A*B=10万次。开销统计如下:</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzg8733vj30wx098jtg.jpg" alt="image-20220705165646252.png">

</p>
<p>当然mysql肯定不会这么粗暴的去进行表的连接，所以就出现了后面的两种对Nested-Loop Join优化算法。</p>
<h4 id="3-index-nested-loop-join-索引嵌套循环连接">3. Index Nested-Loop Join （索引嵌套循环连接）</h4>
<p>Index Nested-Loop Join其优化的思路主要是为了<code>减少内存表数据的匹配次数</code>，所以要求被驱动表上必须<code>有索引</code>才行。通过外层表匹配条件直接与内层表索引进行匹配，避免和内存表的每条记录去进行比较，这样极大的减少了对内存表的匹配次数。</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzgipvt5j30m509jjsq.jpg" alt="image-20220705172315554.png">

</p>
<p>驱动表中的每条记录通过被驱动表的索引进行访问，因为索引查询的成本是比较固定的，故mysql优化器都倾向于使用记录数少的表作为驱动表（外表）。</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzgvjkmqj30ww095din.jpg" alt="image-20220705172650749.png">

</p>
<p>如果被驱动表加索引，效率是非常高的，但如果索引不是主键索引，所以还得进行一次回表查询。相比，被驱动表的索引是主键索引，效率会更高。</p>
<h4 id="4-block-nested-loop-join块嵌套循环连接">4. Block Nested-Loop Join（块嵌套循环连接）</h4>
<p><!-- raw HTML omitted --></p>
<blockquote>
<p>注意：</p>
<p>这里缓存的不只是关联表的列，select后面的列也会缓存起来。</p>
<p>在一个有N个join关联的sql中会分配N-1个join buffer。所以查询的时候尽量减少不必要的字段，可以让join buffer中可以存放更多的列。</p>
</blockquote>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzh9djdqj30nt0aamz9.jpg" alt="image-20220705174005280.png">

</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzhllqi7j30o806r410.jpg" alt="image-20220705174250551.png">

</p>
<p>参数设置：</p>
<ul>
<li>block_nested_loop</li>
</ul>
<p>通过<code>show variables like '%optimizer_switch%</code> 查看 <code>block_nested_loop</code>状态。默认是开启的。</p>
<ul>
<li>join_buffer_size</li>
</ul>
<p>驱动表能不能一次加载完，要看join buffer能不能存储所有的数据，默认情况下<code>join_buffer_size=256k</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">show</span> variables <span style="color:#ff79c6">like</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">%join_buffer%</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>join_buffer_size的最大值在32位操作系统可以申请4G，而在64位操作系统下可以申请大于4G的Join Buffer空间（64位Windows除外，其大值会被截断为4GB并发出警告）。</p>
<h4 id="5-join小结">5. Join小结</h4>
<p>1、<strong>整体效率比较：INLJ &gt; BNLJ &gt; SNLJ</strong></p>
<p>2、永远用小结果集驱动大结果集（其本质就是减少外层循环的数据数量）（小的度量单位指的是表行数 * 每行大小）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">select</span> t1.b,t2.<span style="color:#ff79c6">*</span> <span style="color:#ff79c6">from</span> t1 <span style="color:#ff79c6">straight_join</span> t2 <span style="color:#ff79c6">on</span> (t1.b<span style="color:#ff79c6">=</span>t2.b) <span style="color:#ff79c6">where</span> t2.id<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">100</span>; <span style="color:#6272a4"># 推荐
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">select</span> t1.b,t2.<span style="color:#ff79c6">*</span> <span style="color:#ff79c6">from</span> t2 <span style="color:#ff79c6">straight_join</span> t1 <span style="color:#ff79c6">on</span> (t1.b<span style="color:#ff79c6">=</span>t2.b) <span style="color:#ff79c6">where</span> t2.id<span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">100</span>; <span style="color:#6272a4"># 不推荐
</span></code></pre></div><p>3、为被驱动表匹配的条件增加索引(减少内存表的循环匹配次数)</p>
<p>4、增大join buffer size的大小（一次索引的数据越多，那么内层包的扫描次数就越少）</p>
<p>5、减少驱动表不必要的字段查询（字段越少，join buffer所缓存的数据就越多）</p>
<h4 id="6-hash-join">6. Hash Join</h4>
<p><strong>从MySQL的8.0.20版本开始将废弃BNLJ，因为从MySQL8.0.18版本开始就加入了hash join默认都会使用hash join</strong></p>
<ul>
<li>
<p>Nested Loop:</p>
<p>对于被连接的数据子集较小的情况，Nested Loop是个较好的选择。</p>
</li>
<li>
<p>Hash Join是做<code>大数据集连接</code>时的常用方式，优化器使用两个表中较小（相对较小）的表利用Join Key在内存中建立<code>散列表</code>，然后扫描较大的表并探测散列表，找出与Hash表匹配的行。</p>
<ul>
<li>这种方式适合于较小的表完全可以放于内存中的情况，这样总成本就是访问两个表的成本之和。</li>
<li>在表很大的情况下并不能完全放入内存，这时优化器会将它分割成<code>若干不同的分区</code>，不能放入内存的部分就把该分区写入磁盘的临时段，此时要求有较大的临时段从而尽量提高I/O的性能。</li>
<li>它能够很好的工作于没有索引的大表和并行查询的环境中，并提供最好的性能。大多数人都说它是Join的重型升降机。Hash Join只能应用于等值连接（如WHERE A.COL1 = B.COL2），这是由Hash的特点决定的。</li>
</ul>
</li>
</ul>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yziaidfjj30o80dfwj2.jpg" alt="image-20220705205050280.png">

</p>
<h3 id="35-小结">3.5 小结</h3>
<ul>
<li>保证被驱动表的JOIN字段已经创建了索引</li>
<li>需要JOIN 的字段，数据类型保持绝对一致。</li>
<li>LEFT JOIN 时，选择小表作为驱动表， 大表作为被驱动表 。减少外层循环的次数。</li>
<li>INNER JOIN 时，MySQL会自动将 小结果集的表选为驱动表 。选择相信MySQL优化策略。</li>
<li>能够直接多表关联的尽量直接关联，不用子查询。(减少查询的趟数)</li>
<li>不建议使用子查询，建议将子查询SQL拆开结合程序多次查询，或使用 JOIN 来代替子查询。</li>
<li>衍生表建不了索引</li>
</ul>
<h2 id="4-子查询优化">4. 子查询优化</h2>
<p>MySQL从4.1版本开始支持子查询，使用子查询可以进行SELECT语句的嵌套查询，即一个SELECT查询的结 果作为另一个SELECT语句的条件。 <code>子查询可以一次性完成很多逻辑上需要多个步骤才能完成的SQL操作</code> 。</p>
<p>**子查询是 MySQL 的一项重要的功能，可以帮助我们通过一个 SQL 语句实现比较复杂的查询。但是，子 查询的执行效率不高。**原因：</p>
<p>① 执行子查询时，MySQL需要为内层查询语句的查询结果 建立一个临时表 ，然后外层查询语句从临时表 中查询记录。查询完毕后，再 撤销这些临时表 。这样会消耗过多的CPU和IO资源，产生大量的慢查询。</p>
<p>② 子查询的结果集存储的临时表，不论是内存临时表还是磁盘临时表都 不会存在索引 ，所以查询性能会 受到一定的影响。</p>
<p>③ 对于返回结果集比较大的子查询，其对查询性能的影响也就越大。</p>
<p>**在MySQL中，可以使用连接（JOIN）查询来替代子查询。**连接查询 <code>不需要建立临时表</code> ，其 <code>速度比子查询</code> 要快 ，如果查询中使用索引的话，性能就会更好。</p>
<p>举例1：查询学生表中是班长的学生信息</p>
<ul>
<li>使用子查询</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4"># 创建班级表中班长的索引
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">INDEX</span> idx_monitor <span style="color:#ff79c6">ON</span> <span style="color:#50fa7b">class</span>(monitor);

<span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student stu1
<span style="color:#ff79c6">WHERE</span> stu1.<span style="color:#ff79c6">`</span>stuno<span style="color:#ff79c6">`</span> <span style="color:#ff79c6">IN</span> (
<span style="color:#ff79c6">SELECT</span> monitor
<span style="color:#ff79c6">FROM</span> class c
<span style="color:#ff79c6">WHERE</span> monitor <span style="color:#ff79c6">IS</span> <span style="color:#ff79c6">NOT</span> NULL
)
</code></pre></div><ul>
<li>推荐使用多表查询</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> stu1.<span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student stu1 <span style="color:#ff79c6">JOIN</span> class c
<span style="color:#ff79c6">ON</span> stu1.<span style="color:#ff79c6">`</span>stuno<span style="color:#ff79c6">`</span> <span style="color:#ff79c6">=</span> c.<span style="color:#ff79c6">`</span>monitor<span style="color:#ff79c6">`</span>
<span style="color:#ff79c6">WHERE</span> c.<span style="color:#ff79c6">`</span>monitor<span style="color:#ff79c6">`</span> <span style="color:#ff79c6">is</span> <span style="color:#ff79c6">NOT</span> NULL;
</code></pre></div><p>举例2：取所有不为班长的同学</p>
<ul>
<li>不推荐</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE a.<span style="color:#ff79c6">*</span>
<span style="color:#ff79c6">FROM</span> student a
<span style="color:#ff79c6">WHERE</span> a.stuno <span style="color:#ff79c6">NOT</span> <span style="color:#ff79c6">IN</span> (
	<span style="color:#ff79c6">SELECT</span> monitor <span style="color:#ff79c6">FROM</span> class b
    <span style="color:#ff79c6">WHERE</span> monitor <span style="color:#ff79c6">IS</span> <span style="color:#ff79c6">NOT</span> NULL
);
</code></pre></div><p>执行结果如下：</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yziqpd9hj30w603w76n.jpg" alt="image-20220705210708343.png">

</p>
<ul>
<li>推荐：</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE a.<span style="color:#ff79c6">*</span>
<span style="color:#ff79c6">FROM</span> student a <span style="color:#ff79c6">LEFT</span> <span style="color:#ff79c6">OUTER</span> <span style="color:#ff79c6">JOIN</span> class b
<span style="color:#ff79c6">ON</span> a.stuno <span style="color:#ff79c6">=</span> b.monitor
<span style="color:#ff79c6">WHERE</span> b.monitor <span style="color:#ff79c6">IS</span> NULL;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzj26cxzj30wf03kq4t.jpg" alt="image-20220705210839437.png">

</p>
<blockquote>
<p>结论：尽量不要使用NOT IN或者NOT EXISTS，用LEFT JOIN xxx ON xx WHERE xx IS NULL替代</p>
</blockquote>
<h2 id="5-排序优化">5. 排序优化</h2>
<h3 id="51-排序优化">5.1 排序优化</h3>
<p><strong>问题</strong>：在 WHERE 条件字段上加索引，但是为什么在 ORDER BY 字段上还要加索引呢？</p>
<p><strong>回答：</strong></p>
<p>在MySQL中，支持两种排序方式，分别是 <code>FileSort</code> 和 <code>Index</code> 排序。</p>
<ul>
<li>Index 排序中，索引可以保证数据的有序性，不需要再进行排序，<code>效率更高</code>。</li>
<li>FileSort 排序则一般在 <code>内存中</code> 进行排序，占用<code>CPU较多</code>。如果待排结果较大，会产生临时文件 I/O 到磁盘进行排序的情况，效率较低。</li>
</ul>
<p><strong>优化建议：</strong></p>
<ol>
<li>SQL 中，可以在 WHERE 子句和 ORDER BY 子句中使用索引，目的是在 WHERE 子句中 <code>避免全表扫描</code> ，在 ORDER BY 子句 <code>避免使用 FileSort 排序</code> 。当然，某些情况下全表扫描，或者 FileSort 排序不一定比索引慢。但总的来说，我们还是要避免，以提高查询效率。</li>
<li>尽量使用 Index 完成 ORDER BY 排序。如果 WHERE 和 ORDER BY 后面是相同的列就使用单索引列； 如果不同就使用联合索引。</li>
<li>无法使用 Index 时，需要对 FileSort 方式进行调优。</li>
</ol>
<h3 id="52-测试">5.2 测试</h3>
<p>删除student表和class表中已创建的索引。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4"># 方式1
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_monitor <span style="color:#ff79c6">ON</span> class;
<span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_cid <span style="color:#ff79c6">ON</span> student;
<span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_age <span style="color:#ff79c6">ON</span> student;
<span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_name <span style="color:#ff79c6">ON</span> student;
<span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_age_name_classId <span style="color:#ff79c6">ON</span> student;
<span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_age_classId_name <span style="color:#ff79c6">ON</span> student;

<span style="color:#6272a4"># 方式2
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">call</span> <span style="color:#50fa7b">proc_drop_index</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">atguigudb2</span><span style="color:#f1fa8c">&#39;</span>,<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">student</span><span style="color:#f1fa8c">&#39;</span>;)
</code></pre></div><p>以下是否能使用到索引，<code>能否去掉using filesort</code></p>
<p><strong>过程一：</strong></p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzjhzci0j30wr0d5wmt.jpg" alt="image-20220705215436102.png">

</p>
<p><strong>过程二： order by 时不limit,索引失效</strong></p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzjtz8ynj30wu0hqth5.jpg" alt="image-20220705215909350.png">

</p>
<p><strong>过程三：order by 时顺序错误，索引失效</strong></p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzk74850j30q40ckn1u.jpg" alt="image-20220705220033520.png">

</p>
<p><strong>过程四：order by 时规则不一致，索引失效（顺序错，不索引；方向反，不索引）</strong></p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzkiu7muj30wl071jv5.jpg" alt="image-20220705220404802.png">

</p>
<blockquote>
<p>结论：ORDER BY 子句，尽量使用 Index 方式排序，避免使用 FileSort 方式排序</p>
</blockquote>
<p><strong>过程五：无过滤，不索引</strong></p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzkxwc93j30w806sadd.jpg" alt="image-20220705221212879.png">

</p>
<p><strong>小结</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">INDEX</span> <span style="color:#50fa7b">a_b_c</span>(a,b,c)
<span style="color:#ff79c6">order</span> <span style="color:#ff79c6">by</span> 能使用索引最左前缀
<span style="color:#ff79c6">-</span> <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> a
<span style="color:#ff79c6">-</span> <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> a,b
<span style="color:#ff79c6">-</span> <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> a,b,c
<span style="color:#ff79c6">-</span> <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> a <span style="color:#ff79c6">DESC</span>,b <span style="color:#ff79c6">DESC</span>,c <span style="color:#ff79c6">DESC</span>
如果WHERE使用索引的最左前缀定义为常量，则order <span style="color:#ff79c6">by</span> 能使用索引
<span style="color:#ff79c6">-</span> <span style="color:#ff79c6">WHERE</span> a <span style="color:#ff79c6">=</span> const <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> b,c
<span style="color:#ff79c6">-</span> <span style="color:#ff79c6">WHERE</span> a <span style="color:#ff79c6">=</span> const <span style="color:#ff79c6">AND</span> b <span style="color:#ff79c6">=</span> const <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> c
<span style="color:#ff79c6">-</span> <span style="color:#ff79c6">WHERE</span> a <span style="color:#ff79c6">=</span> const <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> b,c
<span style="color:#ff79c6">-</span> <span style="color:#ff79c6">WHERE</span> a <span style="color:#ff79c6">=</span> const <span style="color:#ff79c6">AND</span> b <span style="color:#ff79c6">&gt;</span> const <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> b,c
不能使用索引进行排序
<span style="color:#ff79c6">-</span> <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> a <span style="color:#ff79c6">ASC</span>,b <span style="color:#ff79c6">DESC</span>,c <span style="color:#ff79c6">DESC</span> <span style="color:#6272a4">/*</span><span style="color:#6272a4"> 排序不一致 </span><span style="color:#6272a4">*/</span>
<span style="color:#ff79c6">-</span> <span style="color:#ff79c6">WHERE</span> g <span style="color:#ff79c6">=</span> const <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> b,c <span style="color:#6272a4">/*</span><span style="color:#6272a4">丢失a索引</span><span style="color:#6272a4">*/</span>
<span style="color:#ff79c6">-</span> <span style="color:#ff79c6">WHERE</span> a <span style="color:#ff79c6">=</span> const <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> c <span style="color:#6272a4">/*</span><span style="color:#6272a4">丢失b索引</span><span style="color:#6272a4">*/</span>
<span style="color:#ff79c6">-</span> <span style="color:#ff79c6">WHERE</span> a <span style="color:#ff79c6">=</span> const <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> a,d <span style="color:#6272a4">/*</span><span style="color:#6272a4">d不是索引的一部分</span><span style="color:#6272a4">*/</span>
<span style="color:#ff79c6">-</span> <span style="color:#ff79c6">WHERE</span> a <span style="color:#ff79c6">in</span> (...) <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> b,c <span style="color:#6272a4">/*</span><span style="color:#6272a4">对于排序来说，多个相等条件也是范围查询</span><span style="color:#6272a4">*/</span>
</code></pre></div><h3 id="53-案例实战">5.3 案例实战</h3>
<p>ORDER BY子句，尽量使用Index方式排序，避免使用FileSort方式排序。</p>
<p>执行案例前先清除student上的索引，只留主键：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_age <span style="color:#ff79c6">ON</span> student;
<span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_age_classid_stuno <span style="color:#ff79c6">ON</span> student;
<span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_age_classid_name <span style="color:#ff79c6">ON</span> student;

<span style="color:#6272a4">#或者
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">call</span> <span style="color:#50fa7b">proc_drop_index</span>(<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">atguigudb2</span><span style="color:#f1fa8c">&#39;</span>,<span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">student</span><span style="color:#f1fa8c">&#39;</span>);
</code></pre></div><p><strong>场景:查询年龄为30岁的，且学生编号小于101000的学生，按用户名称排序</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> stuno <span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">101000</span> <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> NAME ;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzla8rbcj30w503y77i.jpg" alt="image-20220705222027812.png">

</p>
<p>查询结果如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> stuno <span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">101000</span> <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> NAME;
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#ff79c6">|</span> id      <span style="color:#ff79c6">|</span> stuno  <span style="color:#ff79c6">|</span>  name  <span style="color:#ff79c6">|</span> age  <span style="color:#ff79c6">|</span> classId <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">922</span>     <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100923</span> <span style="color:#ff79c6">|</span> elTLXD <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span>   <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">249</span>     <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3723263</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100412</span> <span style="color:#ff79c6">|</span> hKcjLb <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span>   <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">59</span>      <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3724152</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100827</span> <span style="color:#ff79c6">|</span> iHLJmh <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span>   <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">387</span>     <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3724030</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100776</span> <span style="color:#ff79c6">|</span> LgxWoD <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span>   <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">253</span>     <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span>      <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100031</span> <span style="color:#ff79c6">|</span> LZMOIa <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span>   <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">97</span>      <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">3722887</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100237</span> <span style="color:#ff79c6">|</span> QzbJdx <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span>   <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">440</span>     <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">609</span>     <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100610</span> <span style="color:#ff79c6">|</span> vbRimN <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span>   <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">481</span>     <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">139</span>     <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100140</span> <span style="color:#ff79c6">|</span> ZqFbuR <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span>   <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">351</span>     <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#bd93f9">8</span> rows <span style="color:#ff79c6">in</span> <span style="color:#8be9fd">set</span>, <span style="color:#bd93f9">1</span> <span style="color:#50fa7b">warning</span> (<span style="color:#bd93f9">3</span>.<span style="color:#bd93f9">16</span> sec)
</code></pre></div><blockquote>
<p>结论：type 是 ALL，即最坏的情况。Extra 里还出现了 Using filesort,也是最坏的情况。优化是必须的。</p>
</blockquote>
<p><strong>方案一: 为了去掉filesort我们可以把索引建成</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4">#创建新索引
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">INDEX</span> idx_age_name <span style="color:#ff79c6">ON</span> <span style="color:#50fa7b">student</span>(age,NAME);
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> stuno <span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">101000</span> <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> NAME;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzlmppn3j30no036jt6.jpg" alt="image-20220705222912521.png">

</p>
<p>这样我们优化掉了 using filesort</p>
<p>查询结果如下：</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzlzsbz0j30e10evgpo.jpg" alt="image-20220705222954971.png">

</p>
<p><strong>方案二：尽量让where的过滤条件和排序使用上索引</strong></p>
<p>建一个三个字段的组合索引：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_age_name <span style="color:#ff79c6">ON</span> student;
<span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">INDEX</span> idx_age_stuno_name <span style="color:#ff79c6">ON</span> <span style="color:#50fa7b">student</span> (age,stuno,NAME);
<span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> stuno <span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">101000</span> <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> NAME;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzmcg2v8j30nt028dh3.jpg" alt="image-20220705223111883.png">

</p>
<p>我们发现using filesort依然存在，所以name并没有用到索引，而且type还是range光看名字其实并不美好。原因是，因为<code>stuno是一个范围过滤</code>，所以索引后面的字段不会在使用索引了 。</p>
<p>结果如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">SELECT</span> SQL_NO_CACHE <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">WHERE</span> age <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">AND</span> stuno <span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">101000</span> <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> NAME ;
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#ff79c6">|</span> id <span style="color:#ff79c6">|</span> stuno <span style="color:#ff79c6">|</span> name <span style="color:#ff79c6">|</span> age <span style="color:#ff79c6">|</span> classId <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">167</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100168</span> <span style="color:#ff79c6">|</span> AClxEF <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">319</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">323</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100324</span> <span style="color:#ff79c6">|</span> bwbTpQ <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">654</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">651</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100652</span> <span style="color:#ff79c6">|</span> DRwIac <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">997</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">517</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100518</span> <span style="color:#ff79c6">|</span> HNSYqJ <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">256</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">344</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100345</span> <span style="color:#ff79c6">|</span> JuepiX <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">329</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">905</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100906</span> <span style="color:#ff79c6">|</span> JuWALd <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">892</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">574</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100575</span> <span style="color:#ff79c6">|</span> kbyqjX <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">260</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">703</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100704</span> <span style="color:#ff79c6">|</span> KJbprS <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">594</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">723</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100724</span> <span style="color:#ff79c6">|</span> OTdJkY <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">236</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">656</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100657</span> <span style="color:#ff79c6">|</span> Pfgqmj <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">600</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">982</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100983</span> <span style="color:#ff79c6">|</span> qywLqw <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">837</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">468</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100469</span> <span style="color:#ff79c6">|</span> sLEKQW <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">346</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">988</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100989</span> <span style="color:#ff79c6">|</span> UBYqJl <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">457</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">173</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100174</span> <span style="color:#ff79c6">|</span> UltkTN <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">830</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">|</span> <span style="color:#bd93f9">332</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">100333</span> <span style="color:#ff79c6">|</span> YjWiZw <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">30</span> <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">824</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#bd93f9">15</span> rows <span style="color:#ff79c6">in</span> <span style="color:#8be9fd">set</span>, <span style="color:#bd93f9">1</span> <span style="color:#50fa7b">warning</span> (<span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">00</span> sec)
</code></pre></div><p>结果竟然有 filesort的 sql 运行速度， 超过了已经优化掉 filesort的 sql ，而且快了很多，几乎一瞬间就出现了结果。</p>
<p>原因：</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzmzojcaj30wm049gpq.jpg" alt="image-20220705223329164.png">

</p>
<blockquote>
<p>结论：</p>
<ol>
<li>两个索引同时存在，mysql自动选择最优的方案。（对于这个例子，mysql选择 idx_age_stuno_name）。但是， <code>随着数据量的变化，选择的索引也会随之变化的 </code>。</li>
<li><strong>当【范围条件】和【group by 或者 order by】的字段出现二选一时，优先观察条件字段的过 滤数量，如果过滤的数据足够多，而需要排序的数据并不多时，优先把索引放在范围字段上。反之，亦然。</strong></li>
</ol>
</blockquote>
<p>思考：这里我们使用如下索引，是否可行？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_age_stuno_name <span style="color:#ff79c6">ON</span> student;

<span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">INDEX</span> idx_age_stuno <span style="color:#ff79c6">ON</span> <span style="color:#50fa7b">student</span>(age,stuno);
</code></pre></div><p>当然可以。</p>
<h3 id="54-filesort算法双路排序和单路排序">5.4 filesort算法：双路排序和单路排序</h3>
<p>排序的字段若不在索引列上，则filesort会有两种算法：双路排序和单路排序</p>
<p><strong>双路排序 （慢）</strong></p>
<ul>
<li>MySQL 4.1之前是使用双路排序 ，字面意思就是两次扫描磁盘，最终得到数据， 读取行指针和 order by列 ，对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据输出</li>
<li>从磁盘取排序字段，在buffer进行排序，再从磁盘取其他字段 。</li>
</ul>
<p>取一批数据，要对磁盘进行两次扫描，众所周知，IO是很耗时的，所以在mysql4.1之后，出现了第二种 改进的算法，就是单路排序。</p>
<p><strong>单路排序 （快）</strong></p>
<p>从磁盘读取查询需要的 所有列 ，按照order by列在buffer对它们进行排序，然后扫描排序后的列表进行输出， 它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO，但是它会使用更多的空间， 因为它把每一行都保存在内存中了。</p>
<p><strong>结论及引申出的问题</strong></p>
<ul>
<li>由于单路是后出的，总体而言好过双路</li>
<li>但是用单路有问题
<ul>
<li>在sort_buffer中，单路要比多路多占用很多空间，因为单路是把所有字段都取出，所以有可能取出的数据的总大小超出了<code>sort_buffer</code>的容量，导致每次只能取<code>sort_buffer</code>容量大小的数据，进行排序（创建tmp文件，多路合并），排完再取sort_buffer容量大小，再排&hellip;从而多次I/O。</li>
<li>单路本来想省一次I/O操作，反而导致了大量的I/O操作，反而得不偿失。</li>
</ul>
</li>
</ul>
<p><strong>优化策略</strong></p>
<p><strong>1. 尝试提高 sort_buffer_size</strong></p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yznefhmdj30vl0al799.jpg" alt="image-20220705224410340.png">

</p>
<p><strong>2. 尝试提高 max_length_for_sort_data</strong></p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yznqithej30w406wn1e.jpg" alt="image-20220705224505668.png">

</p>
<p><strong>3. Order by 时select * 是一个大忌。最好只Query需要的字段。</strong></p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzo1j4vmj30np03iq5j.jpg" alt="image-20220705224551104.png">

</p>
<h2 id="6-group-by优化">6. GROUP BY优化</h2>
<ul>
<li>group by 使用索引的原则几乎跟order by一致 ，group by 即使没有过滤条件用到索引，也可以直接使用索引。</li>
<li>group by 先排序再分组，遵照索引建的最佳左前缀法则</li>
<li>当无法使用索引列，增大 max_length_for_sort_data 和 sort_buffer_size 参数的设置</li>
<li>where效率高于having，能写在where限定的条件就不要写在having中了</li>
<li>减少使用order by，和业务沟通能不排序就不排序，或将排序放到程序端去做。Order by、group by、distinct这些语句较为耗费CPU，数据库的CPU资源是极其宝贵的。</li>
<li>包含了order by、group by、distinct这些查询的语句，where条件过滤出来的结果集请保持在1000行 以内，否则SQL会很慢。</li>
</ul>
<h2 id="7-优化分页查询">7. 优化分页查询</h2>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzog8vyhj30o707atc4.jpg" alt="image-20220705225329130.png">

</p>
<p><strong>优化思路一</strong></p>
<p>在索引上完成排序分页操作，最后根据主键关联回原表查询所需要的其他列内容。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student t,(<span style="color:#ff79c6">SELECT</span> id <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> id <span style="color:#ff79c6">LIMIT</span> <span style="color:#bd93f9">2000000</span>,<span style="color:#bd93f9">10</span>) a <span style="color:#ff79c6">WHERE</span> t.id <span style="color:#ff79c6">=</span> a.id;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzosb5tmj30w404vdlv.jpg" alt="image-20220705225625166.png">

</p>
<p><strong>优化思路二</strong></p>
<p>该方案适用于主键自增的表，可以把Limit 查询转换成某个位置的查询 。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> id <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">2000000</span> <span style="color:#ff79c6">LIMIT</span> <span style="color:#bd93f9">10</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzpbvgzkj30w303ldkd.jpg" alt="image-20220705225654124.png">

</p>
<h2 id="8-优先考虑覆盖索引">8. 优先考虑覆盖索引</h2>
<h3 id="81-什么是覆盖索引">8.1 什么是覆盖索引？</h3>
<p><strong>理解方式一</strong>：索引是高效找到行的一个方法，但是一般数据库也能使用索引找到一个列的数据，因此它不必读取整个行。毕竟索引叶子节点存储了它们索引的数据；当能通过读取索引就可以得到想要的数据，那就不需要读取行了。<strong>一个索引包含了满足查询结果的数据就叫做覆盖索引</strong>。</p>
<p><strong>理解方式二</strong>：非聚簇复合索引的一种形式，它包括在查询里的SELECT、JOIN和WHERE子句用到的所有列 （即建索引的字段正好是覆盖查询条件中所涉及的字段）。</p>
<p>简单说就是， <code>索引列+主键</code> 包含 <code>SELECT 到 FROM之间查询的列</code> 。</p>
<p><strong>举例一：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4"># 删除之前的索引
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">DROP</span> <span style="color:#ff79c6">INDEX</span> idx_age_stuno <span style="color:#ff79c6">ON</span> student;
<span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">INDEX</span> idx_age_name <span style="color:#ff79c6">ON</span> <span style="color:#50fa7b">student</span>(age, NAME);
<span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> age <span style="color:#ff79c6">&lt;</span><span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">20</span>;
</code></pre></div><p>
  <img src="MySQL%e7%b4%a2%e5%bc%95%e5%8f%8a%e8%b0%83%e4%bc%98%e7%af%87.assets/image-20220706124528680.png" alt="image-20220706124528680">

</p>
<p><strong>举例二：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> NAME <span style="color:#ff79c6">LIKE</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">%abc</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzpq26vrj30wa04htbx.jpg" alt="image-20220706124528680.png">

</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">INDEX</span> idx_age_name <span style="color:#ff79c6">ON</span> <span style="color:#50fa7b">student</span>(age, NAME);
<span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> id,age,NAME <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> NAME <span style="color:#ff79c6">LIKE</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">%abc</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzq1bjcaj30w603vtbo.jpg" alt="image-20220706125113658.png">

</p>
<p>上述都使用到了声明的索引，下面的情况则不然，查询列依然多了classId,结果是未使用到索引：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> id,age,NAME,classId <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> NAME <span style="color:#ff79c6">LIKE</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">%abc</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzqf04elj30w804ltc6.jpg" alt="image-20220706125351116.png">

</p>
<h3 id="82-覆盖索引的利弊">8.2 覆盖索引的利弊</h3>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzqrmxw8j30wk0hz7gf.jpg" alt="image-20220706125943936.png">

</p>
<h2 id="9-如何给字符串添加索引">9. 如何给字符串添加索引</h2>
<p>有一张教师表，表定义如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#ff79c6">create</span> <span style="color:#ff79c6">table</span> <span style="color:#50fa7b">teacher</span>(
ID <span style="color:#8be9fd">bigint</span> <span style="color:#ff79c6">unsigned</span> <span style="color:#ff79c6">primary</span> <span style="color:#ff79c6">key</span>,
email <span style="color:#8be9fd">varchar</span>(<span style="color:#bd93f9">64</span>),
...
)<span style="color:#ff79c6">engine</span><span style="color:#ff79c6">=</span>innodb;
</code></pre></div><p>讲师要使用邮箱登录，所以业务代码中一定会出现类似于这样的语句：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">select</span> col1, col2 <span style="color:#ff79c6">from</span> teacher <span style="color:#ff79c6">where</span> email<span style="color:#ff79c6">=</span><span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">xxx</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><p>如果email这个字段上没有索引，那么这个语句就只能做 <code>全表扫描</code> 。</p>
<h3 id="91-前缀索引">9.1 前缀索引</h3>
<p>MySQL是支持前缀索引的。默认地，如果你创建索引的语句不指定前缀长度，那么索引就会包含整个字 符串。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">alter</span> <span style="color:#ff79c6">table</span> teacher <span style="color:#ff79c6">add</span> <span style="color:#ff79c6">index</span> <span style="color:#50fa7b">index1</span>(email);
<span style="color:#6272a4">#或
</span><span style="color:#6272a4"></span>mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">alter</span> <span style="color:#ff79c6">table</span> teacher <span style="color:#ff79c6">add</span> <span style="color:#ff79c6">index</span> <span style="color:#50fa7b">index2</span>(<span style="color:#50fa7b">email</span>(<span style="color:#bd93f9">6</span>));
</code></pre></div><p>这两种不同的定义在数据结构和存储上有什么区别呢？下图就是这两个索引的示意图。</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzr7cpb1j30w00akgnn.jpg" alt="image-20220706130901307.png">

</p>
<p>以及</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzrk0f1yj30rg0jpq5n.jpg" alt="image-20220706130921934.png">

</p>
<p><strong>如果使用的是index1</strong>（即email整个字符串的索引结构），执行顺序是这样的：</p>
<ol>
<li>从index1索引树找到满足索引值是’ <a href="mailto:zhangssxyz@xxx.com">zhangssxyz@xxx.com</a>’的这条记录，取得ID2的值；</li>
<li>到主键上查到主键值是ID2的行，判断email的值是正确的，将这行记录加入结果集；</li>
<li>取index1索引树上刚刚查到的位置的下一条记录，发现已经不满足email=&rsquo; <a href="mailto:zhangssxyz@xxx.com">zhangssxyz@xxx.com</a> ’的 条件了，循环结束。</li>
</ol>
<p>这个过程中，只需要回主键索引取一次数据，所以系统认为只扫描了一行。</p>
<p><strong>如果使用的是index2</strong>（即email(6)索引结构），执行顺序是这样的：</p>
<ol>
<li>从index2索引树找到满足索引值是’zhangs’的记录，找到的第一个是ID1；</li>
<li>到主键上查到主键值是ID1的行，判断出email的值不是’ <a href="mailto:zhangssxyz@xxx.com">zhangssxyz@xxx.com</a> ’，这行记录丢弃；</li>
<li>取index2上刚刚查到的位置的下一条记录，发现仍然是’zhangs’，取出ID2，再到ID索引上取整行然 后判断，这次值对了，将这行记录加入结果集；</li>
<li>重复上一步，直到在idxe2上取到的值不是’zhangs’时，循环结束。</li>
</ol>
<p>也就是说**使用前缀索引，定义好长度，就可以做到既节省空间，又不用额外增加太多的查询成本。**前面 已经讲过区分度，区分度越高越好。因为区分度越高，意味着重复的键值越少。</p>
<h3 id="92-前缀索引对覆盖索引的影响">9.2 前缀索引对覆盖索引的影响</h3>
<blockquote>
<p>结论： 使用前缀索引就用不上覆盖索引对查询性能的优化了，这也是你在选择是否使用前缀索引时需要考虑的一个因素。</p>
</blockquote>
<h2 id="10-索引下推">10. 索引下推</h2>
<h3 id="101-使用前后对比">10.1 使用前后对比</h3>
<p>Index Condition Pushdown(ICP)是MySQL 5.6中新特性，是一种在存储引擎层使用索引过滤数据的一种优化方式。</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzs6k6vhj30wl08k47c.jpg" alt="image-20220706131320477.png">

</p>
<h3 id="102-icp的开启关闭">10.2 ICP的开启/关闭</h3>
<ul>
<li>默认情况下启动索引条件下推。可以通过设置系统变量<code>optimizer_switch</code>控制：<code>index_condition_pushdown</code></li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#6272a4"># 打开索引下推
</span><span style="color:#6272a4"></span><span style="color:#8be9fd">SET</span> optimizer_switch <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">index_condition_pushdown=on</span><span style="color:#f1fa8c">&#39;</span>;

<span style="color:#6272a4"># 关闭索引下推
</span><span style="color:#6272a4"></span><span style="color:#8be9fd">SET</span> optimizer_switch <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c"></span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">index_condition_pushdown=off</span><span style="color:#f1fa8c">&#39;</span>;
</code></pre></div><ul>
<li>当使用索引条件下推是，<code>EXPLAIN</code>语句输出结果中<code>Extra</code>列内容显示为<code>Using index condition</code>。</li>
</ul>
<h3 id="103-icp使用案例">10.3 ICP使用案例</h3>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzsm1853j30x50k67d4.jpg" alt="image-20220706135436316.png">

</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzu3075xj30x20mvwr9.jpg" alt="image-20220706135506409.png">

</p>
<ul>
<li>主键索引 (简图)</li>
</ul>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzuemx2aj30vv03bdi0.jpg" alt="image-20220706135633814.png">

</p>
<p>二级索引zip_last_first (简图，这里省略了数据页等信息)</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzus1ledj30vv03gmz1.jpg" alt="image-20220706135701187.png">

</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzv6l8zoj30wl0foah6.jpg" alt="image-20220706135723203.png">

</p>
<h3 id="104-开启和关闭icp性能对比">10.4 开启和关闭ICP性能对比</h3>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzvjs92ij30x10kl0yw.jpg" alt="image-20220706135904713.png">

</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzvvaahjj30wx0lhgvi.jpg" alt="image-20220706140213382.png">

</p>
<h3 id="105-icp的使用条件">10.5 ICP的使用条件</h3>
<ol>
<li>如果表的访问类型为 range 、 ref 、 eq_ref 或者 ref_or_null 可以使用ICP。</li>
<li>ICP可以使用<code>InnDB</code>和<code>MyISAM</code>表，包括分区表<code>InnoDB</code>和<code>MyISAM</code>表</li>
<li>对于<code>InnoDB</code>表，ICP仅用于<code>二级索引</code>。ICP的目标是减少全行读取次数，从而减少I/O操作。</li>
<li>当SQL使用覆盖索引时，不支持ICP优化方法。因为这种情况下使用ICP不会减少I/O。</li>
<li>相关子查询的条件不能使用ICP</li>
</ol>
<h2 id="11-普通索引-vs-唯一索引">11. 普通索引 vs 唯一索引</h2>
<p>从性能的角度考虑，你选择唯一索引还是普通索引呢？选择的依据是什么呢？</p>
<p>假设，我们有一个主键列为ID的表，表中有字段k，并且在k上有索引，假设字段 k 上的值都不重复。</p>
<p>这个表的建表语句是：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">create</span> <span style="color:#ff79c6">table</span> <span style="color:#50fa7b">test</span>(
id <span style="color:#8be9fd">int</span> <span style="color:#ff79c6">primary</span> <span style="color:#ff79c6">key</span>,
k <span style="color:#8be9fd">int</span> <span style="color:#ff79c6">not</span> null,
name <span style="color:#8be9fd">varchar</span>(<span style="color:#bd93f9">16</span>),
<span style="color:#ff79c6">index</span> (k)
)<span style="color:#ff79c6">engine</span><span style="color:#ff79c6">=</span>InnoDB;
</code></pre></div><p>表中R1~R5的(ID,k)值分别为(100,1)、(200,2)、(300,3)、(500,5)和(600,6)。</p>
<h3 id="111-查询过程">11.1 查询过程</h3>
<p>假设，执行查询的语句是 select id from test where k=5。</p>
<ul>
<li>对于普通索引来说，查找到满足条件的第一个记录(5,500)后，需要查找下一个记录，直到碰到第一 个不满足k=5条件的记录。</li>
<li>对于唯一索引来说，由于索引定义了唯一性，查找到第一个满足条件的记录后，就会停止继续检 索。</li>
</ul>
<p>那么，这个不同带来的性能差距会有多少呢？答案是， 微乎其微 。</p>
<h3 id="112-更新过程">11.2 更新过程</h3>
<p>为了说明普通索引和唯一索引对更新语句性能的影响这个问题，介绍一下change buffer。</p>
<p>当需要更新一个数据页时，如果数据页在内存中就直接更新，而如果这个数据页还没有在内存中的话， 在不影响数据一致性的前提下， <code>InooDB会将这些更新操作缓存在change buffer中</code> ，这样就不需要从磁盘中读入这个数据页了。在下次查询需要访问这个数据页的时候，将数据页读入内存，然后执行change buffer中与这个页有关的操作。通过这种方式就能保证这个数据逻辑的正确性。</p>
<p>将change buffer中的操作应用到原数据页，得到最新结果的过程称为 merge 。除了 <code>访问这个数据页</code> 会触 发merge外，系统有 <code>后台线程会定期</code> merge。在 <code>数据库正常关闭（shutdown）</code> 的过程中，也会执行merge 操作。</p>
<p>如果能够将更新操作先记录在change buffer， <code>减少读磁盘</code> ，语句的执行速度会得到明显的提升。而且， 数据读入内存是需要占用 buffer pool 的，所以这种方式还能够 <code>避免占用内存 </code>，提高内存利用率。</p>
<p><code>唯一索引的更新就不能使用change buffer</code> ，实际上也只有普通索引可以使用。</p>
<p>如果要在这张表中插入一个新记录(4,400)的话，InnoDB的处理流程是怎样的？</p>
<h3 id="113-change-buffer的使用场景">11.3 change buffer的使用场景</h3>
<ol>
<li>普通索引和唯一索引应该怎么选择？其实，这两类索引在查询能力上是没差别的，主要考虑的是 对 更新性能 的影响。所以，建议你 尽量选择普通索引 。</li>
<li>在实际使用中会发现， 普通索引 和 change buffer 的配合使用，对于 数据量大 的表的更新优化 还是很明显的。</li>
<li>如果所有的更新后面，都马上 伴随着对这个记录的查询 ，那么你应该 关闭change buffer 。而在 其他情况下，change buffer都能提升更新性能。</li>
<li>由于唯一索引用不上change buffer的优化机制，因此如果 业务可以接受 ，从性能角度出发建议优 先考虑非唯一索引。但是如果&quot;业务可能无法确保&quot;的情况下，怎么处理呢？
<ul>
<li>首先， 业务正确性优先 。我们的前提是“业务代码已经保证不会写入重复数据”的情况下，讨论性能 问题。如果业务不能保证，或者业务就是要求数据库来做约束，那么没得选，必须创建唯一索引。 这种情况下，本节的意义在于，如果碰上了大量插入数据慢、内存命中率低的时候，给你多提供一 个排查思路。</li>
<li>然后，在一些“ 归档库 ”的场景，你是可以考虑使用唯一索引的。比如，线上数据只需要保留半年， 然后历史数据保存在归档库。这时候，归档数据已经是确保没有唯一键冲突了。要提高归档效率， 可以考虑把表里面的唯一索引改成普通索引。</li>
</ul>
</li>
</ol>
<h2 id="12-其它查询优化策略">12. 其它查询优化策略</h2>
<h3 id="121-exists-和-in-的区分">12.1 EXISTS 和 IN 的区分</h3>
<p><strong>问题：</strong></p>
<p>不太理解哪种情况下应该使用 EXISTS，哪种情况应该用 IN。选择的标准是看能否使用表的索引吗？</p>
<p><strong>回答：</strong></p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzwewijgj30wn0jltg4.jpg" alt="image-20220706141957185.png">

</p>
<h3 id="122-count与count具体字段效率">12.2 COUNT(*)与COUNT(具体字段)效率</h3>
<p>问：在 MySQL 中统计数据表的行数，可以使用三种方式： SELECT COUNT(*) 、 SELECT COUNT(1) 和 SELECT COUNT(具体字段) ，使用这三者之间的查询效率是怎样的？</p>
<p>答：</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzwq0aymj30wj0ghto9.jpg" alt="image-20220706142648452.png">

</p>
<h3 id="123-关于select">12.3 关于SELECT(*)</h3>
<p>在表查询中，建议明确字段，不要使用 * 作为查询的字段列表，推荐使用SELECT &lt;字段列表&gt; 查询。原因：</p>
<p>① MySQL 在解析的过程中，会通过查询数据字典 将&rdquo;*&ldquo;按序转换成所有列名，这会大大的耗费资源和时间。</p>
<p>② 无法使用 覆盖索引</p>
<h3 id="124-limit-1-对优化的影响">12.4 LIMIT 1 对优化的影响</h3>
<p>针对的是会扫描全表的 SQL 语句，如果你可以确定结果集只有一条，那么加上 LIMIT 1 的时候，当找到一条结果的时候就不会继续扫描了，这样会加快查询速度。</p>
<p>如果数据表已经对字段建立了唯一索引，那么可以通过索引进行查询，不会全表扫描的话，就不需要加上 LIMIT 1 了。</p>
<h3 id="125-多使用commit">12.5 多使用COMMIT</h3>
<p>只要有可能，在程序中尽量多使用 COMMIT，这样程序的性能得到提高，需求也会因为 COMMIT 所释放 的资源而减少。</p>
<p>COMMIT 所释放的资源：</p>
<ul>
<li>回滚段上用于恢复数据的信息</li>
<li>被程序语句获得的锁</li>
<li>redo / undo log buffer 中的空间</li>
<li>管理上述 3 种资源中的内部花费</li>
</ul>
<h2 id="13-淘宝数据库主键如何设计的">13. 淘宝数据库，主键如何设计的？</h2>
<p>聊一个实际问题：淘宝的数据库，主键是如何设计的？</p>
<p>某些错的离谱的答案还在网上年复一年的流传着，甚至还成为了所谓的MySQL军规。其中，一个最明显的错误就是关于MySQL的主键设计。</p>
<p>大部分人的回答如此自信：用8字节的 BIGINT 做主键，而不要用INT。 <code>错 </code>！</p>
<p>这样的回答，只站在了数据库这一层，而没有 <code>从业务的角度</code> 思考主键。主键就是一个自增ID吗？站在 2022年的新年档口，用自增做主键，架构设计上可能 <code>连及格都拿不到</code> 。</p>
<h3 id="131-自增id的问题">13.1 自增ID的问题</h3>
<p>自增ID做主键，简单易懂，几乎所有数据库都支持自增类型，只是实现上各自有所不同而已。自增ID除 了简单，其他都是缺点，总体来看存在以下几方面的问题：</p>
<ol>
<li>
<p><strong>可靠性不高</strong></p>
<p>存在自增ID回溯的问题，这个问题直到最新版本的MySQL 8.0才修复。</p>
</li>
<li>
<p>**安全性不高 **</p>
<p>对外暴露的接口可以非常容易猜测对应的信息。比如：/User/1/这样的接口，可以非常容易猜测用户ID的 值为多少，总用户数量有多少，也可以非常容易地通过接口进行数据的爬取。</p>
</li>
<li>
<p><strong>性能差</strong></p>
<p>自增ID的性能较差，需要在数据库服务器端生成。</p>
</li>
<li>
<p><strong>交互多</strong></p>
<p>业务还需要额外执行一次类似 last_insert_id() 的函数才能知道刚才插入的自增值，这需要多一次的 网络交互。在海量并发的系统中，多1条SQL，就多一次性能上的开销。</p>
</li>
<li>
<p><strong>局部唯一性</strong></p>
<p>最重要的一点，自增ID是局部唯一，只在当前数据库实例中唯一，而不是全局唯一，在任意服务器间都 是唯一的。对于目前分布式系统来说，这简直就是噩梦。</p>
</li>
</ol>
<h3 id="132-业务字段做主键">13.2 业务字段做主键</h3>
<p>为了能够唯一地标识一个会员的信息，需要为 会员信息表 设置一个主键。那么，怎么为这个表设置主 键，才能达到我们理想的目标呢？ 这里我们考虑业务字段做主键。</p>
<p>表数据如下：</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzxcl6m0j30k004rdgl.jpg" alt="image-20220706151506580.png">

</p>
<p>在这个表里，哪个字段比较合适呢？</p>
<ul>
<li><strong>选择卡号（cardno）</strong></li>
</ul>
<p>会员卡号（cardno）看起来比较合适，因为会员卡号不能为空，而且有唯一性，可以用来 标识一条会员 记录。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">CREATE</span> <span style="color:#ff79c6">TABLE</span> demo.membermaster
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> (
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> cardno <span style="color:#8be9fd">CHAR</span>(<span style="color:#bd93f9">8</span>) <span style="color:#ff79c6">PRIMARY</span> <span style="color:#ff79c6">KEY</span>, <span style="color:#6272a4">-- 会员卡号为主键
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> membername <span style="color:#8be9fd">TEXT</span>,
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> memberphone <span style="color:#8be9fd">TEXT</span>,
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> memberpid <span style="color:#8be9fd">TEXT</span>,
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> memberaddress <span style="color:#8be9fd">TEXT</span>,
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> sex <span style="color:#8be9fd">TEXT</span>,
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> birthday <span style="color:#8be9fd">DATETIME</span>
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> );
Query OK, <span style="color:#bd93f9">0</span> rows <span style="color:#50fa7b">affected</span> (<span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">06</span> sec)
</code></pre></div><p>不同的会员卡号对应不同的会员，字段“cardno”唯一地标识某一个会员。如果都是这样，会员卡号与会 员一一对应，系统是可以正常运行的。</p>
<p>但实际情况是， 会员卡号可能存在重复使用 的情况。比如，张三因为工作变动搬离了原来的地址，不再 到商家的门店消费了 （退还了会员卡），于是张三就不再是这个商家门店的会员了。但是，商家不想让 这个会 员卡空着，就把卡号是“10000001”的会员卡发给了王五。</p>
<p>从系统设计的角度看，这个变化只是修改了会员信息表中的卡号是“10000001”这个会员 信息，并不会影 响到数据一致性。也就是说，修改会员卡号是“10000001”的会员信息， 系统的各个模块，都会获取到修 改后的会员信息，不会出现“有的模块获取到修改之前的会员信息，有的模块获取到修改后的会员信息， 而导致系统内部数据不一致”的情况。因此，从 信息系统层面 上看是没问题的。</p>
<p>但是从使用 系统的业务层面 来看，就有很大的问题 了，会对商家造成影响。</p>
<p>比如，我们有一个销售流水表（trans），记录了所有的销售流水明细。2020 年 12 月 01 日，张三在门店 购买了一本书，消费了 89 元。那么，系统中就有了张三买书的流水记录，如下所示：</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzygfrjyj30jz03g74q.jpg" alt="image-20220706151715106.png">

</p>
<p>接着，我们查询一下 2020 年 12 月 01 日的会员销售记录：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">SELECT</span> b.membername,c.goodsname,a.quantity,a.salesvalue,a.transdate
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">FROM</span> demo.trans <span style="color:#ff79c6">AS</span> a
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">JOIN</span> demo.membermaster <span style="color:#ff79c6">AS</span> b
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">JOIN</span> demo.goodsmaster <span style="color:#ff79c6">AS</span> c
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">ON</span> (a.cardno <span style="color:#ff79c6">=</span> b.cardno <span style="color:#ff79c6">AND</span> a.itemnumber<span style="color:#ff79c6">=</span>c.itemnumber);
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#ff79c6">|</span> membername <span style="color:#ff79c6">|</span> goodsname <span style="color:#ff79c6">|</span> quantity <span style="color:#ff79c6">|</span> salesvalue <span style="color:#ff79c6">|</span> transdate <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#ff79c6">|</span>     张三   <span style="color:#ff79c6">|</span> 书         <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1</span>.<span style="color:#bd93f9">000</span>    <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">89</span>.<span style="color:#bd93f9">00</span>      <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">2020</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">12</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">01</span> <span style="color:#bd93f9">00</span>:<span style="color:#bd93f9">00</span>:<span style="color:#bd93f9">00</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#bd93f9">1</span> row <span style="color:#ff79c6">in</span> <span style="color:#8be9fd">set</span> (<span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">00</span> sec)
</code></pre></div><p>如果会员卡“10000001”又发给了王五，我们会更改会员信息表。导致查询时：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">mysql<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">SELECT</span> b.membername,c.goodsname,a.quantity,a.salesvalue,a.transdate
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">FROM</span> demo.trans <span style="color:#ff79c6">AS</span> a
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">JOIN</span> demo.membermaster <span style="color:#ff79c6">AS</span> b
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">JOIN</span> demo.goodsmaster <span style="color:#ff79c6">AS</span> c
<span style="color:#ff79c6">-</span><span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">ON</span> (a.cardno <span style="color:#ff79c6">=</span> b.cardno <span style="color:#ff79c6">AND</span> a.itemnumber<span style="color:#ff79c6">=</span>c.itemnumber);
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#ff79c6">|</span> membername <span style="color:#ff79c6">|</span> goodsname <span style="color:#ff79c6">|</span> quantity <span style="color:#ff79c6">|</span> salesvalue <span style="color:#ff79c6">|</span> transdate <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#ff79c6">|</span> 王五        <span style="color:#ff79c6">|</span> 书        <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1</span>.<span style="color:#bd93f9">000</span>    <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">89</span>.<span style="color:#bd93f9">00</span>      <span style="color:#ff79c6">|</span> <span style="color:#bd93f9">2020</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">12</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">01</span> <span style="color:#bd93f9">00</span>:<span style="color:#bd93f9">00</span>:<span style="color:#bd93f9">00</span> <span style="color:#ff79c6">|</span>
<span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">+</span>
<span style="color:#bd93f9">1</span> row <span style="color:#ff79c6">in</span> <span style="color:#8be9fd">set</span> (<span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">01</span> sec)
</code></pre></div><p>这次得到的结果是：王五在 2020 年 12 月 01 日，买了一本书，消费 89 元。显然是错误的！结论：千万 不能把会员卡号当做主键。</p>
<ul>
<li><strong>选择会员电话 或 身份证号</strong></li>
</ul>
<p>会员电话可以做主键吗？不行的。在实际操作中，手机号也存在 被运营商收回 ，重新发给别人用的情况。</p>
<p>那身份证号行不行呢？好像可以。因为身份证决不会重复，身份证号与一个人存在一一对 应的关系。可 问题是，身份证号属于 个人隐私 ，顾客不一定愿意给你。要是强制要求会员必须登记身份证号，会把很 多客人赶跑的。其实，客户电话也有这个问题，这也是我们在设计会员信息表的时候，允许身份证号和 电话都为空的原因。</p>
<p><strong>所以，建议尽量不要用跟业务有关的字段做主键。毕竟，作为项目设计的技术人员，我们谁也无法预测 在项目的整个生命周期中，哪个业务字段会因为项目的业务需求而有重复，或者重用之类的情况出现。</strong></p>
<blockquote>
<p>经验： 刚开始使用 MySQL 时，很多人都很容易犯的错误是喜欢用业务字段做主键，想当然地认为了解业 务需求，但实际情况往往出乎意料，而更改主键设置的成本非常高。</p>
</blockquote>
<h3 id="133-淘宝的主键设计">13.3 淘宝的主键设计</h3>
<p>在淘宝的电商业务中，订单服务是一个核心业务。请问， 订单表的主键 淘宝是如何设计的呢？是自增ID 吗？</p>
<p>打开淘宝，看一下订单信息：</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzyvf26pj30jw0if0xn.jpg" alt="image-20220706161436920.png">

</p>
<p>从上图可以发现，订单号不是自增ID！我们详细看下上述4个订单号：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#bd93f9">1550672064762308113</span>
<span style="color:#bd93f9">1481195847180308113</span>
<span style="color:#bd93f9">1431156171142308113</span>
<span style="color:#bd93f9">1431146631521308113</span>
</code></pre></div><p>订单号是19位的长度，且订单的最后5位都是一样的，都是08113。且订单号的前面14位部分是单调递增的。</p>
<p>大胆猜测，淘宝的订单ID设计应该是：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">订单ID <span style="color:#ff79c6">=</span> 时间 <span style="color:#ff79c6">+</span> 去重字段 <span style="color:#ff79c6">+</span> 用户ID后6位尾号
</code></pre></div><p>这样的设计能做到全局唯一，且对分布式系统查询及其友好。</p>
<h3 id="134-推荐的主键设计">13.4 推荐的主键设计</h3>
<p><strong>非核心业务</strong> ：对应表的主键自增ID，如告警、日志、监控等信息。</p>
<p><strong>核心业务</strong> ：<code>主键设计至少应该是全局唯一且是单调递增</code>。全局唯一保证在各系统之间都是唯一的，单调 递增是希望插入时不影响数据库性能。</p>
<p>这里推荐最简单的一种主键设计：UUID。</p>
<p><strong>UUID的特点：</strong></p>
<p>全局唯一，占用36字节，数据无序，插入性能差。</p>
<p><strong>认识UUID：</strong></p>
<ul>
<li>为什么UUID是全局唯一的？</li>
<li>为什么UUID占用36个字节？</li>
<li>为什么UUID是无序的？</li>
</ul>
<p>MySQL数据库的UUID组成如下所示：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql">UUID <span style="color:#ff79c6">=</span> 时间<span style="color:#ff79c6">+</span>UUID版本（<span style="color:#bd93f9">16</span>字节）<span style="color:#ff79c6">-</span> 时钟序列（<span style="color:#bd93f9">4</span>字节） <span style="color:#ff79c6">-</span> MAC地址（<span style="color:#bd93f9">12</span>字节）
</code></pre></div><p>我们以UUID值e0ea12d4-6473-11eb-943c-00155dbaa39d举例：</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzz9apzcj30o008ewgc.jpg" alt="image-20220706162131362.png">

</p>
<p><code>为什么UUID是全局唯一的？</code></p>
<p>在UUID中时间部分占用60位，存储的类似TIMESTAMP的时间戳，但表示的是从1582-10-15 00：00：00.00 到现在的100ns的计数。可以看到UUID存储的时间精度比TIMESTAMPE更高，时间维度发生重复的概率降 低到1/100ns。</p>
<p>时钟序列是为了避免时钟被回拨导致产生时间重复的可能性。MAC地址用于全局唯一。</p>
<p><code>为什么UUID占用36个字节？</code></p>
<p>UUID根据字符串进行存储，设计时还带有无用&rdquo;-&ldquo;字符串，因此总共需要36个字节。</p>
<p><code>为什么UUID是随机无序的呢？</code></p>
<p>因为UUID的设计中，将时间低位放在最前面，而这部分的数据是一直在变化的，并且是无序。</p>
<p><strong>改造UUID</strong></p>
<p>若将时间高低位互换，则时间就是单调递增的了，也就变得单调递增了。MySQL 8.0可以更换时间低位和时间高位的存储方式，这样UUID就是有序的UUID了。</p>
<p>MySQL 8.0还解决了UUID存在的空间占用的问题，除去了UUID字符串中无意义的&rdquo;-&ldquo;字符串，并且将字符串用二进制类型保存，这样存储空间降低为了16字节。</p>
<p>可以通过MySQL8.0提供的uuid_to_bin函数实现上述功能，同样的，MySQL也提供了bin_to_uuid函数进行转化：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-mysql" data-lang="mysql"><span style="color:#8be9fd">SET</span> <span style="color:#ff79c6">@</span>uuid <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">UUID</span>();
<span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">@</span>uuid,<span style="color:#50fa7b">uuid_to_bin</span>(<span style="color:#ff79c6">@</span>uuid),<span style="color:#50fa7b">uuid_to_bin</span>(<span style="color:#ff79c6">@</span>uuid,TRUE);
</code></pre></div><p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7yzzluc22j30t304egpa.jpg" alt="image-20220706162657448.png">

</p>
<p><strong>通过函数uuid_to_bin(@uuid,true)将UUID转化为有序UUID了</strong>。全局唯一 + 单调递增，这不就是我们想要的主键！</p>
<p><strong>有序UUID性能测试</strong></p>
<p>16字节的有序UUID，相比之前8字节的自增ID，性能和存储空间对比究竟如何呢？</p>
<p>我们来做一个测试，插入1亿条数据，每条数据占用500字节，含有3个二级索引，最终的结果如下所示：</p>
<p>
  <img src="http://tva1.sinaimg.cn/large/006QQPIfly1h7z0009nhzj30sz08tjsw.jpg" alt="image-20220706162947613.png">

</p>
<p>从上图可以看到插入1亿条数据有序UUID是最快的，而且在实际业务使用中有序UUID在 <code>业务端就可以生成</code> 。还可以进一步减少SQL的交互次数。</p>
<p>另外，虽然有序UUID相比自增ID多了8个字节，但实际只增大了3G的存储空间，还可以接受。</p>
<blockquote>
<p>在当今的互联网环境中，非常不推荐自增ID作为主键的数据库设计。更推荐类似有序UUID的全局 唯一的实现。</p>
<p>另外在真实的业务系统中，主键还可以加入业务和系统属性，如用户的尾号，机房的信息等。这样 的主键设计就更为考验架构师的水平了。</p>
</blockquote>
<p><strong>如果不是MySQL8.0 肿么办？</strong></p>
<p>手动赋值字段做主键！</p>
<p>比如，设计各个分店的会员表的主键，因为如果每台机器各自产生的数据需要合并，就可能会出现主键重复的问题。</p>
<p>可以在总部 MySQL 数据库中，有一个管理信息表，在这个表中添加一个字段，专门用来记录当前会员编号的最大值。</p>
<p>门店在添加会员的时候，先到总部 MySQL 数据库中获取这个最大值，在这个基础上加 1，然后用这个值 作为新会员的“id”，同时，更新总部 MySQL 数据库管理信息表中的当前会员编号的最大值。</p>
<p>这样一来，各个门店添加会员的时候，都对同一个总部 MySQL 数据库中的数据表字段进行操作，就解 决了各门店添加会员时会员编号冲突的问题。</p>


                

                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/post/1079%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/" data-toggle="tooltip" data-placement="top" title="9、性能分析工具的使用（索引与调优篇）">&larr;
                            Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/post/1081%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83/" data-toggle="tooltip" data-placement="top" title="11、数据库的设计规范（索引与调优篇）">Next
                            Post &rarr;</a>
                    </li>
                    
                </ul>
                

            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">标签</a></h5>
                    <div class="tags">
                        
                        
                        
                        <a href="/tags/activemq" title="activemq">
                            activemq
                        </a>
                        
                        
                        
                        <a href="/tags/ajax" title="ajax">
                            ajax
                        </a>
                        
                        
                        
                        <a href="/tags/cookie" title="cookie">
                            cookie
                        </a>
                        
                        
                        
                        <a href="/tags/datax" title="datax">
                            datax
                        </a>
                        
                        
                        
                        <a href="/tags/docker" title="docker">
                            docker
                        </a>
                        
                        
                        
                        <a href="/tags/dubbo" title="dubbo">
                            dubbo
                        </a>
                        
                        
                        
                        <a href="/tags/elasticsearch" title="elasticsearch">
                            elasticsearch
                        </a>
                        
                        
                        
                        <a href="/tags/filter" title="filter">
                            filter
                        </a>
                        
                        
                        
                        <a href="/tags/hadoop" title="hadoop">
                            hadoop
                        </a>
                        
                        
                        
                        <a href="/tags/hbase" title="hbase">
                            hbase
                        </a>
                        
                        
                        
                        <a href="/tags/hive" title="hive">
                            hive
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/java" title="java">
                            java
                        </a>
                        
                        
                        
                        <a href="/tags/javascript" title="javascript">
                            javascript
                        </a>
                        
                        
                        
                        <a href="/tags/javaweb" title="javaweb">
                            javaweb
                        </a>
                        
                        
                        
                        <a href="/tags/jdbc" title="jdbc">
                            jdbc
                        </a>
                        
                        
                        
                        <a href="/tags/jquery" title="jquery">
                            jquery
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/jsp" title="jsp">
                            jsp
                        </a>
                        
                        
                        
                        <a href="/tags/juc" title="juc">
                            juc
                        </a>
                        
                        
                        
                        <a href="/tags/jvm" title="jvm">
                            jvm
                        </a>
                        
                        
                        
                        <a href="/tags/jwt" title="jwt">
                            jwt
                        </a>
                        
                        
                        
                        <a href="/tags/kafka" title="kafka">
                            kafka
                        </a>
                        
                        
                        
                        <a href="/tags/linux" title="linux">
                            linux
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/maven" title="maven">
                            maven
                        </a>
                        
                        
                        
                        <a href="/tags/minio" title="minio">
                            minio
                        </a>
                        
                        
                        
                        <a href="/tags/mongodb" title="mongodb">
                            mongodb
                        </a>
                        
                        
                        
                        <a href="/tags/mybatis" title="mybatis">
                            mybatis
                        </a>
                        
                        
                        
                        
                        
                        <a href="/tags/mysql" title="mysql">
                            mysql
                        </a>
                        
                        
                        
                        <a href="/tags/netty" title="netty">
                            netty
                        </a>
                        
                        
                        
                        <a href="/tags/nginx" title="nginx">
                            nginx
                        </a>
                        
                        
                        
                        <a href="/tags/react" title="react">
                            react
                        </a>
                        
                        
                        
                        <a href="/tags/redis" title="redis">
                            redis
                        </a>
                        
                        
                        
                        <a href="/tags/scala" title="scala">
                            scala
                        </a>
                        
                        
                        
                        <a href="/tags/servlet" title="servlet">
                            servlet
                        </a>
                        
                        
                        
                        <a href="/tags/session" title="session">
                            session
                        </a>
                        
                        
                        
                        <a href="/tags/shiro" title="shiro">
                            shiro
                        </a>
                        
                        
                        
                        <a href="/tags/spark" title="spark">
                            spark
                        </a>
                        
                        
                        
                        <a href="/tags/spring" title="spring">
                            spring
                        </a>
                        
                        
                        
                        <a href="/tags/springboot" title="springboot">
                            springboot
                        </a>
                        
                        
                        
                        <a href="/tags/springcloud" title="springcloud">
                            springcloud
                        </a>
                        
                        
                        
                        <a href="/tags/springmvc" title="springmvc">
                            springmvc
                        </a>
                        
                        
                        
                        <a href="/tags/springsecurity" title="springsecurity">
                            springsecurity
                        </a>
                        
                        
                        
                        <a href="/tags/tomcat" title="tomcat">
                            tomcat
                        </a>
                        
                        
                        
                        <a href="/tags/vue" title="vue">
                            vue
                        </a>
                        
                        
                        
                        <a href="/tags/xml" title="xml">
                            xml
                        </a>
                        
                        
                        
                        <a href="/tags/zookeeper" title="zookeeper">
                            zookeeper
                        </a>
                        
                        
                        
                        <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81" title="分布式锁">
                            分布式锁
                        </a>
                        
                        
                        
                        <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95" title="数据结构与算法">
                            数据结构与算法
                        </a>
                        
                        
                        
                        <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" title="设计模式">
                            设计模式
                        </a>
                        
                        
                        
                        <a href="/tags/%E9%A1%B9%E7%9B%AE" title="项目">
                            项目
                        </a>
                        
                        
                    </div>
                </section>
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">                  
                    
                    <li>
                        <a href="mailto:1424197205@qq.com">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    <li>
                        <a target="_blank" href="/#">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    <li>
                        <a target="_blank" href="https://github.com/yiguan1573">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
           
                   <li>
                       <a href='' rel="alternate" type="application/rss+xml" title="亿观的博客" >
                           <span class="fa-stack fa-lg">
                               <i class="fas fa-circle fa-stack-2x"></i>
                               <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                           </span>
                       </a>
                   </li>
            
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; 亿观的博客 2022
                    <br>
                    <a href="https://themes.gohugo.io/hugo-theme-cleanwhite">CleanWhite Hugo Theme</a> by <a href="https://zhaohuabing.com">Huabing</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>









<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





</body>
</html>
